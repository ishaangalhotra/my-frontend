<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickLocal Marketplace - API Debug</title>
</head>
<body>
    <!-- Hybrid Authentication Client -->
    <script src="https://quicklocal-backend.onrender.com/hybrid-auth-client.js"></script>
    
    <!-- Configuration -->
    <script>
        window.APP_CONFIG = {
            API_BASE_URL: 'https://quicklocal-backend.onrender.com/api/v1',
            SUPABASE_URL: 'https://pmvhsjezhuokwygvhhqk.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtdmhzamV6aHVva3d5Z3ZoaHFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NTU3MDUsImV4cCI6MjA3MzIzMTcwNX0.ZrVjuqB28Qer7F7zSdG_rJIs_ZQZhX1PNyrmpK-Qojg',
            TOKEN_STORAGE_KEY: 'quicklocal_access_token',
            REFRESH_TOKEN_KEY: 'quicklocal_refresh_token',
            ENVIRONMENT: 'production'
        };
    </script>

    <div id="debug-info">
        <h1>API Debug Information</h1>
        <div id="results"></div>
    </div>

    <script>
        async function debugAPI() {
            const resultsDiv = document.getElementById('results');
            
            function log(message, type = 'info') {
                const p = document.createElement('p');
                p.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
                p.textContent = message;
                resultsDiv.appendChild(p);
                console.log(message);
            }

            try {
                log('🔍 Testing API endpoints...');
                log('Backend URL: ' + window.APP_CONFIG.API_BASE_URL);

                // Test 1: Direct fetch to products endpoint
                log('\n📡 Test 1: Direct fetch to /api/v1/products');
                try {
                    const response = await fetch(window.APP_CONFIG.API_BASE_URL + '/products');
                    log(`Status: ${response.status} ${response.statusText}`);
                    
                    const responseHeaders = {};
                    response.headers.forEach((value, key) => {
                        responseHeaders[key] = value;
                    });
                    log(`Headers: ${JSON.stringify(responseHeaders, null, 2)}`);
                    
                    const data = await response.json();
                    log(`Response data structure: ${JSON.stringify(Object.keys(data), null, 2)}`);
                    log(`Success field: ${data.success}`);
                    
                    if (data.success && data.data && data.data.products) {
                        log(`✅ Found ${data.data.products.length} products`, 'success');
                        log(`First product: ${JSON.stringify(data.data.products[0], null, 2)}`);
                    } else {
                        log(`❌ Unexpected response format`, 'error');
                    }
                } catch (error) {
                    log(`❌ Direct fetch failed: ${error.message}`, 'error');
                }

                // Test 2: Test hybrid auth client
                log('\n🔐 Test 2: Hybrid Auth Client');
                if (window.HybridAuthClient) {
                    log('✅ HybridAuthClient available', 'success');
                    
                    // Test API call method
                    if (typeof window.HybridAuthClient.apiCall === 'function') {
                        log('✅ apiCall method available', 'success');
                        try {
                            const data = await window.HybridAuthClient.apiCall('/products');
                            log(`✅ HybridAuthClient.apiCall successful`, 'success');
                            log(`Response: ${JSON.stringify(Object.keys(data), null, 2)}`);
                        } catch (error) {
                            log(`❌ HybridAuthClient.apiCall failed: ${error.message}`, 'error');
                        }
                    } else {
                        log('❌ apiCall method not available', 'error');
                    }
                } else {
                    log('❌ HybridAuthClient not available', 'error');
                }

                // Test 3: Check for CORS issues
                log('\n🌐 Test 3: CORS Check');
                try {
                    const response = await fetch(window.APP_CONFIG.API_BASE_URL.replace('/api/v1', '') + '/health');
                    if (response.ok) {
                        log('✅ CORS working - health endpoint accessible', 'success');
                    } else {
                        log(`❌ Health endpoint returned: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`❌ CORS issue detected: ${error.message}`, 'error');
                }

                // Test 4: Test alternative endpoints
                log('\n🔍 Test 4: Alternative endpoints');
                const alternativeEndpoints = [
                    '/products',
                    '/api/products', 
                    '/api/v1/products'
                ];
                
                for (const endpoint of alternativeEndpoints) {
                    try {
                        const fullUrl = window.APP_CONFIG.API_BASE_URL.replace('/api/v1', '') + endpoint;
                        log(`Testing: ${fullUrl}`);
                        const response = await fetch(fullUrl);
                        log(`${endpoint}: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                    } catch (error) {
                        log(`${endpoint}: Failed - ${error.message}`, 'error');
                    }
                }

            } catch (error) {
                log(`❌ Debug script failed: ${error.message}`, 'error');
            }
        }

        // Wait for hybrid auth to load, then run debug
        setTimeout(() => {
            debugAPI();
        }, 2000);
    </script>
</body>
</html>
