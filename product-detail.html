<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - QuickLocal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 20px 30px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 28px;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.3s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .cart-icon {
            position: relative;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 50%;
        }

        .cart-icon:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }

        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid white;
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .product-detail-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 40px;
            min-height: 600px;
        }

        .product-gallery {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .main-image {
            width: 100%;
            max-width: 500px;
            height: 400px;
            object-fit: cover;
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }

        .main-image:hover {
            transform: scale(1.05);
        }

        .image-zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .image-zoom-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .zoomed-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
        }

        .close-zoom {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .close-zoom:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .thumbnail-gallery {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .thumbnail {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .thumbnail:hover,
        .thumbnail.active {
            border-color: #667eea;
            transform: scale(1.1);
            opacity: 1;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .product-info {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .product-info h1 {
            font-size: 2.5em;
            color: #333;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 10px;
        }

        .product-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rating-badge {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .rating-text {
            color: #666;
            font-size: 14px;
        }

        .availability {
            background: #e8f5e8;
            color: #4caf50;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .price-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            padding: 20px 0;
        }

        .current-price {
            font-size: 2.8em;
            font-weight: bold;
            color: #4caf50;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .original-price {
            font-size: 1.8em;
            color: #999;
            text-decoration: line-through;
        }

        .discount {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1em;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .savings {
            color: #4caf50;
            font-weight: 600;
            font-size: 1.1em;
        }

        .quantity-section {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .qty-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .qty-btn:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
            transform: scale(1.1);
        }

        .qty-display {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
            color: #333;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .add-to-cart {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.3);
            flex: 1;
        }

        .add-to-cart:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 152, 0, 0.4);
        }

        .buy-now {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            box-shadow: 0 8px 25px rgba(238, 90, 82, 0.3);
            flex: 1;
        }

        .buy-now:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(238, 90, 82, 0.4);
        }

        .wishlist-btn {
            background: rgba(255, 255, 255, 0.9);
            color: #666;
            border: 2px solid #e0e0e0;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .wishlist-btn:hover,
        .wishlist-btn.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
            transform: scale(1.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .product-features {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .features-list {
            list-style: none;
            padding: 0;
        }

        .features-list li {
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #555;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .features-list li:hover {
            padding-left: 10px;
            background: rgba(102, 126, 234, 0.05);
        }

        .features-list li:last-child {
            border-bottom: none;
        }

        .feature-icon {
            color: #4caf50;
            font-weight: bold;
            font-size: 16px;
        }

        .delivery-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .delivery-info h3 {
            margin-bottom: 18px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delivery-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            color: #555;
            padding: 8px 0;
            transition: all 0.3s ease;
        }

        .delivery-item:hover {
            padding-left: 10px;
            background: rgba(102, 126, 234, 0.05);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 18px 28px;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .share-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .share-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e0e0e0;
            color: #666;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .breadcrumb {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.1);
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .breadcrumb a:hover {
            color: #5a67d8;
        }

        @media (max-width: 968px) {
            .product-detail-container {
                grid-template-columns: 1fr;
                gap: 30px;
                padding: 25px;
            }

            .product-info h1 {
                font-size: 2em;
            }

            .current-price {
                font-size: 2.2em;
            }

            .action-buttons {
                flex-direction: column;
            }

            .nav-actions {
                gap: 10px;
            }

            .back-btn {
                padding: 10px 18px;
                font-size: 14px;
            }

            .main-image {
                height: 300px;
            }

            .container {
                margin: 10px;
            }

            body {
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .logo {
                font-size: 24px;
            }

            .product-detail-container {
                padding: 20px;
                gap: 20px;
            }

            .price-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .current-price {
                font-size: 1.8em;
            }

            .btn {
                padding: 14px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo" onclick="goHome()">
                <i class="fas fa-shopping-bag"></i>
                QuickLocal
            </div>
            <div class="nav-actions">
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Shop</span>
                </button>
                <div class="cart-icon" onclick="viewCart()">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="cartCount">0</span>
                </div>
            </div>
        </div>

        <div class="breadcrumb">
            <a href="index.html">Home</a>
            <i class="fas fa-chevron-right"></i>
            <a href="marketplace.html">Marketplace</a>
            <i class="fas fa-chevron-right"></i>
            <span id="breadcrumbProduct">Product Details</span>
        </div>
        
        <div class="product-detail-container" id="productDetail">
            <!-- Product details will be populated here -->
        </div>
    </div>

    <div class="image-zoom-overlay" id="imageZoomOverlay">
        <button class="close-zoom" onclick="closeImageZoom()">
            <i class="fas fa-times"></i>
        </button>
        <img id="zoomedImage" class="zoomed-image" src="" alt="Zoomed product image">
    </div>

    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Item added to cart!</span>
    </div>

    <script>
        let currentProduct = null;
        let currentQuantity = 1;
        let isWishlisted = false;

        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // Load product from URL parameters or localStorage
        function loadProductDetails() {
            showLoading();
            
            // Try to get product from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            // Try to get product from localStorage (set by marketplace)
            const storedProduct = localStorage.getItem('current_product');
            
            if (storedProduct) {
                currentProduct = JSON.parse(storedProduct);
            } else if (productId) {
                // If we have a product ID but no stored product, redirect to marketplace
                showNotification('Product not found. Redirecting to marketplace...', 'error');
                setTimeout(() => {
                    window.location.href = 'marketplace.html';
                }, 2000);
                return;
            } else {
                // No product data available
                document.getElementById('productDetail').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-box-open" style="font-size: 4em; color: #ccc; margin-bottom: 20px;"></i>
                        <h2 style="color: #666; margin-bottom: 15px;">No Product Selected</h2>
                        <p style="color: #999; margin-bottom: 30px;">Please select a product from our marketplace to view details.</p>
                        <button class="btn add-to-cart" onclick="goToMarketplace()">
                            <i class="fas fa-store"></i> Browse Products
                        </button>
                    </div>
                `;
                hideLoading();
                return;
            }
            
            if (!currentProduct) {
                showNotification('Product not found. Redirecting...', 'error');
                setTimeout(() => goToMarketplace(), 2000);
                return;
            }

            // Update breadcrumb
            document.getElementById('breadcrumbProduct').textContent = currentProduct.name || 'Product Details';

            setTimeout(() => {
                renderProductDetails();
                updateCartCount();
                checkWishlistStatus();
                hideLoading();
            }, 500);
        }

        function renderProductDetails() {
            const discount = currentProduct.originalPrice && currentProduct.originalPrice > (currentProduct.finalPrice || currentProduct.price) 
                ? Math.round(((currentProduct.originalPrice - (currentProduct.finalPrice || currentProduct.price)) / currentProduct.originalPrice) * 100)
                : 0;
            
            const savings = currentProduct.originalPrice && currentProduct.originalPrice > (currentProduct.finalPrice || currentProduct.price)
                ? currentProduct.originalPrice - (currentProduct.finalPrice || currentProduct.price)
                : 0;
            
            const images = currentProduct.images || [{ url: 'https://via.placeholder.com/500x400/667eea/white?text=No+Image+Available' }];
            const mainImage = images[0]?.url || 'https://via.placeholder.com/500x400/667eea/white?text=No+Image+Available';
            
            document.getElementById('productDetail').innerHTML = `
                <div class="product-gallery">
                    <div class="image-container">
                        <img src="${mainImage}" class="main-image" id="mainImage" alt="${currentProduct.name}" onclick="openImageZoom('${mainImage}')" />
                    </div>
                    
                    ${images.length > 1 ? `
                        <div class="thumbnail-gallery">
                            ${images.map((img, index) => `
                                <img src="${img.url}" class="thumbnail ${index === 0 ? 'active' : ''}" 
                                     onclick="changeMainImage('${img.url}', this)" alt="Product image ${index + 1}" />
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="product-info">
                    <h1>${currentProduct.name}</h1>
                    
                    <div class="product-meta">
                        <div class="product-rating">
                            <div class="rating-badge">
                                <i class="fas fa-star"></i>
                                4.3
                            </div>
                            <span class="rating-text">1,247 ratings & 156 reviews</span>
                        </div>
                        <div class="availability">
                            <i class="fas fa-check-circle"></i> In Stock
                        </div>
                    </div>
                    
                    <div class="price-section">
                        <span class="current-price">₹${(currentProduct.finalPrice || currentProduct.price).toLocaleString()}</span>
                        ${currentProduct.originalPrice && currentProduct.originalPrice > (currentProduct.finalPrice || currentProduct.price) ? `
                            <span class="original-price">₹${currentProduct.originalPrice.toLocaleString()}</span>
                            <span class="discount">${discount}% OFF</span>
                            <span class="savings">You save ₹${savings.toLocaleString()}!</span>
                        ` : ''}
                    </div>
                    
                    <div class="quantity-section">
                        <span style="font-weight: 600; color: #333;">Quantity:</span>
                        <div class="quantity-controls">
                            <button class="qty-btn" onclick="changeQuantity(-1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span class="qty-display" id="quantity">${currentQuantity}</span>
                            <button class="qty-btn" onclick="changeQuantity(1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn add-to-cart" onclick="addToCart()">
                            <i class="fas fa-shopping-cart"></i> 
                            ADD TO CART
                        </button>
                        <button class="btn buy-now" onclick="buyNow()">
                            <i class="fas fa-bolt"></i> 
                            BUY NOW
                        </button>
                        <button class="wishlist-btn" id="wishlistBtn" onclick="toggleWishlist()">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>

                    <div class="share-section">
                        <span style="font-weight: 600; color: #333; margin-right: 10px;">Share:</span>
                        <button class="share-btn" onclick="shareProduct('whatsapp')" title="Share on WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="share-btn" onclick="shareProduct('facebook')" title="Share on Facebook">
                            <i class="fab fa-facebook"></i>
                        </button>
                        <button class="share-btn" onclick="shareProduct('twitter')" title="Share on Twitter">
                            <i class="fab fa-twitter"></i>
                        </button>
                        <button class="share-btn" onclick="shareProduct('copy')" title="Copy Link">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                    
                    <div class="product-features">
                        <h3 style="margin-bottom: 15px; color: #333;">
                            <i class="fas fa-star" style="color: #ffd700;"></i> Key Features
                        </h3>
                        <ul class="features-list">
                            ${currentProduct.description ? `<li><span class="feature-icon">✓</span> ${currentProduct.description}</li>` : ''}
                            <li><span class="feature-icon">✓</span> Premium quality guaranteed</li>
                            <li><span class="feature-icon">✓</span> Fast delivery within 20 minutes</li>
                            <li><span class="feature-icon">✓</span> Easy returns and exchanges</li>
                            <li><span class="feature-icon">✓</span> Secure payment options</li>
                            <li><span class="feature-icon">✓</span> 24/7 customer support</li>
                        </ul>
                    </div>
                    
                    <div class="delivery-info">
                        <h3>
                            <i class="fas fa-shipping-fast" style="color: #4caf50;"></i> 
                            Delivery & Returns
                        </h3>
                        <div class="delivery-item">
                            <i class="fas fa-truck" style="color: #4caf50;"></i>
                            <span>Free express delivery within 20 minutes</span>
                        </div>
                        <div class="delivery-item">
                            <i class="fas fa-undo" style="color: #ff9800;"></i>
                            <span>10 days hassle-free return policy</span>
                        </div>
                        <div class="delivery-item">
                            <i class="fas fa-shield-alt" style="color: #2196f3;"></i>
                            <span>Secure payment & data protection</span>
                        </div>
                        <div class="delivery-item">
                            <i class="fas fa-headset" style="color: #9c27b0;"></i>
                            <span>24/7 customer support available</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeMainImage(newSrc, thumbnailElement) {
            const mainImage = document.getElementById('mainImage');
            mainImage.style.opacity = '0';
            
            setTimeout(() => {
                mainImage.src = newSrc;
                mainImage.style.opacity = '1';
                mainImage.onclick = () => openImageZoom(newSrc);
            }, 200);
            
            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
            thumbnailElement.classList.add('active');
        }

        function openImageZoom(imageSrc) {
            const overlay = document.getElementById('imageZoomOverlay');
            const zoomedImage = document.getElementById('zoomedImage');
            
            zoomedImage.src = imageSrc;
            overlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeImageZoom() {
            const overlay = document.getElementById('imageZoomOverlay');
            overlay.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function changeQuantity(delta) {
            const newQuantity = currentQuantity + delta;
            if (newQuantity >= 1 && newQuantity <= 10) {
                currentQuantity = newQuantity;
                document.getElementById('quantity').textContent = currentQuantity;
            }
        }

        function toggleWishlist() {
            const wishlistBtn = document.getElementById('wishlistBtn');
            const icon = wishlistBtn.querySelector('i');
            
            isWishlisted = !isWishlisted;
            
            if (isWishlisted) {
                icon.className = 'fas fa-heart';
                wishlistBtn.classList.add('active');
                showNotification('Added to wishlist!', 'success');
                // Save to localStorage
                let wishlist = JSON.parse(localStorage.getItem('quicklocal_wishlist')) || [];
                if (!wishlist.find(item => item.id === currentProduct.id)) {
                    wishlist.push({
                        id: currentProduct.id,
                        name: currentProduct.name,
                        price: currentProduct.finalPrice || currentProduct.price,
                        image: currentProduct.images?.[0]?.url
                    });
                    localStorage.setItem('quicklocal_wishlist', JSON.stringify(wishlist));
                }
            } else {
                icon.className = 'far fa-heart';
                wishlistBtn.classList.remove('active');
                showNotification('Removed from wishlist', 'error');
                // Remove from localStorage
                let wishlist = JSON.parse(localStorage.getItem('quicklocal_wishlist')) || [];
                wishlist = wishlist.filter(item => item.id !== currentProduct.id);
                localStorage.setItem('quicklocal_wishlist', JSON.stringify(wishlist));
            }
        }

        function checkWishlistStatus() {
            const wishlist = JSON.parse(localStorage.getItem('quicklocal_wishlist')) || [];
            const wishlistBtn = document.getElementById('wishlistBtn');
            const icon = wishlistBtn?.querySelector('i');
            
            if (wishlist.find(item => item.id === currentProduct.id)) {
                isWishlisted = true;
                if (icon) icon.className = 'fas fa-heart';
                if (wishlistBtn) wishlistBtn.classList.add('active');
            }
        }

        function shareProduct(platform) {
            const productUrl = window.location.href;
            const productName = currentProduct.name;
            const productPrice = `₹${(currentProduct.finalPrice || currentProduct.price).toLocaleString()}`;
            const shareText = `Check out this amazing product: ${productName} for just ${productPrice}!`;
            
            let shareUrl = '';
            
            switch(platform) {
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${encodeURIComponent(shareText + ' ' + productUrl)}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}`;
                    break;
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(productUrl)}`;
                    break;
                case 'copy':
                    navigator.clipboard.writeText(productUrl).then(() => {
                        showNotification('Link copied to clipboard!', 'success');
                    }).catch(() => {
                        showNotification('Failed to copy link', 'error');
                    });
                    return;
            }
            
            if (shareUrl) {
                window.open(shareUrl, '_blank', 'width=600,height=400');
            }
        }
        
        function addToCart() {
            if (!currentProduct) {
                showNotification('Product not found!', 'error');
                return;
            }

            showLoading();

            // Simulate API call delay
            setTimeout(() => {
                // Get existing cart from localStorage
                let cart = JSON.parse(localStorage.getItem('quicklocal_cart')) || [];
                
                const existingItem = cart.find(item => item.id === currentProduct.id);
                
                if (existingItem) {
                    existingItem.quantity += currentQuantity;
                    showNotification(`Updated quantity in cart! (${existingItem.quantity} items)`, 'success');
                } else {
                    cart.push({
                        id: currentProduct.id,
                        title: currentProduct.name,
                        price: currentProduct.finalPrice || currentProduct.price,
                        quantity: currentQuantity,
                        image: currentProduct.images?.[0]?.url || 'https://via.placeholder.com/100x100',
                        originalPrice: currentProduct.originalPrice
                    });
                    showNotification(`${currentProduct.name} added to cart!`, 'success');
                }
                
                // Save cart to localStorage
                localStorage.setItem('quicklocal_cart', JSON.stringify(cart));
                
                updateCartCount();
                
                // Reset quantity after adding
                currentQuantity = 1;
                if (document.getElementById('quantity')) {
                    document.getElementById('quantity').textContent = currentQuantity;
                }

                hideLoading();
            }, 800);
        }
        
        function buyNow() {
            if (!currentProduct) {
                showNotification('Product not found!', 'error');
                return;
            }

            showLoading();
            
            // Add to cart first
            let cart = JSON.parse(localStorage.getItem('quicklocal_cart')) || [];
            const existingItem = cart.find(item => item.id === currentProduct.id);
            
            if (existingItem) {
                existingItem.quantity += currentQuantity;
            } else {
                cart.push({
                    id: currentProduct.id,
                    title: currentProduct.name,
                    price: currentProduct.finalPrice || currentProduct.price,
                    quantity: currentQuantity,
                    image: currentProduct.images?.[0]?.url || 'https://via.placeholder.com/100x100',
                    originalPrice: currentProduct.originalPrice
                });
            }
            
            localStorage.setItem('quicklocal_cart', JSON.stringify(cart));
            
            setTimeout(() => {
                hideLoading();
                showNotification('Redirecting to checkout...', 'success');
                setTimeout(() => {
                    window.location.href = 'cart.html';
                }, 1000);
            }, 800);
        }
        
        function viewCart() {
            window.location.href = 'cart.html';
        }

        function goBack() {
            if (document.referrer && (document.referrer.includes('marketplace.html') || document.referrer.includes('index.html'))) {
                window.history.back();
            } else {
                window.location.href = 'marketplace.html';
            }
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        function goToMarketplace() {
            window.location.href = 'marketplace.html';
        }
        
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('quicklocal_cart')) || [];
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCountElement = document.getElementById('cartCount');
            
            if (cartCountElement) {
                cartCountElement.textContent = totalItems;
                
                if (totalItems > 0) {
                    cartCountElement.style.display = 'flex';
                    cartCountElement.classList.add('pulse');
                    setTimeout(() => cartCountElement.classList.remove('pulse'), 600);
                } else {
                    cartCountElement.style.display = 'none';
                }
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            
            // Remove existing classes
            notification.classList.remove('error', 'success');
            
            // Add appropriate class and content
            if (type === 'error') {
                notification.classList.add('error');
                notification.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${message}</span>`;
            } else {
                notification.classList.add('success');
                notification.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Close image zoom when clicking outside
        document.addEventListener('click', function(e) {
            const overlay = document.getElementById('imageZoomOverlay');
            if (e.target === overlay) {
                closeImageZoom();
            }
        });

        // Close image zoom with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageZoom();
            }
        });

        // Load product on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProductDetails();
        });

        // Handle browser back/forward navigation
        window.addEventListener('popstate', function(e) {
            loadProductDetails();
        });
    </script>

<!-- Product Reviews Section -->
<section class="reviews-section" id="reviewsSection">
  <div class="container">
    <div class="reviews-header">
      <h3>Customer Reviews</h3>
      <div class="reviews-summary">
        <div class="overall-rating">
          <span class="rating-value" id="averageRating">0.0</span>
          <div class="stars-container" id="averageRatingStars"></div>
          <span class="total-reviews" id="totalReviews">0 reviews</span>
        </div>
        <div class="rating-breakdown" id="ratingBreakdown">
          <!-- Rating breakdown bars will be inserted here -->
        </div>
      </div>
      <button class="write-review-btn" id="writeReviewBtn">
        <i class="fas fa-pen"></i> Write a Review
      </button>
    </div>
    
    <div class="reviews-filter">
      <select id="reviewsSort" class="reviews-sort">
        <option value="recent">Most Recent</option>
        <option value="helpful">Most Helpful</option>
        <option value="highest">Highest Rated</option>
        <option value="lowest">Lowest Rated</option>
      </select>
      <div class="filter-options">
        <label><input type="checkbox" id="filterVerified"> Verified Purchases</label>
        <label><input type="checkbox" id="filterWithPhotos"> With Photos</label>
      </div>
    </div>
    
    <div class="reviews-list" id="reviewsList">
      <!-- Reviews will be loaded here -->
      <div class="reviews-loading">
        <div class="spinner"></div>
        <p>Loading reviews...</p>
      </div>
    </div>
    
    <div class="reviews-pagination" id="reviewsPagination">
      <!-- Pagination controls will be inserted here -->
    </div>
  </div>
</section>

<!-- Review Form Modal -->
<div class="modal-overlay" id="reviewFormModal">
  <div class="review-form-container">
    <div class="modal-header">
      <h3>Write a Review</h3>
      <button class="close-modal" id="closeReviewForm">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="productReviewForm">
      <div class="form-group">
        <label>Overall Rating</label>
        <div class="rating-input">
          <i class="far fa-star" data-rating="1"></i>
          <i class="far fa-star" data-rating="2"></i>
          <i class="far fa-star" data-rating="3"></i>
          <i class="far fa-star" data-rating="4"></i>
          <i class="far fa-star" data-rating="5"></i>
        </div>
        <input type="hidden" name="rating" id="ratingInput" required>
      </div>
      <div class="form-group">
        <label for="reviewTitle">Review Title</label>
        <input type="text" id="reviewTitle" name="title" placeholder="Summarize your experience" required>
      </div>
      <div class="form-group">
        <label for="reviewContent">Your Review</label>
        <textarea id="reviewContent" name="content" rows="5" placeholder="What did you like or dislike? What did you use this product for?" required></textarea>
      </div>
      <div class="form-group">
        <label>Add Photos (optional)</label>
        <div class="photo-upload">
          <input type="file" id="reviewPhotos" name="photos" multiple accept="image/*">
          <div class="upload-preview" id="photoPreview"></div>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="submit-review">Submit Review</button>
      </div>
    </form>
  </div>
</div>

<section class="related-products" id="relatedProductsSection">
  <div class="container">
    <h3>Related Products</h3>
    <div class="products-grid" id="relatedProductsGrid"></div>
  </div>
</section>

<script>
// Reviews System
document.addEventListener('DOMContentLoaded', function() {
  // Initialize reviews
  loadProductReviews();
  
  // Review form event listeners
  const writeReviewBtn = document.getElementById('writeReviewBtn');
  const closeReviewForm = document.getElementById('closeReviewForm');
  const reviewFormModal = document.getElementById('reviewFormModal');
  const ratingStars = document.querySelectorAll('.rating-input i');
  const ratingInput = document.getElementById('ratingInput');
  const reviewForm = document.getElementById('productReviewForm');
  const photoInput = document.getElementById('reviewPhotos');
  const photoPreview = document.getElementById('photoPreview');
  const reviewsSort = document.getElementById('reviewsSort');
  
  // Open review form
  writeReviewBtn.addEventListener('click', function() {
    reviewFormModal.classList.add('show');
  });
  
  // Close review form
  closeReviewForm.addEventListener('click', function() {
    reviewFormModal.classList.remove('show');
  });
  
  // Star rating selection
  ratingStars.forEach(star => {
    star.addEventListener('mouseover', function() {
      const rating = this.getAttribute('data-rating');
      highlightStars(rating);
    });
    
    star.addEventListener('mouseout', function() {
      const selectedRating = ratingInput.value;
      if (selectedRating) {
        highlightStars(selectedRating);
      } else {
        resetStars();
      }
    });
    
    star.addEventListener('click', function() {
      const rating = this.getAttribute('data-rating');
      ratingInput.value = rating;
      highlightStars(rating);
    });
  });
  
  // Helper functions for star rating
  function highlightStars(rating) {
    resetStars();
    for (let i = 0; i < rating; i++) {
      ratingStars[i].classList.remove('far');
      ratingStars[i].classList.add('fas');
    }
  }
  
  function resetStars() {
    ratingStars.forEach(star => {
      star.classList.remove('fas');
      star.classList.add('far');
    });
  }
  
  // Photo upload preview
  photoInput.addEventListener('change', function() {
    photoPreview.innerHTML = '';
    if (this.files) {
      for (let i = 0; i < this.files.length; i++) {
        if (i >= 5) break; // Limit to 5 photos
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'preview-image';
          photoPreview.appendChild(img);
        }
        reader.readAsDataURL(this.files[i]);
      }
    }
  });
  
  // Submit review
  reviewForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const productId = getProductIdFromUrl();
    if (!productId) {
      showNotification('Product ID not found', 'error');
      return;
    }
    
    // Check if user is logged in
    const token = localStorage.getItem('auth_token');
    if (!token) {
      showNotification('Please login to submit a review', 'error');
      return;
    }
    
    // Validate form
    if (!ratingInput.value) {
      showNotification('Please select a rating', 'error');
      return;
    }
    
    // Show loading
    showLoading();
    
    try {
      // Prepare form data
      const formData = new FormData();
      formData.append('productId', productId);
      formData.append('rating', ratingInput.value);
      formData.append('title', document.getElementById('reviewTitle').value);
      formData.append('content', document.getElementById('reviewContent').value);
      
      // Add photos if any
      const photoFiles = document.getElementById('reviewPhotos').files;
      for (let i = 0; i < photoFiles.length; i++) {
        if (i >= 5) break; // Limit to 5 photos
        formData.append('photos', photoFiles[i]);
      }
      
      // Submit review to API
      const response = await fetch('/api/reviews', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showNotification('Review submitted successfully');
        reviewFormModal.classList.remove('show');
        reviewForm.reset();
        resetStars();
        photoPreview.innerHTML = '';
        
        // Reload reviews
        loadProductReviews();
      } else {
        throw new Error(data.message || 'Failed to submit review');
      }
    } catch (error) {
      showNotification(error.message, 'error');
    } finally {
      hideLoading();
    }
  });
  
  // Sort reviews
  reviewsSort.addEventListener('change', function() {
    loadProductReviews();
  });
  
  // Filter reviews
  document.getElementById('filterVerified').addEventListener('change', loadProductReviews);
  document.getElementById('filterWithPhotos').addEventListener('change', loadProductReviews);
});

// Load product reviews
async function loadProductReviews() {
  const productId = getProductIdFromUrl();
  if (!productId) return;
  
  const reviewsList = document.getElementById('reviewsList');
  reviewsList.innerHTML = '<div class="reviews-loading"><div class="spinner"></div><p>Loading reviews...</p></div>';
  
  try {
    // Get sort and filter options
    const sort = document.getElementById('reviewsSort').value;
    const verifiedOnly = document.getElementById('filterVerified').checked;
    const withPhotosOnly = document.getElementById('filterWithPhotos').checked;
    
    // Fetch reviews from API
    const response = await fetch(`/api/reviews/${productId}?sort=${sort}&verified=${verifiedOnly}&photos=${withPhotosOnly}`);
    const data = await response.json();
    
    if (response.ok) {
      // Update average rating and total reviews
      document.getElementById('averageRating').textContent = data.averageRating.toFixed(1);
      document.getElementById('totalReviews').textContent = `${data.totalReviews} reviews`;
      
      // Render stars for average rating
      const starsContainer = document.getElementById('averageRatingStars');
      starsContainer.innerHTML = renderStars(data.averageRating);
      
      // Render rating breakdown
      const breakdownContainer = document.getElementById('ratingBreakdown');
      breakdownContainer.innerHTML = '';
      
      for (let i = 5; i >= 1; i--) {
        const percentage = data.totalReviews > 0 ? (data.ratingCounts[i] / data.totalReviews) * 100 : 0;
        
        const breakdownItem = document.createElement('div');
        breakdownItem.className = 'breakdown-item';
        breakdownItem.innerHTML = `
          <span class="stars">${i} <i class="fas fa-star"></i></span>
          <div class="bar-container">
            <div class="bar" style="width: ${percentage}%"></div>
          </div>
          <span class="count">${data.ratingCounts[i]}</span>
        `;
        
        breakdownContainer.appendChild(breakdownItem);
      }
      
      // Render reviews
      if (data.reviews.length > 0) {
        reviewsList.innerHTML = '';
        
        data.reviews.forEach(review => {
          const reviewElement = document.createElement('div');
          reviewElement.className = 'review-item';
          
          let photosHtml = '';
          if (review.photos && review.photos.length > 0) {
            photosHtml = '<div class="review-photos">';
            review.photos.forEach(photo => {
              photosHtml += `<img src="${photo}" alt="Review photo" class="review-photo" onclick="showImageZoom('${photo}')">`;
            });
            photosHtml += '</div>';
          }
          
          reviewElement.innerHTML = `
            <div class="review-header">
              <div class="reviewer-info">
                <span class="reviewer-name">${review.userName}</span>
                ${review.verifiedPurchase ? '<span class="verified-badge"><i class="fas fa-check-circle"></i> Verified Purchase</span>' : ''}
              </div>
              <div class="review-date">${new Date(review.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="review-rating">${renderStars(review.rating)}</div>
            <h4 class="review-title">${review.title}</h4>
            <div class="review-content">${review.content}</div>
            ${photosHtml}
            <div class="review-actions">
              <button class="helpful-btn" data-review-id="${review._id}">
                <i class="far fa-thumbs-up"></i> Helpful (${review.helpfulCount || 0})
              </button>
              <button class="report-btn" data-review-id="${review._id}">
                <i class="far fa-flag"></i> Report
              </button>
            </div>
          `;
          
          reviewsList.appendChild(reviewElement);
        });
        
        // Add event listeners for helpful buttons
        document.querySelectorAll('.helpful-btn').forEach(button => {
          button.addEventListener('click', markReviewAsHelpful);
        });
        
        // Add event listeners for report buttons
        document.querySelectorAll('.report-btn').forEach(button => {
          button.addEventListener('click', reportReview);
        });
        
        // Render pagination
        renderPagination(data.currentPage, data.totalPages);
      } else {
        reviewsList.innerHTML = '<div class="no-reviews">No reviews yet. Be the first to review this product!</div>';
      }
    } else {
      throw new Error(data.message || 'Failed to load reviews');
    }
  } catch (error) {
    reviewsList.innerHTML = `<div class="reviews-error"><i class="fas fa-exclamation-circle"></i> ${error.message || 'Failed to load reviews'}</div>`;
  }
}

// Mark review as helpful
async function markReviewAsHelpful(e) {
  const reviewId = this.getAttribute('data-review-id');
  const token = localStorage.getItem('auth_token');
  
  if (!token) {
    showNotification('Please login to mark reviews as helpful', 'error');
    return;
  }
  
  try {
    const response = await fetch(`/api/reviews/${reviewId}/helpful`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // Update helpful count
      this.innerHTML = `<i class="fas fa-thumbs-up"></i> Helpful (${data.helpfulCount})`;
      this.disabled = true;
      this.classList.add('marked');
    } else {
      throw new Error(data.message || 'Failed to mark review as helpful');
    }
  } catch (error) {
    showNotification(error.message, 'error');
  }
}

// Report review
async function reportReview(e) {
  const reviewId = this.getAttribute('data-review-id');
  const token = localStorage.getItem('auth_token');
  
  if (!token) {
    showNotification('Please login to report reviews', 'error');
    return;
  }
  
  const reason = prompt('Please provide a reason for reporting this review:');
  if (!reason) return;
  
  try {
    const response = await fetch(`/api/reviews/${reviewId}/report`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ reason })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      showNotification('Review reported successfully');
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-flag"></i> Reported';
      this.classList.add('reported');
    } else {
      throw new Error(data.message || 'Failed to report review');
    }
  } catch (error) {
    showNotification(error.message, 'error');
  }
}

// Render pagination
function renderPagination(currentPage, totalPages) {
  const paginationContainer = document.getElementById('reviewsPagination');
  paginationContainer.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  const pagination = document.createElement('div');
  pagination.className = 'pagination';
  
  // Previous button
  const prevButton = document.createElement('button');
  prevButton.className = 'pagination-btn prev';
  prevButton.innerHTML = '<i class="fas fa-chevron-left"></i> Previous';
  prevButton.disabled = currentPage === 1;
  prevButton.addEventListener('click', () => {
    if (currentPage > 1) {
      goToReviewsPage(currentPage - 1);
    }
  });
  
  // Next button
  const nextButton = document.createElement('button');
  nextButton.className = 'pagination-btn next';
  nextButton.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
  nextButton.disabled = currentPage === totalPages;
  nextButton.addEventListener('click', () => {
    if (currentPage < totalPages) {
      goToReviewsPage(currentPage + 1);
    }
  });
  
  // Page numbers
  const pageNumbers = document.createElement('div');
  pageNumbers.className = 'page-numbers';
  
  // Determine which page numbers to show
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, startPage + 4);
  
  if (endPage - startPage < 4) {
    startPage = Math.max(1, endPage - 4);
  }
  
  // First page
  if (startPage > 1) {
    const firstPage = document.createElement('button');
    firstPage.className = 'page-number';
    firstPage.textContent = '1';
    firstPage.addEventListener('click', () => goToReviewsPage(1));
    pageNumbers.appendChild(firstPage);
    
    if (startPage > 2) {
      const ellipsis = document.createElement('span');
      ellipsis.className = 'ellipsis';
      ellipsis.textContent = '...';
      pageNumbers.appendChild(ellipsis);
    }
  }
  
  // Page numbers
  for (let i = startPage; i <= endPage; i++) {
    const pageNumber = document.createElement('button');
    pageNumber.className = 'page-number';
    if (i === currentPage) {
      pageNumber.classList.add('active');
    }
    pageNumber.textContent = i;
    pageNumber.addEventListener('click', () => goToReviewsPage(i));
    pageNumbers.appendChild(pageNumber);
  }
  
  // Last page
  if (endPage < totalPages) {
    if (endPage < totalPages - 1) {
      const ellipsis = document.createElement('span');
      ellipsis.className = 'ellipsis';
      ellipsis.textContent = '...';
      pageNumbers.appendChild(ellipsis);
    }
    
    const lastPage = document.createElement('button');
    lastPage.className = 'page-number';
    lastPage.textContent = totalPages;
    lastPage.addEventListener('click', () => goToReviewsPage(totalPages));
    pageNumbers.appendChild(lastPage);
  }
  
  pagination.appendChild(prevButton);
  pagination.appendChild(pageNumbers);
  pagination.appendChild(nextButton);
  
  paginationContainer.appendChild(pagination);
}

// Go to reviews page
function goToReviewsPage(page) {
  // Update URL with page parameter
  const url = new URL(window.location.href);
  url.searchParams.set('reviewPage', page);
  window.history.replaceState({}, '', url);
  
  // Load reviews for the selected page
  loadProductReviews();
  
  // Scroll to reviews section
  document.getElementById('reviewsSection').scrollIntoView({ behavior: 'smooth' });
}

// Helper function to render stars
function renderStars(rating) {
  const fullStars = Math.floor(rating);
  const halfStar = rating % 1 >= 0.5;
  const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
  
  let starsHtml = '';
  
  // Full stars
  for (let i = 0; i < fullStars; i++) {
    starsHtml += '<i class="fas fa-star"></i>';
  }
  
  // Half star
  if (halfStar) {
    starsHtml += '<i class="fas fa-star-half-alt"></i>';
  }
  
  // Empty stars
  for (let i = 0; i < emptyStars; i++) {
    starsHtml += '<i class="far fa-star"></i>';
  }
  
  return starsHtml;
}

// Related Products
document.addEventListener('DOMContentLoaded', async () => {
  const prod = JSON.parse(localStorage.getItem('current_product') || '{}');
  if (!prod || !prod.id) return;
  try {
    const res = await window.apiClient.get('/en.../products/related/' + prod.id);
    const related = res.related || [];
    const container = document.getElementById('relatedProductsGrid');
    if (container) container.innerHTML = related.map(p => `
      <div class="product-card" onclick="viewProduct('${p._id||p.id}')">
        <img loading="lazy" src="${'${p.image}'}" alt="${'${p.name}'}">
        <h4>${'${p.name}'}</h4>
        <p>₹${'${p.price}'}</p>
      </div>
    `).join('');
  } catch (err) {
    console.warn('Related products failed', err);
  }
});
</script>
</body>
</html>