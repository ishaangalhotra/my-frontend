<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Orders - QuickLocal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    :root {
      --bg: #f5f7fb;
      --bg-card: #ffffff;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.12);
      --danger: #dc2626;
      --danger-soft: rgba(220, 38, 38, 0.08);
      --success: #16a34a;
      --success-soft: rgba(22, 163, 74, 0.08);
      --border: #e5e7eb;
      --text-main: #111827;
      --text-soft: #6b7280;
      --sidebar-bg: #0f172a;
      --sidebar-active: rgba(37, 99, 235, 0.15);
      --badge-bg: #e5edff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      min-height: 100vh;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    /* Layout */
    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      width: 100%;
      min-height: 100vh;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: sticky;
        top: 0;
        z-index: 30;
      }
    }

    /* Sidebar */
    .sidebar {
      background: var(--sidebar-bg);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      padding: 18px 16px;
      gap: 18px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .sidebar-logo {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      background: linear-gradient(135deg, #2563eb, #38bdf8);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 800;
      font-size: 1rem;
    }

    .sidebar-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .sidebar-title span:first-child {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .sidebar-title span:last-child {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .sidebar-section-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #6b7280;
      margin: 10px 2px 4px;
    }

    .nav-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
    }

    .nav-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 10px;
      border-radius: 10px;
      font-size: 0.86rem;
      color: #d1d5db;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, transform 0.05s;
    }

    .nav-link i {
      width: 16px;
      text-align: center;
      font-size: 0.9rem;
    }

    .nav-link span {
      flex: 1;
    }

    .nav-link small {
      font-size: 0.7rem;
      background: rgba(15, 23, 42, 0.6);
      padding: 1px 6px;
      border-radius: 999px;
      color: #9ca3af;
    }

    .nav-link.active {
      background: var(--sidebar-active);
      color: #ffffff;
    }

    .nav-link:hover {
      background: rgba(148, 163, 184, 0.12);
      transform: translateY(-1px);
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 8px;
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
      font-size: 0.7rem;
      color: #6b7280;
    }

    /* Main */
    .main {
      padding: 18px 18px 28px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    header.main-header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .breadcrumb {
      font-size: 0.7rem;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .breadcrumb i {
      font-size: 0.55rem;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .page-title {
      font-size: 1.2rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .page-title .pill {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .page-subtitle {
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .toolbar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e5edff;
      color: #1d4ed8;
    }

    .badge-pill i {
      font-size: 0.7rem;
    }

    .user-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.06);
    }

    .user-pill i {
      color: var(--primary);
    }

    .logout-btn {
      border: none;
      background: #fee2e2;
      color: #b91c1c;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    .logout-btn i {
      font-size: 0.8rem;
    }

    /* Filters */
    .filters-card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 140px;
      max-width: 220px;
      flex: 1;
    }

    .filter-group label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-soft);
    }

    .filter-input,
    .filter-select {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 5px 8px;
      font-size: 0.8rem;
      outline: none;
      background: #f9fafb;
    }

    .filter-input:focus,
    .filter-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
      background: #ffffff;
    }

    .filter-range {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .filter-chip {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.03);
      font-size: 0.7rem;
      color: var(--text-soft);
      align-items: center;
      gap: 5px;
    }

    /* Notification */
    .notification {
      margin-top: 8px;
      padding: 6px 9px;
      border-radius: 10px;
      font-size: 0.78rem;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .notification.show {
      display: inline-flex;
    }

    .notification.info {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .notification.error {
      background: #fef2f2;
      color: #b91c1c;
    }

    .notification.success {
      background: #ecfdf3;
      color: #15803d;
    }

    /* Card & Table */
    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 10px 12px 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-subtitle {
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .badge-count {
      font-size: 0.74rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: #f9fafb;
    }

    th,
    td {
      padding: 7px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-soft);
    }

    tbody tr:hover {
      background: #f9fafb;
    }

    .order-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .order-id {
      font-weight: 600;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .customer-info {
      font-size: 0.76rem;
      color: var(--text-soft);
      display: flex;
      flex-wrap: wrap;
      gap: 4px 8px;
    }

    .items-preview {
      font-size: 0.73rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.73rem;
    }

    .status-pill.pending {
      background: #fef9c3;
      color: #92400e;
    }

    .status-pill.confirmed {
      background: #e0f2fe;
      color: #0369a1;
    }

    .status-pill.preparing {
      background: #fef3c7;
      color: #a16207;
    }

    .status-pill.out_for_delivery {
      background: #e0f2fe;
      color: #0369a1;
    }

    .status-pill.delivered {
      background: var(--success-soft);
      color: var(--success);
    }

    .status-pill.cancelled {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .inline-select {
      margin-top: 4px;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 3px 6px;
      font-size: 0.75rem;
    }

    .inline-input {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 4px 6px;
      font-size: 0.75rem;
    }

    .inline-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.12);
    }

    .action-btn {
      border: none;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      background: var(--primary);
      color: #ffffff;
      margin-top: 4px;
    }

    .action-btn i {
      font-size: 0.8rem;
    }

    /* Pagination */
    .pagination {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.75rem;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pagination-info {
      color: var(--text-soft);
    }

    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .pagination button {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 3px 7px;
      background: #ffffff;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    @media (max-width: 720px) {
      .card {
        padding: 8px 8px 10px;
      }
      th,
      td {
        padding: 6px 6px;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div>
        <div class="sidebar-header">
          <div class="sidebar-logo">
            <i class="fas fa-bolt"></i>
          </div>
          <div class="sidebar-title">
            <span>QuickLocal Admin</span>
            <span>Control Center</span>
          </div>
        </div>

        <div class="sidebar-section-label">Overview</div>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="admin-dashboard.html" class="nav-link">
              <i class="fas fa-gauge-high"></i>
              <span>Dashboard</span>
            </a>
          </li>
        </ul>

        <div class="sidebar-section-label">Management</div>
        <ul class="nav-list">
          <li class="nav-item">
            <a href="admin-products.html" class="nav-link">
              <i class="fas fa-box"></i><span>Products</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="admin-orders.html" class="nav-link active">
              <i class="fas fa-receipt"></i><span>Orders</span>
              <small>Live</small>
            </a>
          </li>
          <li class="nav-item">
            <a href="admin-users.html" class="nav-link">
              <i class="fas fa-users"></i><span>Users</span>
            </a>
          </li>
        </ul>
      </div>

      <div class="sidebar-footer">
        <div>Signed in as <strong id="sidebarAdminName">Admin</strong></div>
        <div>v1.0 • Orders Console</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="main-header">
        <div class="breadcrumb">
          <span>Admin</span>
          <i class="fas fa-chevron-right"></i>
          <span>Orders</span>
        </div>

        <div class="header-row">
          <div class="title-block">
            <div class="page-title">
              Orders
              <span class="pill">
                <i class="fas fa-circle-dot"></i>
                Live overview
              </span>
            </div>
            <div class="page-subtitle">
              View all customer orders and update their status in one place.
            </div>
          </div>

          <div class="toolbar">
            <div class="badge-pill" id="apiStatus">
              <i class="fas fa-circle-notch fa-spin"></i>
              <span>Checking API...</span>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
              <div class="user-pill">
                <i class="fas fa-user-shield"></i>
                <span id="adminUserName">Admin</span>
              </div>
              <button id="logoutBtn" class="logout-btn">
                <i class="fas fa-arrow-right-from-bracket"></i>
                <span>Logout</span>
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Filters -->
      <section class="filters-card">
        <div class="filter-row">
          <div class="filter-group">
            <label for="searchInput">Search</label>
            <input
              id="searchInput"
              class="filter-input"
              type="text"
              placeholder="Order ID, customer name or email"
            />
          </div>

          <div class="filter-group" style="max-width:160px;">
            <label for="statusFilter">Status</label>
            <select id="statusFilter" class="filter-select">
              <option value="all">All statuses</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="preparing">Preparing</option>
              <option value="out_for_delivery">Out for delivery</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Date range</label>
            <div class="filter-range">
              <input id="startDate" class="filter-input" type="date" />
              <span style="font-size:0.75rem;">to</span>
              <input id="endDate" class="filter-input" type="date" />
            </div>
          </div>

          <div class="filter-group">
            <label>Amount (₹)</label>
            <div class="filter-range">
              <input id="minAmount" class="filter-input" type="number" placeholder="Min" />
              <input id="maxAmount" class="filter-input" type="number" placeholder="Max" />
            </div>
          </div>

          <div style="flex:1;"></div>

          <div class="filter-group" style="max-width:220px;">
            <label>&nbsp;</label>
            <span class="filter-chip" id="currentFilterSummary">
              Showing latest orders
            </span>
          </div>
        </div>

        <div id="notification" class="notification">
          <i class="fas fa-circle-info"></i>
          <span id="notificationText"></span>
        </div>
      </section>

      <!-- Orders table -->
      <section class="card" style="margin-top:10px;">
        <div class="card-header-row">
          <div>
            <div class="card-title">
              <i class="fas fa-receipt"></i>
              <span>Orders</span>
            </div>
            <div class="card-subtitle">
              Update order status and see basic order details.
            </div>
          </div>
          <span class="badge-count" id="ordersCountLabel">0 orders</span>
        </div>

        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Order / Customer</th>
                <th>Status</th>
                <th>Total</th>
                <th>Placed</th>
                <th style="min-width:180px;">Update</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody">
              <tr>
                <td colspan="5" style="text-align:center; padding:10px;">
                  Loading orders...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination">
          <div class="pagination-info" id="paginationInfo">
            Page 1 of 1 • 0 orders
          </div>
          <div class="pagination-controls">
            <button id="prevPageBtn" disabled>&laquo; Prev</button>
            <button id="nextPageBtn" disabled>Next &raquo;</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const BASE_API = 'https://ecommerce-backend-mlik.onrender.com/api/v1';
      const ADMIN_API = BASE_API + '/admin';
      const ORDERS_API = ADMIN_API + '/orders';

      const ORDER_STATUSES = [
        'pending',
        'confirmed',
        'preparing',
        'out_for_delivery',
        'delivered',
        'cancelled'
      ];

      const ordersTableBody = document.getElementById('ordersTableBody');
      const paginationInfo = document.getElementById('paginationInfo');
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');
      const ordersCountLabel = document.getElementById('ordersCountLabel');
      const apiStatus = document.getElementById('apiStatus');
      const notificationEl = document.getElementById('notification');
      const notificationText = document.getElementById('notificationText');
      const adminUserName = document.getElementById('adminUserName');
      const sidebarAdminName = document.getElementById('sidebarAdminName');
      const logoutBtn = document.getElementById('logoutBtn');

      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const minAmountInput = document.getElementById('minAmount');
      const maxAmountInput = document.getElementById('maxAmount');
      const currentFilterSummary = document.getElementById('currentFilterSummary');

      let currentPage = 1;
      let totalPages = 1;
      let totalOrders = 0;
      let debounceTimer = null;

      let currentSearch = '';
      let currentStatus = 'all';

      function getAdminToken() {
        return localStorage.getItem('adminToken');
      }

      function showNotification(message, type = 'info', timeout = 4000) {
        if (!notificationEl) return;
        notificationEl.classList.remove('info', 'error', 'success', 'show');
        notificationEl.classList.add(type, 'show');
        notificationText.textContent = message;

        if (timeout) {
          setTimeout(() => {
            notificationEl.classList.remove('show');
          }, timeout);
        }
      }

      function initAdminUser() {
        try {
          const stored = localStorage.getItem('adminUser');
          if (!stored) return;
          const admin = JSON.parse(stored);
          if (admin && admin.name) {
            adminUserName.textContent = admin.name;
            sidebarAdminName.textContent = admin.name;
          }
        } catch (e) {
          console.warn('Failed to parse admin user from localStorage');
        }
      }

      function formatCurrency(amount) {
        const n = Number(amount) || 0;
        return '₹' + n.toFixed(2);
      }

      function formatDate(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleString('en-IN', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      function buildFilterSummary() {
        const parts = [];

        if (currentStatus && currentStatus !== 'all') {
          parts.push('Status: ' + currentStatus.replace(/_/g, ' '));
        }
        if (searchInput.value.trim()) {
          parts.push('Search: "' + searchInput.value.trim() + '"');
        }
        if (startDateInput.value || endDateInput.value) {
          parts.push(
            'Date: ' +
              (startDateInput.value || 'any') +
              ' → ' +
              (endDateInput.value || 'any')
          );
        }
        if (minAmountInput.value || maxAmountInput.value) {
          parts.push(
            'Amount: ' +
              (minAmountInput.value || '0') +
              ' - ' +
              (maxAmountInput.value || '∞')
          );
        }

        if (!parts.length) {
          currentFilterSummary.textContent = 'Showing latest orders';
        } else {
          currentFilterSummary.textContent = parts.join(' • ');
        }
      }

      async function loadOrders(page = 1) {
        const token = getAdminToken();
        if (!token) {
          showNotification('No admin session found. Redirecting to login...', 'error');
          setTimeout(() => {
            window.location.href = 'admin-login.html';
          }, 800);
          return;
        }

        currentPage = page;
        apiStatus.innerHTML =
          '<i class="fas fa-circle-notch fa-spin"></i><span>Loading orders...</span>';

        const params = new URLSearchParams();
        params.set('page', page);
        params.set('limit', 20);

        const searchVal = searchInput.value.trim();
        if (searchVal) params.set('search', searchVal);

        if (currentStatus && currentStatus !== 'all') {
          params.set('status', currentStatus);
        }

        if (startDateInput.value) params.set('startDate', startDateInput.value);
        if (endDateInput.value) params.set('endDate', endDateInput.value);

        if (minAmountInput.value) params.set('minAmount', minAmountInput.value);
        if (maxAmountInput.value) params.set('maxAmount', maxAmountInput.value);

        buildFilterSummary();

        try {
          const res = await fetch(ORDERS_API + '?' + params.toString(), {
            headers: {
              Authorization: 'Bearer ' + token,
              Accept: 'application/json'
            }
          });

          const data = await res.json().catch(() => ({}));

          if (!res.ok || data.success === false) {
            throw new Error(data.message || 'Failed to load orders');
          }

          apiStatus.innerHTML =
            '<i class="fas fa-check-circle"></i><span>Admin orders API OK</span>';

          const orders = Array.isArray(data.data)
            ? data.data
            : Array.isArray(data.orders)
            ? data.orders
            : [];

          totalPages =
            (data.pagination &&
              (data.pagination.totalPages || data.pagination.pages)) ||
            1;
          totalOrders =
            (data.pagination &&
              (data.pagination.totalOrders || data.pagination.total)) ||
            orders.length;

          renderOrders(orders);
          updatePagination();
        } catch (err) {
          console.error('Admin orders load error:', err);
          apiStatus.innerHTML =
            '<i class="fas fa-triangle-exclamation"></i><span>Orders API error</span>';
          showNotification(err.message || 'Unable to load orders.', 'error');
          renderOrders([]);
          totalPages = 1;
          totalOrders = 0;
          updatePagination();
        }
      }

      function renderOrders(orders) {
        ordersTableBody.innerHTML = '';

        if (!orders.length) {
          ordersTableBody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; padding:10px;">No orders found.</td></tr>';
          ordersCountLabel.textContent = '0 orders';
          return;
        }

        ordersCountLabel.textContent = totalOrders + ' orders';

        orders.forEach((order) => {
          const tr = document.createElement('tr');
          const orderId = order._id || order.id || '';
          tr.dataset.orderId = orderId;

          const mainTd = document.createElement('td');
          const mainWrapper = document.createElement('div');
          mainWrapper.className = 'order-main';

          const oid = document.createElement('div');
          oid.className = 'order-id';
          const shortId = order.orderNumber || (orderId ? '#' + orderId.slice(-6) : '');
          oid.innerHTML =
            '<i class="fas fa-receipt"></i><span>' +
            (shortId || 'Order') +
            '</span>';
          mainWrapper.appendChild(oid);

          const customerInfo = document.createElement('div');
          customerInfo.className = 'customer-info';
          const user = order.user || {};
          const name = user.name || 'Guest';
          const email = user.email || '';
          const phone = user.phone || '';
          const address =
            (order.shippingAddress && order.shippingAddress.text) ||
            order.address ||
            '';

          customerInfo.innerHTML =
            '<span><i class="fas fa-user"></i> ' +
            name +
            '</span>' +
            (email ? '<span><i class="fas fa-envelope"></i> ' + email + '</span>' : '') +
            (phone ? '<span><i class="fas fa-phone"></i> ' + phone + '</span>' : '') +
            (address
              ? '<span><i class="fas fa-location-dot"></i> ' +
                address +
                '</span>'
              : '');
          mainWrapper.appendChild(customerInfo);

          const itemsPreview = document.createElement('div');
          itemsPreview.className = 'items-preview';
          if (Array.isArray(order.items) && order.items.length) {
            const first = order.items[0];
            const p = first.product || {};
            const firstName = p.name || 'Item';
            const restCount = order.items.length - 1;
            let text = firstName;
            if (restCount > 0) {
              text += ' + ' + restCount + ' more';
            }
            itemsPreview.textContent = text;
          } else {
            itemsPreview.textContent = 'No items';
          }
          mainWrapper.appendChild(itemsPreview);

          mainTd.appendChild(mainWrapper);

          const statusTd = document.createElement('td');
          const statusRaw = order.status || 'pending';
          const pill = document.createElement('span');
          pill.className = 'status-pill ' + statusRaw;
          pill.innerHTML =
            '<i class="fas fa-circle"></i>' +
            statusRaw.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
          const select = document.createElement('select');
          select.className = 'inline-select';
          select.dataset.field = 'status';

          ORDER_STATUSES.forEach((s) => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent =
              s.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
            if (s === statusRaw) opt.selected = true;
            select.appendChild(opt);
          });

          statusTd.appendChild(pill);
          statusTd.appendChild(document.createElement('br'));
          statusTd.appendChild(select);

          const totalTd = document.createElement('td');
          const total = order.totalPrice || order.total || 0;
          totalTd.textContent = formatCurrency(total);

          const dateTd = document.createElement('td');
          dateTd.textContent = formatDate(order.createdAt);

          const actionsTd = document.createElement('td');
          const notesInput = document.createElement('input');
          notesInput.className = 'inline-input';
          notesInput.placeholder = 'Status change note (optional)';
          notesInput.dataset.field = 'notes';
          notesInput.style.marginBottom = '4px';

          const updateBtn = document.createElement('button');
          updateBtn.className = 'action-btn';
          updateBtn.dataset.action = 'update-status';
          updateBtn.innerHTML =
            '<i class="fas fa-floppy-disk"></i><span>Update</span>';

          actionsTd.appendChild(notesInput);
          actionsTd.appendChild(document.createElement('br'));
          actionsTd.appendChild(updateBtn);

          tr.appendChild(mainTd);
          tr.appendChild(statusTd);
          tr.appendChild(totalTd);
          tr.appendChild(dateTd);
          tr.appendChild(actionsTd);

          ordersTableBody.appendChild(tr);
        });
      }

      function updatePagination() {
        paginationInfo.textContent =
          'Page ' +
          (currentPage || 1) +
          ' of ' +
          (totalPages || 1) +
          ' • ' +
          (totalOrders || 0) +
          ' orders';

        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;
      }

      async function updateOrderStatus(row) {
        const token = getAdminToken();
        if (!token) {
          showNotification('No admin session found. Redirecting to login...', 'error');
          setTimeout(() => {
            window.location.href = 'admin-login.html';
          }, 800);
          return;
        }

        const orderId = row.dataset.orderId;
        if (!orderId) return;

        const statusSelect = row.querySelector('select[data-field="status"]');
        const notesInput = row.querySelector('input[data-field="notes"]');
        const newStatus = statusSelect ? statusSelect.value : null;
        const notes = notesInput ? notesInput.value.trim() : '';

        if (!newStatus || !ORDER_STATUSES.includes(newStatus)) {
          showNotification('Please select a valid status.', 'error');
          return;
        }

        try {
          const res = await fetch(
            ADMIN_API + '/orders/' + encodeURIComponent(orderId) + '/status',
            {
              method: 'PUT',
              headers: {
                Authorization: 'Bearer ' + token,
                'Content-Type': 'application/json',
                Accept: 'application/json'
              },
              body: JSON.stringify({ status: newStatus, notes: notes || undefined })
            }
          );

          const data = await res.json().catch(() => ({}));
          if (!res.ok || !data.success) {
            throw new Error(data.message || 'Failed to update order status.');
          }

          showNotification('Order status updated successfully.', 'success');
          loadOrders(currentPage);
        } catch (err) {
          console.error('Update order status error:', err);
          showNotification(err.message || 'Unable to update order.', 'error');
        }
      }

      // Event listeners
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('adminToken');
        localStorage.removeItem('adminUser');
        showNotification('Logged out successfully.', 'info');
        setTimeout(() => {
          window.location.href = 'admin-login.html';
        }, 600);
      });

      prevPageBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          loadOrders(currentPage - 1);
        }
      });

      nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          loadOrders(currentPage + 1);
        }
      });

      searchInput.addEventListener('input', () => {
        const value = searchInput.value.trim();
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          currentSearch = value;
          loadOrders(1);
        }, 400);
      });

      statusFilter.addEventListener('change', () => {
        currentStatus = statusFilter.value;
        loadOrders(1);
      });

      [startDateInput, endDateInput, minAmountInput, maxAmountInput].forEach(
        (input) => {
          input.addEventListener('change', () => {
            loadOrders(1);
          });
        }
      );

      ordersTableBody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="update-status"]');
        if (btn) {
          const row = btn.closest('tr');
          if (row) updateOrderStatus(row);
        }
      });

      // Init
      initAdminUser();
      loadOrders(1);
    })();
  </script>
</body>
</html>
