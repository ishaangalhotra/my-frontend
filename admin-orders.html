<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Orders • QuickLocal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 240px;
      background: #111827;
      color: white;
      padding: 20px;
    }
    .sidebar h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    .sidebar a {
      display: block;
      padding: 10px;
      margin-bottom: 6px;
      color: #e5e7eb;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .sidebar a.active,
    .sidebar a:hover {
      background: #4f46e5;
      color: white;
    }
    .content {
      flex: 1;
      padding: 25px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.4rem;
      margin-bottom: 15px;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .filters input,
    .filters select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table th,
    table td {
      padding: 10px;
      border: 1px solid #e5e5e5;
      font-size: 0.9rem;
      text-align: left;
      vertical-align: top;
    }
    table th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: capitalize;
      color: white;
    }
    .badge.processing,
    .badge.pending {
      background: #3b82f6;
    }
    .badge.shipped,
    .badge.confirmed,
    .badge.preparing,
    .badge["out_for_delivery"] {
      background: #0ea5e9;
    }
    .badge.delivered {
      background: #22c55e;
    }
    .badge.cancelled {
      background: #ef4444;
    }
    .badge.default {
      background: #6b7280;
    }
    .action-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #4f46e5;
      color: white;
    }
    .pagination {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
    }
    .pagination button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: white;
      font-size: 0.8rem;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .info-bar {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .notification {
      margin-top: 8px;
      padding: 6px 9px;
      border-radius: 6px;
      font-size: 0.8rem;
      display: none;
    }
    .notification.info {
      background: #e0f2fe;
      color: #0369a1;
    }
    .notification.error {
      background: #fee2e2;
      color: #b91c1c;
    }
    .notification.success {
      background: #ecfdf3;
      color: #166534;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>QuickLocal Admin</h2>
    <a href="admin-dashboard.html">Dashboard</a>
    <a class="active" href="admin-orders.html">Orders</a>
    <a href="admin-users.html">Users</a>
    <a href="admin-products.html">Products</a>
    <a href="admin-login.html" id="logoutLink">Logout</a>
  </aside>

  <!-- Main content -->
  <main class="content">
    <h1>Manage Orders</h1>

    <div class="filters">
      <input id="searchInput" type="text" placeholder="Search by order ID / customer" />
      <select id="statusFilter">
        <option value="all">All Status</option>
        <option value="pending">Pending</option>
        <option value="confirmed">Confirmed</option>
        <option value="preparing">Preparing</option>
        <option value="out_for_delivery">Out for delivery</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>

    <div class="info-bar">
      <span id="filterSummary">Showing latest orders</span> •
      <span id="ordersCountLabel"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Order</th>
          <th>Status</th>
          <th>Total</th>
          <th>Placed</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTableBody">
        <tr>
          <td colspan="5" style="text-align:center; padding:10px;">Loading orders...</td>
        </tr>
      </tbody>
    </table>

    <div class="pagination">
      <button id="prevPageBtn">Prev</button>
      <button id="nextPageBtn">Next</button>
      <span id="pageInfo"></span>
    </div>

    <div id="notification" class="notification">
      <span id="notificationText"></span>
    </div>
  </main>
</div>

<script>
  const API_BASE = "https://ecommerce-backend-mlik.onrender.com";
  const API_V1 = API_BASE + "/api/v1";
  const ADMIN_API = API_V1 + "/admin";
  const ADMIN_ORDERS_API = ADMIN_API + "/orders";
  const USER_ORDERS_API = API_V1 + "/orders"; // fallback

  const ORDER_STATUS_VALUES = [
    "pending",
    "confirmed",
    "preparing",
    "out_for_delivery",
    "delivered",
    "cancelled",
    "Processing",
    "Shipped",
    "Delivered",
    "Cancelled"
  ];

  let currentPage = 1;
  let totalPages = 1;
  let totalOrders = 0;
  let currentSearch = "";
  let currentStatus = "all";
  let isLoading = false;
  let debounceTimer = null;

  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");
  const ordersTableBody = document.getElementById("ordersTableBody");
  const ordersCountLabel = document.getElementById("ordersCountLabel");
  const pageInfo = document.getElementById("pageInfo");
  const prevPageBtn = document.getElementById("prevPageBtn");
  const nextPageBtn = document.getElementById("nextPageBtn");
  const filterSummary = document.getElementById("filterSummary");
  const logoutLink = document.getElementById("logoutLink");
  const notificationEl = document.getElementById("notification");
  const notificationTextEl = document.getElementById("notificationText");

  function showNotification(message, type = "info") {
    notificationEl.className = "notification " + type;
    notificationTextEl.textContent = message;
    notificationEl.style.display = message ? "block" : "none";
  }

  function formatCurrency(val) {
    if (val == null || isNaN(val)) return "₹0";
    return "₹" + Number(val).toFixed(0);
  }

  function formatDate(value) {
    if (!value) return "—";
    const d = new Date(value);
    if (Number.isNaN(d.getTime())) return "—";
    return d.toLocaleString();
  }

  function getStatusClass(status) {
    if (!status) return "default";
    const s = status.toString().toLowerCase();
    if (s.includes("pending") || s.includes("process")) return "pending";
    if (s.includes("confirm")) return "confirmed";
    if (s.includes("prepar")) return "preparing";
    if (s.includes("out_for_delivery") || s.includes("out for delivery")) return "out_for_delivery";
    if (s.includes("deliver")) return "delivered";
    if (s.includes("cancel")) return "cancelled";
    return "default";
  }

  function updateFilterSummary() {
    const parts = [];
    if (currentStatus !== "all") parts.push("Status: " + currentStatus.replace(/_/g, " "));
    if (currentSearch) parts.push('Search: "' + currentSearch + '"');
    filterSummary.textContent = parts.length ? parts.join(" • ") : "Showing latest orders";
  }

  function updatePagination() {
    pageInfo.textContent =
      "Page " +
      (currentPage || 1) +
      " of " +
      (totalPages || 1) +
      " • " +
      (totalOrders || 0) +
      " orders";

    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
  }

  async function fetchOrdersWithFallback(params, token) {
    // 1) Try /api/v1/admin/orders
    try {
      const res = await fetch(ADMIN_ORDERS_API + "?" + params.toString(), {
        headers: {
          "Authorization": "Bearer " + token,
          "Accept": "application/json"
        }
      });

      if (res.status === 404) {
        console.warn("Admin orders route 404, falling back to /api/v1/orders");
      } else {
        const data = await res.json().catch(() => ({}));
        if (res.ok && (data.success === undefined || data.success === true)) {
          console.log("Using /api/v1/admin/orders");
          return { res, data };
        } else {
          console.warn("Admin orders error, falling back:", data);
        }
      }
    } catch (err) {
      console.warn("Admin orders fetch failed, falling back:", err);
    }

    // 2) Fallback: /api/v1/orders
    const res2 = await fetch(USER_ORDERS_API + "?" + params.toString(), {
      headers: {
        "Authorization": "Bearer " + token,
        "Accept": "application/json"
      }
    });
    const data2 = await res2.json().catch(() => ({}));
    console.log("Using /api/v1/orders fallback", data2);
    return { res: res2, data: data2 };
  }

  async function loadOrders(page = 1) {
    if (isLoading) return;

    const token = localStorage.getItem("adminToken");
    if (!token) {
      alert("Please login as admin.");
      window.location.href = "admin-login.html";
      return;
    }

    isLoading = true;
    showNotification("Loading orders...", "info");

    const params = new URLSearchParams();
    params.set("page", page);
    params.set("limit", 20);
    if (currentStatus !== "all") params.set("status", currentStatus);
    if (currentSearch) params.set("search", currentSearch);

    try {
      const { res, data } = await fetchOrdersWithFallback(params, token);

      if (res.status === 401 || res.status === 403) {
        alert("Session expired. Please login again.");
        localStorage.removeItem("adminToken");
        localStorage.removeItem("adminUser");
        window.location.href = "admin-login.html";
        return;
      }

      if (!res.ok || data.success === false) {
        throw new Error(data.message || "Failed to load orders");
      }

      // Normalise orders array
      let orders = [];
      let pagination = data.pagination || {};

      if (Array.isArray(data.data)) {
        orders = data.data;
      } else if (Array.isArray(data.orders)) {
        orders = data.orders;
      } else if (Array.isArray(data.results)) {
        orders = data.results;
      } else if (Array.isArray(data)) {
        orders = data;
      } else {
        console.warn("Unknown orders response shape:", data);
        orders = [];
      }

      currentPage = pagination.currentPage || pagination.page || page || 1;
      totalOrders =
        pagination.totalOrders ||
        pagination.total ||
        data.count ||
        orders.length;
      totalPages = pagination.totalPages || pagination.pages || 1;
      if (!totalPages) totalPages = 1;

      renderOrders(orders);
      updatePagination();
      updateFilterSummary();
      showNotification("", "info");
    } catch (err) {
      console.error("Admin orders load error:", err);
      renderOrders([]);
      updatePagination();
      showNotification(err.message || "Unable to load orders.", "error");
    } finally {
      isLoading = false;
    }
  }

  function renderOrders(orders) {
    ordersTableBody.innerHTML = "";
    ordersCountLabel.textContent = (totalOrders || orders.length) + " orders";

    if (!orders.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.style.textAlign = "center";
      td.style.padding = "10px";
      td.textContent = "No orders found.";
      tr.appendChild(td);
      ordersTableBody.appendChild(tr);
      return;
    }

    orders.forEach(order => {
      const tr = document.createElement("tr");

      const orderId = order._id || order.id || order.orderNumber || order.orderId || "—";
      const user = order.user || order.customer || {};
      const name = user.name || user.fullName || "Unknown";
      const email = user.email || user.contactEmail || "";
      const totalVal = order.total || order.totalPrice || order.amount || 0;
      const status = order.status || order.orderStatus || "pending";
      const created = order.createdAt || order.placedAt || order.orderDate;

      const mainTd = document.createElement("td");
      mainTd.innerHTML =
        "<strong>" + orderId + "</strong><br>" +
        name +
        (email
          ? "<br><span style='font-size:0.75rem;color:#6b7280;'>" + email + "</span>"
          : "");

      const statusTd = document.createElement("td");
      const badge = document.createElement("span");
      badge.className = "badge " + getStatusClass(status);
      badge.textContent = status.replace(/_/g, " ");
      statusTd.appendChild(badge);

      const totalTd = document.createElement("td");
      totalTd.textContent = formatCurrency(totalVal);

      const dateTd = document.createElement("td");
      dateTd.textContent = formatDate(created);

      const actionsTd = document.createElement("td");
      const btn = document.createElement("button");
      btn.className = "action-btn";
      btn.textContent = "Change Status";
      btn.addEventListener("click", () => {
        changeOrderStatus(orderId, status);
      });
      actionsTd.appendChild(btn);

      tr.appendChild(mainTd);
      tr.appendChild(statusTd);
      tr.appendChild(totalTd);
      tr.appendChild(dateTd);
      tr.appendChild(actionsTd);

      ordersTableBody.appendChild(tr);
    });
  }

  async function changeOrderStatus(orderId, currentStatus) {
    const token = localStorage.getItem("adminToken");
    if (!token) {
      alert("Please login as admin.");
      window.location.href = "admin-login.html";
      return;
    }

    const newStatus = prompt(
      `Current status: ${currentStatus}\n\nEnter new status (pending / confirmed / preparing / out_for_delivery / delivered / cancelled):`
    );
    if (!newStatus) return;

    if (!ORDER_STATUS_VALUES.map(s => s.toLowerCase()).includes(newStatus.toLowerCase())) {
      alert("Invalid status entered.");
      return;
    }

    // Normalize to backend style (keep as typed, backend decides)
    try {
      // Try admin status endpoint first
      let url = `${ADMIN_API}/orders/${encodeURIComponent(orderId)}/status`;
      let res = await fetch(url, {
        method: "PUT",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify({ status: newStatus })
      });

      // If 404, fallback to /api/v1/orders/:id
      if (res.status === 404) {
        console.warn("Admin order status 404, falling back to /api/v1/orders/:id");
        url = `${USER_ORDERS_API}/${encodeURIComponent(orderId)}`;
        res = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ status: newStatus })
        });
      }

      const data = await res.json().catch(() => ({}));
      console.log("Order update response:", data);

      if (!res.ok || data.success === false) {
        throw new Error(data.message || "Failed to update order status");
      }

      alert("Order status updated successfully!");
      loadOrders(currentPage);
    } catch (err) {
      console.error("Update order status error:", err);
      alert(err.message || "Unable to update order.");
    }
  }

  // Events
  prevPageBtn.addEventListener("click", () => {
    if (currentPage > 1) {
      loadOrders(currentPage - 1);
    }
  });

  nextPageBtn.addEventListener("click", () => {
    if (currentPage < totalPages) {
      loadOrders(currentPage + 1);
    }
  });

  searchInput.addEventListener("input", () => {
    const value = searchInput.value.trim();
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      currentSearch = value;
      loadOrders(1);
    }, 400);
  });

  statusFilter.addEventListener("change", () => {
    currentStatus = statusFilter.value;
    loadOrders(1);
  });

  logoutLink.addEventListener("click", (e) => {
    e.preventDefault();
    localStorage.removeItem("adminToken");
    localStorage.removeItem("adminUser");
    window.location.href = "admin-login.html";
  });

  document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("adminToken");
    if (!token) {
      alert("Please login as admin.");
      window.location.href = "admin-login.html";
      return;
    }
    loadOrders(1);
  });
</script>
</body>
</html>
