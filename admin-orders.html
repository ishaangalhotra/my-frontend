<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Orders • QuickLocal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 240px;
      background: #111827;
      color: white;
      padding: 20px;
    }
    .sidebar h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    .sidebar a {
      display: block;
      padding: 10px;
      margin-bottom: 6px;
      color: #e5e7eb;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .sidebar a.active, .sidebar a:hover {
      background: #4f46e5;
      color: white;
    }
    .content {
      flex: 1;
      padding: 25px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.4rem;
      margin-bottom: 15px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .top-bar-right {
      font-size: 0.85rem;
      color: #6b7280;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .filters input, .filters select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table th, table td {
      padding: 10px;
      border: 1px solid #e5e5e5;
      font-size: 0.9rem;
      text-align: left;
    }
    table th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      text-transform: capitalize;
      gap: 4px;
    }
    .status-pill .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
    }
    .status-pill.processing { background: #eff6ff; color: #1d4ed8; }
    .status-pill.processing .dot { background: #1d4ed8; }
    .status-pill.shipped { background: #ecfeff; color: #0891b2; }
    .status-pill.shipped .dot { background: #0891b2; }
    .status-pill.delivered { background: #ecfdf3; color: #16a34a; }
    .status-pill.delivered .dot { background: #16a34a; }
    .status-pill.cancelled { background: #fef2f2; color: #dc2626; }
    .status-pill.cancelled .dot { background: #dc2626; }

    .inline-select, .inline-input {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .action-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #4f46e5;
      color: white;
      margin-right: 4px;
    }
    .action-btn.secondary {
      background: white;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    .pagination {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
    }
    .pagination button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: white;
      font-size: 0.8rem;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .notification {
      margin-top: 10px;
      padding: 8px 10px;
      font-size: 0.8rem;
      border-radius: 6px;
      display: none;
    }
    .notification.info { background: #e0f2fe; color: #0369a1; }
    .notification.success { background: #ecfdf3; color: #166534; }
    .notification.error { background: #fee2e2; color: #b91c1c; }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .modal-card {
      background: white;
      max-width: 800px;
      width: 95%;
      max-height: 90vh;
      border-radius: 12px;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }
    .close-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 1rem;
    }
    .modal-section {
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    .modal-section h3 {
      margin: 0 0 4px 0;
      font-size: 0.95rem;
      color: #374151;
    }
    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .badge {
      display: inline-block;
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e5e7eb;
      color: #374151;
    }
    .items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .items-table th, .items-table td {
      padding: 6px;
      border: 1px solid #e5e5e5;
    }
    .items-table th {
      background: #f9fafb;
    }
  </style>
</head>
<body>
<div class="container">

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2>QuickLocal Admin</h2>
    <a href="admin-dashboard.html">Dashboard</a>
    <a class="active" href="admin-orders.html">Orders</a>
    <a href="admin-users.html">Users</a>
    <a href="admin-products.html">Products</a>
    <a href="admin-login.html">Logout</a>
  </aside>

  <!-- Main -->
  <main class="content">
    <div class="top-bar">
      <h1>Manage Orders</h1>
      <div class="top-bar-right">
        <span id="adminUserName"></span>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <input id="searchInput" type="text" placeholder="Search by order ID / email / phone" />
      <select id="statusFilter">
        <option value="all">All Status</option>
        <option value="Processing">Processing</option>
        <option value="Shipped">Shipped</option>
        <option value="Delivered">Delivered</option>
        <option value="Cancelled">Cancelled</option>
      </select>
      <input id="startDate" type="date" />
      <input id="endDate" type="date" />
      <input id="minAmount" type="number" placeholder="Min amount" />
      <input id="maxAmount" type="number" placeholder="Max amount" />
    </div>

    <div id="currentFilterSummary" style="font-size:0.8rem;color:#6b7280;margin-bottom:5px;">
      Showing latest orders
    </div>

    <!-- Table -->
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Order / Customer</th>
          <th>Status</th>
          <th>Total</th>
          <th>Placed</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTableBody"></tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination">
      <button id="prevPageBtn">Prev</button>
      <button id="nextPageBtn">Next</button>
      <span id="paginationInfo"></span>
    </div>

    <div class="notification" id="notification"></div>
  </main>
</div>

<!-- Order Details Modal -->
<div id="orderDetailsModal" class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-header">
      <h2>Order Details</h2>
      <button class="close-btn" id="closeDetailsBtn"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-section" id="orderBasicInfo"></div>
    <div class="modal-section modal-grid">
      <div id="orderCustomerInfo"></div>
      <div id="orderShippingInfo"></div>
      <div id="orderPaymentInfo"></div>
    </div>
    <div class="modal-section">
      <h3>Items</h3>
      <div id="orderItemsContainer"></div>
    </div>
  </div>
</div>

<script>
  (function () {
    const API_BASE = 'https://ecommerce-backend-mlik.onrender.com';
    const API_V1 = API_BASE + '/api/v1';
    const ADMIN_API = API_V1 + '/admin';
    const ORDERS_API = API_V1 + '/orders';
    const ORDER_STATUSES = ['Processing', 'Shipped', 'Delivered', 'Cancelled'];

    const notifEl = document.getElementById('notification');
    const adminUserNameEl = document.getElementById('adminUserName');

    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const minAmountInput = document.getElementById('minAmount');
    const maxAmountInput = document.getElementById('maxAmount');
    const currentFilterSummary = document.getElementById('currentFilterSummary');

    const ordersTableBody = document.getElementById('ordersTableBody');
    const paginationInfo = document.getElementById('paginationInfo');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');

    const modalBackdrop = document.getElementById('orderDetailsModal');
    const closeDetailsBtn = document.getElementById('closeDetailsBtn');
    const basicInfoEl = document.getElementById('orderBasicInfo');
    const customerInfoEl = document.getElementById('orderCustomerInfo');
    const shippingInfoEl = document.getElementById('orderShippingInfo');
    const paymentInfoEl = document.getElementById('orderPaymentInfo');
    const itemsContainerEl = document.getElementById('orderItemsContainer');

    let currentPage = 1;
    let totalPages = 1;
    let totalOrders = 0;
    let currentSearch = '';
    let currentStatus = 'all';
    let isLoading = false;
    let debounceTimer = null;

    function showNotification(message, type) {
      if (!notifEl) return;
      notifEl.textContent = message || '';
      notifEl.className = 'notification ' + (type || 'info');
      notifEl.style.display = message ? 'block' : 'none';
    }

    function initAdminUser() {
      try {
        const adminUserJson = localStorage.getItem('adminUser');
        if (adminUserJson) {
          const user = JSON.parse(adminUserJson);
          if (user && user.name) {
            adminUserNameEl.textContent = user.name + ' (Admin)';
          }
        }
      } catch (e) {
        console.warn('Failed to parse adminUser:', e);
      }
    }

    function formatDate(value) {
      if (!value) return '—';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return '—';
      return d.toLocaleString();
    }

    function formatCurrency(val) {
      if (val == null || isNaN(val)) return '₹0';
      return '₹' + Number(val).toFixed(0);
    }

    function updateFilterSummary() {
      const parts = [];
      if (currentStatus && currentStatus !== 'all') {
        parts.push('Status: ' + currentStatus);
      }
      if (currentSearch) {
        parts.push('Search: "' + currentSearch + '"');
      }
      if (startDateInput.value || endDateInput.value) {
        parts.push(
          'Date: ' +
          (startDateInput.value || '…') +
          ' to ' +
          (endDateInput.value || '…')
        );
      }
      if (minAmountInput.value || maxAmountInput.value) {
        parts.push(
          'Amount: ' +
          (minAmountInput.value || '0') +
          ' - ' +
          (maxAmountInput.value || '∞')
        );
      }
      currentFilterSummary.textContent = parts.length
        ? parts.join(' • ')
        : 'Showing latest orders';
    }

    async function fetchOrdersFromBestEndpoint(params, token) {
      let res = await fetch(ADMIN_API + '/orders?' + params.toString(), {
        headers: {
          'Authorization': 'Bearer ' + token,
          'Accept': 'application/json'
        }
      });

      if (res.status === 404) {
        console.warn('Admin orders route 404, falling back to /api/v1/orders');
        res = await fetch(ORDERS_API + '?' + params.toString(), {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/json'
          }
        });
      }

      return res;
    }

    async function loadOrders(page = 1) {
      if (isLoading) return;
      const token = localStorage.getItem('adminToken');
      if (!token) {
        showNotification('No admin session found. Redirecting to login...', 'error');
        setTimeout(() => {
          window.location.href = 'admin-login.html';
        }, 800);
        return;
      }

      isLoading = true;
      showNotification('Loading orders...', 'info');

      const params = new URLSearchParams();
      params.set('page', page);
      params.set('limit', 20);
      if (currentStatus && currentStatus !== 'all') params.set('status', currentStatus);
      if (currentSearch) params.set('search', currentSearch);
      if (startDateInput.value) params.set('startDate', startDateInput.value);
      if (endDateInput.value) params.set('endDate', endDateInput.value);
      if (minAmountInput.value) params.set('minAmount', minAmountInput.value);
      if (maxAmountInput.value) params.set('maxAmount', maxAmountInput.value);

      try {
        let res = await fetchOrdersFromBestEndpoint(params, token);

        if (res.status === 401 || res.status === 403) {
          showNotification('Session expired or unauthorized. Please login again.', 'error');
          localStorage.removeItem('adminToken');
          localStorage.removeItem('adminUser');
          setTimeout(() => {
            window.location.href = 'admin-login.html';
          }, 900);
          return;
        }

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          throw new Error(data.message || 'Failed to load orders');
        }

        const orders =
          Array.isArray(data.data) ? data.data :
          Array.isArray(data.orders) ? data.orders :
          [];

        const pagination = data.pagination || {};
        currentPage = pagination.currentPage || pagination.page || 1;
        totalOrders = pagination.totalOrders || pagination.total || orders.length;
        totalPages = pagination.totalPages || pagination.pages || 1;

        renderOrders(orders);
        updatePagination();
        updateFilterSummary();
        showNotification('', 'info');
      } catch (err) {
        console.error('Load orders error:', err);
        renderOrders([]);
        updatePagination();
        showNotification(err.message || 'Unable to load orders.', 'error');
      } finally {
        isLoading = false;
      }
    }

    function renderOrders(orders) {
      ordersTableBody.innerHTML = '';
      if (!orders.length) {
        paginationInfo.textContent = 'No orders found';
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.style.textAlign = 'center';
        td.style.padding = '10px';
        td.textContent = 'No orders found for this filter.';
        tr.appendChild(td);
        ordersTableBody.appendChild(tr);
        return;
      }

      orders.forEach(order => {
        const tr = document.createElement('tr');
        const orderId = order._id || order.id;
        tr.dataset.orderId = orderId;

        const user = order.user || order.customer || {};
        const statusRaw = order.status || 'Processing';
        const statusLower = statusRaw.toString().toLowerCase();

        const mainTd = document.createElement('td');
        const idLine = document.createElement('div');
        idLine.textContent = orderId || '—';
        const userLine = document.createElement('div');
        userLine.textContent = (user.name || 'Unknown') + ' • ' + (user.email || 'no email');
        userLine.style.fontSize = '0.72rem';
        userLine.style.color = '#6b7280';
        mainTd.appendChild(idLine);
        mainTd.appendChild(userLine);

        const statusTd = document.createElement('td');
        const pill = document.createElement('span');
        pill.className = 'status-pill ' + statusLower;
        const dot = document.createElement('span');
        dot.className = 'dot';
        const label = document.createElement('span');
        label.textContent = statusRaw;
        pill.appendChild(dot);
        pill.appendChild(label);

        const select = document.createElement('select');
        select.className = 'inline-select';
        select.dataset.field = 'status';
        ORDER_STATUSES.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          if (s === statusRaw) opt.selected = true;
          select.appendChild(opt);
        });

        statusTd.appendChild(pill);
        statusTd.appendChild(document.createElement('br'));
        statusTd.appendChild(select);

        const totalTd = document.createElement('td');
        const total = order.total || order.totalPrice || 0;
        totalTd.textContent = formatCurrency(total);

        const dateTd = document.createElement('td');
        dateTd.textContent = formatDate(order.createdAt);

        const actionsTd = document.createElement('td');
        const notesInput = document.createElement('input');
        notesInput.className = 'inline-input';
        notesInput.placeholder = 'Status change note (optional)';
        notesInput.dataset.field = 'notes';
        notesInput.style.marginBottom = '4px';

        const updateBtn = document.createElement('button');
        updateBtn.className = 'action-btn';
        updateBtn.dataset.action = 'update-status';
        updateBtn.innerHTML = '<i class="fas fa-floppy-disk"></i> Update';

        const detailsBtn = document.createElement('button');
        detailsBtn.className = 'action-btn secondary';
        detailsBtn.dataset.action = 'view-details';
        detailsBtn.innerHTML = '<i class="fas fa-eye"></i> Details';

        actionsTd.appendChild(notesInput);
        actionsTd.appendChild(document.createElement('br'));
        actionsTd.appendChild(updateBtn);
        actionsTd.appendChild(detailsBtn);

        tr.appendChild(mainTd);
        tr.appendChild(statusTd);
        tr.appendChild(totalTd);
        tr.appendChild(dateTd);
        tr.appendChild(actionsTd);

        ordersTableBody.appendChild(tr);
      });
    }

    function updatePagination() {
      paginationInfo.textContent =
        'Page ' +
        (currentPage || 1) +
        ' of ' +
        (totalPages || 1) +
        ' • ' +
        (totalOrders || 0) +
        ' orders';

      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
    }

    async function updateOrderStatus(row) {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        showNotification('No admin session found. Redirecting to login...', 'error');
        setTimeout(() => {
          window.location.href = 'admin-login.html';
        }, 800);
        return;
      }

      const orderId = row.dataset.orderId;
      if (!orderId) return;

      const statusSelect = row.querySelector('select[data-field="status"]');
      const notesInput = row.querySelector('input[data-field="notes"]');
      const newStatus = statusSelect ? statusSelect.value : null;
      const notes = notesInput ? notesInput.value.trim() : '';

      if (!newStatus || !ORDER_STATUSES.includes(newStatus)) {
        showNotification('Please select a valid status.', 'error');
        return;
      }

      async function sendUpdate(url) {
        return fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ status: newStatus, notes: notes || undefined })
        });
      }

      try {
        let res = await sendUpdate(
          ADMIN_API + '/orders/' + encodeURIComponent(orderId) + '/status'
        );

        if (res.status === 404) {
          console.warn('Admin order status 404, falling back to /api/v1/orders/:id');
          res = await sendUpdate(ORDERS_API + '/' + encodeURIComponent(orderId));
        }

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          throw new Error(data.message || 'Failed to update order status.');
        }

        showNotification('Order status updated successfully.', 'success');
        loadOrders(currentPage);
      } catch (err) {
        console.error('Update order status error:', err);
        showNotification(err.message || 'Unable to update order.', 'error');
      }
    }

    async function fetchOrderDetails(orderId) {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        showNotification('No admin session found. Redirecting to login...', 'error');
        setTimeout(() => {
          window.location.href = 'admin-login.html';
        }, 800);
        return null;
      }

      async function doFetch(url) {
        return fetch(url, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'Accept': 'application/json'
          }
        });
      }

      try {
        let res = await doFetch(ADMIN_API + '/orders/' + encodeURIComponent(orderId));
        if (res.status === 404) {
          console.warn('Admin order details 404, falling back to /api/v1/orders/:id');
          res = await doFetch(ORDERS_API + '/' + encodeURIComponent(orderId));
        }

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.success === false) {
          throw new Error(data.message || 'Failed to load order details.');
        }

        // Some endpoints return { success, data: order }, some return just order
        return data.data && !Array.isArray(data.data) ? data.data : data;
      } catch (err) {
        console.error('Order details error:', err);
        showNotification(err.message || 'Unable to load order details.', 'error');
        return null;
      }
    }

    function openOrderDetails(order) {
      if (!order) return;

      const user = order.user || order.customer || {};
      const shipping = order.shippingAddress || order.address || {};
      const payment = order.paymentInfo || order.payment || {};
      const items = Array.isArray(order.items)
        ? order.items
        : Array.isArray(order.orderItems)
        ? order.orderItems
        : [];

      const total = order.total || order.totalPrice || 0;
      const orderId = order._id || order.id;
      const status = order.status || 'Processing';

      basicInfoEl.innerHTML = `
        <div><strong>Order ID:</strong> ${orderId}</div>
        <div><strong>Status:</strong> <span class="badge">${status}</span></div>
        <div><strong>Total:</strong> ${formatCurrency(total)}</div>
        <div><strong>Placed:</strong> ${formatDate(order.createdAt)}</div>
      `;

      customerInfoEl.innerHTML = `
        <h3>Customer</h3>
        <div><strong>Name:</strong> ${user.name || '—'}</div>
        <div><strong>Email:</strong> ${user.email || '—'}</div>
        <div><strong>Phone:</strong> ${user.phone || user.mobile || '—'}</div>
      `;

      shippingInfoEl.innerHTML = `
        <h3>Shipping Address</h3>
        <div>${shipping.addressLine1 || shipping.street || ''}</div>
        <div>${shipping.addressLine2 || ''}</div>
        <div>${shipping.city || ''}${shipping.state ? ', ' + shipping.state : ''}</div>
        <div>${shipping.postalCode || shipping.zip || ''}</div>
        <div>${shipping.country || ''}</div>
      `;

      paymentInfoEl.innerHTML = `
        <h3>Payment</h3>
        <div><strong>Method:</strong> ${payment.method || payment.paymentMethod || '—'}</div>
        <div><strong>Status:</strong> ${payment.status || payment.paymentStatus || '—'}</div>
        <div><strong>Txn ID:</strong> ${payment.transactionId || payment.id || '—'}</div>
      `;

      if (!items.length) {
        itemsContainerEl.innerHTML = '<div>No items found for this order.</div>';
      } else {
        const rows = items
          .map((item, idx) => {
            const name = item.name || item.productName || item.product?.name || 'Item ' + (idx + 1);
            const qty = item.quantity || item.qty || 1;
            const price = item.price || item.unitPrice || 0;
            const subtotal = (qty * price) || 0;
            return `
              <tr>
                <td>${name}</td>
                <td>${qty}</td>
                <td>${formatCurrency(price)}</td>
                <td>${formatCurrency(subtotal)}</td>
              </tr>
            `;
          })
          .join('');

        itemsContainerEl.innerHTML = `
          <table class="items-table">
            <thead>
              <tr>
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      modalBackdrop.classList.add('active');
    }

    function closeOrderDetails() {
      modalBackdrop.classList.remove('active');
    }

    // Event listeners
    closeDetailsBtn.addEventListener('click', closeOrderDetails);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeOrderDetails();
    });

    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) loadOrders(currentPage - 1);
    });

    nextPageBtn.addEventListener('click', () => {
      if (currentPage < totalPages) loadOrders(currentPage + 1);
    });

    searchInput.addEventListener('input', () => {
      const value = searchInput.value.trim();
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        currentSearch = value;
        loadOrders(1);
      }, 400);
    });

    statusFilter.addEventListener('change', () => {
      currentStatus = statusFilter.value;
      loadOrders(1);
    });

    [startDateInput, endDateInput, minAmountInput, maxAmountInput].forEach(input => {
      input.addEventListener('change', () => {
        loadOrders(1);
      });
    });

    ordersTableBody.addEventListener('click', async (e) => {
      const target = e.target;
      const row = target.closest('tr');
      if (!row) return;

      const updateBtn = target.closest('button[data-action="update-status"]');
      const detailsBtn = target.closest('button[data-action="view-details"]');

      if (updateBtn) {
        updateOrderStatus(row);
      } else if (detailsBtn) {
        const orderId = row.dataset.orderId;
        if (!orderId) return;
        const order = await fetchOrderDetails(orderId);
        if (order) openOrderDetails(order);
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        alert('Please login as admin.');
        window.location.href = 'admin-login.html';
        return;
      }
      initAdminUser();
      loadOrders(1);
    });
  })();
</script>
</body>
</html>
