<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Users â€¢ QuickLocal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Icons -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      width: 240px;
      background: #111827;
      color: white;
      padding: 20px;
    }

    .sidebar h2 {
      margin: 0 0 20px;
      font-size: 1.2rem;
    }

    .sidebar a {
      display: block;
      padding: 10px;
      margin-bottom: 6px;
      color: #e5e7eb;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .sidebar a.active,
    .sidebar a:hover {
      background: #4f46e5;
      color: white;
    }

    /* ================= CONTENT ================= */
    .content {
      flex: 1;
      padding: 25px;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    /* ================= FILTERS ================= */
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .filters input,
    .filters select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }

    /* ================= TABLE ================= */
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #e5e7eb;
      font-size: 0.9rem;
      text-align: left;
    }

    th {
      background: #f3f4f6;
    }

    /* ================= BADGES ================= */
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      color: white;
      text-transform: capitalize;
    }

    .badge.admin { background: #7c3aed; }
    .badge.seller { background: #0891b2; }
    .badge.customer { background: #3b82f6; }
    .badge.moderator { background: #db2777; }
    .badge.delivery_agent { background: #f97316; }

    .badge.active { background: #22c55e; }
    .badge.inactive { background: #9ca3af; }
    .badge.suspended { background: #f59e0b; }

    /* ================= PAGINATION ================= */
    .pagination {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
    }

    .pagination button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: white;
      font-size: 0.8rem;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Debug panel */
    .debug-panel {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 0.85rem;
    }
    .debug-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-right: 5px;
    }
    .debug-btn:hover {
      background: #5a6268;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- ================= SIDEBAR ================= -->
  <aside class="sidebar">
    <h2>QuickLocal Admin</h2>
    <a href="admin-dashboard.html">Dashboard</a>
    <a href="admin-orders.html">Orders</a>
    <a class="active" href="admin-users.html">Users</a>
    <a href="admin-products.html">Products</a>
    <a href="admin-login.html">Logout</a>
  </aside>

  <!-- ================= CONTENT ================= -->
  <main class="content">
    <h1>Manage Users</h1>

    <!-- DEBUG PANEL -->
    <div class="debug-panel">
      <strong>Debug Panel</strong>
      <button class="debug-btn" onclick="debugAuth()">Test Auth</button>
      <button class="debug-btn" onclick="testEndpoints()">Test Endpoints</button>
      <button class="debug-btn" onclick="checkToken()">Check Token</button>
      <div id="debugOutput" style="margin-top: 10px; font-family: monospace; font-size: 0.8rem;"></div>
    </div>

    <!-- FILTERS -->
    <div class="filters">
      <input id="searchInput" type="text" placeholder="Search name or email" />
      <select id="roleFilter">
        <option value="">All Roles</option>
        <option value="admin">Admin</option>
        <option value="seller">Seller</option>
        <option value="customer">Customer</option>
        <option value="moderator">Moderator</option>
        <option value="delivery_agent">Delivery Agent</option>
      </select>
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="suspended">Suspended</option>
      </select>
    </div>

    <!-- TABLE -->
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="usersTable">
        <tr><td colspan="4">Loading usersâ€¦</td></tr>
      </tbody>
    </table>

    <!-- PAGINATION -->
    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextBtn">Next</button>
    </div>
  </main>

</div>

<!-- ðŸ” Hybrid Auth Client (served from backend /public) -->
<script src="https://ecommerce-backend-mlik.onrender.com/hybrid-auth-client.js"></script>

<script>
/* =================================================
   GLOBAL STATE
================================================== */
let currentPage = 1;
let totalPages = 1;
let authUser = null;
const API_BASE_URL = "https://ecommerce-backend-mlik.onrender.com/api/v1";

/* =================================================
   AUTH INITIALIZATION
================================================== */
const auth = new HybridAuthClient({
  autoInitialize: true,
  enableSessionWatcher: true
});

document.addEventListener("auth-ready", (e) => {
  authUser = e.detail?.user;
  console.log("[Admin Users] Auth user:", authUser);
  
  updateDebug(`Auth ready. User: ${authUser?.name || 'Unknown'}, Role: ${authUser?.role || 'None'}`);

  if (!authUser) {
    alert("Please login first.");
    window.location.href = "admin-login.html";
    return;
  }

  // Temporarily bypass frontend check to test backend
  loadUsers();
});

/* =================================================
   LOAD USERS - WITH BACKEND DEBUGGING
================================================== */
async function loadUsers() {
  const search = document.getElementById("searchInput").value.trim();
  const role = document.getElementById("roleFilter").value;
  const status = document.getElementById("statusFilter").value;

  const params = new URLSearchParams({
    page: currentPage,
    limit: 10
  });

  if (search) params.append("search", search);
  if (role) params.append("role", role);
  if (status) params.append("status", status);

  try {
    updateDebug(`Trying: GET /api/v1/users?${params}`);
    
    // Try the main endpoint first
    const response = await auth.apiCall(`/api/v1/users?${params}`);
    
    updateDebug(`Response: ${response.status} ${response.statusText}`);
    
    if (response.status === 403) {
      // Get the actual error from backend
      let errorMessage = "Access denied (403)";
      try {
        const errorData = await response.json();
        errorMessage = errorData.message || errorMessage;
        updateDebug(`Backend error: ${JSON.stringify(errorData)}`);
      } catch (e) {
        updateDebug(`Could not parse error response: ${e.message}`);
      }
      
      // Show detailed error
      document.getElementById("usersTable").innerHTML = 
        `<tr><td colspan="4" style="text-align:center;color:red;">
          <strong>Backend Permission Error</strong><br>
          ${errorMessage}<br>
          <small>User role: ${authUser?.role || 'unknown'}</small>
        </td></tr>`;
      return;
    }
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();
    updateDebug(`Success! Found ${data.users?.length || data.data?.length || 0} users`);
    
    processUsersResponse(data);

  } catch (err) {
    console.error("Load users error:", err);
    updateDebug(`Error: ${err.message}`);
    document.getElementById("usersTable").innerHTML =
      `<tr><td colspan="4" style="text-align:center;color:red;">
        Error: ${err.message}<br>
        <small>Check debug panel for details</small>
      </td></tr>`;
  }
}

/* =================================================
   PROCESS USERS RESPONSE
================================================== */
function processUsersResponse(data) {
  // Extract users from response
  let users = [];
  
  if (Array.isArray(data)) {
    users = data;
  } else if (Array.isArray(data.data)) {
    users = data.data;
  } else if (Array.isArray(data.users)) {
    users = data.users;
  } else if (data.data && Array.isArray(data.data.users)) {
    users = data.data.users;
  }

  if (users.length === 0) {
    console.warn("No users found in response:", data);
    document.getElementById("usersTable").innerHTML = 
      `<tr><td colspan="4" style="text-align:center;">
        No users found in database.<br>
        <small>Response format: ${JSON.stringify(data).substring(0, 100)}...</small>
      </td></tr>`;
    return;
  }

  renderUsers(users);

  // Update pagination
  const pagination = data.pagination || data.data?.pagination || {};
  totalPages = pagination.totalPages || pagination.pages || 1;
  document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${totalPages}`;
  
  // Update button states
  document.getElementById("prevBtn").disabled = currentPage <= 1;
  document.getElementById("nextBtn").disabled = currentPage >= totalPages;
}

/* =================================================
   RENDER USERS
================================================== */
function renderUsers(users) {
  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "";

  users.forEach(u => {
    // Determine status
    let statusClass = "inactive";
    let statusText = "Inactive";
    
    if (u.status) {
      statusClass = u.status.toLowerCase();
      statusText = u.status;
    } else if (u.isActive === true) {
      statusClass = "active";
      statusText = "Active";
    } else if (u.isActive === false) {
      statusClass = "inactive";
      statusText = "Inactive";
    }

    // Determine role
    const role = u.role || "customer";
    
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <div style="font-weight:600;">${u.name || "Unknown"}</div>
        <div style="font-size:0.8em;color:#666;">${u.phone || ""}</div>
      </td>
      <td>${u.email || "No email"}</td>
      <td><span class="badge ${role}">${role}</span></td>
      <td><span class="badge ${statusClass}">${statusText}</span></td>
    `;
    tbody.appendChild(tr);
  });
}

/* =================================================
   DEBUG FUNCTIONS
================================================== */
function updateDebug(message) {
  const debugEl = document.getElementById("debugOutput");
  const timestamp = new Date().toLocaleTimeString();
  debugEl.innerHTML += `[${timestamp}] ${message}<br>`;
  debugEl.scrollTop = debugEl.scrollHeight;
}

async function debugAuth() {
  updateDebug("=== DEBUG AUTH ===");
  try {
    const response = await auth.apiCall('/api/v1/auth/me');
    const data = await response.json();
    updateDebug(`Auth check: ${response.status} - ${JSON.stringify(data)}`);
  } catch (err) {
    updateDebug(`Auth error: ${err.message}`);
  }
}

async function testEndpoints() {
  updateDebug("=== TEST ENDPOINTS ===");
  const endpoints = [
    '/api/v1/users?limit=1',
    '/api/v1/admin/users?limit=1',
    '/api/v1/admin/dashboard',
    '/api/v1/test'
  ];
  
  for (const endpoint of endpoints) {
    try {
      const response = await auth.apiCall(endpoint);
      updateDebug(`${endpoint}: ${response.status} ${response.statusText}`);
    } catch (err) {
      updateDebug(`${endpoint}: ERROR - ${err.message}`);
    }
  }
}

async function checkToken() {
  updateDebug("=== CHECK TOKEN ===");
  try {
    // Get token from localStorage (HybridAuthClient stores it there)
    const token = localStorage.getItem('quicklocal_access_token') || 
                  localStorage.getItem('accessToken') || 
                  localStorage.getItem('token');
    
    if (token) {
      updateDebug(`Token found: ${token.substring(0, 30)}...`);
      
      // Try to decode JWT (client-side)
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        updateDebug(`JWT Payload: ${JSON.stringify(payload)}`);
        updateDebug(`User ID: ${payload.id || payload.userId || payload.sub}`);
        updateDebug(`Role: ${payload.role || 'Not specified'}`);
      } catch (e) {
        updateDebug(`Cannot decode token: ${e.message}`);
      }
    } else {
      updateDebug("No token found in localStorage");
    }
  } catch (err) {
    updateDebug(`Token check error: ${err.message}`);
  }
}

/* =================================================
   EVENTS
================================================== */
let searchTimeout;
document.getElementById("searchInput").addEventListener("input", () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentPage = 1;
    loadUsers();
  }, 500);
});

document.getElementById("roleFilter").addEventListener("change", () => {
  currentPage = 1;
  loadUsers();
});

document.getElementById("statusFilter").addEventListener("change", () => {
  currentPage = 1;
  loadUsers();
});

document.getElementById("prevBtn").onclick = () => {
  if (currentPage > 1) {
    currentPage--;
    loadUsers();
  }
};

document.getElementById("nextBtn").onclick = () => {
  if (currentPage < totalPages) {
    currentPage++;
    loadUsers();
  }
};

// Quick workaround: Try to load without waiting for auth
setTimeout(() => {
  if (!authUser && window.HybridAuthClient) {
    try {
      const auth = window.HybridAuthClient;
      if (auth && auth.isAuthenticated && typeof auth.getUser === 'function') {
        authUser = auth.getUser();
        updateDebug(`Manual auth check: ${authUser?.name || 'Unknown'}`);
        loadUsers();
      }
    } catch (e) {
      updateDebug(`Manual auth failed: ${e.message}`);
    }
  }
}, 1000);
</script>

</body>
</html>