<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Users ‚Ä¢ QuickLocal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Icons -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      width: 240px;
      background: #111827;
      color: white;
      padding: 20px;
    }

    .sidebar h2 {
      margin: 0 0 20px;
      font-size: 1.2rem;
    }

    .sidebar a {
      display: block;
      padding: 10px;
      margin-bottom: 6px;
      color: #e5e7eb;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .sidebar a.active,
    .sidebar a:hover {
      background: #4f46e5;
      color: white;
    }

    /* ================= CONTENT ================= */
    .content {
      flex: 1;
      padding: 25px;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    /* ================= FILTERS ================= */
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      align-items: center;
    }

    .filters input,
    .filters select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }

    .load-btn {
      padding: 8px 15px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .load-btn:hover {
      background: #0da271;
    }
    .load-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* ================= TABLE ================= */
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    th,
    td {
      padding: 12px;
      border: 1px solid #e5e7eb;
      font-size: 0.9rem;
      text-align: left;
    }

    th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
    }

    tr:hover {
      background: #f9fafb;
    }

    /* ================= BADGES ================= */
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      color: white;
      text-transform: capitalize;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }

    .badge.admin { background: #7c3aed; }
    .badge.seller { background: #0891b2; }
    .badge.customer { background: #3b82f6; }
    .badge.moderator { background: #db2777; }
    .badge.delivery_agent { background: #f97316; }

    .badge.active { background: #22c55e; }
    .badge.inactive { background: #9ca3af; }
    .badge.suspended { background: #f59e0b; }
    .badge.pending { background: #f59e0b; }

    /* ================= PAGINATION ================= */
    .pagination {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
    }

    .pagination button {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: white;
      font-size: 0.8rem;
    }

    .pagination button:hover:not(:disabled) {
      background: #374151;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Status messages */
    .status-message {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .status-warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #f59e0b;
    }
    .status-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .status-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .status-icon {
      font-size: 1rem;
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .stat-box {
      background: white;
      padding: 12px 15px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      min-width: 120px;
    }
    .stat-label {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
    }

    /* Action buttons */
    .action-btn {
      padding: 4px 8px;
      font-size: 0.8rem;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
      margin-right: 5px;
    }
    .action-btn:hover {
      background: #f3f4f6;
    }
    .action-btn.delete {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #991b1b;
    }
    .action-btn.delete:hover {
      background: #fecaca;
    }
    .action-btn.edit {
      background: #dbeafe;
      border-color: #93c5fd;
      color: #1e40af;
    }
    .action-btn.edit:hover {
      background: #bfdbfe;
    }

    /* Current user highlight */
    .current-user {
      background: #f0f9ff !important;
      border-left: 3px solid #3b82f6;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- ================= SIDEBAR ================= -->
  <aside class="sidebar">
    <h2>QuickLocal Admin</h2>
    <a href="admin-dashboard.html">Dashboard</a>
    <a href="admin-orders.html">Orders</a>
    <a class="active" href="admin-users.html">Users</a>
    <a href="admin-products.html">Products</a>
    <a href="admin-login.html">Logout</a>
  </aside>

  <!-- ================= CONTENT ================= -->
  <main class="content">
    <h1>Manage Users</h1>
    
    <!-- Status Message -->
    <div id="statusMessage" class="status-message status-info">
      <span class="status-icon">‚è≥</span>
      <span id="statusText">Initializing admin users panel...</span>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat-box">
        <div class="stat-label">Total Users</div>
        <div id="totalUsers" class="stat-value">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Active</div>
        <div id="activeUsers" class="stat-value">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Customers</div>
        <div id="customerCount" class="stat-value">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">Sellers</div>
        <div id="sellerCount" class="stat-value">0</div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="filters">
      <input id="searchInput" type="text" placeholder="Search name or email" />
      <select id="roleFilter">
        <option value="">All Roles</option>
        <option value="admin">Admin</option>
        <option value="seller">Seller</option>
        <option value="customer">Customer</option>
        <option value="moderator">Moderator</option>
        <option value="delivery_agent">Delivery Agent</option>
      </select>
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="suspended">Suspended</option>
        <option value="pending">Pending</option>
      </select>
      <button id="loadBtn" class="load-btn" onclick="loadUsers()">
        <span id="loadBtnText">Load Users</span>
        <span id="loadSpinner" style="display:none;">‚åõ</span>
      </button>
      <button class="load-btn" onclick="refreshUsers()" style="background: #3b82f6;">
        Refresh
      </button>
    </div>

    <!-- TABLE -->
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Orders</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTable">
        <tr><td colspan="6" style="text-align:center;padding: 30px;">Click "Load Users" to load user data</td></tr>
      </tbody>
    </table>

    <!-- PAGINATION -->
    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <span id="pageInfo">Page 1 of 1</span>
      <button id="nextBtn">Next</button>
      <span style="margin-left: auto; color: #6b7280; font-size: 0.8rem;">
        Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> users
      </span>
    </div>
  </main>

</div>

<!-- üîê Hybrid Auth Client (served from backend /public) -->
<script src="https://ecommerce-backend-mlik.onrender.com/hybrid-auth-client.js"></script>

<script>
/* =================================================
   GLOBAL STATE
================================================== */
let currentPage = 1;
const limitPerPage = 10;
let totalPages = 1;
let authUser = null;
let allUsers = [];
let filteredUsers = [];
const API_BASE_URL = "https://ecommerce-backend-mlik.onrender.com/api/v1";

/* =================================================
   AUTH INITIALIZATION
================================================== */
const auth = new HybridAuthClient({
  autoInitialize: true,
  enableSessionWatcher: true
});

document.addEventListener("auth-ready", (e) => {
  authUser = e.detail?.user;
  console.log("[Admin Users] Auth user:", authUser);
  
  updateStatus(`Logged in as: ${authUser?.name || 'Unknown'} (Role: ${authUser?.role || 'None'})`, 'info');

  if (!authUser) {
    updateStatus("Please login first.", 'warning');
    setTimeout(() => window.location.href = "admin-login.html", 2000);
    return;
  }

  // Auto-load if admin
  if (authUser.role === 'admin' || authUser.role === 'super_admin') {
    setTimeout(() => {
      updateStatus('Ready to load users. Click "Load Users" button.', 'info');
    }, 500);
  } else {
    updateStatus('Access denied. Admin privileges required.', 'error');
  }
});

/* =================================================
   MAIN LOAD FUNCTION
================================================== */
async function loadUsers() {
  const loadBtn = document.getElementById('loadBtn');
  const loadBtnText = document.getElementById('loadBtnText');
  const loadSpinner = document.getElementById('loadSpinner');
  
  // Show loading state
  loadBtn.disabled = true;
  loadBtnText.textContent = 'Loading...';
  loadSpinner.style.display = 'inline';
  
  updateStatus("Loading user data from orders...", 'info');
  
  try {
    // Get token from localStorage
    const token = getAuthToken();
    if (!token) {
      throw new Error("No authentication token found");
    }
    
    // Load orders to extract users
    const orders = await loadOrders(token);
    
    // Extract users from orders
    const users = extractUsersFromOrders(orders);
    
    // Add current user if not in list
    if (authUser && !users.find(u => u.id === authUser.id)) {
      users.unshift({
        id: authUser.id,
        name: authUser.name,
        email: authUser.email,
        role: authUser.role,
        status: 'active',
        isCurrentUser: true,
        orderCount: 0
      });
    }
    
    // Store and display
    allUsers = users;
    filteredUsers = [...users];
    
    // Update UI
    updateStats(users);
    renderUsers();
    updateStatus(`Successfully loaded ${users.length} users from order history`, 'success');
    
    // Cache for future
    localStorage.setItem('cached_users', JSON.stringify(users));
    localStorage.setItem('cached_users_timestamp', Date.now());
    
  } catch (err) {
    console.error("Load users error:", err);
    updateStatus(`Error: ${err.message}`, 'error');
    
    // Try to load cached data
    const cached = localStorage.getItem('cached_users');
    if (cached) {
      try {
        allUsers = JSON.parse(cached);
        filteredUsers = [...allUsers];
        updateStats(allUsers);
        renderUsers();
        updateStatus(`Loaded ${allUsers.length} cached users`, 'warning');
      } catch (e) {
        console.error("Failed to load cached users:", e);
      }
    }
    
  } finally {
    // Reset button state
    loadBtn.disabled = false;
    loadBtnText.textContent = 'Load Users';
    loadSpinner.style.display = 'none';
  }
}

async function refreshUsers() {
  // Clear cache and reload
  localStorage.removeItem('cached_users');
  localStorage.removeItem('cached_users_timestamp');
  loadUsers();
}

/* =================================================
   HELPER FUNCTIONS
================================================== */
function updateStatus(message, type = 'info') {
  const statusEl = document.getElementById('statusMessage');
  const statusText = document.getElementById('statusText');
  
  // Update classes
  statusEl.className = `status-message status-${type}`;
  
  // Update icon
  const iconMap = {
    'info': '‚ÑπÔ∏è',
    'warning': '‚ö†Ô∏è',
    'success': '‚úÖ',
    'error': '‚ùå'
  };
  statusEl.querySelector('.status-icon').textContent = iconMap[type] || '‚ÑπÔ∏è';
  
  // Update text
  statusText.textContent = message;
  console.log(`Status: ${message}`);
}

function getAuthToken() {
  // Try multiple storage locations
  const token = 
    localStorage.getItem('quicklocal_access_token') ||
    localStorage.getItem('accessToken') ||
    localStorage.getItem('token') ||
    localStorage.getItem('adminToken') ||
    (auth && auth.getToken && auth.getToken()) ||
    sessionStorage.getItem('quicklocal_access_token');
  
  return token;
}

async function loadOrders(token) {
  try {
    const response = await fetch(`${API_BASE_URL}/orders?limit=100`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to load orders: ${response.status}`);
    }
    
    const data = await response.json();
    return data.orders || data.data || [];
    
  } catch (err) {
    console.error("Load orders error:", err);
    throw err;
  }
}

function extractUsersFromOrders(orders) {
  const userMap = new Map();
  
  // Add current user first
  if (authUser) {
    userMap.set(authUser.id, {
      id: authUser.id,
      name: authUser.name,
      email: authUser.email,
      role: authUser.role,
      status: 'active',
      isCurrentUser: true,
      orderCount: 0,
      totalSpent: 0,
      lastOrder: null
    });
  }
  
  // Process orders
  orders.forEach(order => {
    if (order.user && order.user._id) {
      const userId = order.user._id;
      const existingUser = userMap.get(userId);
      
      if (existingUser) {
        // Update existing user
        existingUser.orderCount = (existingUser.orderCount || 0) + 1;
        existingUser.totalSpent = (existingUser.totalSpent || 0) + (order.totalAmount || order.total || 0);
        if (!existingUser.lastOrder || new Date(order.createdAt) > new Date(existingUser.lastOrder)) {
          existingUser.lastOrder = order.createdAt;
        }
      } else {
        // Create new user
        userMap.set(userId, {
          id: userId,
          name: order.user.name || 'Customer',
          email: order.user.email || 'No email',
          phone: order.user.phone || '',
          role: order.user.role || 'customer',
          status: 'active',
          orderCount: 1,
          totalSpent: order.totalAmount || order.total || 0,
          lastOrder: order.createdAt,
          createdAt: order.createdAt
        });
      }
    }
  });
  
  return Array.from(userMap.values()).sort((a, b) => {
    // Sort by: current user first, then by order count, then by name
    if (a.isCurrentUser) return -1;
    if (b.isCurrentUser) return 1;
    return (b.orderCount || 0) - (a.orderCount || 0);
  });
}

function updateStats(users) {
  const total = users.length;
  const active = users.filter(u => u.status === 'active').length;
  const customers = users.filter(u => u.role === 'customer').length;
  const sellers = users.filter(u => u.role === 'seller').length;
  
  document.getElementById('totalUsers').textContent = total;
  document.getElementById('activeUsers').textContent = active;
  document.getElementById('customerCount').textContent = customers;
  document.getElementById('sellerCount').textContent = sellers;
}

/* =================================================
   RENDER & FILTER FUNCTIONS
================================================== */
function applyFilters() {
  const search = document.getElementById("searchInput").value.toLowerCase();
  const roleFilter = document.getElementById("roleFilter").value;
  const statusFilter = document.getElementById("statusFilter").value;
  
  filteredUsers = allUsers.filter(user => {
    // Search filter
    if (search) {
      const searchMatch = 
        (user.name && user.name.toLowerCase().includes(search)) ||
        (user.email && user.email.toLowerCase().includes(search)) ||
        (user.phone && user.phone.toLowerCase().includes(search));
      if (!searchMatch) return false;
    }
    
    // Role filter
    if (roleFilter && user.role !== roleFilter) {
      return false;
    }
    
    // Status filter
    if (statusFilter && user.status !== statusFilter) {
      return false;
    }
    
    return true;
  });
  
  currentPage = 1; // Reset to first page when filtering
  renderUsers();
}

function renderUsers() {
  const tbody = document.getElementById("usersTable");
  
  if (filteredUsers.length === 0) {
    tbody.innerHTML = 
      `<tr><td colspan="6" style="text-align:center;padding: 30px;color: #6b7280;">
        No users match your filters.<br>
        <small>Try changing search or filter criteria</small>
      </td></tr>`;
    updatePagination();
    return;
  }
  
  // Apply pagination
  const startIndex = (currentPage - 1) * limitPerPage;
  const endIndex = startIndex + limitPerPage;
  const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
  
  // Calculate totals
  totalPages = Math.ceil(filteredUsers.length / limitPerPage);
  
  // Generate table rows
  let html = '';
  paginatedUsers.forEach(user => {
    const isCurrent = user.isCurrentUser || user.id === authUser?.id;
    const rowClass = isCurrent ? 'current-user' : '';
    
    // Format last order date
    let lastOrderText = 'No orders';
    if (user.lastOrder) {
      const date = new Date(user.lastOrder);
      lastOrderText = date.toLocaleDateString();
    }
    
    html += `
      <tr class="${rowClass}">
        <td>
          <div style="font-weight:600;">${user.name || "Unknown"}</div>
          ${isCurrent ? '<div style="font-size:0.7em;color:#3b82f6;">(Current User)</div>' : ''}
          ${user.phone ? `<div style="font-size:0.8em;color:#666;">${user.phone}</div>` : ''}
        </td>
        <td>${user.email || "No email"}</td>
        <td><span class="badge ${user.role || 'customer'}">${user.role || 'customer'}</span></td>
        <td><span class="badge ${user.status || 'active'}">${user.status || 'Active'}</span></td>
        <td>
          <div style="font-weight:500;">${user.orderCount || 0}</div>
          ${user.totalSpent ? `<div style="font-size:0.8em;color:#666;">$${user.totalSpent.toFixed(2)} spent</div>` : ''}
          <div style="font-size:0.7em;color:#9ca3af;">Last: ${lastOrderText}</div>
        </td>
        <td>
          <button class="action-btn edit" onclick="editUser('${user.id}')">Edit</button>
          ${!isCurrent ? `<button class="action-btn delete" onclick="deleteUser('${user.id}')">Delete</button>` : ''}
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  updatePagination();
}

function updatePagination() {
  const totalFiltered = filteredUsers.length;
  const startItem = totalFiltered > 0 ? ((currentPage - 1) * limitPerPage) + 1 : 0;
  const endItem = Math.min(currentPage * limitPerPage, totalFiltered);
  
  document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
  document.getElementById("showingCount").textContent = `${startItem}-${endItem}`;
  document.getElementById("totalCount").textContent = totalFiltered;
  
  document.getElementById("prevBtn").disabled = currentPage <= 1;
  document.getElementById("nextBtn").disabled = currentPage >= totalPages;
}

/* =================================================
   EVENT HANDLERS
================================================== */
// Initialize event listeners
document.addEventListener('DOMContentLoaded', () => {
  // Search input with debounce
  let searchTimeout;
  document.getElementById("searchInput").addEventListener("input", () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(applyFilters, 300);
  });
  
  // Filter dropdowns
  document.getElementById("roleFilter").addEventListener("change", applyFilters);
  document.getElementById("statusFilter").addEventListener("change", applyFilters);
  
  // Pagination buttons
  document.getElementById("prevBtn").onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      renderUsers();
    }
  };
  
  document.getElementById("nextBtn").onclick = () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderUsers();
    }
  };
  
  // Auto-load cached data if available
  setTimeout(() => {
    const cached = localStorage.getItem('cached_users');
    const timestamp = localStorage.getItem('cached_users_timestamp');
    const cacheAge = timestamp ? (Date.now() - parseInt(timestamp)) / (1000 * 60 * 60) : 24; // hours
    
    if (cached && cacheAge < 1) { // Use cache if less than 1 hour old
      try {
        allUsers = JSON.parse(cached);
        filteredUsers = [...allUsers];
        updateStats(allUsers);
        renderUsers();
        updateStatus(`Loaded ${allUsers.length} cached users`, 'info');
      } catch (e) {
        console.error("Failed to load cached users:", e);
      }
    }
  }, 1000);
});

/* =================================================
   ACTION BUTTONS
================================================== */
function editUser(userId) {
  const user = allUsers.find(u => u.id === userId);
  if (user) {
    alert(`Edit User: ${user.name}\n\nFeature coming soon!`);
    // In production: window.location.href = `edit-user.html?id=${userId}`;
  }
}

function deleteUser(userId) {
  const user = allUsers.find(u => u.id === userId);
  if (user && confirm(`Are you sure you want to delete ${user.name}?\n\nThis action cannot be undone.`)) {
    alert(`Delete User: ${user.name}\n\nFeature coming soon!`);
    // In production: API call to delete user
  }
}
</script>

</body>
</html>