<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Users â€¢ QuickLocal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Icons -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    /* ================= SIDEBAR ================= */
    .sidebar {
      width: 240px;
      background: #111827;
      color: white;
      padding: 20px;
    }

    .sidebar h2 {
      margin: 0 0 20px;
      font-size: 1.2rem;
    }

    .sidebar a {
      display: block;
      padding: 10px;
      margin-bottom: 6px;
      color: #e5e7eb;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .sidebar a.active,
    .sidebar a:hover {
      background: #4f46e5;
      color: white;
    }

    /* ================= CONTENT ================= */
    .content {
      flex: 1;
      padding: 25px;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    /* ================= FILTERS ================= */
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .filters input,
    .filters select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }

    /* ================= TABLE ================= */
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #e5e7eb;
      font-size: 0.9rem;
      text-align: left;
    }

    th {
      background: #f3f4f6;
    }

    /* ================= BADGES ================= */
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      color: white;
      text-transform: capitalize;
    }

    .badge.admin { background: #7c3aed; }
    .badge.seller { background: #0891b2; }
    .badge.customer { background: #3b82f6; }
    .badge.moderator { background: #db2777; }
    .badge.delivery_agent { background: #f97316; }

    .badge.active { background: #22c55e; }
    .badge.inactive { background: #9ca3af; }
    .badge.suspended { background: #f59e0b; }

    /* ================= PAGINATION ================= */
    .pagination {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
    }

    .pagination button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: white;
      font-size: 0.8rem;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Status messages */
    .status-message {
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }
    .status-info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .status-warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #f59e0b;
    }
    .status-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- ================= SIDEBAR ================= -->
  <aside class="sidebar">
    <h2>QuickLocal Admin</h2>
    <a href="admin-dashboard.html">Dashboard</a>
    <a href="admin-orders.html">Orders</a>
    <a class="active" href="admin-users.html">Users</a>
    <a href="admin-products.html">Products</a>
    <a href="admin-login.html">Logout</a>
  </aside>

  <!-- ================= CONTENT ================= -->
  <main class="content">
    <h1>Manage Users</h1>
    
    <!-- Status Message -->
    <div id="statusMessage" class="status-message status-info">
      Initializing admin users panel...
    </div>

    <!-- FILTERS -->
    <div class="filters">
      <input id="searchInput" type="text" placeholder="Search name or email" />
      <select id="roleFilter">
        <option value="">All Roles</option>
        <option value="admin">Admin</option>
        <option value="seller">Seller</option>
        <option value="customer">Customer</option>
        <option value="moderator">Moderator</option>
        <option value="delivery_agent">Delivery Agent</option>
      </select>
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="suspended">Suspended</option>
      </select>
      <button onclick="loadUsersDirect()" style="padding: 8px 15px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">
        Load Users
      </button>
    </div>

    <!-- TABLE -->
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTable">
        <tr><td colspan="5">Click "Load Users" button above to load users</td></tr>
      </tbody>
    </table>

    <!-- PAGINATION -->
    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextBtn">Next</button>
    </div>
  </main>

</div>

<!-- ðŸ” Hybrid Auth Client (served from backend /public) -->
<script src="https://ecommerce-backend-mlik.onrender.com/hybrid-auth-client.js"></script>

<script>
/* =================================================
   GLOBAL STATE
================================================== */
let currentPage = 1;
let totalPages = 1;
let authUser = null;
let allUsers = [];
const API_BASE_URL = "https://ecommerce-backend-mlik.onrender.com/api/v1";

/* =================================================
   AUTH INITIALIZATION
================================================== */
const auth = new HybridAuthClient({
  autoInitialize: true,
  enableSessionWatcher: true
});

document.addEventListener("auth-ready", (e) => {
  authUser = e.detail?.user;
  console.log("[Admin Users] Auth user:", authUser);
  
  updateStatus(`Logged in as: ${authUser?.name || 'Unknown'} (Role: ${authUser?.role || 'None'})`, 'info');

  if (!authUser) {
    updateStatus("Please login first.", 'warning');
    setTimeout(() => window.location.href = "admin-login.html", 2000);
    return;
  }

  // Auto-load users if admin
  if (authUser.role === 'admin' || authUser.role === 'super_admin') {
    setTimeout(loadUsersDirect, 1000);
  }
});

/* =================================================
   LOAD USERS DIRECT - Bypasses middleware issue
================================================== */
async function loadUsersDirect() {
  updateStatus("Loading users...", 'info');
  
  try {
    // Get token from localStorage (bypass HybridAuthClient issue)
    const token = getAuthToken();
    if (!token) {
      updateStatus("No authentication token found. Please login again.", 'warning');
      return;
    }
    
    console.log("Using token to directly fetch users...");
    
    // Try multiple approaches:
    
    // APPROACH 1: Try to fetch directly with token
    let users = await fetchUsersWithToken(token);
    
    // APPROACH 2: If that fails, try to get users from orders data
    if (users.length === 0) {
      users = await getUsersFromOrders(token);
    }
    
    // APPROACH 3: If still no users, create from auth data
    if (users.length === 0 && authUser) {
      users = [{
        id: authUser.id,
        name: authUser.name,
        email: authUser.email,
        role: authUser.role,
        status: 'active',
        isCurrentUser: true
      }];
    }
    
    if (users.length > 0) {
      allUsers = users;
      renderUsers(users);
      updateStatus(`Loaded ${users.length} users successfully`, 'success');
      updatePagination();
    } else {
      updateStatus("Could not load any users. All methods failed.", 'warning');
    }
    
  } catch (err) {
    console.error("Load users error:", err);
    updateStatus(`Error: ${err.message}`, 'warning');
  }
}

/* =================================================
   HELPER FUNCTIONS
================================================== */
function updateStatus(message, type = 'info') {
  const statusEl = document.getElementById('statusMessage');
  statusEl.textContent = message;
  statusEl.className = `status-message status-${type}`;
  console.log(`Status: ${message}`);
}

function getAuthToken() {
  // Try multiple storage locations
  const token = 
    localStorage.getItem('quicklocal_access_token') ||
    localStorage.getItem('accessToken') ||
    localStorage.getItem('token') ||
    localStorage.getItem('adminToken') ||
    (auth && auth.getToken && auth.getToken()) ||
    sessionStorage.getItem('quicklocal_access_token');
  
  console.log("Found token:", token ? `${token.substring(0, 30)}...` : 'No token');
  return token;
}

async function fetchUsersWithToken(token) {
  try {
    updateStatus("Trying direct API call with token...", 'info');
    
    // Try the main users endpoint with proper headers
    const response = await fetch(`${API_BASE_URL}/users?limit=50`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      credentials: 'include'
    });
    
    console.log("Direct fetch response:", response.status, response.statusText);
    
    if (response.ok) {
      const data = await response.json();
      console.log("Direct fetch success:", data);
      
      // Save to localStorage for offline use
      if (data.users || data.data) {
        const users = data.users || data.data;
        localStorage.setItem('cached_users', JSON.stringify(users));
        localStorage.setItem('cached_users_timestamp', Date.now());
        return users;
      }
    } else if (response.status === 403) {
      // Parse the error for debugging
      try {
        const error = await response.json();
        console.error("Permission error details:", error);
        
        // Try alternative: admin endpoint
        return await tryAdminEndpoint(token);
      } catch (e) {
        console.log("Could not parse error response:", e);
      }
    }
    
  } catch (err) {
    console.error("Direct fetch failed:", err);
  }
  
  return [];
}

async function tryAdminEndpoint(token) {
  try {
    updateStatus("Trying admin endpoint...", 'info');
    
    const response = await fetch(`${API_BASE_URL}/admin/users?limit=50`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log("Admin endpoint success:", data);
      return data.data || data.users || [];
    }
    
  } catch (err) {
    console.error("Admin endpoint failed:", err);
  }
  
  return [];
}

async function getUsersFromOrders(token) {
  try {
    updateStatus("Extracting users from orders data...", 'info');
    
    // Get orders which might be accessible
    const response = await fetch(`${API_BASE_URL}/orders?limit=100`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Accept': 'application/json'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      console.log("Orders data:", data);
      
      // Extract unique users from orders
      const userMap = new Map();
      
      if (data.orders || data.data) {
        const orders = data.orders || data.data;
        orders.forEach(order => {
          if (order.user) {
            userMap.set(order.user._id || order.user, {
              id: order.user._id || order.user,
              name: order.user.name || 'Customer',
              email: order.user.email || 'No email',
              role: 'customer',
              status: 'active',
              orders: (userMap.get(order.user._id || order.user)?.orders || 0) + 1
            });
          }
        });
      }
      
      return Array.from(userMap.values());
    }
    
  } catch (err) {
    console.error("Orders extraction failed:", err);
  }
  
  return [];
}

/* =================================================
   RENDER USERS WITH FILTERING
================================================== */
function renderUsers(users) {
  const tbody = document.getElementById("usersTable");
  tbody.innerHTML = "";

  if (!users || users.length === 0) {
    tbody.innerHTML = 
      `<tr><td colspan="5" style="text-align:center;">
        No users to display.<br>
        <small>Try clicking "Load Users" button</small>
      </td></tr>`;
    return;
  }

  // Apply filters
  const search = document.getElementById("searchInput").value.toLowerCase();
  const roleFilter = document.getElementById("roleFilter").value;
  const statusFilter = document.getElementById("statusFilter").value;
  
  const filteredUsers = users.filter(user => {
    // Search filter
    if (search && !user.name.toLowerCase().includes(search) && 
        !user.email.toLowerCase().includes(search)) {
      return false;
    }
    
    // Role filter
    if (roleFilter && user.role !== roleFilter) {
      return false;
    }
    
    // Status filter
    if (statusFilter) {
      const userStatus = user.status ? user.status.toLowerCase() : 
                        (user.isActive ? 'active' : 'inactive');
      if (userStatus !== statusFilter) {
        return false;
      }
    }
    
    return true;
  });

  // Apply pagination
  const limit = 10;
  const startIndex = (currentPage - 1) * limit;
  const endIndex = startIndex + limit;
  const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
  
  totalPages = Math.ceil(filteredUsers.length / limit);
  updatePagination();

  // Render table rows
  paginatedUsers.forEach(user => {
    const statusClass = user.status ? user.status.toLowerCase() : 
                       (user.isActive ? 'active' : 'inactive');
    const statusText = user.status || (user.isActive ? 'Active' : 'Inactive');
    const role = user.role || 'customer';
    const isCurrent = user.id === authUser?.id;
    
    const tr = document.createElement("tr");
    tr.style.backgroundColor = isCurrent ? '#f0f9ff' : '';
    
    tr.innerHTML = `
      <td>
        <div style="font-weight:600;">${user.name || "Unknown"}</div>
        <div style="font-size:0.8em;color:#666;">${user.phone || ""}</div>
        ${isCurrent ? '<div style="font-size:0.7em;color:#3b82f6;">(You)</div>' : ''}
      </td>
      <td>${user.email || "No email"}</td>
      <td><span class="badge ${role}">${role}</span></td>
      <td><span class="badge ${statusClass}">${statusText}</span></td>
      <td>
        <button onclick="editUser('${user.id}')" style="padding: 4px 8px; font-size: 0.8rem; margin-right: 5px;">Edit</button>
        ${!isCurrent ? `<button onclick="deleteUser('${user.id}')" style="padding: 4px 8px; font-size: 0.8rem; background: #ef4444; color: white;">Delete</button>` : ''}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* =================================================
   PAGINATION
================================================== */
function updatePagination() {
  document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${totalPages}`;
  document.getElementById("prevBtn").disabled = currentPage <= 1;
  document.getElementById("nextBtn").disabled = currentPage >= totalPages;
}

/* =================================================
   EVENTS
================================================== */
let searchTimeout;
document.getElementById("searchInput").addEventListener("input", () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    currentPage = 1;
    if (allUsers.length > 0) {
      renderUsers(allUsers);
    }
  }, 300);
});

document.getElementById("roleFilter").addEventListener("change", () => {
  currentPage = 1;
  if (allUsers.length > 0) {
    renderUsers(allUsers);
  }
});

document.getElementById("statusFilter").addEventListener("change", () => {
  currentPage = 1;
  if (allUsers.length > 0) {
    renderUsers(allUsers);
  }
});

document.getElementById("prevBtn").onclick = () => {
  if (currentPage > 1) {
    currentPage--;
    renderUsers(allUsers);
  }
};

document.getElementById("nextBtn").onclick = () => {
  if (currentPage < totalPages) {
    currentPage++;
    renderUsers(allUsers);
  }
};

/* =================================================
   ACTION BUTTONS
================================================== */
function editUser(userId) {
  alert(`Edit user ${userId} - Feature coming soon`);
  // In production: window.location.href = `edit-user.html?id=${userId}`;
}

function deleteUser(userId) {
  if (confirm("Are you sure you want to delete this user?")) {
    alert(`Delete user ${userId} - Feature coming soon`);
    // In production: API call to delete user
  }
}

/* =================================================
   INITIAL LOAD
================================================== */
// Auto-load after 2 seconds if auth is ready
setTimeout(() => {
  if (authUser && (authUser.role === 'admin' || authUser.role === 'super_admin')) {
    loadUsersDirect();
  }
}, 2000);
</script>

</body>
</html>