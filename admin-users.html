<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Users • QuickLocal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 240px;
      background: #111827;
      color: white;
      padding: 20px;
    }
    .sidebar h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.2rem;
    }
    .sidebar a {
      display: block;
      padding: 10px;
      margin-bottom: 6px;
      color: #e5e7eb;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .sidebar a.active, .sidebar a:hover {
      background: #4f46e5;
      color: white;
    }
    .content {
      flex: 1;
      padding: 25px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.4rem;
      margin-bottom: 15px;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .filters input, .filters select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
    }
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table th, table td {
      padding: 10px;
      border: 1px solid #e5e5e5;
      font-size: 0.9rem;
      text-align: left;
    }
    table th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      color: white;
      text-transform: capitalize;
    }
    /* Role Badges */
    .badge.admin { background: #7c3aed; }
    .badge.seller { background: #0891b2; }
    .badge.customer { background: #3b82f6; }
    .badge.moderator { background: #db2777; }
    .badge.delivery_agent { background: #f97316; }
    
    /* Status Badges */
    .badge.active { background: #22c55e; }
    .badge.inactive { background: #9ca3af; }
    .badge.suspended { background: #f59e0b; }
    
    .action-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #4f46e5;
      color: white;
    }
    .pagination {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 0.85rem;
    }
    .pagination button {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: white;
      font-size: 0.8rem;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: default;
    }
  </style>
</head>
<body>
<div class="container">

  <aside class="sidebar">
    <h2>QuickLocal Admin</h2>
    <a href="admin-dashboard.html">Dashboard</a>
    <a href="admin-orders.html">Orders</a>
    <a class="active" href="admin-users.html">Users</a>
    <a href="admin-products.html">Products</a>
    <a href="admin-login.html" id="logoutLink">Logout</a>
  </aside>

  <main class="content">
    <h1>Manage Users</h1>

    <div class="filters">
      <input id="searchInput" type="text" placeholder="Search name, email, phone..." />
      <select id="roleFilter">
        <option value="">All Roles</option>
        <option value="customer">Customer</option>
        <option value="seller">Seller</option>
        <option value="admin">Admin</option>
        <option value="moderator">Moderator</option>
        <option value="delivery_agent">Delivery Agent</option>
      </select>
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>

    <table id="usersTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Role</th>
          <th>Status</th>
          <th>Joined</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="7" style="text-align:center;">Loading users...</td></tr>
      </tbody>
    </table>

    <div class="pagination">
      <button id="prevBtn">Prev</button>
      <button id="nextBtn">Next</button>
      <span id="pageInfo"></span>
    </div>
  </main>
</div>

<script>
  // ---------- CONFIG ----------
  const API_BASE = "https://ecommerce-backend-mlik.onrender.com";
  // We define both endpoints to be robust
  const ADMIN_API = API_BASE + "/api/v1/admin";
  const USERS_API = API_BASE + "/api/v1/users";

  let currentPage = 1;
  let totalPages = 1;

  // ---------- LOAD USERS ----------
  async function loadUsers(page = 1) {
    const token = localStorage.getItem("adminToken");
    if (!token) {
      alert("Please login as admin.");
      window.location.href = "admin-login.html";
      return;
    }

    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "<tr><td colspan='7' style='text-align:center'>Loading users...</td></tr>";

    const search = document.getElementById('searchInput').value.trim();
    const role = document.getElementById('roleFilter').value;
    const status = document.getElementById('statusFilter').value;

    const params = new URLSearchParams({
      page: page.toString(),
      limit: "20"
    });

    if (search) params.append("search", search);
    if (role) params.append("role", role);
    if (status) params.append("status", status);

    try {
      // 1. Try the Dedicated Admin Endpoint first
      let res = await fetch(`${ADMIN_API}/users?` + params.toString(), {
        headers: {
          "Authorization": "Bearer " + token,
          "Accept": "application/json"
        }
      });

      // 2. If 404 (Route missing), Fallback to Standard Users Endpoint
      if (res.status === 404) {
        console.warn("Admin route /admin/users missing (404). Falling back to /users...");
        res = await fetch(`${USERS_API}?` + params.toString(), {
          headers: {
            "Authorization": "Bearer " + token,
            "Accept": "application/json"
          }
        });
      }

      if (res.status === 401 || res.status === 403) {
        alert("Session expired. Please login again.");
        window.location.href = "admin-login.html";
        return;
      }

      const data = await res.json();
      console.log("Users API response:", data);

      if (!res.ok || data.success === false) {
        console.error("Users API error:", data);
        renderUsers([]);
        updatePagination(1, 1, 0);
        return;
      }

      // 3. Normalise Data (Handle different response structures)
      let users = [];
      let pagination = {};
      let totalCount = 0;

      // Handle Admin.js style response
      if (Array.isArray(data.data)) {
        users = data.data;
        pagination = data.pagination || {};
        totalCount = pagination.totalUsers || pagination.total || users.length;
      } 
      // Handle Users.js style response
      else if (data.data && Array.isArray(data.data.users)) {
        users = data.data.users;
        pagination = data.data.pagination || data.pagination || {};
        totalCount = pagination.totalUsers || pagination.total || users.length;
      } 
      // Fallback
      else if (data.users && Array.isArray(data.users)) {
        users = data.users;
        totalCount = users.length;
      }

      currentPage = pagination.currentPage || pagination.page || page || 1;
      totalPages = pagination.totalPages || pagination.pages || Math.ceil(totalCount / 20) || 1;

      renderUsers(users);
      updatePagination(currentPage, totalPages, totalCount);

    } catch (err) {
      console.error("Load users error:", err);
      tbody.innerHTML = `<tr><td colspan='7' style='color:red; text-align:center'>Error loading users: ${err.message}</td></tr>`;
    }
  }

  // ---------- RENDER USERS ----------
  function renderUsers(users) {
    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";

    if (!users || users.length === 0) {
      tbody.innerHTML = "<tr><td colspan='7' style='text-align:center'>No users found.</td></tr>";
      return;
    }

    users.forEach(u => {
      const tr = document.createElement("tr");

      const name = u.name || "Unknown";
      const email = u.email || "—";
      const phone = u.phone || "—";
      const role = u.role || "customer";
      
      // Determine status safely
      let status = "active";
      if (u.status) status = u.status;
      else if (u.isActive === false) status = "inactive";
      else if (u.accountStatus) status = u.accountStatus;
      
      const joined = u.createdAt ? new Date(u.createdAt).toLocaleDateString() : "—";
      const id = u._id || u.id;

      tr.innerHTML = `
        <td>${name}</td>
        <td>${email}</td>
        <td>${phone}</td>
        <td><span class="badge ${role}">${role}</span></td>
        <td><span class="badge ${status}">${status}</span></td>
        <td>${joined}</td>
        <td>
          <button class="action-btn" onclick="updateUser('${id}', '${role}', '${status}')">
            Update
          </button>
        </td>
      `;

      tbody.appendChild(tr);
    });
  }

  // ---------- UPDATE USER ----------
  async function updateUser(id, currentRole, currentStatus) {
    const token = localStorage.getItem("adminToken");
    if (!token) {
      alert("Please login as admin.");
      window.location.href = "admin-login.html";
      return;
    }

    const newRoleInput = prompt(
      `Current Role: ${currentRole}\n\nEnter new role (customer / seller / admin / moderator / delivery_agent) or leave blank to keep same:`
    );
    
    const newStatusInput = prompt(
      `Current Status: ${currentStatus}\n\nEnter new status (active / inactive / suspended) or leave blank to keep same:`
    );

    if ((!newRoleInput || newRoleInput.trim() === "") && (!newStatusInput || newStatusInput.trim() === "")) {
      return; 
    }

    const body = {};
    if (newRoleInput && newRoleInput.trim() !== "") body.role = newRoleInput.trim().toLowerCase();
    
    if (newStatusInput && newStatusInput.trim() !== "") {
      const s = newStatusInput.trim().toLowerCase();
      body.status = s;
      // Handle active/inactive mapping
      if (s === 'active') body.isActive = true;
      if (s === 'inactive') body.isActive = false;
    }

    try {
      // 1. Try Admin Endpoint
      let url = `${ADMIN_API}/users/${encodeURIComponent(id)}`;
      let method = "PUT";
      
      let res = await fetch(url, {
        method: method,
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(body)
      });

      // 2. If Admin Endpoint fails (404) and we are changing role, try Users Endpoint
      if (res.status === 404 && body.role) {
         console.log("Admin update failed, trying users role endpoint...");
         url = `${USERS_API}/${encodeURIComponent(id)}/role`;
         res = await fetch(url, {
            method: "PATCH",
            headers: {
              "Authorization": "Bearer " + token,
              "Content-Type": "application/json",
              "Accept": "application/json"
            },
            body: JSON.stringify({ role: body.role })
         });
      }

      const data = await res.json().catch(() => ({}));

      if (!res.ok || data.success === false) {
        alert("Update failed: " + (data.message || "Unknown error"));
        return;
      }

      alert("User updated successfully!");
      loadUsers(currentPage);
    } catch (err) {
      console.error("Update error:", err);
      alert("Error updating user: " + err.message);
    }
  }

  // ---------- PAGINATION ----------
  function updatePagination(current, total, count) {
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");

    prevBtn.disabled = current <= 1;
    nextBtn.disabled = current >= total;

    pageInfo.textContent = `Page ${current} of ${total} • ${count} users`;
  }

  // ---------- EVENTS ----------
  document.addEventListener("DOMContentLoaded", () => {
    // Logout Handler
    document.getElementById("logoutLink").addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("adminToken");
      localStorage.removeItem("adminUser");
      window.location.href = "admin-login.html";
    });

    // Filters
    document.getElementById("searchInput").addEventListener("input", () => loadUsers(1));
    document.getElementById("roleFilter").addEventListener("change", () => loadUsers(1));
    document.getElementById("statusFilter").addEventListener("change", () => loadUsers(1));

    // Pagination
    document.getElementById("prevBtn").addEventListener("click", () => {
      if (currentPage > 1) loadUsers(currentPage - 1);
    });
    document.getElementById("nextBtn").addEventListener("click", () => {
      if (currentPage < totalPages) loadUsers(currentPage + 1);
    });

    // Init
    loadUsers(1);
  });
</script>
</body>
</html>