<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🛒 Checkout - Your Order</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .checkout-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .checkout-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .checkout-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .checkout-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            padding: 40px;
        }

        .checkout-form {
            max-width: 100%;
        }

        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .form-section:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .form-section h2 {
            color: #333;
            margin-bottom: 25px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input.error, select.error {
            border-color: #e74c3c;
            background: #fdf2f2;
        }

        input.success, select.success {
            border-color: #2ecc71;
            background: #f2fdf2;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* Address Management Styles */
        .address-management {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(52, 152, 219, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(52, 152, 219, 0.2);
        }

        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: end;
            margin-bottom: 20px;
            gap: 20px;
        }

        .saved-addresses-section {
            flex: 1;
        }

        .address-selector {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: white;
            font-size: 14px;
        }

        .add-address-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .add-address-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .saved-address-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .saved-address-item:hover {
            border-color: #3498db;
            transform: translateX(5px);
        }

        .address-info {
            flex: 1;
        }

        .address-info h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .address-info p {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .address-actions {
            display: flex;
            gap: 8px;
        }

        .address-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .select-btn { background: #3498db; color: white; }
        .edit-btn { background: #f39c12; color: white; }
        .delete-btn { background: #e74c3c; color: white; }

        .address-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .save-address-checkbox {
            margin: 20px 0;
            padding: 15px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 8px;
            border: 1px solid #2ecc71;
        }

        .save-address-checkbox label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: #27ae60;
            font-weight: 600;
        }

        .payment-methods {
            display: grid;
            gap: 15px;
        }

        .payment-option {
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .payment-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .payment-option input[type="radio"] {
            margin-right: 15px;
            width: auto;
        }

        .payment-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0;
            font-size: 1.1rem;
        }

        .order-summary {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .order-summary h2 {
            color: #333;
            margin-bottom: 25px;
            text-align: center;
        }

        .cart-items {
            margin-bottom: 25px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .item-info h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .item-info p {
            color: #666;
            font-size: 14px;
        }

        .item-price {
            font-weight: 600;
            color: #667eea;
        }

        .order-totals {
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .total-row.final {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            border-top: 1px solid #ddd;
            padding-top: 15px;
            margin-top: 15px;
        }

        .checkout-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 25px;
        }

        .checkout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .checkout-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .security-badges {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .security-badge {
            text-align: center;
            font-size: 12px;
            color: #666;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.success { background: #2ecc71; }
        .toast.error { background: #e74c3c; }
        .toast.info { background: #3498db; }

        .toast.show { transform: translateX(0); }

        /* Loading screen styles from your original file */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .loading-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .checkout-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .address-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .add-address-btn {
                width: 100%;
            }

            .address-actions {
                flex-direction: column;
                gap: 5px;
            }

            .saved-address-item {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen (from your original file) -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">🛒 Preparing Your Checkout</div>
            <div class="loading-subtext">Setting up secure payment process...</div>
        </div>
    </div>

    <div class="container">
        <div class="checkout-header">
            <h1>🛒 Checkout</h1>
            <p>Complete your purchase securely</p>
        </div>

        <div class="checkout-content">
            <div class="checkout-form">
                <!-- Address Management Section -->
                <div class="form-section">
                    <h2>📋 Billing Information</h2>
                    
                    <div class="address-management" id="address-management">
                        <div class="address-header">
                            <div class="saved-addresses-section">
                                <label>📍 Saved Addresses</label>
                                <select id="saved-addresses" class="address-selector">
                                    <option value="">Select a saved address</option>
                                </select>
                            </div>
                            <button type="button" class="add-address-btn" onclick="addressManager.toggleAddressForm()">
                                + Add New Address
                            </button>
                        </div>
                        
                        <div class="saved-addresses-list" id="saved-addresses-list">
                            <!-- Saved addresses will be rendered here -->
                        </div>
                    </div>

                    <form id="checkout-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="name">Full Name *</label>
                                <input type="text" id="name" name="name" required>
                                <div class="error-message" id="name-error">Please enter your full name</div>
                            </div>
                            <div class="form-group">
                                <label for="email">Email Address *</label>
                                <input type="email" id="email" name="email" required>
                                <div class="error-message" id="email-error">Please enter a valid email</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="phone">Phone Number *</label>
                                <input type="tel" id="phone" name="phone" required>
                                <div class="error-message" id="phone-error">Please enter a valid phone number</div>
                            </div>
                            <div class="form-group">
                                <label for="country">Country *</label>
                                <select id="country" name="country" required>
                                    <option value="">Select Country</option>
                                    <option value="India" selected>India</option>
                                    <option value="USA">United States</option>
                                    <option value="UK">United Kingdom</option>
                                    <option value="Canada">Canada</option>
                                    <option value="Australia">Australia</option>
                                </select>
                                <div class="error-message" id="country-error">Please select your country</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="address">Street Address *</label>
                            <textarea id="address" name="address" rows="3" placeholder="House/Flat number, Building name, Street name" required></textarea>
                            <div class="error-message" id="address-error">Please enter your address</div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">City *</label>
                                <input type="text" id="city" name="city" required>
                                <div class="error-message" id="city-error">Please enter your city</div>
                            </div>
                            <div class="form-group">
                                <label for="state">State/Province *</label>
                                <input type="text" id="state" name="state" required>
                                <div class="error-message" id="state-error">Please enter your state</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="pincode">PIN/ZIP Code *</label>
                                <input type="text" id="pincode" name="pincode" required>
                                <div class="error-message" id="pincode-error">Please enter a valid PIN code</div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Payment Method Section -->
                <div class="form-section">
                    <h2>💳 Payment Method</h2>
                    <div class="payment-methods">
                        <div class="payment-option" onclick="selectPayment('card')">
                            <label>
                                <input type="radio" name="payment" value="card" checked>
                                💳 Credit/Debit Card
                            </label>
                        </div>
                        <div class="payment-option" onclick="selectPayment('upi')">
                            <label>
                                <input type="radio" name="payment" value="upi">
                                📱 UPI Payment
                            </label>
                        </div>
                        <div class="payment-option" onclick="selectPayment('netbanking')">
                            <label>
                                <input type="radio" name="payment" value="netbanking">
                                🏦 Net Banking
                            </label>
                        </div>
                        <div class="payment-option" onclick="selectPayment('cod')">
                            <label>
                                <input type="radio" name="payment" value="cod">
                                💵 Cash on Delivery
                            </label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="checkout-btn" id="checkout-btn">
                    🔒 Place Order Securely
                </button>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <h2>📦 Order Summary</h2>
                
                <div class="cart-items" id="cart-items">
                    <!-- Cart items will be loaded here -->
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading cart items...</p>
                    </div>
                </div>

                <div class="order-totals">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">₹0.00</span>
                    </div>
                    <div class="total-row">
                        <span>Shipping:</span>
                        <span id="shipping">₹50.00</span>
                    </div>
                    <div class="total-row">
                        <span>Tax (18%):</span>
                        <span id="tax">₹0.00</span>
                    </div>
                    <div class="total-row final">
                        <span>Total:</span>
                        <span id="total">₹0.00</span>
                    </div>
                </div>

                <div class="security-badges">
                    <div class="security-badge">
                        🔒<br>SSL Secured
                    </div>
                    <div class="security-badge">
                        🛡️<br>Safe Payment
                    </div>
                    <div class="security-badge">
                        ✅<br>Verified
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Loading screen logic (from your original file)
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.style.opacity = '0';
                setTimeout(function() {
                    loadingScreen.style.display = 'none';
                }, 500);
            }, 2000);
        });

        class CheckoutManager {
            constructor() {
                this.form = document.getElementById('checkout-form');
                this.submitBtn = document.getElementById('checkout-btn');
                this.cart = this.loadCart();
                this.init();
            }

            init() {
                this.setupFormValidation();
                this.setupFormSubmission();
                this.renderCartItems();
                this.calculateTotals();
                this.setupPaymentMethods();
            }

            loadCart() {
                // In a real application, this would load from localStorage or API
                const mockCart = [
                    {
                        id: 1,
                        name: "Premium Headphones",
                        price: 2999,
                        quantity: 1,
                        image: "🎧"
                    },
                    {
                        id: 2,
                        name: "Wireless Mouse",
                        price: 1499,
                        quantity: 2,
                        image: "🖱️"
                    },
                    {
                        id: 3,
                        name: "USB-C Cable",
                        price: 699,
                        quantity: 1,
                        image: "🔌"
                    }
                ];

                // Try to load from localStorage, fallback to mock data
                return JSON.parse(localStorage.getItem('cart') || JSON.stringify(mockCart));
            }

            renderCartItems() {
                const container = document.getElementById('cart-items');
                const loading = container.querySelector('.loading');
                
                setTimeout(() => {
                    if (loading) loading.style.display = 'none';
                    
                    if (this.cart.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">Your cart is empty</p>';
                        return;
                    }

                    container.innerHTML = this.cart.map(item => `
                        <div class="cart-item">
                            <div class="item-info">
                                <h4>${item.image} ${item.name}</h4>
                                <p>Quantity: ${item.quantity}</p>
                            </div>
                            <div class="item-price">₹${(item.price * item.quantity).toLocaleString()}</div>
                        </div>
                    `).join('');
                }, 1000);
            }

            calculateTotals() {
                const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const shipping = subtotal > 5000 ? 0 : 50; // Free shipping over ₹5000
                const tax = Math.round(subtotal * 0.18);
                const total = subtotal + shipping + tax;

                document.getElementById('subtotal').textContent = `₹${subtotal.toLocaleString()}`;
                document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : `₹${shipping}`;
                document.getElementById('tax').textContent = `₹${tax.toLocaleString()}`;
                document.getElementById('total').textContent = `₹${total.toLocaleString()}`;
            }

            setupFormValidation() {
                const inputs = this.form.querySelectorAll('input, select, textarea');
                
                inputs.forEach(input => {
                    input.addEventListener('input', () => this.validateField(input));
                    input.addEventListener('blur', () => this.validateField(input));
                });
            }

            validateField(field) {
                const value = field.value.trim();
                const name = field.name;
                let isValid = true;
                let errorMessage = '';

                // Remove existing validation classes
                field.classList.remove('error', 'success');

                switch (name) {
                    case 'name':
                        isValid = value.length >= 2;
                        errorMessage = 'Name must be at least 2 characters';
                        break;
                    case 'email':
                        isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
                        errorMessage = 'Please enter a valid email address';
                        break;
                    case 'phone':
                        isValid = /^[6-9]\d{9}$/.test(value);
                        errorMessage = 'Please enter a valid 10-digit phone number';
                        break;
                    case 'pincode':
                        isValid = /^[1-9][0-9]{5}$/.test(value);
                        errorMessage = 'Please enter a valid 6-digit PIN code';
                        break;
                    default:
                        isValid = value.length > 0;
                        errorMessage = 'This field is required';
                }

                const errorElement = document.getElementById(`${name}-error`);
                if (errorElement) {
                    if (isValid) {
                        errorElement.style.display = 'none';
                        field.classList.add('success');
                    } else {
                        errorElement.style.display = 'block';
                        errorElement.textContent = errorMessage;
                        field.classList.add('error');
                    }
                }

                return isValid;
            }

            setupFormSubmission() {
                this.form.addEventListener('submit', (e) => this.handleCheckout(e));
            }

            async handleCheckout(e) {
                e.preventDefault();
                
                // Validate all fields
                const inputs = this.form.querySelectorAll('input[required], select[required], textarea[required]');
                let isFormValid = true;

                inputs.forEach(input => {
                    if (!this.validateField(input)) {
                        isFormValid = false;
                    }
                });

                if (!isFormValid) {
                    this.showToast('Please fix the errors in the form', 'error');
                    return;
                }

                // Save address if checkbox is checked
                if (addressManager) {
                    addressManager.onFormSubmit();
                }

                // Show loading state
                this.submitBtn.disabled = true;
                this.submitBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; display: inline-block; margin-right: 10px;"></div>Processing...';

                try {
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // In a real application, you would:
                    // 1. Send form data to your backend
                    // 2. Process payment
                    // 3. Create order
                    // 4. Send confirmation email
                    // 5. Redirect to success page

                    this.showToast('Order placed successfully! 🎉', 'success');
                    
                    // Redirect to success page
                    setTimeout(() => {
                        window.location.href = '/order-success.html';
                    }, 2000);

                } catch (error) {
                    this.showToast('Order failed. Please try again.', 'error');
                    console.error('Checkout error:', error);
                } finally {
                    this.submitBtn.disabled = false;
                    this.submitBtn.innerHTML = '🔒 Place Order Securely';
                }
            }

            setupPaymentMethods() {
                const paymentOptions = document.querySelectorAll('.payment-option');
                paymentOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        paymentOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        option.querySelector('input[type="radio"]').checked = true;
                    });
                });

                // Set first option as selected by default
                if (paymentOptions[0]) {
                    paymentOptions[0].classList.add('selected');
                }
            }

            showToast(message, type = 'info') {
                // Remove existing toast
                const existingToast = document.querySelector('.toast');
                if (existingToast) {
                    existingToast.remove();
                }

                // Create new toast
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                // Show toast
                setTimeout(() => toast.classList.add('show'), 100);

                // Hide toast after 4 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 4000);
            }
        }

        class AddressManager {
            constructor() {
                this.savedAddresses = this.loadAddresses();
                this.currentEditId = null;
                this.init();
            }

            init() {
                this.renderSavedAddresses();
                this.setupAddressEventListeners();
                this.addSaveAddressCheckbox();
            }

            loadAddresses() {
                // In a real implementation, this would load from localStorage or server
                const mockAddresses = JSON.parse(localStorage.getItem('saved_addresses') || '[]');
                
                // Add some demo addresses if none exist
                if (mockAddresses.length === 0) {
                    return [
                        {
                            id: 'addr_1',
                            name: 'Home',
                            fullName: 'John Doe',
                            email: 'john@example.com',
                            phone: '9876543210',
                            address: '123 Main Street, Apartment 4B',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001',
                            country: 'India'
                        },
                        {
                            id: 'addr_2',
                            name: 'Office',
                            fullName: 'John Doe',
                            email: 'john.work@example.com',
                            phone: '9876543210',
                            address: '456 Business Park, Floor 10',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400051',
                            country: 'India'
                        }
                    ];
                }
                return mockAddresses;
            }

            saveAddresses() {
                localStorage.setItem('saved_addresses', JSON.stringify(this.savedAddresses));
            }

            renderSavedAddresses() {
                // Update dropdown
                const selector = document.getElementById('saved-addresses');
                if (selector) {
                    selector.innerHTML = '<option value="">Select a saved address</option>';
                    this.savedAddresses.forEach(addr => {
                        const option = document.createElement('option');
                        option.value = addr.id;
                        option.textContent = `${addr.name} - ${addr.city}`;
                        selector.appendChild(option);
                    });
                }

                // Update addresses list
                const list = document.getElementById('saved-addresses-list');
                if (list) {
                    if (this.savedAddresses.length === 0) {
                        list.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No saved addresses yet</p>';
                    } else {
                        list.innerHTML = this.savedAddresses.map(addr => `
                            <div class="saved-address-item">
                                <div class="address-info">
                                    <h4>🏠 ${addr.name}</h4>
                                    <p><strong>${addr.fullName}</strong> | ${addr.phone}</p>
                                    <p>${addr.address}</p>
                                    <p>${addr.city}, ${addr.state} - ${addr.pincode}</p>
                                </div>
                                <div class="address-actions">
                                    <button class="address-btn select-btn" onclick="addressManager.selectAddress('${addr.id}')">
                                        Select
                                    </button>
                                    <button class="address-btn edit-btn" onclick="addressManager.editAddress('${addr.id}')">
                                        Edit
                                    </button>
                                    <button class="address-btn delete-btn" onclick="addressManager.deleteAddress('${addr.id}')">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            }

            setupAddressEventListeners() {
                // Dropdown selection
                const selector = document.getElementById('saved-addresses');
                if (selector) {
                    selector.addEventListener('change', (e) => {
                        if (e.target.value) {
                            this.selectAddress(e.target.value);
                        }
                    });
                }
            }

            addSaveAddressCheckbox() {
                // Add checkbox to save current address
                const form = document.getElementById('checkout-form');
                const submitButton = form.parentElement.querySelector('.checkout-btn');
                
                const checkboxHtml = `
                    <div class="save-address-checkbox" id="save-address-section">
                        <label>
                            <input type="checkbox" id="save-address-checkbox">
                            💾 Save this address for future orders
                        </label>
                    </div>
                `;
                
                submitButton.insertAdjacentHTML('beforebegin', checkboxHtml);
            }

            selectAddress(addressId) {
                const address = this.savedAddresses.find(addr => addr.id === addressId);
                if (address) {
                    this.fillForm(address);
                    checkoutManager.showToast(`Address "${address.name}" selected`, 'success');
                }
            }

            fillForm(address) {
                const form = document.getElementById('checkout-form');
                const fields = {
                    'name': address.fullName,
                    'email': address.email,
                    'phone': address.phone,
                    'address': address.address,
                    'city': address.city,
                    'state': address.state,
                    'pincode': address.pincode,
                    'country': address.country
                };

                Object.entries(fields).forEach(([fieldName, value]) => {
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        field.value = value;
                        // Trigger validation
                        field.dispatchEvent(new Event('input'));
                    }
                });
            }

            toggleAddressForm() {
                const formData = this.getFormData();
                
                if (this.isFormEmpty(formData)) {
                    checkoutManager.showToast('Please fill in the address form first', 'error');
                    return;
                }

                this.saveCurrentAddress(formData);
            }

            getFormData() {
                const form = document.getElementById('checkout-form');
                return {
                    fullName: form.querySelector('[name="name"]').value,
                    email: form.querySelector('[name="email"]').value,
                    phone: form.querySelector('[name="phone"]').value,
                    address: form.querySelector('[name="address"]').value,
                    city: form.querySelector('[name="city"]').value,
                    state: form.querySelector('[name="state"]').value,
                    pincode: form.querySelector('[name="pincode"]').value,
                    country: form.querySelector('[name="country"]').value
                };
            }

            isFormEmpty(formData) {
                return !formData.fullName || !formData.email || !formData.phone || 
                       !formData.address || !formData.city || !formData.state || !formData.pincode;
            }

            saveCurrentAddress(formData) {
                const addressName = prompt('Enter a name for this address (e.g., Home, Office):');
                if (!addressName) return;

                // Check if address already exists
                const existingAddress = this.savedAddresses.find(addr => 
                    addr.address === formData.address && addr.pincode === formData.pincode
                );

                if (existingAddress) {
                    checkoutManager.showToast('This address is already saved', 'info');
                    return;
                }

                const newAddress = {
                    id: 'addr_' + Date.now(),
                    name: addressName,
                    ...formData
                };

                this.savedAddresses.push(newAddress);
                this.saveAddresses();
                this.renderSavedAddresses();
                
                checkoutManager.showToast(`Address "${addressName}" saved successfully!`, 'success');
            }

            editAddress(addressId) {
                const address = this.savedAddresses.find(addr => addr.id === addressId);
                if (address) {
                    this.fillForm(address);
                    this.currentEditId = addressId;
                    checkoutManager.showToast('Address loaded for editing', 'info');
                }
            }

            deleteAddress(addressId) {
                if (confirm('Are you sure you want to delete this address?')) {
                    const addressIndex = this.savedAddresses.findIndex(addr => addr.id === addressId);
                    if (addressIndex > -1) {
                        const deletedAddress = this.savedAddresses.splice(addressIndex, 1)[0];
                        this.saveAddresses();
                        this.renderSavedAddresses();
                        checkoutManager.showToast(`Address "${deletedAddress.name}" deleted`, 'info');
                    }
                }
            }

            // Method to save address when form is submitted with checkbox checked
            onFormSubmit() {
                const saveCheckbox = document.getElementById('save-address-checkbox');
                if (saveCheckbox && saveCheckbox.checked) {
                    const formData = this.getFormData();
                    if (!this.isFormEmpty(formData)) {
                        this.saveCurrentAddress(formData);
                    }
                }
            }
        }

        // Helper function for payment selection
        function selectPayment(method) {
            const radio = document.querySelector(`input[value="${method}"]`);
            if (radio) radio.checked = true;
        }

        // Initialize both managers
        let checkoutManager;
        let addressManager;

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                checkoutManager = new CheckoutManager();
                addressManager = new AddressManager();
            });
        } else {
            checkoutManager = new CheckoutManager();
            addressManager = new AddressManager();
        }
    </script>
</body>
</html>
