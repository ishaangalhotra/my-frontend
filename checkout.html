<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>🔒 Secure Checkout - QuickLocal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --primary-light: #a5b4fc;
            --secondary: #f59e0b;
            --accent: #10b981;
            --accent-dark: #059669;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-light: #94a3b8;
            --text-inverse: #ffffff;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            --radius-lg: 1rem;
            --radius-2xl: 2rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-secondary); color: var(--text-primary); line-height: 1.6; }
        header { position: sticky; top: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); z-index: 1000; }
        .nav-container { max-width:1400px; margin: 0 auto; padding: 1rem 2rem; }
        .nav { display:flex; align-items:center; justify-content:space-between; }
        .logo { font-size:1.875rem; font-weight:900; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; display:flex; align-items:center; gap:0.5rem; text-decoration:none; color:inherit; }
        .breadcrumb { background:white; padding:1rem 0; border-bottom:1px solid var(--border); }
        .breadcrumb-container { max-width:1400px; margin:0 auto; padding:0 2rem; }
        .breadcrumb-nav { display:flex; align-items:center; gap:0.75rem; color:var(--text-secondary); font-weight:500; }
        .breadcrumb-nav a { color:var(--primary); text-decoration:none; }
        .checkout-page { max-width:1400px; margin:0 auto; padding:2rem; }
        .checkout-header { text-align:center; margin-bottom:3rem; }
        .checkout-title { font-size:3rem; font-weight:900; margin-bottom:0.5rem; display:flex; align-items:center; justify-content:center; gap:1rem; }
        .checkout-subtitle { font-size:1.125rem; color:var(--text-secondary); }
        .checkout-layout { display:grid; grid-template-columns:2fr 1fr; gap:3rem; align-items:start; }
        .checkout-form, .order-summary { background:white; border-radius:var(--radius-2xl); padding:2rem; box-shadow:var(--shadow-lg); border:1px solid var(--border); }
        .order-summary { position:sticky; top:2rem; }
        .form-section { margin-bottom:2.5rem; }
        .section-title { font-size:1.5rem; font-weight:700; margin-bottom:1.5rem; display:flex; align-items:center; gap:0.75rem; }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:1.5rem; }
        .form-group { position:relative; display:flex; flex-direction:column; gap:0.5rem; }
        .form-label { font-weight:600; color:var(--text-secondary); font-size:0.9rem; }
        .form-input { padding:1rem; border:2px solid var(--border); border-radius:var(--radius-lg); font-size:1rem; transition:var(--transition); }
        .form-input:focus { outline:none; border-color:var(--primary); box-shadow: var(--shadow-glow); }
        .field-error { color:var(--error); font-size:0.875rem; font-weight:500; min-height:1em; margin-top:0.25rem; }
        .payment-methods { display:grid; gap:1rem; }
        .payment-option { border:2px solid var(--border); border-radius:var(--radius-lg); padding:1.5rem; cursor:pointer; display:flex; align-items:center; gap:1rem; transition:var(--transition-bounce); }
        .payment-option:hover { border-color:var(--primary); transform:translateY(-2px); box-shadow:var(--shadow-md); }
        .payment-option.selected { border-color:var(--primary); background: rgba(99,102,241,0.05); box-shadow:var(--shadow-glow); }
        .card-payment-form { margin-top:1.5rem; padding:1.5rem; background:var(--bg-secondary); border-radius:var(--radius-lg); border:1px solid var(--border); display:none; }
        .card-payment-form.active { display:block; }
        .summary-totals { border-top:2px solid var(--border-light); padding-top:1.5rem; }
        .total-row { display:flex; justify-content:space-between; padding:0.5rem 0; font-weight:500; }
        .total-row.final { font-size:1.25rem; font-weight:900; border-top:1px solid var(--border); padding-top:1rem; margin-top:1rem; }
        .place-order-btn { width:100%; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color:white; border:none; padding:1.25rem; border-radius:var(--radius-lg); font-size:1.125rem; font-weight:700; cursor:pointer; transition:var(--transition-bounce); display:flex; align-items:center; justify-content:center; gap:0.75rem; margin-top:1.5rem; }
        .place-order-btn:disabled { opacity:0.6; cursor:not-allowed; }
        .loading-container, .empty-checkout { padding:4rem 2rem; background:white; border-radius:var(--radius-2xl); box-shadow:var(--shadow-lg); text-align:center; }
        .loading-spinner { width:50px; height:50px; border:4px solid var(--border); border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 1rem; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .address-autocomplete { position:absolute; top:100%; left:0; right:0; background:white; border:1px solid var(--border); border-radius:var(--radius-lg); box-shadow:var(--shadow-lg); z-index:100; max-height:200px; overflow-y:auto; display:none; }
        .address-suggestion { padding:0.75rem 1rem; cursor:pointer; border-bottom:1px solid var(--border-light); }
        .address-suggestion:hover { background:var(--bg-secondary); }
        #toastContainer { position:fixed; top:2rem; right:2rem; z-index:9999; }
        .toast { background:white; padding:1rem 1.5rem; border-radius:var(--radius-lg); box-shadow:var(--shadow-xl); margin-bottom:1rem; display:flex; align-items:center; gap:1rem; min-width:300px; transition:var(--transition); }
        .toast-icon { font-size:1.25rem; }
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter: blur(10px); display:flex; align-items:center; justify-content:center; z-index:10000; opacity:0; visibility:hidden; transition:var(--transition); }
        .modal-overlay.active { opacity:1; visibility:visible; }
        .success-modal { background:white; border-radius:var(--radius-2xl); padding:3rem; max-width:600px; text-align:center; box-shadow:var(--shadow-xl); transform:scale(0.8); transition:var(--transition-bounce); }
        .modal-overlay.active .success-modal { transform: scale(1); }
        .success-icon { width:80px; height:80px; background:var(--success); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem; color:white; font-size:2rem; }
        .success-title { font-size:1.875rem; font-weight:900; margin-bottom:1rem; }
        .success-message { color:var(--text-secondary); margin-bottom:1.5rem; }
        .order-id { background:var(--bg-secondary); padding:1rem; border-radius:var(--radius-lg); font-family:'Courier New', monospace; font-weight:700; color:var(--primary); margin-bottom:1.5rem; font-size:1.125rem; }
        .email-preview { background:var(--bg-secondary); padding:1.5rem; border-radius:var(--radius-lg); margin-bottom:1.5rem; }
        .email-preview-title { font-weight:700; margin-bottom:1rem; display:flex; align-items:center; justify-content:center; gap:0.5rem; }
        .email-item { display:flex; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid var(--border-light); }
        .email-item:last-child { border:none; font-weight:700; margin-top:0.5rem; }
        @media (max-width:1024px) { .checkout-layout { grid-template-columns:1fr; } .order-summary { position:static; order:-1; } }
        @media (max-width:768px) { .checkout-page { padding:1rem; } .checkout-title { font-size:2rem; } .form-row { grid-template-columns:1fr; } .card-row { grid-template-columns:1fr; } .checkout-form, .order-summary { padding:1.5rem; } .success-modal { padding:2rem; margin:1rem; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <nav class="nav">
                <a href="marketplace.html" class="logo"><i class="fas fa-rocket"></i> QuickLocal</a>
                <a href="cart.html" class="action-btn btn-secondary" style="text-decoration:none; color:var(--primary); font-weight:600;"><i class="fas fa-arrow-left"></i> Back to Cart</a>
            </nav>
        </div>
    </header>

    <div class="breadcrumb">
        <div class="breadcrumb-container">
            <nav class="breadcrumb-nav">
                <a href="marketplace.html">Home</a><span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>
                <a href="cart.html">Cart</a><span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>
                <span>Checkout</span>
            </nav>
        </div>
    </div>

    <main class="checkout-page">
        <div class="checkout-header">
            <h1 class="checkout-title"><i class="fas fa-lock"></i> Secure Checkout</h1>
            <p class="checkout-subtitle">Complete your order safely and securely</p>
        </div>

        <div id="loadingState" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading your cart...</p>
        </div>

        <div id="emptyCheckoutState" class="empty-checkout" style="display:none;">
            <i class="fas fa-shopping-cart" style="font-size:4rem; color:var(--text-light); margin-bottom:1rem;"></i>
            <h2>Your cart is empty</h2>
            <p>Add some items to your cart before proceeding to checkout.</p>
            <div style="display:flex; gap:1rem; justify-content:center; margin-top:2rem; flex-wrap:wrap;">
                <a href="marketplace.html" class="place-order-btn" style="width:auto; padding:1rem 2rem;"><i class="fas fa-shopping-bag"></i> Start Shopping</a>
                <a href="cart.html" class="place-order-btn" style="width:auto; padding:1rem 2rem; background: linear-gradient(135deg, var(--primary), var(--primary-dark));"><i class="fas fa-arrow-left"></i> Back to Cart</a>
            </div>
        </div>

        <div id="checkoutContent" class="checkout-layout" style="display:none;">
            <section class="checkout-form">
                <form id="checkoutForm" novalidate>
                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-truck"></i> Shipping Information</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="name">Full Name *</label>
                                <input type="text" id="name" name="name" class="form-input" required>
                                <div class="field-error"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="phone">Phone Number *</label>
                                <input type="tel" id="phone" name="phone" class="form-input" required>
                                <div class="field-error"></div>
                            </div>
                        </div>

                        <div class="form-group full-width" style="margin-bottom:1.5rem;">
                            <label class="form-label" for="email">Email Address *</label>
                            <input type="email" id="email" name="email" class="form-input" required>
                            <div class="field-error"></div>
                        </div>

                        <div class="form-group full-width" style="margin-bottom:1.5rem; position:relative;">
                            <label class="form-label" for="address">Street Address *</label>
                            <input type="text" id="address" name="address" class="form-input" required autocomplete="street-address">
                            <div class="address-autocomplete" id="addressAutocomplete"></div>
                            <div class="field-error"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="city">City *</label>
                                <input type="text" id="city" name="city" class="form-input" required autocomplete="address-level2">
                                <div class="field-error"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="state">State/Province *</label>
                                <input type="text" id="state" name="state" class="form-input" required autocomplete="address-level1">
                                <div class="field-error"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="pincode">Pincode *</label>
                                <input type="text" id="pincode" name="pincode" class="form-input" required>
                                <div class="field-error"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="country">Country *</label>
                                <input type="text" id="country" name="country" class="form-input" required value="India">
                                <div class="field-error"></div>
                            </div>
                        </div>

                        <div style="display:flex; gap:1rem; align-items:center; margin-top:1rem;">
                            <input type="checkbox" id="saveAddress" checked>
                            <label for="saveAddress" style="font-weight:600; color:var(--text-secondary);">Save this address for future orders</label>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-credit-card"></i> Payment Method</h2>

                        <div class="payment-methods" id="paymentMethods">
                            <div class="payment-option selected" data-payment="card">
                                <input type="radio" name="payment" class="payment-radio" value="card" checked style="display:none;">
                                <div class="payment-icon"><i class="fas fa-credit-card"></i></div>
                                <div class="payment-info">
                                    <div class="payment-name">Card</div>
                                    <div class="payment-desc">Pay with debit/credit card</div>
                                </div>
                            </div>

                            <div class="payment-option" data-payment="upi">
                                <input type="radio" name="payment" class="payment-radio" value="upi" style="display:none;">
                                <div class="payment-icon"><i class="fas fa-qrcode"></i></div>
                                <div class="payment-info">
                                    <div class="payment-name">UPI</div>
                                    <div class="payment-desc">Quick UPI payment</div>
                                </div>
                            </div>

                            <div class="payment-option" data-payment="cod">
                                <input type="radio" name="payment" class="payment-radio" value="cod" style="display:none;">
                                <div class="payment-icon"><i class="fas fa-money-bill-wave"></i></div>
                                <div class="payment-info">
                                    <div class="payment-name">Cash on Delivery</div>
                                    <div class="payment-desc">Pay when delivered</div>
                                </div>
                            </div>
                        </div>

                        <div id="cardPaymentForm" class="card-payment-form active">
                            <div class="form-row card-row">
                                <div class="form-group full-width">
                                    <label class="form-label" for="cardNumber">Card Number</label>
                                    <input type="text" id="cardNumber" class="form-input" placeholder="1234 5678 9012 3456" maxlength="19">
                                    <div class="field-error"></div>
                                </div>
                            </div>
                            <div class="form-row card-row">
                                <div class="form-group">
                                    <label class="form-label" for="cardName">Name on Card</label>
                                    <input type="text" id="cardName" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="cardExpiry">Expiry (MM/YY)</label>
                                    <input type="text" id="cardExpiry" class="form-input" maxlength="5" placeholder="MM/YY">
                                </div>
                            </div>
                            <div class="form-row card-row">
                                <div class="form-group">
                                    <label class="form-label" for="cardCvv">CVV</label>
                                    <input type="text" id="cardCvv" class="form-input" maxlength="4" placeholder="123">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="cardNote">Note (optional)</label>
                                    <input type="text" id="cardNote" class="form-input">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </section>

            <aside class="order-summary">
                <h2 class="section-title"><i class="fas fa-receipt"></i> Order Summary</h2>
                <div id="cartItemsList" style="margin-bottom:1rem;"></div>

                <div class="summary-totals">
                    <div class="total-row"><span>Items (<span id="itemCount">0</span>)</span><span id="subtotal">₹0</span></div>
                    <div class="total-row"><span>Discount</span><span id="discount">-₹0</span></div>
                    <div class="total-row"><span>Delivery</span><span id="deliveryFee">₹0</span></div>
                    <div class="total-row"><span>Tax</span><span id="tax">₹0</span></div>
                    <div class="total-row final"><span>Total</span><span id="total">₹0</span></div>
                </div>

                <button id="placeOrderBtn" class="place-order-btn"><i class="fas fa-lock"></i> Place Order</button>

                <div class="security-info" style="margin-top:1.5rem;">
                    <div class="security-badges" style="display:flex; gap:1rem; justify-content:center; flex-wrap:wrap;">
                        <div class="security-badge" style="display:flex; align-items:center; gap:0.5rem; color:var(--text-secondary); font-size:0.875rem;"><i class="fas fa-shield-alt"></i> SSL Secured</div>
                        <div class="security-badge" style="display:flex; align-items:center; gap:0.5rem; color:var(--text-secondary); font-size:0.875rem;"><i class="fas fa-lock"></i> Safe Payment</div>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <div class="modal-overlay" id="successModal">
        <div class="success-modal">
            <div class="success-icon"><i class="fas fa-check"></i></div>
            <h3 class="success-title">Order Placed Successfully!</h3>
            <p class="success-message">Your order has been confirmed. You will receive an email with the details shortly.</p>
            <div class="order-id">Order ID: <span id="orderNumber">#QL000000</span></div>
            <div class="email-preview">
                <div class="email-preview-title"><i class="fas fa-envelope"></i> Order Summary</div>
                <div class="email-items" id="emailPreviewItems"></div>
                <div class="email-item">
                    <span>Total Amount:</span>
                    <span id="emailPreviewTotal">₹0</span>
                </div>
            </div>
            <button onclick="closeSuccessModal()" class="place-order-btn" style="width:auto; padding:0.75rem 1.5rem;"><i class="fas fa-home"></i> Continue Shopping</button>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="https://quicklocal-backend.onrender.com/hybrid-auth-client.js"></script>

    <script>
    // State
    const checkoutState = {
        cart: null,
        isProcessing: false,
        selectedPayment: 'card',
        saveAddress: true
    };

    // Toast notifications
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.style.borderLeft = `4px solid ${type === 'error' ? 'var(--error)' : 'var(--success)'}`;
        toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} toast-icon"></i><div>${message}</div>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // API wrapper with timeout
    const api = {
        async request(endpoint, options = {}) {
            const { timeout = 30000, ...fetchOptions } = options;

            if (window.HybridAuthClient && typeof window.HybridAuthClient.apiCall === 'function') {
                try {
                    const response = await window.HybridAuthClient.apiCall(endpoint, options);
                    if (response.status === 401 || response.status === 403) { handleUnauthorized(); throw new Error('Unauthorized'); }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` }));
                        throw new Error(errorData.message || `HTTP ${response.status}`);
                    }
                    return await response.json();
                } catch (err) {
                    if (err.message !== 'Unauthorized') console.error(`API Error [hybrid ${endpoint}]:`, err);
                    throw err;
                }
            }

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const base = (new URL(endpoint, window.location.href)).href;
                const res = await fetch(base, {
                    ...fetchOptions,
                    method: options.method || 'GET',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, options.headers || {}),
                    credentials: 'include',
                    body: options.body || undefined,
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (res.status === 401 || res.status === 403) { handleUnauthorized(); throw new Error('Unauthorized'); }
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({ message: `HTTP ${res.status}` }));
                    throw new Error(errData.message || `HTTP ${res.status}`);
                }
                return await res.json();
            } catch (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                    const errorMsg = `Request timed out after ${timeout / 1000}s.`;
                    console.error(`API Error [fetch ${endpoint}]: ${errorMsg}`);
                    showToast('The server is taking too long to respond. Please try again later.', 'error');
                    throw new Error(errorMsg);
                }
                console.error(`API Error [fetch ${endpoint}]:`, err);
                throw err;
            }
        },
        get: (endpoint, options) => api.request(endpoint, { ...options, method: 'GET' }),
        post: (endpoint, data, options) => api.request(endpoint, { ...options, method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'application/json' } }),
        put: (endpoint, data, options) => api.request(endpoint, { ...options, method: 'PUT', body: JSON.stringify(data), headers: { 'Content-Type': 'application/json' } })
    };

    function handleUnauthorized() {
        showToast('Please login to proceed to checkout', 'warning');
        setTimeout(() => { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`; }, 1300);
    }

    function getSafeImageUrl(product) {
        const fallback = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e2e8f0'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='12' fill='%2394a3b8' text-anchor='middle'%3ENo Image%3C/text%3E%3C/svg%3E";
        if (!product || typeof product !== 'object') return fallback;
        if (product.images && Array.isArray(product.images) && product.images.length > 0) {
            const img = product.images[0];
            if (typeof img === 'string' && img.startsWith('http')) return img;
            if (img && typeof img === 'object' && img.url && img.url.startsWith('http')) return img.url;
        }
        if (product.image && typeof product.image === 'string' && product.image.startsWith('http')) return product.image;
        if (product.primaryImage && product.primaryImage.startsWith('http')) return product.primaryImage;
        return fallback;
    }

    function formatCurrency(num) {
        return `₹${Number(num || 0).toLocaleString()}`;
    }

    function renderCartSummary() {
        console.log('Rendering cart summary.');
        if (!checkoutState.cart) return;
        const { items, pricing } = checkoutState.cart;
        const cartItemsContainer = document.getElementById('cartItemsList');
        if (!items || !Array.isArray(items) || items.length === 0) {
            cartItemsContainer.innerHTML = '<p style="text-align:center; color:var(--text-light); padding:2rem;">No items in cart</p>';
            return;
        }

        const itemsHtml = items.map((item, index) => {
            if (!item) return '';
            const product = item.product || item;
            const quantity = item.quantity || 1;
            const price = (product && (product.price ?? item.priceAtAdd ?? item.price)) || 0;
            const productName = product?.name || 'Product';
            const productId = product?._id || product?.id || `item-${index}`;
            const itemTotal = price * quantity;
            return `
                <div class="cart-item" data-product-id="${productId}" style="display:flex; align-items:center; gap:1rem; padding:0.75rem 0; border-bottom:1px solid var(--border-light);">
                    <img src="${getSafeImageUrl(product)}" alt="${productName}" class="item-image" style="width:64px; height:64px; object-fit:cover; border-radius:0.5rem;">
                    <div style="flex:1;">
                        <div style="font-weight:700;">${productName}</div>
                        <div style="color:var(--text-secondary); margin-top:0.25rem;">Qty: ${quantity}</div>
                    </div>
                    <div style="font-weight:700;">${formatCurrency(itemTotal)}</div>
                </div>
            `;
        }).filter(Boolean).join('');

        cartItemsContainer.innerHTML = itemsHtml;
        updatePricingDisplay(items, pricing);
    }

    function updatePricingDisplay(items, pricing) {
        const itemCount = items ? items.reduce((sum, item) => sum + (item.quantity || 1), 0) : 0;
        const subtotal = pricing?.subtotal || items?.reduce((s, it) => {
            const p = (it.product?.price ?? it.price ?? 0);
            return s + p * (it.quantity || 1);
        }, 0) || 0;
        const discount = pricing?.discount || 0;
        const deliveryFee = typeof pricing?.deliveryFee === 'number' ? pricing.deliveryFee : (subtotal >= 500 ? 0 : 25);
        const tax = typeof pricing?.tax === 'number' ? pricing.tax : Math.round(subtotal * 0.05 * 100) / 100;
        const total = pricing?.total || (subtotal - discount + deliveryFee + tax);

        document.getElementById('itemCount').textContent = itemCount;
        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('discount').textContent = `- ${formatCurrency(discount)}`;
        document.getElementById('deliveryFee').textContent = deliveryFee > 0 ? formatCurrency(deliveryFee) : 'FREE';
        document.getElementById('tax').textContent = formatCurrency(tax);
        document.getElementById('total').textContent = formatCurrency(total);

        const deliveryElement = document.getElementById('deliveryFee');
        deliveryElement.style.color = deliveryFee === 0 ? 'var(--accent)' : 'inherit';
        deliveryElement.style.fontWeight = deliveryFee === 0 ? '700' : 'inherit';
    }

    function formatCardNumber(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let parts = [];
        for (let i = 0; i < value.length; i += 4) parts.push(value.substring(i, i+4));
        e.target.value = parts.join(' ').substring(0, 19);
    }
    function formatCardExpiry(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        if (value.length >= 2) e.target.value = value.substring(0,2) + '/' + value.substring(2,4);
        else e.target.value = value;
    }
    function formatCardCvv(e) {
        e.target.value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '').substring(0,4);
    }

    function showLoading(isLoading) {
        const spinner = document.getElementById('loadingState');
        if (!spinner) return;
        spinner.style.display = isLoading ? 'flex' : 'none';
    }
    function showEmptyCheckout() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('checkoutContent').style.display = 'none';
        document.getElementById('emptyCheckoutState').style.display = 'block';
    }
    function showCheckoutContent() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('checkoutContent').style.display = 'grid';
        document.getElementById('emptyCheckoutState').style.display = 'none';
    }

    function initializeEventListeners() {
        const form = document.getElementById('checkoutForm');
        if (form) form.addEventListener('submit', (e) => e.preventDefault());
        document.getElementById('placeOrderBtn').addEventListener('click', handlePlaceOrder);
        document.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('blur', (e) => validateField(e.target));
            input.addEventListener('input', (e) => clearFieldError(e.target));
        });
        document.getElementById('cardNumber')?.addEventListener('input', formatCardNumber);
        document.getElementById('cardExpiry')?.addEventListener('input', formatCardExpiry);
        document.getElementById('cardCvv')?.addEventListener('input', formatCardCvv);
        document.getElementById('saveAddress')?.addEventListener('change', (e) => checkoutState.saveAddress = e.target.checked);
    }

    function initializePaymentMethods() {
        const options = document.querySelectorAll('.payment-option');
        if (!options || options.length === 0) return;
        options.forEach(opt => {
            opt.addEventListener('click', () => {
                options.forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                const radio = opt.querySelector('input[type="radio"]');
                if (radio) radio.checked = true;
                checkoutState.selectedPayment = opt.dataset.payment;
                const cardForm = document.getElementById('cardPaymentForm');
                if (cardForm) {
                    if (checkoutState.selectedPayment === 'card') cardForm.classList.add('active');
                    else cardForm.classList.remove('active');
                }
            });
        });

        const initiallySelected = document.querySelector('.payment-option.selected') || options[0];
        initiallySelected.classList.add('selected');
        checkoutState.selectedPayment = initiallySelected.dataset.payment || 'card';
        const cardForm = document.getElementById('cardPaymentForm');
        if (cardForm) {
            if (checkoutState.selectedPayment === 'card') cardForm.classList.add('active');
            else cardForm.classList.remove('active');
        }
    }

    const addressSuggestions = [
        "123 Main Street, Mumbai, Maharashtra 400001",
        "456 Park Avenue, Delhi, Delhi 110001",
        "789 MG Road, Bangalore, Karnataka 560001",
        "321 Churchgate, Mumbai, Maharashtra 400020",
        "654 Connaught Place, Delhi, Delhi 110001"
    ];
    function initializeAddressAutocomplete() {
        const addressInput = document.getElementById('address');
        const autocompleteContainer = document.getElementById('addressAutocomplete');
        if (!addressInput || !autocompleteContainer) return;

        addressInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            autocompleteContainer.innerHTML = '';
            if (value.length < 2) { autocompleteContainer.style.display = 'none'; return; }
            const filtered = addressSuggestions.filter(a => a.toLowerCase().includes(value.toLowerCase()));
            if (filtered.length === 0) { autocompleteContainer.style.display = 'none'; return; }
            filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = 'address-suggestion';
                div.textContent = s;
                div.addEventListener('click', () => {
                    addressInput.value = s;
                    autocompleteContainer.style.display = 'none';
                });
                autocompleteContainer.appendChild(div);
            });
            autocompleteContainer.style.display = 'block';
        });

        document.addEventListener('click', (e) => {
            if (!addressInput.contains(e.target) && !autocompleteContainer.contains(e.target)) autocompleteContainer.style.display = 'none';
        });
    }

    function clearFieldError(field) {
        const fe = field.parentElement.querySelector('.field-error');
        if (fe) fe.textContent = '';
        field.classList.remove('error');
    }
    function validateField(field) {
        const value = (field.value || '').trim();
        let isValid = true;
        let msg = '';
        if (field.hasAttribute('required') && !value) { isValid = false; msg = `${field.previousElementSibling.textContent.replace(' *', '')} is required`; }
        else if (field.name === 'email' && value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) { isValid = false; msg = 'Please enter a valid email address'; }
        else if (field.name === 'phone' && value && !/^[6-9]\d{9}$/.test(value)) { isValid = false; msg = 'Please enter a valid 10-digit mobile number'; }

        const fe = field.parentElement.querySelector('.field-error');
        if (!isValid) {
            if (fe) fe.textContent = msg;
            field.classList.add('error');
        } else {
            if (fe) fe.textContent = '';
            field.classList.remove('error');
        }
        return isValid;
    }
    function validateForm() {
        let ok = true;
        document.querySelectorAll('#checkoutForm .form-input[required]').forEach(i => { if (!validateField(i)) ok = false; });
        if (checkoutState.selectedPayment === 'card') {
            ['cardNumber','cardName','cardExpiry','cardCvv'].forEach(id => {
                const f = document.getElementById(id);
                if (f && !validateField(f)) ok = false;
            });
        }
        return ok;
    }

    async function loadCheckoutData() {
        showLoading(true);
        try {
            console.log('🛒 Loading checkout cart data...');
            // Try direct fetch first with proper headers
            const response = await fetch('https://quicklocal-backend.onrender.com/api/v1/cart', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });
            console.log('📦 Cart Response Status:', response.status);
            if (!response.ok) {
                if (response.status === 401) {
                    handleUnauthorized();
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }
            const data = await response.json();
            console.log('📦 Cart Data:', data);
            // Handle multiple possible response structures
            const items = data?.items || data?.data?.items || data?.cart?.items || [];
            const pricing = data?.pricing || data?.data?.pricing || data?.cart?.pricing || {};
            console.log('📦 Parsed items:', items);
            console.log('💰 Parsed pricing:', pricing);
            if (Array.isArray(items) && items.length > 0) {
                checkoutState.cart = { items, pricing };
                renderCartSummary();
                showCheckoutContent();
            } else {
                console.warn('⚠️ No items in cart or empty response');
                showEmptyCheckout();
            }
        } catch (err) {
            console.error('❌ Cart load error:', err);
            if (err.message.includes('401') || err.message === 'Unauthorized') {
                handleUnauthorized();
            } else {
                showToast('Failed to load your cart. Please refresh or login again.', 'error');
                showEmptyCheckout();
            }
        } finally {
            showLoading(false);
        }
    }

    async function loadSavedAddress() {
        try {
            if (window.HybridAuthClient && typeof window.HybridAuthClient.getCurrentUser === 'function') {
                const user = await window.HybridAuthClient.getCurrentUser();
                if (user && user.address) {
                    Object.keys(user.address).forEach(k => {
                        const input = document.getElementById(k);
                        if (input && user.address[k]) input.value = user.address[k];
                    });
                }
            } else {
                const profile = await api.get('/api/v1/auth/me').catch(() => null);
                if (profile && profile.user && profile.user.address) {
                    Object.keys(profile.user.address).forEach(k => {
                        const input = document.getElementById(k);
                        if (input && profile.user.address[k]) input.value = profile.user.address[k];
                    });
                }
            }
        } catch (err) {
            console.warn('Could not prefill address:', err);
        }
    }

    async function saveAddress() {
        if (!checkoutState.saveAddress) return;
        try {
            const form = document.getElementById('checkoutForm');
            const address = {
                name: form.querySelector('#name').value,
                email: form.querySelector('#email').value,
                phone: form.querySelector('#phone').value,
                address: form.querySelector('#address').value,
                city: form.querySelector('#city').value,
                state: form.querySelector('#state').value,
                pincode: form.querySelector('#pincode').value,
                country: form.querySelector('#country').value
            };
            await api.put('/api/v1/auth/profile', { address });
        } catch (err) {
            console.warn('Could not save address:', err);
        }
    }

    function validateCartBeforeCheckout() {
        if (!checkoutState.cart || !checkoutState.cart.items || checkoutState.cart.items.length === 0) {
            showToast('Your cart is empty', 'error');
            setTimeout(() => { window.location.href = 'cart.html'; }, 1200);
            return false;
        }
        const unavailable = checkoutState.cart.unavailableItems || [];
        if (unavailable.length > 0) {
            showToast('Some items in your cart are no longer available', 'error');
            setTimeout(() => { window.location.href = 'cart.html'; }, 1400);
            return false;
        }
        return true;
    }

    async function handlePlaceOrder() {
        if (checkoutState.isProcessing) return;
        if (!validateCartBeforeCheckout()) return;
        if (!validateForm()) { showToast('Please fill in all required fields correctly','error'); return; }

        checkoutState.isProcessing = true;
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const originalText = placeOrderBtn.innerHTML;
        placeOrderBtn.disabled = true;
        placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

        await saveAddress();

        const formData = new FormData(document.getElementById('checkoutForm'));
        const shippingAddress = Object.fromEntries(formData.entries());

        // FIXED: Extract product IDs correctly
        const items = checkoutState.cart.items.map(item => {
            const productObj = item.product || item;
            const pid = productObj?._id || productObj?.id || productObj;
            return { product: pid, quantity: item.quantity || 1 };
        });

        const orderPayload = {
            shippingAddress,
            paymentMethod: checkoutState.selectedPayment,
            saveAddress: checkoutState.saveAddress,
            items,
            orderItems: items  // ✅ FIXED: Added for backend compatibility
        };

        if (checkoutState.selectedPayment === 'card') {
            orderPayload.cardDetails = {
                number: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                name: document.getElementById('cardName').value,
                expiry: document.getElementById('cardExpiry').value,
                cvv: document.getElementById('cardCvv').value
            };
        }

        try {
            const response = await api.post('/api/v1/orders', orderPayload, { timeout: 60000 });
            
            if (response.success && (response.order || response.data)) {
                const order = response.order || response.data?.order || response.data || {};
                showOrderSuccess(order.orderNumber || order.id || '#');
            } else {
                throw new Error(response.message || 'Failed to place order.');
            }
        } catch (err) {
            console.error('Order error:', err);
            if (err.name !== 'AbortError') {
                 showToast(`Order failed: ${err.message}`, 'error');
            }
        } finally {
            checkoutState.isProcessing = false;
            placeOrderBtn.disabled = false;
            placeOrderBtn.innerHTML = originalText;
        }
    }

    function showOrderSuccess(orderId) {
        document.getElementById('orderNumber').textContent = orderId || '#';
        updateEmailPreview();
        document.getElementById('successModal').classList.add('active');
        checkoutState.cart = null;
        document.getElementById('cartItemsList').innerHTML = '';
        updatePricingDisplay([], { subtotal:0, discount:0, deliveryFee:0, tax:0, total:0 });
    }

    function updateEmailPreview() {
        if (!checkoutState.cart) return;
        const { items, pricing } = checkoutState.cart;
        if (!items || !Array.isArray(items)) return;
        const emailPreviewContainer = document.getElementById('emailPreviewItems');
        const emailPreviewTotal = document.getElementById('emailPreviewTotal');
        const itemsHtml = items.map((item) => {
            const product = item.product || item;
            const price = product?.price ?? item.price ?? 0;
            const quantity = item.quantity || 1;
            return `<div class="email-item"><span>${product?.name || 'Product'} × ${quantity}</span><span>${formatCurrency(price * quantity)}</span></div>`;
        }).join('');
        emailPreviewContainer.innerHTML = itemsHtml;
        emailPreviewTotal.textContent = formatCurrency(pricing?.total || 0);
    }

    function closeSuccessModal() {
        document.getElementById('successModal').classList.remove('active');
        window.location.href = 'marketplace.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log('🔐 Initializing Secure Checkout.');
        initializeEventListeners();
        initializePaymentMethods();
        initializeAddressAutocomplete();
        // Try loading immediately - don't wait for HybridAuthClient
        console.log('⚡ Loading cart immediately...');
        loadCheckoutData().then(() => {
            loadSavedAddress();
        }).catch(err => {
            console.error('❌ Initial cart load failed:', err);
            // If initial load fails, wait for auth client
            setTimeout(() => {
                if (window.HybridAuthClient && typeof window.HybridAuthClient.isAuthenticated === 'function') {
                    window.HybridAuthClient.isAuthenticated().then(isAuth => {
                        if (isAuth) {
                            loadCheckoutData();
                            loadSavedAddress();
                        } else {
                            handleUnauthorized();
                        }
                    });
                } else {
                    showToast('Authentication system not ready. Please refresh.', 'error');
                }
            }, 2000);
        });
    });

    window.closeSuccessModal = closeSuccessModal;
    </script>
</body>
</html>