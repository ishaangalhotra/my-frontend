<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí Secure Checkout - QuickLocal</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --primary-light: #a5b4fc;
            --secondary: #f59e0b;
            --accent: #10b981;
            --accent-dark: #059669;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-light: #94a3b8;
            --text-inverse: #ffffff;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 0 1px rgba(99, 102, 241, 0.05), 0 4px 16px rgba(99, 102, 241, 0.12);
            --radius-lg: 1rem;
            --radius-2xl: 2rem;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        .header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
        }
        .nav-container { max-width: 1400px; margin: 0 auto; padding: 1rem 2rem; }
        .nav { display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.875rem; font-weight: 900; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; }
        .breadcrumb { background: white; padding: 1rem 0; border-bottom: 1px solid var(--border); }
        .breadcrumb-container { max-width: 1400px; margin: 0 auto; padding: 0 2rem; }
        .breadcrumb-nav { display: flex; align-items: center; gap: 0.75rem; color: var(--text-secondary); font-weight: 500; }
        .breadcrumb-nav a { color: var(--primary); text-decoration: none; }
        .breadcrumb-sep { color: var(--text-light); }
        .checkout-page { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .checkout-header { text-align: center; margin-bottom: 3rem; }
        .checkout-title { font-size: 3rem; font-weight: 900; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 1rem; }
        .checkout-subtitle { font-size: 1.125rem; color: var(--text-secondary); }
        .checkout-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 3rem; align-items: start; }
        .checkout-form, .order-summary { background: white; border-radius: var(--radius-2xl); padding: 2rem; box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
        .order-summary { position: sticky; top: 2rem; }
        .form-section { margin-bottom: 2.5rem; }
        .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { position: relative; display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-label { font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; }
        .form-input { padding: 1rem; border: 2px solid var(--border); border-radius: var(--radius-lg); font-size: 1rem; transition: var(--transition); }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: var(--shadow-glow); }
        .form-input.error { border-color: var(--error); }
        .field-error { color: var(--error); font-size: 0.875rem; font-weight: 500; min-height: 1em; margin-top: 0.25rem; }
        .payment-methods { display: grid; gap: 1rem; }
        .payment-option { border: 2px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; cursor: pointer; transition: var(--transition-bounce); display: flex; align-items: center; gap: 1rem; }
        .payment-option:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .payment-option.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); box-shadow: var(--shadow-glow); }
        .payment-radio { width: 1.25rem; height: 1.25rem; accent-color: var(--primary); }
        .payment-info { flex: 1; }
        .payment-name { font-weight: 700; }
        .payment-desc { color: var(--text-secondary); font-size: 0.9rem; }
        .payment-icon { font-size: 1.5rem; color: var(--primary); }
        /* Card Payment Form */
        .card-payment-form { 
            margin-top: 1.5rem; 
            padding: 1.5rem; 
            background: var(--bg-secondary); 
            border-radius: var(--radius-lg); 
            border: 1px solid var(--border);
            display: none;
        }
        .card-payment-form.active { display: block; }
        .card-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; }
        .checkbox-group { display: flex; align-items: center; gap: 0.75rem; margin-top: 1rem; }
        .checkbox-group input[type="checkbox"] { width: 1.25rem; height: 1.25rem; accent-color: var(--primary); }
        .checkbox-group label { font-weight: 500; color: var(--text-secondary); }
        .summary-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .cart-items { 
            margin-bottom: 1.5rem; 
            max-height: 400px; 
            overflow-y: auto; 
            padding-right: 0.5rem;
        }
        .cart-item { 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            padding: 1rem 0; 
            border-bottom: 1px solid var(--border-light);
        }
        .cart-item:last-child { border-bottom: none; }
        .item-image { width: 60px; height: 60px; border-radius: var(--radius-lg); object-fit: cover; background: var(--bg-tertiary); }
        .item-details { flex: 1; min-width: 0; }
        .item-name { font-weight: 600; font-size: 0.9rem; }
        .item-quantity { color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.25rem; }
        .item-price { font-weight: 700; color: var(--primary); white-space: nowrap; }
        .summary-totals { border-top: 2px solid var(--border-light); padding-top: 1.5rem; }
        .total-row { display: flex; justify-content: space-between; padding: 0.5rem 0; font-weight: 500; }
        .total-row.final { font-size: 1.25rem; font-weight: 900; border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem; }
        .place-order-btn { width: 100%; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: white; border: none; padding: 1.25rem; border-radius: var(--radius-lg); font-size: 1.125rem; font-weight: 700; cursor: pointer; transition: var(--transition-bounce); display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-top: 1.5rem; }
        .place-order-btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: var(--shadow-xl); }
        .place-order-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .security-info { margin-top: 1.5rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-lg); text-align: center; }
        .security-badges { display: flex; justify-content: center; gap: 1.5rem; margin-bottom: 0.75rem; }
        .security-badge i { font-size: 1.25rem; color: var(--accent); }
        .loading-container, .empty-checkout { padding: 4rem 2rem; background: white; border-radius: var(--radius-2xl); box-shadow: var(--shadow-lg); text-align: center; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .empty-checkout { grid-column: 1 / -1; }
        #toastContainer { position: fixed; top: 2rem; right: 2rem; z-index: 9999; }
        .toast { background: white; border-radius: var(--radius-lg); padding: 1rem 1.5rem; box-shadow: var(--shadow-xl); border-left: 4px solid var(--success); margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; animation: toastSlide 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast.error { border-left-color: var(--error); }
        .toast-icon { font-size: 1.25rem; color: var(--success); }
        .toast.error .toast-icon { color: var(--error); }
        @keyframes toastSlide { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 0; visibility: hidden; transition: var(--transition); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .success-modal { background: white; border-radius: var(--radius-2xl); padding: 3rem; max-width: 600px; text-align: center; box-shadow: var(--shadow-xl); transform: scale(0.8); transition: var(--transition-bounce); }
        .modal-overlay.active .success-modal { transform: scale(1); }
        .success-icon { width: 80px; height: 80px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: white; font-size: 2rem; }
        .success-title { font-size: 1.75rem; font-weight: 800; margin-bottom: 1rem; }
        .success-message { color: var(--text-secondary); margin-bottom: 2rem; }
        .order-id { background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-lg); font-family: 'Courier New', monospace; font-weight: 700; color: var(--primary); margin-bottom: 1rem; }
        /* Email Preview in Success Modal */
        .email-preview { 
            background: var(--bg-secondary); 
            border-radius: var(--radius-lg); 
            padding: 1.5rem; 
            margin: 1.5rem 0; 
            text-align: left;
            border: 1px solid var(--border);
        }
        .email-preview-title { 
            font-weight: 700; 
            margin-bottom: 1rem; 
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .email-items { margin-bottom: 1rem; }
        .email-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-light);
        }
        .email-item:last-child { border-bottom: none; }
        /* Address Autocomplete Dropdown */
        .address-autocomplete { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 1px solid var(--border); 
            border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-lg); 
            z-index: 100; 
            max-height: 200px; 
            overflow-y: auto; 
            display: none;
        }
        .address-suggestion { 
            padding: 0.75rem 1rem; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition);
        }
        .address-suggestion:hover { background: var(--bg-secondary); }
        .address-suggestion:last-child { border-bottom: none; }
        @media (max-width: 1024px) {
            .checkout-layout { grid-template-columns: 1fr; }
            .order-summary { position: static; order: -1; }
        }
        @media (max-width: 768px) {
            .checkout-page { padding: 1rem; }
            .checkout-title { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .card-row { grid-template-columns: 1fr; }
            .checkout-form, .order-summary { padding: 1.5rem; }
            .success-modal { padding: 2rem; margin: 1rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="nav-container">
            <nav class="nav">
                <a href="marketplace.html" class="logo"><i class="fas fa-rocket"></i> QuickLocal</a>
                <a href="cart.html" class="action-btn btn-secondary" style="text-decoration: none; color: var(--primary); font-weight: 600;"><i class="fas fa-arrow-left"></i> Back to Cart</a>
            </nav>
        </div>
    </header>
    <div class="breadcrumb">
        <div class="breadcrumb-container">
            <nav class="breadcrumb-nav">
                <a href="marketplace.html">Home</a><span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>
                <a href="cart.html">Cart</a><span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>
                <span>Checkout</span>
            </nav>
        </div>
    </div>
    <main class="checkout-page">
        <div class="checkout-header">
            <h1 class="checkout-title"><i class="fas fa-lock"></i> Secure Checkout</h1>
            <p class="checkout-subtitle">Complete your order safely and securely</p>
        </div>
        <div id="loadingState" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Loading your cart...</p>
        </div>
        <div id="emptyCheckoutState" class="empty-checkout" style="display: none;">
            <i class="fas fa-shopping-cart" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
            <h2>Your cart is empty</h2>
            <p>Add some items to your cart before proceeding to checkout.</p>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                <a href="marketplace.html" class="place-order-btn" style="width: auto; padding: 1rem 2rem;"><i class="fas fa-shopping-bag"></i> Start Shopping</a>
                <a href="cart.html" class="place-order-btn" style="width: auto; padding: 1rem 2rem; background: linear-gradient(135deg, var(--primary), var(--primary-dark));"><i class="fas fa-arrow-left"></i> Back to Cart</a>
            </div>
        </div>
        <div id="checkoutContent" class="checkout-layout" style="display: none;">
            <section class="checkout-form">
                <form id="checkoutForm" novalidate>
                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-truck"></i> Shipping Information</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="name">Full Name *</label>
                                <input type="text" id="name" name="name" class="form-input" required>
                                <div class="field-error"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="phone">Phone Number *</label>
                                <input type="tel" id="phone" name="phone" class="form-input" required>
                                <div class="field-error"></div>
                            </div>
                        </div>
                        <div class="form-group full-width" style="margin-bottom: 1.5rem;">
                            <label class="form-label" for="email">Email Address *</label>
                            <input type="email" id="email" name="email" class="form-input" required>
                            <div class="field-error"></div>
                        </div>
                        <div class="form-group full-width" style="margin-bottom: 1.5rem; position: relative;">
                            <label class="form-label" for="address">Street Address *</label>
                            <input type="text" id="address" name="address" class="form-input" required autocomplete="street-address">
                            <div class="address-autocomplete" id="addressAutocomplete"></div>
                            <div class="field-error"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="city">City *</label>
                                <input type="text" id="city" name="city" class="form-input" required autocomplete="address-level2">
                                <div class="field-error"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="state">State/Province *</label>
                                <input type="text" id="state" name="state" class="form-input" required autocomplete="address-level1">
                                <div class="field-error"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="pincode">PIN/ZIP Code *</label>
                                <input type="text" id="pincode" name="pincode" class="form-input" required autocomplete="postal-code">
                                <div class="field-error"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="country">Country *</label>
                                <select id="country" name="country" class="form-input" required autocomplete="country">
                                    <option value="India" selected>India</option>
                                    <option value="USA">United States</option>
                                </select>
                                <div class="field-error"></div>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="saveAddress" name="saveAddress" checked>
                            <label for="saveAddress">Save this address for future orders</label>
                        </div>
                    </div>
                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-credit-card"></i> Payment Method</h2>
                        <div class="payment-methods" id="paymentMethods">
                            <label class="payment-option selected" data-payment="card">
                                <input type="radio" name="paymentMethod" value="card" class="payment-radio" checked>
                                <div class="payment-info">
                                    <div class="payment-name">Credit/Debit Card</div>
                                    <div class="payment-desc">Pay securely with your card</div>
                                </div>
                                <div class="payment-icon"><i class="fas fa-credit-card"></i></div>
                            </label>
                             <label class="payment-option" data-payment="cod">
                                <input type="radio" name="paymentMethod" value="cod" class="payment-radio">
                                <div class="payment-info">
                                    <div class="payment-name">Cash on Delivery</div>
                                    <div class="payment-desc">Pay when you receive your order</div>
                                </div>
                                <div class="payment-icon"><i class="fas fa-money-bill-wave"></i></div>
                            </label>
                        </div>
                        <div class="card-payment-form" id="cardPaymentForm">
                            <div class="form-group full-width">
                                <label class="form-label" for="cardNumber">Card Number *</label>
                                <input type="text" id="cardNumber" name="cardNumber" class="form-input" placeholder="1234 5678 9012 3456" maxlength="19">
                                <div class="field-error"></div>
                            </div>
                            <div class="form-row card-row">
                                <div class="form-group">
                                    <label class="form-label" for="cardName">Name on Card *</label>
                                    <input type="text" id="cardName" name="cardName" class="form-input" placeholder="John Doe">
                                    <div class="field-error"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="cardExpiry">Expiry Date *</label>
                                    <input type="text" id="cardExpiry" name="cardExpiry" class="form-input" placeholder="MM/YY" maxlength="5">
                                    <div class="field-error"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="cardCvv">CVV *</label>
                                    <input type="text" id="cardCvv" name="cardCvv" class="form-input" placeholder="123" maxlength="4">
                                    <div class="field-error"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </section>
            <aside class="order-summary">
                <h2 class="summary-title"><i class="fas fa-receipt"></i> Order Summary</h2>
                <div class="cart-items" id="cartItemsList"></div>
                <div class="summary-totals">
                    <div class="total-row"><span>Subtotal (<span id="itemCount">0</span> items)</span><span id="subtotal">‚Çπ0</span></div>
                    <div class="total-row"><span>Discount</span><span id="discount" style="color: var(--accent);">-‚Çπ0</span></div>
                    <div class="total-row"><span>Delivery Charges</span><span id="deliveryFee">‚Çπ0</span></div>
                    <div class="total-row"><span>Tax (GST)</span><span id="tax">‚Çπ0</span></div>
                    <div class="total-row final"><span>Total Amount</span><span id="total">‚Çπ0</span></div>
                </div>
                <button class="place-order-btn" id="placeOrderBtn"><i class="fas fa-lock"></i> Place Order Securely</button>
                <div class="security-info">
                    <div class="security-badges">
                        <div class="security-badge"><i class="fas fa-shield-alt"></i> SSL Secured</div>
                        <div class="security-badge"><i class="fas fa-lock"></i> Safe Payment</div>
                    </div>
                </div>
            </aside>
        </div>
    </main>
    <div class="modal-overlay" id="successModal">
        <div class="success-modal">
            <div class="success-icon"><i class="fas fa-check"></i></div>
            <h3 class="success-title">Order Placed Successfully!</h3>
            <p class="success-message">Your order has been confirmed. You will receive an email with the details shortly.</p>
            <div class="order-id">Order ID: <span id="orderNumber">#QL000000</span></div>
            <div class="email-preview">
                <div class="email-preview-title"><i class="fas fa-envelope"></i> Order Summary</div>
                <div class="email-items" id="emailPreviewItems"></div>
                <div class="email-item">
                    <span>Total Amount:</span>
                    <span id="emailPreviewTotal">‚Çπ0</span>
                </div>
            </div>
            <button onclick="closeSuccessModal()" class="place-order-btn" style="width: auto; padding: 0.75rem 1.5rem;"><i class="fas fa-home"></i> Continue Shopping</button>
        </div>
    </div>
    <div id="toastContainer"></div>
    <script src="https://quicklocal-backend.onrender.com/hybrid-auth-client.js"></script>
    <script>
    const checkoutState = { 
        cart: null, 
        isProcessing: false, 
        selectedPayment: 'card',
        saveAddress: true
    };
    const auth = {
        handleUnauthorized: () => {
            showToast('Please login to proceed to checkout', 'warning');
            setTimeout(() => { window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`; }, 1500);
        }
    };
    const api = {
        async request(endpoint, options = {}) {
            if (!window.HybridAuthClient) throw new Error('Auth client not available');
            try {
                const response = await window.HybridAuthClient.apiCall(endpoint, options);
                if (response.status === 401 || response.status === 403) { auth.handleUnauthorized(); throw new Error('Unauthorized'); }
                if (!response.ok) { const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}` })); throw new Error(errorData.message || `HTTP ${response.status}`); }
                return await response.json();
            } catch (error) {
                if (error.message !== 'Unauthorized') console.error(`API Error [${endpoint}]:`, error);
                throw error;
            }
        },
        get: (endpoint) => api.request(endpoint, { method: 'GET' }),
        post: (endpoint, data) => api.request(endpoint, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'application/json' } }),
    };
    const addressSuggestions = [
        "123 Main Street, Mumbai, Maharashtra 400001",
        "456 Park Avenue, Delhi, Delhi 110001", 
        "789 MG Road, Bangalore, Karnataka 560001",
        "321 Churchgate, Mumbai, Maharashtra 400020",
        "654 Connaught Place, Delhi, Delhi 110001"
    ];
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üîí Initializing Secure Checkout...');
        const waitForAuthClient = setInterval(() => {
            if (window.HybridAuthClient && typeof window.HybridAuthClient.isAuthenticated === 'function') {
                clearInterval(waitForAuthClient);
                window.HybridAuthClient.isAuthenticated().then(isAuth => {
                    if (isAuth) { console.log('‚úÖ User authenticated, loading cart...'); loadCheckoutData(); loadSavedAddress(); }
                    else { console.log('‚ùå User not authenticated'); auth.handleUnauthorized(); }
                }).catch(error => { console.error('Auth check failed:', error); showToast('Authentication check failed', 'error'); auth.handleUnauthorized(); });
            }
        }, 100);
        setTimeout(() => { if (!window.HybridAuthClient) { console.error('Auth client failed to load'); showToast('Authentication service unavailable', 'error'); } }, 5000);
        initializeEventListeners();
        initializePaymentMethods();
        initializeAddressAutocomplete();
    });
    function initializeEventListeners() {
        const form = document.getElementById("checkoutForm");
        form.addEventListener('submit', (e) => e.preventDefault());
        document.getElementById('placeOrderBtn').addEventListener('click', handlePlaceOrder);
        form.querySelectorAll('.form-input').forEach(input => {
            input.addEventListener('blur', (e) => validateField(e.target));
            input.addEventListener('input', (e) => clearFieldError(e.target));
        });
        document.getElementById('cardNumber')?.addEventListener('input', formatCardNumber);
        document.getElementById('cardExpiry')?.addEventListener('input', formatCardExpiry);
        document.getElementById('cardCvv')?.addEventListener('input', formatCardCvv);
        document.getElementById('saveAddress')?.addEventListener('change', (e) => {
            checkoutState.saveAddress = e.target.checked;
        });
    }
    function initializePaymentMethods() {
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                option.querySelector('input[type="radio"]').checked = true;
                checkoutState.selectedPayment = option.dataset.payment;
                const cardForm = document.getElementById('cardPaymentForm');
                if (cardForm) {
                    if (checkoutState.selectedPayment === 'card') {
                        cardForm.classList.add('active');
                    } else {
                        cardForm.classList.remove('active');
                    }
                }
            });
        });
    }
    function initializeAddressAutocomplete() {
        const addressInput = document.getElementById('address');
        const autocompleteContainer = document.getElementById('addressAutocomplete');
        if (!addressInput || !autocompleteContainer) return;
        addressInput.addEventListener('input', (e) => {
            const value = e.target.value.trim();
            autocompleteContainer.innerHTML = '';
            if (value.length < 2) {
                autocompleteContainer.style.display = 'none';
                return;
            }
            const filteredSuggestions = addressSuggestions.filter(addr => 
                addr.toLowerCase().includes(value.toLowerCase())
            );
            if (filteredSuggestions.length > 0) {
                filteredSuggestions.forEach(suggestion => {
                    const div = document.createElement('div');
                    div.className = 'address-suggestion';
                    div.textContent = suggestion;
                    div.addEventListener('click', () => {
                        addressInput.value = suggestion;
                        autocompleteContainer.style.display = 'none';
                    });
                    autocompleteContainer.appendChild(div);
                });
                autocompleteContainer.style.display = 'block';
            } else {
                autocompleteContainer.style.display = 'none';
            }
        });
        document.addEventListener('click', (e) => {
            if (!addressInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
                autocompleteContainer.style.display = 'none';
            }
        });
    }
    function formatCardNumber(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        let matches = value.match(/\d{4,16}/g);
        let match = matches && matches[0] || '';
        let parts = [];
        for (let i = 0; i < match.length; i += 4) {
            parts.push(match.substring(i, i + 4));
        }
        if (parts.length) {
            e.target.value = parts.join(' ');
        } else {
            e.target.value = value;
        }
    }
    function formatCardExpiry(e) {
        let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
        if (value.length >= 2) {
            e.target.value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
    }
    function formatCardCvv(e) {
        e.target.value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
    }
    async function loadCheckoutData() {
        showLoading(true);
        try {
            console.log('üõí Loading checkout cart data...');
            const response = await api.get('/api/v1/cart');
            console.log('üì¶ Cart API Response:', response);
            // ‚úÖ FIXED: Use root-level items, not response.data
            if (response.success && response.items) {
                checkoutState.cart = response; // ‚Üê assign full response
                if (response.items.length > 0) {
                    renderCartSummary();
                    showCheckoutContent();
                } else {
                    showEmptyCheckout();
                }
            } else {
                showEmptyCheckout();
            }
        } catch (error) {
            console.error('‚ùå Cart load error:', error);
            if (error.message !== 'Unauthorized') { 
                showToast('Failed to load your cart. Please try again.', 'error'); 
                showEmptyCheckout(); 
            }
        } finally { 
            showLoading(false); 
        }
    }
    function getSafeImageUrl(product) {
        const fallback = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e2e8f0'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='12' fill='%2394a3b8' text-anchor='middle'%3ENo Image%3C/text%3E%3C/svg%3E";
        if (!product || typeof product !== 'object') return fallback;
        if (product.images && Array.isArray(product.images) && product.images.length > 0) {
            const img = product.images[0];
            if (typeof img === 'string' && img.startsWith('http')) return img;
            if (img && typeof img === 'object' && img.url && img.url.startsWith('http')) return img.url;
        }
        if (product.image && typeof product.image === 'string' && product.image.startsWith('http')) return product.image;
        if (product.primaryImage && product.primaryImage.startsWith('http')) return product.primaryImage;
        return fallback;
    }
    function renderCartSummary() {
        console.log('Rendering cart summary...');
        if (!checkoutState.cart) return;
        const { items, pricing } = checkoutState.cart;
        const cartItemsContainer = document.getElementById('cartItemsList');
        if (!items || !Array.isArray(items) || items.length === 0) {
            cartItemsContainer.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No items in cart</p>';
            return;
        }
        // ‚úÖ Handle both { product: {...}, quantity } and flat item formats
        const itemsHtml = items.map((item, index) => {
            if (!item) return '';
            const product = item.product || item; // ‚Üê key fix
            const quantity = item.quantity || 1;
            const price = product.price ?? item.priceAtAdd ?? item.price ?? 0;
            const productName = product.name || 'Product';
            const productId = product._id || product.id || `item-${index}`;
            const itemTotal = price * quantity;
            return `
                <div class="cart-item" data-product-id="${productId}">
                    <img src="${getSafeImageUrl(product)}" alt="${productName}" class="item-image">
                    <div class="item-details">
                        <div class="item-name">${productName}</div>
                        <div class="item-quantity">Qty: ${quantity}</div>
                    </div>
                    <div class="item-price">‚Çπ${itemTotal.toLocaleString()}</div>
                </div>
            `;
        }).filter(html => html).join('');
        cartItemsContainer.innerHTML = itemsHtml;
        updatePricingDisplay(items, pricing);
    }
    function updatePricingDisplay(items, pricing) {
        const itemCount = items ? items.reduce((sum, item) => sum + (item.quantity || 1), 0) : 0;
        const subtotal = pricing?.subtotal || 0;
        const discount = pricing?.discount || 0;
        const deliveryFee = pricing?.deliveryFee || (subtotal >= 500 ? 0 : 25);
        const tax = pricing?.tax || Math.round(subtotal * 0.05 * 100) / 100;
        const total = pricing?.total || (subtotal - discount + deliveryFee + tax);
        document.getElementById('itemCount').textContent = itemCount;
        document.getElementById('subtotal').textContent = `‚Çπ${subtotal.toLocaleString()}`;
        document.getElementById('discount').textContent = `-‚Çπ${discount.toLocaleString()}`;
        document.getElementById('deliveryFee').textContent = deliveryFee > 0 ? `‚Çπ${deliveryFee.toLocaleString()}` : 'FREE';
        document.getElementById('tax').textContent = `‚Çπ${tax.toLocaleString()}`;
        document.getElementById('total').textContent = `‚Çπ${total.toLocaleString()}`;
        const deliveryElement = document.getElementById('deliveryFee');
        deliveryElement.style.color = deliveryFee === 0 ? 'var(--accent)' : 'inherit';
        deliveryElement.style.fontWeight = deliveryFee === 0 ? '700' : 'inherit';
    }
    function validateField(field) {
        const value = field.value.trim();
        let isValid = true;
        let errorMessage = '';
        if (field.hasAttribute('required') && !value) {
            isValid = false;
            errorMessage = `${field.previousElementSibling.textContent.replace(' *', '')} is required`;
        } else if (field.name === 'email' && value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid email address';
        } else if (field.name === 'phone' && value && !/^[6-9]\d{9}$/.test(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid 10-digit mobile number';
        } else if (field.name === 'pincode' && value && !/^[1-9][0-9]{5}$/.test(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid 6-digit pincode';
        } else if (field.name === 'cardNumber' && checkoutState.selectedPayment === 'card' && value && !/^\d{4}\s\d{4}\s\d{4}\s\d{4}$/.test(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid 16-digit card number';
        } else if (field.name === 'cardExpiry' && checkoutState.selectedPayment === 'card' && value && !/^(0[1-9]|1[0-2])\/\d{2}$/.test(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid expiry date (MM/YY)';
        } else if (field.name === 'cardCvv' && checkoutState.selectedPayment === 'card' && value && !/^\d{3,4}$/.test(value)) {
            isValid = false;
            errorMessage = 'Please enter a valid CVV';
        } else if (field.name === 'cardName' && checkoutState.selectedPayment === 'card' && value && value.length < 2) {
            isValid = false;
            errorMessage = 'Please enter the name on your card';
        }
        showFieldError(field, isValid ? '' : errorMessage);
        return isValid;
    }
    function showFieldError(field, message) {
        field.classList.toggle('error', !!message);
        const errorDiv = field.parentNode.querySelector('.field-error');
        if (errorDiv) errorDiv.textContent = message;
    }
    function clearFieldError(field) { showFieldError(field, ''); }
    function validateForm() {
        let isFormValid = true;
        document.querySelectorAll('#checkoutForm .form-input[required]').forEach(input => {
            if (!validateField(input)) isFormValid = false;
        });
        if (checkoutState.selectedPayment === 'card') {
            const cardFields = ['cardNumber', 'cardName', 'cardExpiry', 'cardCvv'];
            cardFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field && !validateField(field)) isFormValid = false;
            });
        }
        return isFormValid;
    }
    function loadSavedAddress() {
        const user = window.HybridAuthClient.getCurrentUser();
        if (user && user.address) {
            Object.keys(user.address).forEach(field => {
                const input = document.getElementById(field);
                if (input && user.address[field]) input.value = user.address[field];
            });
        }
    }
    async function saveAddress() {
        if (!checkoutState.saveAddress) return;
        const form = document.getElementById("checkoutForm");
        const address = {
            name: form.querySelector("#name").value,
            email: form.querySelector("#email").value,
            phone: form.querySelector("#phone").value,
            address: form.querySelector("#address").value,
            city: form.querySelector("#city").value,
            state: form.querySelector("#state").value,
            pincode: form.querySelector("#pincode").value,
            country: form.querySelector("#country").value
        };
        try {
            await api.request('/api/v1/auth/profile', { method: 'PUT', body: JSON.stringify({ address }) });
        } catch (error) {
            console.warn('Could not save address:', error.message);
        }
    }
    function validateCartBeforeCheckout() {
        if (!checkoutState.cart || !checkoutState.cart.items || checkoutState.cart.items.length === 0) {
            showToast('Your cart is empty', 'error');
            setTimeout(() => { window.location.href = 'cart.html'; }, 2000);
            return false;
        }
        const unavailableItems = checkoutState.cart.unavailableItems || [];
        if (unavailableItems.length > 0) {
            showToast('Some items in your cart are no longer available', 'error');
            setTimeout(() => { window.location.href = 'cart.html'; }, 2000);
            return false;
        }
        return true;
    }
    async function handlePlaceOrder() {
        if (checkoutState.isProcessing) return;
        if (!validateCartBeforeCheckout()) return;
        if (!validateForm()) {
            showToast('Please fill in all required fields correctly', 'error');
            return;
        }
        checkoutState.isProcessing = true;
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const originalText = placeOrderBtn.innerHTML;
        placeOrderBtn.disabled = true;
        placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        await saveAddress();
        const formData = new FormData(document.getElementById('checkoutForm'));
        const shippingAddress = Object.fromEntries(formData.entries());
        // ==========================================================
        // == START: CRITICAL FIX ‚Äî Robust product ID extraction
        // ==========================================================
        const orderPayload = { 
            shippingAddress, 
            paymentMethod: checkoutState.selectedPayment,
            saveAddress: checkoutState.saveAddress,
            items: checkoutState.cart.items.map(item => ({
                product: (item.product?._id || item._id || item.id),
                quantity: item.quantity || 1
            }))
        };
        // ==========================================================
        // == END: CRITICAL FIX
        // ==========================================================
        if (checkoutState.selectedPayment === 'card') {
            orderPayload.cardDetails = {
                number: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                name: document.getElementById('cardName').value,
                expiry: document.getElementById('cardExpiry').value,
                cvv: document.getElementById('cardCvv').value
            };
        }
        try {
            const response = await api.post('/api/v1/orders', orderPayload);
            if (response.success && response.order) {
                showOrderSuccess(response.order.orderId || response.order._id);
            } else {
                throw new Error(response.message || 'Failed to place order.');
            }
        } catch (error) {
            showToast(`Order failed: ${error.message}`, 'error');
        } finally {
            checkoutState.isProcessing = false;
            placeOrderBtn.disabled = false;
            placeOrderBtn.innerHTML = originalText;
        }
    }
    function showOrderSuccess(orderId) {
        document.getElementById('orderNumber').textContent = orderId;
        updateEmailPreview();
        document.getElementById('successModal').classList.add('active');
        checkoutState.cart = null;
    }
    function updateEmailPreview() {
        if (!checkoutState.cart) return;
        const { items, pricing } = checkoutState.cart;
        const emailPreviewContainer = document.getElementById('emailPreviewItems');
        const emailPreviewTotal = document.getElementById('emailPreviewTotal');
        if (!items || !Array.isArray(items)) return;
        const itemsHtml = items.map((item, index) => {
            if (!item) return '';
            const product = item.product || item;
            const quantity = item.quantity || 1;
            const price = product.price ?? item.priceAtAdd ?? item.price ?? 0;
            const productName = product.name || 'Product';
            const itemTotal = price * quantity;
            return `
                <div class="email-item">
                    <span>${productName} √ó ${quantity}</span>
                    <span>‚Çπ${itemTotal.toLocaleString()}</span>
                </div>
            `;
        }).filter(html => html).join('');
        emailPreviewContainer.innerHTML = itemsHtml;
        const total = pricing?.total || 0;
        emailPreviewTotal.textContent = `‚Çπ${total.toLocaleString()}`;
    }
    function closeSuccessModal() {
        document.getElementById('successModal').classList.remove('active');
        window.location.href = 'marketplace.html';
    }
    function showLoading(isLoading) {
        document.getElementById('loadingState').style.display = isLoading ? 'flex' : 'none';
        document.getElementById('checkoutContent').style.display = 'none';
        document.getElementById('emptyCheckoutState').style.display = 'none';
    }
    function showEmptyCheckout() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('checkoutContent').style.display = 'none';
        document.getElementById('emptyCheckoutState').style.display = 'block';
    }
    function showCheckoutContent() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('checkoutContent').style.display = 'grid';
        document.getElementById('emptyCheckoutState').style.display = 'none';
    }
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} toast-icon"></i><div>${message}</div>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }
    window.closeSuccessModal = closeSuccessModal;
    </script>
</body>
</html>