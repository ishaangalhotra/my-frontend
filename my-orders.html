<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My Orders - QuickLocal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --primary-soft: #eef2ff;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-light: #94a3b8;
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --radius-lg: 1rem;
            --radius-xl: 1.25rem;
            --shadow-sm: 0 1px 2px rgba(15,23,42,0.05);
            --shadow-md: 0 4px 10px rgba(15,23,42,0.08);
            --transition: all 0.18s ease-out;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "Inter", sans-serif;
            background: radial-gradient(circle at top, #e0f2fe 0, #f8fafc 42%, #f1f5f9 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        header {
            position: sticky;
            top: 0;
            z-index: 20;
            background: rgba(255,255,255,0.86);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(148,163,184,0.3);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0.7rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-logo {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #f97316, #facc15);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(249,115,22,0.3);
            color: #fff;
        }

        .nav-title-main {
            font-size: 1.05rem;
            font-weight: 700;
        }

        .nav-title-sub {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-pill {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.7rem;
            background: #e0f2fe;
            color: #0369a1;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .nav-link-home {
            font-size: 0.78rem;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.7);
            background: #0f172a;
            color: #e5e7eb;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 4px 12px rgba(15,23,42,0.3);
        }

        .nav-link-home i {
            font-size: 0.85rem;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.3rem 1rem 2.5rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .page-title-block {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-title span.icon {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .page-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .orders-summary {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .summary-pill {
            background: rgba(255,255,255,0.9);
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.35);
            padding: 0.45rem 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.78rem;
            box-shadow: var(--shadow-sm);
        }

        .summary-pill span.badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--primary);
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .filter-chip {
            flex: 1 1 180px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(255,255,255,0.9);
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.45);
            padding: 0.35rem 0.7rem;
            box-shadow: var(--shadow-sm);
        }

        .filter-chip i {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .filter-chip select,
        .filter-chip input {
            border: none;
            background: transparent;
            outline: none;
            font-size: 0.8rem;
            width: 100%;
        }

        .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.45rem 0.9rem;
            font-size: 0.78rem;
            border-radius: 999px;
            border: 1px solid rgba(129,140,248,0.7);
            background: #eef2ff;
            color: #4f46e5;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .refresh-btn i {
            font-size: 0.8rem;
        }

        .layout {
            display: grid;
            grid-template-columns: minmax(0, 1.8fr) minmax(260px, 1.1fr);
            gap: 1.2rem;
        }

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .orders-panel {
            background: rgba(255,255,255,0.95);
            border-radius: var(--radius-xl);
            padding: 1rem;
            box-shadow: var(--shadow-md);
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 70vh;
            overflow: auto;
            padding-right: 0.3rem;
        }

        .orders-list::-webkit-scrollbar {
            width: 6px;
        }
        .orders-list::-webkit-scrollbar-thumb {
            background: rgba(148,163,184,0.6);
            border-radius: 999px;
        }

        .order-card {
            border-radius: 1rem;
            border: 1px solid rgba(226,232,240,0.9);
            background: #ffffff;
            box-shadow: var(--shadow-sm);
            padding: 0.75rem 0.85rem;
            display: grid;
            grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.4fr);
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 700px) {
            .order-card {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .order-card.highlight {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px #6366f1, 0 14px 35px rgba(79,70,229,0.25);
        }

        .order-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.35rem;
            margin-bottom: 0.25rem;
        }

        .order-id {
            font-size: 0.88rem;
            font-weight: 600;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            color: #0f172a;
        }

        .order-date {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .status-pill {
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            background: #e5e7eb;
            color: #4b5563;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .status-pill i {
            font-size: 0.45rem;
        }

        .status-pill.pending { background: #fef9c3; color: #854d0e; }
        .status-pill.processing { background: #dbeafe; color: #1d4ed8; }
        .status-pill.shipped { background: #dcfce7; color: #166534; }
        .status-pill.delivered { background: #bbf7d0; color: #166534; }
        .status-pill.cancelled { background: #fee2e2; color: #b91c1c; }

        .order-main {
            display: flex;
            gap: 0.65rem;
            align-items: center;
        }

        .order-image {
            width: 60px;
            height: 60px;
            border-radius: 0.9rem;
            background: #f1f5f9;
            overflow: hidden;
            flex-shrink: 0;
        }

        .order-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-items-text {
            flex: 1;
            min-width: 0;
        }

        .item-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-meta {
            font-size: 0.78rem;
            color: var(--text-light);
        }

        .order-total-block {
            margin-top: 0.35rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .order-total-block strong {
            font-size: 0.9rem;
        }

        .order-side {
            border-left: 1px dashed #e2e8f0;
            padding-left: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 0.4rem;
        }

        @media (max-width: 700px) {
            .order-side {
                border-left: none;
                border-top: 1px dashed #e2e8f0;
                padding-left: 0;
                padding-top: 0.5rem;
            }
        }

        .order-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .order-action {
            border-radius: 999px;
            padding: 0.35rem 0.7rem;
            font-size: 0.76rem;
            border: 1px solid #e2e8f0;
            background: #f9fafb;
            color: #0f172a;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition);
        }

        .order-action i {
            font-size: 0.8rem;
        }

        .order-action.primary {
            border-color: #6366f1;
            background: #eef2ff;
            color: #4338ca;
        }
        .order-action.primary:hover { background: #e0e7ff; }

        .order-action.danger {
            border-color: #fecaca;
            background: #fef2f2;
            color: #b91c1c;
        }

        .order-action.secondary {
            border-color: #bae6fd;
            background: #eff6ff;
            color: #0369a1;
        }

        .order-meta-line {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .stats-panel {
            background: rgba(15,23,42,0.93);
            color: #e5e7eb;
            border-radius: var(--radius-xl);
            padding: 1rem;
            box-shadow: 0 18px 40px rgba(15,23,42,0.6);
            position: relative;
            overflow: hidden;
        }

        .stats-panel:before {
            content: "";
            position: absolute;
            right: -60px;
            top: -60px;
            width: 180px;
            height: 180px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #4f46e5, transparent 70%);
            opacity: 0.8;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.7rem;
        }

        .stats-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stats-subtitle {
            font-size: 0.75rem;
            color: #cbd5f5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 0.6rem;
        }

        .stat-card {
            border-radius: 0.85rem;
            background: rgba(15,23,42,0.85);
            border: 1px solid rgba(148,163,184,0.4);
            padding: 0.6rem 0.7rem;
            position: relative;
            overflow: hidden;
        }

        .stat-label {
            font-size: 0.72rem;
            color: #94a3b8;
            margin-bottom: 0.15rem;
        }

        .stat-value {
            font-size: 1.05rem;
            font-weight: 600;
        }

        .stat-chip {
            font-size: 0.7rem;
            color: #bbf7d0;
            margin-top: 0.2rem;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 2rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
        }

        .pagination {
            display: none;
            margin-top: 0.75rem;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .pagination button {
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #ffffff;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .loader-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.12);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }

        .loader-card {
            background: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 999px;
            box-shadow: var(--shadow-md);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loader-card i {
            color: var(--primary);
        }

        .toast {
            position: fixed;
            top: 70px;
            right: 16px;
            padding: 0.6rem 0.9rem;
            border-radius: 999px;
            background: #111827;
            color: #e5e7eb;
            font-size: 0.8rem;
            display: none;
            align-items: center;
            gap: 0.4rem;
            z-index: 50;
            box-shadow: 0 10px 30px rgba(15,23,42,0.5);
        }

        .toast.toast-success { background: #16a34a; }
        .toast.toast-error { background: #b91c1c; }
        .toast.toast-warning { background: #ea580c; }

        /* --- Order Details Modal --- */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.65);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
            padding: 1rem;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: #ffffff;
            border-radius: 1.2rem;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 22px 45px rgba(15,23,42,0.5);
            overflow: hidden;
        }

        .modal-header {
            padding: 0.85rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .modal-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .modal-body {
            padding: 0.9rem 1rem 1rem;
            overflow: auto;
        }

        .modal-close-btn {
            border: none;
            background: transparent;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .details-layout {
            display: grid;
            grid-template-columns: minmax(0,1.6fr) minmax(260px,1.1fr);
            gap: 0.75rem;
        }

        @media (max-width: 900px) {
            .details-layout { grid-template-columns: minmax(0,1fr); }
        }

        .details-items {
            border-radius: 0.9rem;
            border: 1px solid var(--border);
            padding: 0.6rem 0.65rem;
        }

        .details-items-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .details-item-row {
            display: grid;
            grid-template-columns: auto minmax(0, 1fr) auto;
            gap: 0.6rem;
            padding: 0.45rem 0.45rem;
            border-radius: 0.6rem;
            background: #f9fafb;
            margin-bottom: 0.3rem;
        }

        .details-item-img {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #e5e7eb;
        }

        .details-item-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .details-item-name {
            font-size: 0.82rem;
            font-weight: 600;
            margin-bottom: 0.12rem;
        }

        .details-item-meta {
            font-size: 0.74rem;
            color: var(--text-light);
        }

        .details-item-price {
            text-align: right;
            font-size: 0.8rem;
        }

        .details-side-card {
            border-radius: 0.9rem;
            border: 1px solid var(--border);
            background: #f8fafc;
            padding: 0.65rem 0.7rem;
            font-size: 0.8rem;
            margin-bottom: 0.55rem;
        }

        .details-side-title {
            font-weight: 600;
            font-size: 0.83rem;
            margin-bottom: 0.25rem;
        }

        .details-side-line {
            margin-bottom: 0.15rem;
        }

        .details-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .details-summary-row.total {
            font-weight: 700;
            border-top: 1px dashed var(--border);
            margin-top: 0.3rem;
            padding-top: 0.3rem;
        }
    </style>
</head>
<body>
<header>
    <div class="nav-container">
        <div class="nav-left">
            <div class="brand-logo">
                <i class="fas fa-bag-shopping"></i>
            </div>
            <div>
                <div class="nav-title-main">QuickLocal</div>
                <div class="nav-title-sub">Your recent orders</div>
            </div>
        </div>
        <div class="nav-right">
            <div class="nav-pill">
                <span class="badge-dot"></span>
                <span>Signed in</span>
            </div>
            <a href="marketplace.html" class="nav-link-home">
                <i class="fas fa-arrow-left"></i>
                Back to shopping
            </a>
        </div>
    </div>
</header>

<main>
    <div class="page-header">
        <div class="page-title-block">
            <div class="page-title">
                <span class="icon"><i class="fas fa-box-open"></i></span>
                My Orders
            </div>
            <div class="page-subtitle">
                Track your purchases, see item details, and manage returns or cancellations.
            </div>
        </div>
        <div class="orders-summary">
            <div class="summary-pill">
                <span class="badge-dot"></span>
                <span><strong id="summaryTotal">0</strong> orders</span>
            </div>
            <div class="summary-pill">
                <i class="fas fa-truck-fast"></i>
                <span id="summaryActive">0 in progress</span>
            </div>
            <div class="summary-pill">
                <i class="fas fa-circle-check"></i>
                <span id="summaryDelivered">0 delivered</span>
            </div>
        </div>
    </div>

    <div class="filters-row">
        <div class="filter-chip">
            <i class="fas fa-magnifying-glass"></i>
            <input type="text" id="searchInput" placeholder="Search by order ID or item name..." />
        </div>
        <div class="filter-chip">
            <i class="fas fa-filter"></i>
            <select id="statusFilter">
                <option value="">All statuses</option>
                <option value="pending">Pending</option>
                <option value="processing">Processing</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="filter-chip">
            <i class="fas fa-clock"></i>
            <select id="timeFilter">
                <option value="">All time</option>
                <option value="week">Last 7 days</option>
                <option value="month">Last 30 days</option>
                <option value="3months">Last 3 months</option>
            </select>
        </div>
        <button id="refreshBtn" class="refresh-btn">
            <i class="fas fa-rotate"></i> Refresh
        </button>
    </div>

    <div class="layout">
        <section class="orders-panel">
            <div id="emptyState" class="empty-state" style="display:none;">
                <i class="fas fa-box-open"></i>
                <h3 style="margin-bottom:0.25rem;">You havenâ€™t placed any orders yet</h3>
                <p style="font-size:0.85rem;">Once you buy something from QuickLocal, itâ€™ll show up here.</p>
            </div>

            <div id="ordersContainer" class="orders-list" style="display:none;"></div>

            <div id="paginationContainer" class="pagination">
                <button id="prevPageBtn">&laquo; Previous</button>
                <span id="pageInfo"></span>
                <button id="nextPageBtn">Next &raquo;</button>
            </div>
        </section>

        <aside class="stats-panel">
            <div class="stats-header">
                <div>
                    <div class="stats-title">Order insights</div>
                    <div class="stats-subtitle">A quick overview of your activity</div>
                </div>
                <i class="fas fa-chart-line" style="font-size:0.9rem; opacity:0.7;"></i>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total spend</div>
                    <div class="stat-value" id="statTotalSpend">â‚¹0</div>
                    <div class="stat-chip">Last 90 days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Average order value</div>
                    <div class="stat-value" id="statAvgOrder">â‚¹0</div>
                    <div class="stat-chip">Per order</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Delivered</div>
                    <div class="stat-value" id="statDelivered">0</div>
                    <div class="stat-chip">Completed purchases</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">In transit</div>
                    <div class="stat-value" id="statInTransit">0</div>
                    <div class="stat-chip">Shipped / Processing</div>
                </div>
            </div>
        </aside>
    </div>
</main>

<!-- Loader -->
<div id="loaderOverlay" class="loader-overlay">
    <div class="loader-card">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading your orders.</span>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Order Details Modal -->
<div id="orderDetailsModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <div>
                <div class="modal-title" id="modalOrderTitle">Order details</div>
                <div style="font-size:0.75rem; color:var(--text-light);" id="modalOrderMeta"></div>
            </div>
            <button class="modal-close-btn" onclick="closeOrderDetailsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="details-layout">
                <div class="details-items">
                    <div class="details-items-title">Items in this order</div>
                    <div id="modalItemsContainer"></div>
                </div>
                <div>
                    <div class="details-side-card">
                        <div class="details-side-title"><i class="fas fa-location-dot"></i> Delivery address</div>
                        <div id="modalAddressText"></div>
                    </div>
                    <div class="details-side-card">
                        <div class="details-side-title"><i class="fas fa-user"></i> Contact</div>
                        <div class="details-side-line" id="modalCustomerName"></div>
                        <div class="details-side-line" id="modalCustomerPhone"></div>
                        <div class="details-side-line" id="modalCustomerEmail"></div>
                    </div>
                    <div class="details-side-card">
                        <div class="details-side-title"><i class="fas fa-receipt"></i> Summary</div>
                        <div id="modalSummaryRows"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="js/hybrid-auth-client.js"></script>
<script>
    let allOrders = [];
    let filteredOrders = [];
    let currentPage = 1;
    const ordersPerPage = 6;
    let highlightOrderId = null;

    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        highlightOrderId = urlParams.get('highlight');

        setupEventListeners();
        initializeOrdersPage();
    });

    function setupEventListeners() {
        document.getElementById('searchInput').addEventListener('input', debounce(filterOrders, 250));
        document.getElementById('statusFilter').addEventListener('change', filterOrders);
        document.getElementById('timeFilter').addEventListener('change', filterOrders);
        document.getElementById('refreshBtn').addEventListener('click', loadOrders);

        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderCurrentPage();
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderCurrentPage();
            }
        });
    }

    async function initializeOrdersPage() {
        showLoading(true);
        try {
            let attempts = 0;
            while (!window.HybridAuthClient && attempts < 50) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }

            if (window.HybridAuthClient && typeof window.HybridAuthClient.isAuthenticated === 'function') {
                const isAuth = await window.HybridAuthClient.isAuthenticated();
                if (!isAuth) {
                    showToast('Please log in to view your orders', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                    }, 1500);
                    return;
                }
            }

            await loadOrders();
        } catch (err) {
            console.error('Initialization error:', err);
            showEmptyState();
            showToast('Failed to initialize orders page', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function loadOrders() {
        showLoading(true);
        try {
            console.log('ðŸ” Loading user orders.');
            const endpoint = '/api/v1/orders?limit=50&page=1';
            let response;

            if (window.HybridAuthClient && typeof window.HybridAuthClient.apiCall === 'function') {
                response = await window.HybridAuthClient.apiCall(endpoint, { method: 'GET' });
            } else {
                throw new Error('Authentication client not available');
            }

            if (!response || !response.ok) {
                throw new Error('Failed to load orders: ' + (response ? response.status : 'no response'));
            }

            const result = await response.json();
            const ordersList = result.orders || result.data || result.results || [];
            allOrders = Array.isArray(ordersList) ? ordersList : [];

            allOrders = allOrders.map(order => {
                const products = order.orderItems || order.items || [];
                const status = (order.status || 'pending').toLowerCase();

                return {
                    raw: order,
                    id: order._id || order.id,
                    orderNumber: order.orderNumber || order.orderId || order._id,
                    customer: order.customerInfo || order.user || {},
                    products,
                    totalAmount: order.pricing?.totalPrice ??
                                 order.totalAmount ??
                                 order.total ??
                                 0,
                    orderDate: order.createdAt || order.orderDate || order.date,
                    status,
                    shippingAddress: order.shippingAddress || order.shipping || {},
                    pricing: order.pricing || {},
                    canCancel: order.canCancel || { allowed: status === 'pending' || status === 'processing' },
                    canReturn: order.canReturn || { allowed: status === 'delivered' }
                };
            });

            filteredOrders = [...allOrders];
            renderOrders();
            updateStats();
        } catch (err) {
            console.error('âŒ Error loading orders:', err);
            showToast('Unable to load your orders. Please try again.', 'error');
            allOrders = [];
            filteredOrders = [];
            renderOrders();
            updateStats();
        } finally {
            showLoading(false);
        }
    }

    function filterOrders() {
        const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const timeFilter = document.getElementById('timeFilter').value;

        filteredOrders = allOrders.filter(order => {
            const searchMatch =
                !searchTerm ||
                (order.orderNumber || '').toLowerCase().includes(searchTerm) ||
                (order.products || []).some(p =>
                    (p.name || '').toLowerCase().includes(searchTerm)
                );

            const statusMatch = !statusFilter || order.status === statusFilter;
            const timeMatch = filterByTime(order.orderDate, timeFilter);

            return searchMatch && statusMatch && timeMatch;
        });

        currentPage = 1;
        renderOrders();
        updateStats();
    }

    function filterByTime(orderDate, filter) {
        if (!filter || !orderDate) return true;

        const now = new Date();
        const dt = new Date(orderDate);

        if (isNaN(dt.getTime())) return true;

        if (filter === 'week') {
            const weekAgo = new Date(now);
            weekAgo.setDate(now.getDate() - 7);
            return dt >= weekAgo;
        }
        if (filter === 'month') {
            const monthAgo = new Date(now);
            monthAgo.setMonth(now.getMonth() - 1);
            return dt >= monthAgo;
        }
        if (filter === '3months') {
            const threeMonthsAgo = new Date(now);
            threeMonthsAgo.setMonth(now.getMonth() - 3);
            return dt >= threeMonthsAgo;
        }
        return true;
    }

    function renderOrders() {
        const container = document.getElementById('ordersContainer');
        const emptyState = document.getElementById('emptyState');
        const paginationContainer = document.getElementById('paginationContainer');

        if (!filteredOrders.length) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
            paginationContainer.style.display = 'none';
            return;
        }

        container.style.display = 'flex';
        emptyState.style.display = 'none';

        if (filteredOrders.length > ordersPerPage) {
            paginationContainer.style.display = 'flex';
        } else {
            paginationContainer.style.display = 'none';
        }

        renderCurrentPage();
    }

    function renderCurrentPage() {
        const container = document.getElementById('ordersContainer');
        container.innerHTML = '';

        const start = (currentPage - 1) * ordersPerPage;
        const end = start + ordersPerPage;
        const ordersToShow = filteredOrders.slice(start, end);

        ordersToShow.forEach(order => {
            container.appendChild(renderOrderCard(order));
        });

        const totalPages = Math.ceil(filteredOrders.length / ordersPerPage) || 1;
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    }

    function renderOrderCard(order) {
        const card = document.createElement('div');
        card.className = 'order-card';
        if (highlightOrderId && (order.id === highlightOrderId || order.orderNumber === highlightOrderId)) {
            card.classList.add('highlight');
        }

        const products = order.products || [];
        const firstItem = products[0] || {};
        const imgUrl = getItemImage(firstItem);
        const itemName = firstItem.name || 'Item from your order';
        const itemCount = products.length;

        const statusClass = getStatusClass(order.status);
        const statusLabel = getStatusLabel(order.status);

        const dateLabel = order.orderDate ? formatDateTime(order.orderDate) : 'Date not available';
        const totalLabel = formatCurrency(order.totalAmount || 0);

        card.innerHTML = `
            <div>
                <div class="order-header-row">
                    <div>
                        <div class="order-id">Order #${(order.orderNumber || order.id || '').toString().slice(-10)}</div>
                        <div class="order-date">Placed on ${dateLabel}</div>
                    </div>
                    <div class="status-pill ${statusClass}">
                        <i class="fas fa-circle"></i>
                        <span>${statusLabel}</span>
                    </div>
                </div>
                <div class="order-main">
                    <div class="order-image">
                        <img src="${imgUrl}" alt="${itemName}">
                    </div>
                    <div class="order-items-text">
                        <div class="item-title" title="${itemName}">${itemName}</div>
                        <div class="item-meta">
                            ${itemCount > 1 ? `${itemCount} items in this order` : '1 item'}
                        </div>
                        <div class="order-total-block">
                            <span>Order total: <strong>${totalLabel}</strong></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="order-side">
                <div class="order-actions">
                    <button class="order-action primary" onclick="viewOrderDetails('${order.id}')">
                        <i class="fas fa-eye"></i>
                        View details
                    </button>
                    <button class="order-action secondary" onclick="trackOrder('${order.orderNumber || order.id}')">
                        <i class="fas fa-truck"></i>
                        Track
                    </button>
                    ${order.canCancel && order.canCancel.allowed ? `
                        <button class="order-action danger" onclick="cancelOrder('${order.id}')">
                            <i class="fas fa-ban"></i>
                            Cancel
                        </button>
                    ` : ''}
                </div>
                <div class="order-meta-line">
                    ${(order.shippingAddress && order.shippingAddress.city) ? `Delivering to ${order.shippingAddress.city}` : ''}
                </div>
            </div>
        `;

        return card;
    }

    function getItemImage(item) {
        const prod = item.product || {};
        if (item.image && typeof item.image === 'string') return item.image;
        if (prod.images && prod.images[0]) {
            if (typeof prod.images[0] === 'string') return prod.images[0];
            if (prod.images[0].url) return prod.images[0].url;
        }
        if (prod.image) return prod.image;
        return 'https://placehold.co/80x80?text=Item';
    }

    function getStatusClass(status) {
        status = (status || '').toLowerCase();
        if (!status) return '';
        if (status === 'pending') return 'pending';
        if (['processing', 'confirmed', 'preparing'].includes(status)) return 'processing';
        if (['shipped', 'dispatched', 'out_for_delivery'].includes(status)) return 'shipped';
        if (status === 'delivered') return 'delivered';
        if (['cancelled', 'failed'].includes(status)) return 'cancelled';
        return '';
    }

    function getStatusLabel(status) {
        status = (status || '').toLowerCase();
        if (!status) return 'Pending';
        if (status === 'pending') return 'Pending';
        if (['processing', 'confirmed', 'preparing'].includes(status)) return 'Processing';
        if (['shipped', 'dispatched', 'out_for_delivery'].includes(status)) return 'On the way';
        if (status === 'delivered') return 'Delivered';
        if (['cancelled', 'failed'].includes(status)) return 'Cancelled';
        return status[0].toUpperCase() + status.slice(1);
    }

    function formatCurrency(value) {
        const num = Number(value || 0);
        return 'â‚¹' + num.toLocaleString('en-IN', { maximumFractionDigits: 2 });
    }

    function formatDateTime(date) {
        const d = new Date(date);
        if (isNaN(d.getTime())) return 'Unknown date';
        return d.toLocaleDateString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    }

    function updateStats() {
        const totalOrders = allOrders.length;
        const delivered = allOrders.filter(o => o.status === 'delivered').length;
        const active = allOrders.filter(o =>
            ['pending', 'processing', 'shipped'].includes(o.status)
        ).length;

        const totalSpend = allOrders.reduce((sum, o) => sum + Number(o.totalAmount || 0), 0);
        const avgOrder = totalOrders ? totalSpend / totalOrders : 0;

        document.getElementById('summaryTotal').textContent = totalOrders;
        document.getElementById('summaryActive').textContent = `${active} in progress`;
        document.getElementById('summaryDelivered').textContent = `${delivered} delivered`;

        document.getElementById('statTotalSpend').textContent = formatCurrency(totalSpend);
        document.getElementById('statAvgOrder').textContent = formatCurrency(avgOrder);
        document.getElementById('statDelivered').textContent = delivered;
        document.getElementById('statInTransit').textContent = active;
    }

    function showEmptyState() {
        document.getElementById('ordersContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('paginationContainer').style.display = 'none';
    }

    function showLoading(show) {
        document.getElementById('loaderOverlay').style.display = show ? 'flex' : 'none';
    }

    function showToast(msg, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast';
        if (type === 'success') toast.classList.add('toast-success');
        else if (type === 'error') toast.classList.add('toast-error');
        else if (type === 'warning') toast.classList.add('toast-warning');
        toast.style.display = 'flex';
        setTimeout(() => {
            toast.style.display = 'none';
        }, 2500);
    }

    function debounce(fn, delay) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...args), delay);
        };
    }

    // --- Actions ---

    function trackOrder(orderId) {
        if (!orderId) {
            showToast('Order ID missing for tracking', 'warning');
            return;
        }
        window.open(`order-tracking.html?order=${encodeURIComponent(orderId)}`, '_blank');
    }

    async function cancelOrder(orderId) {
        if (!orderId) return;
        if (!confirm('Are you sure you want to cancel this order?')) return;

        try {
            showLoading(true);
            const res = await window.HybridAuthClient.apiCall(`/orders/${orderId}/cancel`, {
                method: 'POST'
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.success === false) {
                throw new Error(data.message || 'Failed to cancel order');
            }
            showToast('Order cancelled', 'success');
            await loadOrders();
        } catch (err) {
            console.error('Cancel error:', err);
            showToast(err.message || 'Could not cancel order', 'error');
        } finally {
            showLoading(false);
        }
    }

    function viewOrderDetails(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
            showToast('Order not found', 'error');
            return;
        }

        const modal = document.getElementById('orderDetailsModalBackdrop');
        const titleEl = document.getElementById('modalOrderTitle');
        const metaEl = document.getElementById('modalOrderMeta');
        const itemsContainer = document.getElementById('modalItemsContainer');
        const addrText = document.getElementById('modalAddressText');
        const custName = document.getElementById('modalCustomerName');
        const custPhone = document.getElementById('modalCustomerPhone');
        const custEmail = document.getElementById('modalCustomerEmail');
        const summaryRows = document.getElementById('modalSummaryRows');

        const statusLabel = getStatusLabel(order.status);
        titleEl.textContent = `Order #${(order.orderNumber || order.id || '').toString().slice(-10)}`;
        metaEl.textContent = `${statusLabel} â€¢ ${formatDateTime(order.orderDate)}`;

        itemsContainer.innerHTML = '';
        (order.products || []).forEach(item => {
            const img = getItemImage(item);
            const name = item.name || 'Item';
            const qty = item.qty || item.quantity || 1;
            const unitPrice = item.unitPrice ?? item.price ?? 0;
            const total = item.totalPrice ?? (unitPrice * qty);

            const row = document.createElement('div');
            row.className = 'details-item-row';
            row.innerHTML = `
                <div class="details-item-img">
                    <img src="${img}" alt="${name}">
                </div>
                <div>
                    <div class="details-item-name">${name}</div>
                    <div class="details-item-meta">Qty: ${qty}</div>
                </div>
                <div class="details-item-price">
                    <div>${formatCurrency(unitPrice)}</div>
                    <div style="font-size:0.72rem; color:var(--text-light);">Total: ${formatCurrency(total)}</div>
                </div>
            `;
            itemsContainer.appendChild(row);
        });

        const ship = order.shippingAddress || {};
        const addrParts = [
            ship.name || ship.fullName,
            ship.address,
            ship.city,
            ship.state,
            ship.postalCode || ship.pincode,
            ship.country
        ].filter(Boolean);
        addrText.innerHTML = addrParts.join(', ') || 'No address provided';

        const cust = order.customer || {};
        custName.textContent = (cust.name || 'Customer');
        custPhone.textContent = (cust.phone || ship.phone || ship.phoneNumber || 'Phone not available');
        custEmail.textContent = (cust.email || ship.email || 'Email not available');

        const pricing = order.pricing || {};
        const itemsPrice = pricing.itemsPrice ?? pricing.subtotal ?? null;
        const shipping = pricing.shippingPrice ?? pricing.shipping ?? null;
        const tax = pricing.taxPrice ?? pricing.tax ?? null;
        const discount = pricing.discountAmount ?? pricing.discount ?? null;
        const totalAmount = order.totalAmount || pricing.totalPrice || 0;

        summaryRows.innerHTML = '';

        if (itemsPrice != null) {
            summaryRows.innerHTML += `
                <div class="details-summary-row">
                    <span>Items total</span>
                    <span>${formatCurrency(itemsPrice)}</span>
                </div>
            `;
        }
        if (shipping != null) {
            summaryRows.innerHTML += `
                <div class="details-summary-row">
                    <span>Shipping</span>
                    <span>${formatCurrency(shipping)}</span>
                </div>
            `;
        }
        if (tax != null) {
            summaryRows.innerHTML += `
                <div class="details-summary-row">
                    <span>Tax</span>
                    <span>${formatCurrency(tax)}</span>
                </div>
            `;
        }
        if (discount) {
            summaryRows.innerHTML += `
                <div class="details-summary-row">
                    <span>Discount</span>
                    <span>- ${formatCurrency(discount)}</span>
                </div>
            `;
        }
        summaryRows.innerHTML += `
            <div class="details-summary-row total">
                <span>Grand total</span>
                <span>${formatCurrency(totalAmount)}</span>
            </div>
        `;

        modal.classList.add('active');
    }

    function closeOrderDetailsModal() {
        document.getElementById('orderDetailsModalBackdrop').classList.remove('active');
    }
</script>
</body>
</html>
