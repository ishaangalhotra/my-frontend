<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Orders - QuickLocal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #111827;
            --bg-surface: #0b1120;
            --bg-card: #020617;
            --bg-soft: #020617;
            --accent: #6366f1;
            --accent-soft: rgba(99, 102, 241, 0.1);
            --accent-strong: #4f46e5;
            --success: #22c55e;
            --warning: #facc15;
            --danger: #ef4444;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --border-subtle: rgba(148, 163, 184, 0.3);
            --radius-lg: 1.25rem;
            --radius-xl: 1.75rem;
            --shadow-lg: 0 24px 80px rgba(15, 23, 42, 0.9);
            --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.7);
            --shadow-subtle: 0 0 0 1px rgba(148, 163, 184, 0.35);
            --transition: all 0.2s ease;
            --transition-soft: all 0.3s ease-out;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif;
            background: radial-gradient(circle at top, #1f2937 0, #020617 40%);
            color: var(--text-primary);
            min-height: 100vh;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        .page-shell {
            max-width: 1100px;
            margin: 24px auto 40px;
            padding: 0 16px 32px;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
            gap: 16px;
        }

        .page-title-wrap {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .page-title {
            font-size: 1.7rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pill {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 3px 10px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .page-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .orders-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.2fr);
            gap: 18px;
        }

        @media (max-width: 900px) {
            .orders-layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        /* Left: Orders list */
        .orders-panel {
            background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.25), transparent 60%),
                        radial-gradient(circle at bottom right, rgba(8, 47, 73, 0.9), rgba(15, 23, 42, 1));
            border-radius: 28px;
            padding: 18px 18px 20px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .orders-panel::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 0% 0%, rgba(96, 165, 250, 0.08), transparent 40%);
            mix-blend-mode: screen;
        }

        .orders-panel-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .orders-panel-title {
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(226, 232, 240, 0.9);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .orders-chip {
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.5);
        }

        .orders-scroll {
            position: relative;
            margin-top: 6px;
            max-height: 540px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .orders-scroll::-webkit-scrollbar {
            width: 5px;
        }
        .orders-scroll::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 999px;
        }

        .order-card {
            position: relative;
            background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.2), rgba(15, 23, 42, 0.98));
            border-radius: 20px;
            padding: 12px 12px 12px 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            margin-bottom: 10px;
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            display: grid;
            grid-template-columns: auto minmax(0, 1fr);
            gap: 12px;
            align-items: stretch;
            transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
        }

        .order-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 18px 50px rgba(79, 70, 229, 0.8);
        }

        .order-thumb {
            width: 80px;
            min-width: 80px;
            height: 80px;
            border-radius: 18px;
            overflow: hidden;
            position: relative;
            background: radial-gradient(circle at top, rgba(30, 64, 175, 0.4), #020617 60%);
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .order-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-thumb-label {
            position: absolute;
            bottom: 6px;
            left: 6px;
            right: 6px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            text-align: center;
            color: var(--text-secondary);
        }

        .order-main {
            display: grid;
            grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.2fr);
            gap: 10px;
        }

        @media (max-width: 680px) {
            .order-card {
                grid-template-columns: minmax(0, 1fr);
            }
            .order-main {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .order-line-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .order-title-line {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            align-items: center;
        }

        .order-product-name {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .order-product-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .order-id {
            font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono";
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .order-meta-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.78rem;
        }

        .order-meta-pill {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(148, 163, 184, 0.45);
            color: var(--text-secondary);
        }

        .order-price-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .order-total {
            font-weight: 600;
            font-size: 1rem;
        }

        .order-status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 9px;
            border-radius: 999px;
            font-size: 0.76rem;
            text-transform: uppercase;
            letter-spacing: 0.09em;
        }

        .status-pending {
            background: rgba(251, 191, 36, 0.10);
            color: #facc15;
            border: 1px solid rgba(250, 204, 21, 0.4);
        }

        .status-processing {
            background: rgba(59, 130, 246, 0.12);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        .status-shipped {
            background: rgba(56, 189, 248, 0.15);
            color: #22d3ee;
            border: 1px solid rgba(56, 189, 248, 0.6);
        }

        .status-delivered {
            background: rgba(34, 197, 94, 0.16);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.6);
        }

        .status-cancelled, .status-failed {
            background: rgba(248, 113, 113, 0.12);
            color: #fca5a5;
            border: 1px solid rgba(248, 113, 113, 0.45);
        }

        .order-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-between;
            gap: 8px;
        }

        .order-actions-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .order-action-btn {
            font-size: 0.78rem;
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            background: rgba(15, 23, 42, 0.7);
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: var(--transition);
        }

        .order-action-btn.primary {
            border-color: rgba(129, 140, 248, 0.9);
            background: radial-gradient(circle at top, rgba(79, 70, 229, 0.8), rgba(15, 23, 42, 0.9));
            color: #e5e7eb;
        }

        .order-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.7);
        }

        .order-action-btn.danger {
            border-color: rgba(248, 113, 113, 0.9);
            background: rgba(127, 29, 29, 0.9);
        }

        .order-action-btn.secondary {
            border-color: rgba(59, 130, 246, 0.8);
            background: rgba(15, 23, 42, 0.8);
        }

        /* Right: Summary / timeline card */
        .side-panel {
            background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.3), rgba(15, 23, 42, 0.98));
            border-radius: 28px;
            padding: 16px 16px 18px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            box-shadow: var(--shadow-soft);
            position: relative;
            overflow: hidden;
        }

        .side-panel::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 110% -10%, rgba(16, 185, 129, 0.4), transparent 50%);
            opacity: 0.9;
        }

        .side-panel-inner {
            position: relative;
            z-index: 1;
        }

        .side-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .side-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(226, 232, 240, 0.9);
        }

        .side-value {
            font-size: 1.4rem;
            font-weight: 600;
        }

        .side-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(209, 213, 219, 0.8);
            margin-bottom: 4px;
        }

        .side-kpis {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
            margin-bottom: 14px;
        }

        .kpi-card {
            background: rgba(15, 23, 42, 0.4);
            border-radius: 16px;
            padding: 8px 10px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            font-size: 0.8rem;
        }

        .kpi-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .kpi-meta {
            font-size: 0.7rem;
            color: rgba(209, 213, 219, 0.85);
        }

        .side-bottom-note {
            font-size: 0.8rem;
            color: rgba(209, 213, 219, 0.9);
            margin-top: 10px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 32px 24px;
            border-radius: 24px;
            background: radial-gradient(circle at top, rgba(37, 99, 235, 0.2), rgba(15, 23, 42, 0.95));
            border: 1px dashed rgba(148, 163, 184, 0.6);
            margin-top: 12px;
        }

        .empty-title {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 0.88rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .empty-btn {
            border-radius: 999px;
            padding: 8px 16px;
            border: none;
            background: linear-gradient(135deg, #4f46e5, #22c55e);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 14px 35px rgba(30, 64, 175, 0.8);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 14px;
            right: 16px;
            min-width: 220px;
            padding: 10px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.7);
            color: var(--text-secondary);
            font-size: 0.82rem;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 9999;
        }

        .toast.show {
            display: inline-flex;
        }

        .toast-success {
            border-color: rgba(34, 197, 94, 0.8);
        }

        .toast-error {
            border-color: rgba(248, 113, 113, 0.9);
        }

        /* Loading overlay */
        .loading-backdrop {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .loading-backdrop.show {
            display: flex;
        }

        .loading-card {
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            padding: 16px 20px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        /* Modal */
        #orderDetailsModal {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.78);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 12px;
        }

        #orderDetailsModal .modal-inner {
            background: radial-gradient(circle at top, rgba(30, 64, 175, 0.35), rgba(15, 23, 42, 1));
            border-radius: 26px;
            width: 100%;
            max-width: 880px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(148, 163, 184, 0.6);
            box-shadow: 0 30px 80px rgba(15, 23, 42, 0.95);
            padding: 18px 20px 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.6);
            background: rgba(15, 23, 42, 0.9);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-section {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            padding: 10px 12px;
            margin-bottom: 10px;
        }

        .modal-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: rgba(209, 213, 219, 0.9);
            margin-bottom: 6px;
        }

        .details-grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 10px;
        }

        .detail-label {
            font-size: 0.78rem;
            color: rgba(156, 163, 175, 0.9);
        }

        .detail-value {
            font-size: 0.9rem;
        }

        .items-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-row {
            display: grid;
            grid-template-columns: auto minmax(0, 2.5fr) auto;
            gap: 8px;
            align-items: center;
        }

        .item-thumb {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: rgba(15, 23, 42, 0.7);
        }

        .item-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-main {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .item-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .item-meta {
            font-size: 0.78rem;
            color: rgba(156, 163, 175, 0.95);
        }

        .item-price {
            font-size: 0.85rem;
            font-weight: 600;
            text-align: right;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .summary-row.total {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<div class="page-shell">
    <div class="page-header">
        <div class="page-title-wrap">
            <div class="page-title">
                <span>My Orders</span>
                <span class="pill"><i class="fa-solid fa-bag-shopping"></i> Order History</span>
            </div>
            <div class="page-subtitle">
                Track your deliveries, view items, and see live status when sellers update orders.
            </div>
        </div>
    </div>

    <div class="orders-layout">
        <!-- Orders list -->
        <section class="orders-panel">
            <div class="orders-panel-header">
                <div class="orders-panel-title">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>Recent Orders</span>
                </div>
                <div class="orders-chip" id="ordersCountChip">
                    0 Orders
                </div>
            </div>

            <div id="ordersEmpty" class="empty-state" style="display: none;">
                <div style="font-size: 2rem; margin-bottom: 10px;">üõçÔ∏è</div>
                <div class="empty-title">No orders yet</div>
                <div class="empty-text">
                    When you place an order, it will appear here with full item details and tracking.
                </div>
                <button class="empty-btn" onclick="window.location.href='marketplace.html'">
                    <i class="fa-solid fa-store"></i>
                    Start Shopping
                </button>
            </div>

            <div id="ordersScroll" class="orders-scroll" style="display: none;">
                <div id="ordersContainer"></div>
            </div>
        </section>

        <!-- Side summary -->
        <aside class="side-panel">
            <div class="side-panel-inner">
                <div class="side-header">
                    <div>
                        <div class="side-label">This Year</div>
                        <div class="side-title">Order Summary</div>
                    </div>
                    <div class="side-value" id="summaryTotal">‚Çπ0</div>
                </div>

                <div class="side-kpis">
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiOrders">0</div>
                        <div class="kpi-meta">Total Orders</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiDelivered">0</div>
                        <div class="kpi-meta">Delivered</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiInTransit">0</div>
                        <div class="kpi-meta">In Transit</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpiCancelled">0</div>
                        <div class="kpi-meta">Cancelled</div>
                    </div>
                </div>

                <div class="side-bottom-note">
                    Tip: When a seller updates your order status (Processing, Shipped, Delivered),
                    it will refresh here automatically next time you open this page.
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast">
    <i id="toastIcon" class="fa-solid fa-circle-info"></i>
    <span id="toastMsg">Message</span>
</div>

<!-- Loading -->
<div id="loadingOverlay" class="loading-backdrop">
    <div class="loading-card">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <span>Loading your orders‚Ä¶</span>
    </div>
</div>

<script>
    let allOrders = [];
    let filteredOrders = [];

    function showLoading(show) {
        const el = document.getElementById('loadingOverlay');
        if (!el) return;
        el.classList.toggle('show', !!show);
    }

    function showToast(msg, type = 'info') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        const text = document.getElementById('toastMsg');
        if (!toast) return;
        text.textContent = msg;

        toast.className = 'toast show';
        icon.className = 'fa-solid fa-circle-info';

        if (type === 'success') {
            toast.classList.add('toast-success');
            icon.className = 'fa-solid fa-circle-check';
        } else if (type === 'error') {
            toast.classList.add('toast-error');
            icon.className = 'fa-solid fa-triangle-exclamation';
        }

        setTimeout(() => {
            toast.classList.remove('show');
        }, 2500);
    }

    function getApiBase() {
        if (window.API_BASE_URL) return window.API_BASE_URL;
        // Fallback to relative /api/v1
        return '/api/v1';
    }

    async function apiGet(path) {
        // Prefer HybridAuthClient if available
        if (window.HybridAuthClient && typeof window.HybridAuthClient.apiCall === 'function') {
            const res = await window.HybridAuthClient.apiCall(path, { method: 'GET' });
            if (!res.ok) {
                const text = await res.text().catch(() => '');
                throw new Error(`HTTP ${res.status}: ${text}`);
            }
            return res.json();
        }

        const res = await fetch(getApiBase() + path, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        if (!res.ok) {
            const text = await res.text().catch(() => '');
            throw new Error(`HTTP ${res.status}: ${text}`);
        }
        return res.json();
    }

    function normalizeOrders(raw) {
        let list = [];

        if (Array.isArray(raw)) {
            list = raw;
        } else if (raw && Array.isArray(raw.orders)) {
            list = raw.orders;
        } else if (raw && raw.data && Array.isArray(raw.data.orders)) {
            list = raw.data.orders;
        } else if (raw && raw.data && Array.isArray(raw.data)) {
            list = raw.data;
        }

        return list.map(order => {
            const itemsRaw = order.orderItems || order.items || [];
            const products = itemsRaw.map(item => {
                const prod = item.product || {};
                const images = prod.images || [];
                const imgCandidate =
                    item.image ||
                    (Array.isArray(images) && (images[0]?.url || images[0]?.secure_url || images[0])) ||
                    prod.image ||
                    null;

                const name = item.name || prod.name || 'Item';
                const qty = item.qty || item.quantity || 1;
                const price = item.unitPrice ?? item.price ?? prod.price ?? 0;

                return {
                    ...item,
                    product: prod,
                    displayName: name,
                    displayImage: imgCandidate || 'https://placehold.co/80x80?text=Item',
                    displayQty: qty,
                    displayPrice: Number(price) || 0
                };
            });

            const total =
                order.pricing?.totalPrice ??
                order.totalAmount ??
                order.total ??
                products.reduce((sum, p) => sum + p.displayPrice * p.displayQty, 0);

            return {
                ...order,
                id: order._id || order.id,
                orderNumber: order.orderNumber || order.orderId || order._id,
                status: String(order.status || 'pending').toLowerCase(),
                orderDate: order.createdAt || order.orderDate || order.date,
                products,
                totalAmount: Number(total) || 0,
                shippingAddress: order.shippingAddress || order.address || null,
                payment: order.paymentInfo || order.payment || {}
            };
        });
    }

    function formatMoney(v) {
        const num = Number(v) || 0;
        return '‚Çπ' + num.toLocaleString('en-IN');
    }

    function formatDateTime(dateInput) {
        if (!dateInput) return '‚Äî';
        const d = new Date(dateInput);
        if (isNaN(d.getTime())) return '‚Äî';
        return d.toLocaleString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function getStatusLabel(status) {
        const s = String(status || '').toLowerCase();
        if (s === 'processing' || s === 'processed') return 'Processing';
        if (s === 'shipped' || s === 'out_for_delivery') return 'Shipped';
        if (s === 'delivered') return 'Delivered';
        if (s === 'cancelled' || s === 'canceled') return 'Cancelled';
        if (s === 'failed') return 'Failed';
        if (s === 'pending') return 'Pending';
        return s ? (s.charAt(0).toUpperCase() + s.slice(1)) : 'Pending';
    }

    function getStatusClass(status) {
        const s = String(status || '').toLowerCase();
        if (['processing', 'processed'].includes(s)) return 'status-processing';
        if (['shipped', 'out_for_delivery'].includes(s)) return 'status-shipped';
        if (s === 'delivered') return 'status-delivered';
        if (['cancelled', 'canceled', 'failed'].includes(s)) return 'status-cancelled';
        if (!s || s === 'pending') return 'status-pending';
        return 'status-pending';
    }

    function updateSummaryStats() {
        const totalOrders = allOrders.length;
        const totalAmount = allOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

        const delivered = allOrders.filter(o => o.status === 'delivered').length;
        const inTransit = allOrders.filter(o => ['processing', 'processed', 'shipped', 'out_for_delivery'].includes(o.status)).length;
        const cancelled = allOrders.filter(o => ['cancelled', 'canceled', 'failed'].includes(o.status)).length;

        document.getElementById('summaryTotal').textContent = formatMoney(totalAmount);
        document.getElementById('kpiOrders').textContent = totalOrders;
        document.getElementById('kpiDelivered').textContent = delivered;
        document.getElementById('kpiInTransit').textContent = inTransit;
        document.getElementById('kpiCancelled').textContent = cancelled;

        const countChip = document.getElementById('ordersCountChip');
        if (countChip) {
            countChip.textContent = totalOrders === 1 ? '1 Order' : `${totalOrders} Orders`;
        }
    }

    function renderOrders() {
        const container = document.getElementById('ordersContainer');
        const scroll = document.getElementById('ordersScroll');
        const empty = document.getElementById('ordersEmpty');

        if (!container) return;

        if (!filteredOrders.length) {
            container.innerHTML = '';
            scroll.style.display = 'none';
            empty.style.display = 'block';
            updateSummaryStats();
            return;
        }

        scroll.style.display = 'block';
        empty.style.display = 'none';

        container.innerHTML = filteredOrders.map(order => renderOrderCard(order)).join('');
        updateSummaryStats();
    }

    function renderOrderCard(order) {
        const first = order.products && order.products.length ? order.products[0] : null;
        const extraCount = (order.products?.length || 0) - 1;

        const imgUrl = first?.displayImage || 'https://placehold.co/80x80?text=Item';
        const name = first?.displayName || 'Order Items';
        const qty = first?.displayQty || 1;

        const dateStr = formatDateTime(order.orderDate);
        const statusLabel = getStatusLabel(order.status);
        const statusClass = getStatusClass(order.status);

        return `
            <article class="order-card">
                <div class="order-thumb">
                    <img src="${imgUrl}" alt="${name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80?text=Item';">
                    <div class="order-thumb-label">
                        ${order.products?.length || 0} item${order.products?.length === 1 ? '' : 's'}
                    </div>
                </div>
                <div class="order-main">
                    <div class="order-line-info">
                        <div class="order-title-line">
                            <div>
                                <div class="order-product-name">${name}</div>
                                <div class="order-product-meta">
                                    Qty: ${qty}${extraCount > 0 ? ` ‚Ä¢ +${extraCount} more item${extraCount > 1 ? 's' : ''}` : ''}
                                </div>
                            </div>
                            <div class="order-status-pill ${statusClass}">
                                <span style="font-size:6px;">‚óè</span>
                                <span>${statusLabel}</span>
                            </div>
                        </div>
                        <div class="order-meta-row">
                            <div class="order-meta-pill">
                                <i class="fa-solid fa-receipt"></i>
                                <span>Order #${order.orderNumber}</span>
                            </div>
                            <div class="order-meta-pill">
                                <i class="fa-regular fa-calendar"></i>
                                <span>${dateStr}</span>
                            </div>
                        </div>
                        <div class="order-price-line">
                            <div class="order-id">
                                ID: ${order.id}
                            </div>
                            <div class="order-total">
                                ${formatMoney(order.totalAmount)}
                            </div>
                        </div>
                    </div>
                    <div class="order-actions">
                        <div class="order-actions-row">
                            <button class="order-action-btn primary" onclick="viewOrderDetails('${order.id}')">
                                <i class="fa-solid fa-eye"></i>
                                View Details
                            </button>
                            <button class="order-action-btn secondary" onclick="trackOrder('${order.orderNumber || order.id}')">
                                <i class="fa-solid fa-truck"></i>
                                Track
                            </button>
                        </div>
                        <div class="order-actions-row">
                            <button class="order-action-btn danger" onclick="cancelOrder('${order.id}')">
                                <i class="fa-solid fa-xmark"></i>
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </article>
        `;
    }

    // --- Order details modal ---
    function closeOrderDetailsModal() {
        const modal = document.getElementById('orderDetailsModal');
        if (modal) {
            modal.remove();
        }
        document.body.style.overflow = 'auto';
    }

    function openOrderDetailsModal(order) {
        const statusLabel = getStatusLabel(order.status);
        const statusClass = getStatusClass(order.status);

        const addr = order.shippingAddress || {};
        const pay = order.payment || {};

        const itemsHtml = (order.products || []).map(item => {
            const name = item.displayName || 'Item';
            const img = item.displayImage || 'https://placehold.co/80x80?text=Item';
            const qty = item.displayQty || 1;
            const price = item.displayPrice || 0;
            const total = price * qty;

            return `
                <div class="item-row">
                    <div class="item-thumb">
                        <img src="${img}" alt="${name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80?text=Item';">
                    </div>
                    <div class="item-main">
                        <div class="item-name">${name}</div>
                        <div class="item-meta">Quantity: ${qty}</div>
                    </div>
                    <div class="item-price">
                        ${formatMoney(total)}
                    </div>
                </div>
            `;
        }).join('');

        const shipping = Number(order.pricing?.shippingPrice ?? order.shippingCost ?? 0);
        const tax = Number(order.pricing?.taxPrice ?? order.tax ?? 0);
        const subtotal = Number(order.pricing?.itemsPrice ?? order.subtotal ?? (order.totalAmount - shipping - tax)) || 0;
        const total = Number(order.totalAmount || (subtotal + shipping + tax)) || 0;

        const modalHtml = `
            <div id="orderDetailsModal">
                <div class="modal-inner">
                    <div class="modal-header">
                        <div>
                            <div class="detail-label">Order Details</div>
                            <div class="modal-title">Order #${order.orderNumber}</div>
                        </div>
                        <button class="modal-close" onclick="closeOrderDetailsModal()">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <div class="modal-section">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                            <div>
                                <div class="detail-label">Status</div>
                                <div class="order-status-pill ${statusClass}">
                                    <span style="font-size:6px;">‚óè</span>
                                    <span>${statusLabel}</span>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div class="detail-label">Order Date</div>
                                <div class="detail-value">${formatDateTime(order.orderDate)}</div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="modal-section-title">Customer & Delivery</div>
                        <div class="details-grid-2">
                            <div>
                                <div class="detail-label">Delivery To</div>
                                <div class="detail-value">
                                    ${addr.fullName || addr.name || 'Not available'}<br>
                                    ${addr.address || addr.line1 || ''} ${addr.line2 ? '<br>' + addr.line2 : ''}<br>
                                    ${[addr.city, addr.state, addr.postalCode || addr.pincode].filter(Boolean).join(', ')}<br>
                                    ${addr.country || ''}
                                </div>
                            </div>
                            <div>
                                <div class="detail-label">Contact</div>
                                <div class="detail-value">
                                    Phone: ${addr.phoneNumber || addr.phone || '‚Äî'}<br>
                                    Email: ${order.customer?.email || '‚Äî'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="modal-section-title">Items in this order</div>
                        <div class="items-list">
                            ${itemsHtml}
                        </div>
                    </div>

                    <div class="modal-section">
                        <div class="modal-section-title">Payment & Summary</div>
                        <div class="details-grid-2">
                            <div>
                                <div class="detail-label">Payment</div>
                                <div class="detail-value">
                                    Method: ${pay.method || 'Not available'}<br>
                                    Status: ${pay.status || 'Not available'}<br>
                                    Txn ID: ${pay.transactionId || '‚Äî'}
                                </div>
                            </div>
                            <div>
                                <div class="summary-row">
                                    <span>Subtotal</span>
                                    <span>${formatMoney(subtotal)}</span>
                                </div>
                                <div class="summary-row">
                                    <span>Shipping</span>
                                    <span>${formatMoney(shipping)}</span>
                                </div>
                                <div class="summary-row">
                                    <span>Tax</span>
                                    <span>${formatMoney(tax)}</span>
                                </div>
                                <div class="summary-row total">
                                    <span>Total</span>
                                    <span>${formatMoney(total)}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
                        <button class="order-action-btn secondary" style="border-radius:999px;" onclick="trackOrder('${order.orderNumber || order.id}')">
                            <i class="fa-solid fa-truck"></i> Track Order
                        </button>
                        <button class="order-action-btn danger" style="border-radius:999px;" onclick="cancelOrder('${order.id}')">
                            <i class="fa-solid fa-xmark"></i> Cancel Order
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        document.body.style.overflow = 'hidden';
    }

    async function viewOrderDetails(orderId) {
        try {
            const order = filteredOrders.find(o => o.id === orderId);
            if (!order) {
                showToast('Order not found in current list', 'error');
                return;
            }
            openOrderDetailsModal(order);
        } catch (e) {
            console.error('Error showing order details', e);
            showToast('Failed to open order details', 'error');
        }
    }

    // For now, just show placeholder behaviour for track & cancel.
    function trackOrder(orderNumber) {
        showToast(`Tracking for Order #${orderNumber} coming soon.`, 'info');
    }

    function cancelOrder(orderId) {
        // You can hook this to your real cancel endpoint when ready
        showToast('Cancel feature not wired to backend yet.', 'info');
    }

    async function loadOrders() {
        showLoading(true);
        try {
            const data = await apiGet('/orders?limit=50&page=1');
            allOrders = normalizeOrders(data);
            filteredOrders = allOrders.slice();
            renderOrders();
        } catch (err) {
            console.error('Order load error', err);
            showToast('Unable to load orders. Please login again or try later.', 'error');
            allOrders = [];
            filteredOrders = [];
            renderOrders();
        } finally {
            showLoading(false);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadOrders();
    });
</script>

</body>
</html>
