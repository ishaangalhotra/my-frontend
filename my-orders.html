<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Orders - QuickLocal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <style>
        :root {
            --primary: #2563eb;
            --primary-soft: #dbeafe;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --warning: #f97316;
            --danger: #dc2626;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --text: #111827;
            --text-light: #6b7280;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #eff6ff, #f9fafb);
            color: var(--text);
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(14px);
            background: rgba(15, 23, 42, 0.85);
            color: #f9fafb;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.25);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .brand-logo {
            width: 34px;
            height: 34px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 30% 20%, #facc15, #f97316);
            color: #111827;
        }
        .brand-text {
            display: flex;
            flex-direction: column;
        }
        .brand-text .title {
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.04em;
        }
        .brand-text .subtitle {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .header-chip {
            font-size: 0.75rem;
            padding: 0.1rem 0.55rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.7);
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }
        .header-btn {
            border-radius: 999px;
            padding: 0.45rem 0.9rem;
            border: none;
            font-size: 0.8rem;
            background: #facc15;
            color: #111827;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 2px 10px rgba(250, 204, 21, 0.45);
        }

        main {
            max-width: 1100px;
            margin: 1.5rem auto 2rem;
            padding: 0 1rem 2rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .page-title {
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .page-title span {
            font-size: 0.85rem;
            font-weight: 500;
            background: #e5f2ff;
            color: #1e40af;
            padding: 0.15rem 0.6rem;
            border-radius: 999px;
        }

        .page-subtitle {
            margin-top: 0.25rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .page-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 0.45rem 0.9rem;
            font-size: 0.9rem;
            background: #fff;
            color: var(--text);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary {
            border-color: transparent;
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            color: #fff;
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.35);
        }

        .btn-icon {
            padding: 0.45rem;
            width: 2.3rem;
            height: 2.3rem;
            border-radius: 999px;
            justify-content: center;
        }

        /* Filters & stats */
        .filters-row {
            display: grid;
            grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.2fr) minmax(0, 1.2fr) auto;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.55rem 0.9rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            padding-left: 2.3rem;
            background: #ffffff;
        }

        .search-wrapper {
            position: relative;
            display: flex;
        }

        .search-wrapper i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .select {
            width: 100%;
            padding: 0.55rem 0.9rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            background: #ffffff;
        }

        .refresh-btn {
            border-radius: 999px;
            border: 1px solid var(--border);
            padding: 0.45rem 0.8rem;
            background: #fff;
            cursor: pointer;
        }

        /* Stats row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 0.9rem;
            border: 1px solid rgba(226, 232, 240, 0.9);
            padding: 0.8rem 0.9rem;
            display: flex;
            gap: 0.6rem;
            align-items: center;
        }

        .stat-icon {
            width: 2.1rem;
            height: 2.1rem;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #eff6ff;
            color: #1d4ed8;
            font-size: 0.9rem;
        }

        .stat-content {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* States */
        .loading-state,
        .empty-state {
            margin-top: 2.5rem;
            text-align: center;
            color: var(--text-light);
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 3px solid #d1d5db;
            border-top-color: #2563eb;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 0.75rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .orders-list {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Order card */
        .order-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 0.9rem;
            border: 1px solid rgba(226, 232, 240, 0.9);
            padding: 0.85rem 1rem;
            box-shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
        }

        .order-card.highlight {
            border-color: #22c55e;
            box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.55), 0 10px 30px rgba(22, 163, 74, 0.35);
        }

        .order-card-header {
            display: flex;
            justify-content: space-between;
            gap: 0.85rem;
            align-items: flex-start;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 0.45rem;
            margin-bottom: 0.45rem;
        }

        .order-id {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .order-meta {
            margin-top: 0.15rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: #eff6ff;
            color: #1e40af;
        }

        .badge-status {
            background: #e5f2ff;
            color: #1d4ed8;
        }
        .badge-status.delivered {
            background: #dcfce7;
            color: #15803d;
        }
        .badge-status.cancelled {
            background: #fee2e2;
            color: #b91c1c;
        }

        .order-summary-chip {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .order-card-body {
            display: grid;
            grid-template-columns: minmax(0, 2.4fr) minmax(0, 1.4fr);
            gap: 0.75rem;
        }

        /* Items list in card */
        .items-list {
            display: grid;
            gap: 0.55rem;
        }

        .item-row {
            display: grid;
            grid-template-columns: auto minmax(0, 1fr) auto;
            gap: 0.6rem;
            align-items: center;
        }

        .item-image-wrapper {
            width: 48px;
            height: 48px;
            border-radius: 0.75rem;
            background: #f3f4f6;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .item-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-info {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .item-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .item-meta {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .item-price {
            text-align: right;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .more-items {
            margin-top: 0.1rem;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* Order right side: summary + timeline + actions */
        .order-right {
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
        }

        .order-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .order-amount {
            font-weight: 600;
            font-size: 1rem;
        }

        .payment-chip {
            font-size: 0.75rem;
            padding: 0.15rem 0.6rem;
            border-radius: 999px;
            background: #f1f5f9;
            color: #0f172a;
        }

        .delivery-timeline {
            background: #f9fafb;
            border-radius: 0.7rem;
            padding: 0.5rem 0.6rem;
            border: 1px dashed #e5e7eb;
            max-height: 110px;
            overflow-y: auto;
        }

        .timeline-title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
            color: #0f172a;
        }

        .timeline-item {
            display: flex;
            gap: 0.45rem;
            align-items: flex-start;
        }

        .timeline-icon {
            width: 20px;
            height: 20px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        .timeline-icon.completed {
            background: #22c55e;
            color: #f9fafb;
        }
        .timeline-icon.current {
            background: #2563eb;
            color: #f9fafb;
        }
        .timeline-icon.pending {
            background: #e5e7eb;
            color: #6b7280;
        }

        .timeline-content {
            font-size: 0.8rem;
        }

        .timeline-time {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        .order-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            margin-top: 0.25rem;
        }

        .order-actions button {
            font-size: 0.8rem;
            padding: 0.3rem 0.7rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .order-actions .primary {
            border-color: transparent;
            background: #2563eb;
            color: #fff;
        }

        .order-actions .danger {
            border-color: transparent;
            background: #fee2e2;
            color: #b91c1c;
        }

        /* Pagination */
        .pagination-section {
            margin-top: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.85rem;
        }

        .pagination-controls {
            display: flex;
            gap: 0.35rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-btn,
        .page-number {
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #fff;
            font-size: 0.8rem;
            padding: 0.25rem 0.65rem;
            cursor: pointer;
        }

        .page-number.active {
            background: #2563eb;
            color: #fff;
            border-color: transparent;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1.25rem;
            right: 1.25rem;
            background: #111827;
            color: #f9fafb;
            padding: 0.6rem 0.85rem;
            border-radius: 0.6rem;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.45rem;
            box-shadow: 0 8px 25px rgba(15, 23, 42, 0.3);
            z-index: 50;
        }

        .toast.success { background: #16a34a; }
        .toast.error { background: #dc2626; }
        .toast.warning { background: #ea580c; }
        .toast.info { background: #1d4ed8; }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .filters-row {
                grid-template-columns: 1fr;
            }
            .order-card-body {
                grid-template-columns: 1fr;
            }
            .pagination-section {
                flex-direction: column;
                align-items: flex-start;
            }
            .header {
                flex-wrap: wrap;
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <div class="brand-logo">
                <i class="fas fa-bag-shopping"></i>
            </div>
            <div class="brand-text">
                <div class="title">QuickLocal</div>
                <div class="subtitle">My Orders</div>
            </div>
        </div>
        <div class="header-right">
            <div class="header-chip">
                <i class="fas fa-shield-heart"></i>
                Buyer Protection
            </div>
            <button class="header-btn" onclick="window.location.href='marketplace.html'">
                <i class="fas fa-store"></i>
                Shop more
            </button>
        </div>
    </header>

    <main>
        <div class="page-header">
            <div>
                <div class="page-title">
                    My Orders
                    <span><i class="fas fa-clock"></i> last 6 months</span>
                </div>
                <div class="page-subtitle">
                    Track your packages, view what you ordered, and manage returns in one place.
                </div>
            </div>
            <div class="page-actions">
                <button class="btn" onclick="window.location.href='order-tracking.html'">
                    <i class="fas fa-location-crosshairs"></i>
                    Track order
                </button>
                <button class="btn" onclick="window.location.href='returns.html'">
                    <i class="fas fa-box-open"></i>
                    Returns & refunds
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-row">
            <div class="search-wrapper">
                <i class="fas fa-search"></i>
                <input id="searchInput" class="search-input" placeholder="Search by product or order ID">
            </div>
            <select id="statusFilter" class="select">
                <option value="all">All statuses</option>
                <option value="active">Active (not delivered/cancelled)</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled / Failed</option>
            </select>
            <select id="timeFilter" class="select">
                <option value="all">All time</option>
                <option value="30">Last 30 days</option>
                <option value="90">Last 3 months</option>
                <option value="180" selected>Last 6 months</option>
            </select>
            <button id="refreshBtn" class="refresh-btn" title="Refresh orders">
                <i class="fas fa-rotate"></i>
            </button>
        </div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-boxes-stacked"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total orders</div>
                    <div class="stat-value" id="statTotalOrders">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-truck-fast"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Active</div>
                    <div class="stat-value" id="statActiveOrders">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-circle-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Delivered</div>
                    <div class="stat-value" id="statDeliveredOrders">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-indian-rupee-sign"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Spent (approx)</div>
                    <div class="stat-value" id="statTotalSpent">â‚¹0</div>
                </div>
            </div>
        </div>

        <!-- Loading state -->
        <div id="loadingState" class="loading-state" style="display:none;">
            <div class="loading-spinner"></div>
            <div>Loading your orders...</div>
        </div>

        <!-- Empty state -->
        <div id="emptyState" class="empty-state" style="display:none;">
            <i class="fas fa-box-open" style="font-size:2.4rem; margin-bottom:0.6rem;"></i>
            <p>You don't have any orders yet.</p>
            <button class="btn btn-primary" onclick="window.location.href='marketplace.html'">
                <i class="fas fa-shopping-cart"></i>
                Start shopping
            </button>
        </div>

        <!-- Orders list -->
        <div id="ordersContainer" class="orders-list"></div>

        <!-- Pagination -->
        <div id="paginationContainer" class="pagination-section" style="display:none;">
            <div class="pagination-info">
                <span id="paginationInfo">Showing 0â€“0 of 0 orders</span>
            </div>
            <div class="pagination-controls">
                <button id="prevPageBtn" class="pagination-btn" disabled>
                    <i class="fas fa-chevron-left"></i> Prev
                </button>
                <div id="pageNumbers" class="page-numbers"></div>
                <button id="nextPageBtn" class="pagination-btn">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Auth + notifications (same as other pages) -->
    <script src="https://ecommerce-backend-mlik.onrender.com/hybrid-auth-client.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="js/api/notification-service.js"></script>
    <script src="js/api/tracking-service.js"></script>
    <script src="js/api/push-notification-service.js"></script>

    <script>
        // Global state
        let allOrders = [];
        let filteredOrders = [];
        let highlightOrderId = null;
        let currentPage = 1;
        const ordersPerPage = 5;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            highlightOrderId = urlParams.get('highlight') || null;

            setupEventListeners();
            initializeOrdersPage();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(filterOrders, 300));
            document.getElementById('statusFilter').addEventListener('change', filterOrders);
            document.getElementById('timeFilter').addEventListener('change', filterOrders);
            document.getElementById('refreshBtn').addEventListener('click', loadOrders);

            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderCurrentPage();
                }
            });

            document.getElementById('nextPageBtn').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCurrentPage();
                }
            });
        }

        async function initializeOrdersPage() {
            showLoading(true);
            try {
                let attempts = 0;
                while (!window.HybridAuthClient && attempts < 50) {
                    await new Promise(r => setTimeout(r, 100));
                    attempts++;
                }

                if (window.HybridAuthClient && typeof window.HybridAuthClient.isAuthenticated === 'function') {
                    const isAuth = await window.HybridAuthClient.isAuthenticated();
                    if (!isAuth) {
                        showToast('Please login to view your orders.', 'warning');
                        setTimeout(() => {
                            window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
                        }, 1500);
                        return;
                    }
                }

                await loadOrders();
            } catch (err) {
                console.error('Initialization error:', err);
                showEmptyState();
                showToast('Failed to load orders.', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadOrders() {
            showLoading(true);
            try {
                console.log('ðŸ” Loading user orders...');
                const endpoint = '/api/v1/orders?limit=50&page=1';
                let response;

                if (window.HybridAuthClient && typeof window.HybridAuthClient.apiCall === 'function') {
                    response = await window.HybridAuthClient.apiCall(endpoint, { method: 'GET' });
                } else {
                    throw new Error('Authentication client not available');
                }

                if (!response || !response.ok) {
                    throw new Error('Failed to fetch orders');
                }

                const result = await response.json();
                console.log('âœ… Orders loaded:', result);

                const rawOrders = result.orders || result.data || result.results || [];
                allOrders = Array.isArray(rawOrders) ? rawOrders.map(mapRawOrderToUIModel) : [];

                if (!allOrders.length) {
                    showEmptyState();
                    return;
                }

                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('ordersContainer').style.display = 'flex';

                filteredOrders = allOrders.slice();
                currentPage = 1;
                filterOrders(); // this will call renderCurrentPage + updateStats
            } catch (err) {
                console.error('Load orders error:', err);
                showEmptyState();
                showToast(err.message || 'Failed to load orders', 'error');
            } finally {
                showLoading(false);
            }
        }

        function mapRawOrderToUIModel(order) {
            const status = (order.status || 'pending').toLowerCase();
            const items = order.orderItems || order.items || [];

            const products = items.map((it) => {
                const product = it.product || it || {};
                const qty = it.qty || it.quantity || product.quantity || 1;
                const price =
                    it.unitPrice ||
                    it.price ||
                    product.unitPrice ||
                    product.price ||
                    0;

                return {
                    id: product._id || product.id,
                    name: product.name || 'Product item',
                    qty,
                    price,
                    image: getSafeImageUrl(product)
                };
            });

            // Build a simple timeline from deliveryTracking / status
            const timeline = buildOrderTimeline(order, status);

            return {
                id: order._id || order.id,
                orderNumber: order.orderNumber || order.orderId || order._id,
                status,
                createdAt: order.createdAt || order.orderDate || order.date,
                totalAmount: order.pricing?.totalPrice || order.totalAmount || order.total || 0,
                paymentMethod: order.paymentMethod || order.paymentInfo?.method || 'card',
                products,
                timeline,
                canCancel: order.canBeCancelled ??
                    ['pending', 'confirmed', 'processing', 'preparing'].includes(status),
                canReturn: order.canBeReturned ?? (status === 'delivered')
            };
        }

        function buildOrderTimeline(order, status) {
            const timeline = [];

            timeline.push({
                status: 'Order placed',
                completed: true,
                timestamp: order.createdAt
            });

            if (['confirmed', 'processing', 'preparing'].includes(status)) {
                timeline.push({
                    status: 'Processing',
                    completed: status !== 'processing',
                    timestamp: order.updatedAt || order.processingAt
                });
            }

            if (['shipped', 'out_for_delivery', 'delivered'].includes(status)) {
                timeline.push({
                    status: 'Shipped',
                    completed: ['out_for_delivery', 'delivered'].includes(status),
                    timestamp: order.deliveryTracking?.shippedAt || order.shippedAt
                });
            }

            if (['out_for_delivery', 'delivered'].includes(status)) {
                timeline.push({
                    status: 'Out for delivery',
                    completed: status === 'delivered',
                    timestamp: order.deliveryTracking?.outForDeliveryAt
                });
            }

            if (status === 'delivered') {
                timeline.push({
                    status: 'Delivered',
                    completed: true,
                    timestamp: order.deliveryTracking?.deliveredAt || order.deliveredAt
                });
            }

            if (status === 'cancelled' || status === 'failed') {
                timeline.push({
                    status: 'Order cancelled',
                    completed: true,
                    timestamp: order.cancelledAt || order.updatedAt
                });
            }

            return timeline;
        }

        function filterOrders() {
            const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;

            const now = new Date();
            filteredOrders = allOrders.filter(order => {
                // text search (orderNumber or product name)
                const matchesSearch = !q ||
                    String(order.orderNumber || '').toLowerCase().includes(q) ||
                    order.products.some(p => (p.name || '').toLowerCase().includes(q));

                if (!matchesSearch) return false;

                // status filter
                let matchesStatus = true;
                if (statusFilter === 'active') {
                    matchesStatus = !['delivered', 'cancelled', 'failed'].includes(order.status);
                } else if (statusFilter === 'delivered') {
                    matchesStatus = order.status === 'delivered';
                } else if (statusFilter === 'cancelled') {
                    matchesStatus = ['cancelled', 'failed'].includes(order.status);
                }

                if (!matchesStatus) return false;

                // time filter
                let matchesTime = true;
                if (timeFilter !== 'all') {
                    const days = Number(timeFilter);
                    const cutoff = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
                    const created = order.createdAt ? new Date(order.createdAt) : null;
                    if (!created || created < cutoff) matchesTime = false;
                }

                return matchesTime;
            });

            currentPage = 1;
            updateStats();
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const container = document.getElementById('ordersContainer');
            container.innerHTML = '';

            if (!filteredOrders.length) {
                showEmptyState();
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('ordersContainer').style.display = 'flex';

            const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
            const startIdx = (currentPage - 1) * ordersPerPage;
            const endIdx = Math.min(startIdx + ordersPerPage, filteredOrders.length);
            const pageOrders = filteredOrders.slice(startIdx, endIdx);

            pageOrders.forEach(order => {
                container.appendChild(renderOrderCard(order));
            });

            // Pagination info
            document.getElementById('paginationInfo').textContent =
                `Showing ${startIdx + 1}â€“${endIdx} of ${filteredOrders.length} orders`;
            document.getElementById('paginationContainer').style.display = totalPages > 1 ? 'flex' : 'none';

            // Prev/next buttons
            document.getElementById('prevPageBtn').disabled = currentPage === 1;
            document.getElementById('nextPageBtn').disabled = currentPage === totalPages;

            // page numbers
            const pageNumbersContainer = document.getElementById('pageNumbers');
            pageNumbersContainer.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = 'page-number' + (i === currentPage ? ' active' : '');
                btn.textContent = i;
                btn.onclick = () => {
                    currentPage = i;
                    renderCurrentPage();
                };
                pageNumbersContainer.appendChild(btn);
            }

            // scroll highlighted order into view once
            if (highlightOrderId) {
                const el = container.querySelector(`[data-order-id="${highlightOrderId}"]`);
                if (el) {
                    el.classList.add('highlight');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => el.classList.remove('highlight'), 3000);
                    highlightOrderId = null;
                }
            }
        }

        function renderOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card';
            card.dataset.orderId = order.id;

            const statusClass =
                order.status === 'delivered' ? 'delivered' :
                ['cancelled', 'failed'].includes(order.status) ? 'cancelled' : '';

            const statusLabel = formatStatus(order.status);
            const createdDate = order.createdAt ? formatDate(order.createdAt) : 'Unknown date';

            const firstItems = order.products.slice(0, 3);
            const remainingCount = order.products.length - firstItems.length;

            card.innerHTML = `
                <div class="order-card-header">
                    <div>
                        <div class="order-id">Order #${order.orderNumber}</div>
                        <div class="order-meta">
                            <span>Placed on ${createdDate}</span>
                            <span class="order-summary-chip">${order.products.length} item(s)</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <span class="badge badge-status ${statusClass}">
                            <i class="fas fa-circle" style="font-size:0.55rem;"></i>
                            ${statusLabel}
                        </span>
                    </div>
                </div>

                <div class="order-card-body">
                    <div>
                        <div class="items-list">
                            ${firstItems.map(item => `
                                <div class="item-row">
                                    <div class="item-image-wrapper">
                                        <img src="${item.image}" class="item-image" alt="Product">
                                    </div>
                                    <div class="item-info">
                                        <div class="item-name">${item.name}</div>
                                        <div class="item-meta">Qty: ${item.qty}</div>
                                    </div>
                                    <div class="item-price">
                                        â‚¹${(item.price * item.qty).toFixed(2)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${remainingCount > 0 ? `<div class="more-items">+ ${remainingCount} more item(s)</div>` : ''}
                    </div>

                    <div class="order-right">
                        <div class="order-total-row">
                            <div>
                                <div style="font-size:0.8rem; color:var(--text-light);">Total</div>
                                <div class="order-amount">â‚¹${order.totalAmount.toFixed(2)}</div>
                            </div>
                            <div class="payment-chip">
                                <i class="fas fa-credit-card"></i>
                                ${String(order.paymentMethod || '').toUpperCase()}
                            </div>
                        </div>

                        ${renderDeliveryTimeline(order)}

                        <div class="order-actions">
                            <button class="primary" onclick="trackOrder('${order.orderNumber}')">
                                <i class="fas fa-location-dot"></i> Track
                            </button>
                            ${order.canCancel ? `
                            <button class="danger" onclick="cancelOrder('${order.id}')">
                                <i class="fas fa-ban"></i> Cancel
                            </button>` : ''}
                            ${order.canReturn ? `
                            <button onclick="returnOrder('${order.id}')">
                                <i class="fas fa-rotate-left"></i> Return
                            </button>` : ''}
                            <button onclick="viewInvoice('${order.id}')">
                                <i class="fas fa-file-invoice"></i> Invoice
                            </button>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        function renderDeliveryTimeline(order) {
            if (!order.timeline || !Array.isArray(order.timeline) || !order.timeline.length) return '';

            return `
                <div class="delivery-timeline">
                    <div class="timeline-title">Order timeline</div>
                    ${order.timeline.map((item, index) => {
                        const isCompleted = item.completed;
                        const firstIncompleteIndex = order.timeline.findIndex(t => !t.completed);
                        const isCurrent = !isCompleted && index === firstIncompleteIndex;

                        return `
                            <div class="timeline-item">
                                <div class="timeline-icon ${isCompleted ? 'completed' : isCurrent ? 'current' : 'pending'}">
                                    <i class="fas ${isCompleted ? 'fa-check' : isCurrent ? 'fa-clock' : 'fa-circle'}"></i>
                                </div>
                                <div class="timeline-content">
                                    <div>${item.status}</div>
                                    ${item.timestamp ? `<div class="timeline-time">${formatDateTime(item.timestamp)}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updateStats() {
            const totalOrders = filteredOrders.length;
            const activeOrders = filteredOrders.filter(o =>
                ['pending', 'confirmed', 'processing', 'preparing', 'shipped', 'out_for_delivery'].includes(o.status)
            ).length;
            const deliveredOrders = filteredOrders.filter(o => o.status === 'delivered').length;
            const totalSpent = filteredOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

            document.getElementById('statTotalOrders').textContent = totalOrders;
            document.getElementById('statActiveOrders').textContent = activeOrders;
            document.getElementById('statDeliveredOrders').textContent = deliveredOrders;
            document.getElementById('statTotalSpent').textContent = 'â‚¹' + totalSpent.toFixed(2);
        }

        // --- Actions ---
        async function cancelOrder(orderId) {
            const confirmCancel = confirm('Are you sure you want to cancel this order?');
            if (!confirmCancel) return;

            try {
                const response = await fetch(`/api/v1/orders/${orderId}/cancel`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    throw new Error('Failed to cancel order');
                }

                const result = await response.json();
                if (result.success) {
                    showToast('Order cancelled successfully', 'success');
                    await loadOrders();
                } else {
                    throw new Error(result.message || 'Cancellation failed');
                }
            } catch (err) {
                console.error('Cancel order error:', err);
                showToast(err.message || 'Failed to cancel order', 'error');
            }
        }

        function returnOrder(orderId) {
            const order = filteredOrders.find(o => o.id === orderId);
            if (!order) {
                showToast('Order not found', 'error');
                return;
            }

            const orderNumber = order.orderNumber || orderId;
            showToast(`Opening return request for order ${orderNumber}`, 'info');
            setTimeout(() => {
                window.location.href = `returns.html?orderNumber=${encodeURIComponent(orderNumber)}`;
            }, 1200);
        }

        function viewInvoice(orderId) {
            window.open(`invoice.html?orderId=${encodeURIComponent(orderId)}`, '_blank');
        }

        function trackOrder(orderNumber) {
            showToast('Opening order tracking', 'info');
            const trackingUrl = `order-tracking.html?order=${encodeURIComponent(orderNumber)}`;
            window.open(trackingUrl, '_blank');

            if (window.trackingService) {
                window.trackingService.subscribeToOrderTracking(orderNumber, (data) => {
                    console.log('Real-time tracking update:', data);
                    if (data.type === 'status') {
                        loadOrders();
                    }
                });
            }
        }

        // --- Utils ---
        function getSafeImageUrl(product) {
            const fallback = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e5e7eb'/%3E%3Ctext x='50' y='55' font-family='sans-serif' font-size='12' fill='%2394a3b8' text-anchor='middle'%3ENo Image%3C/text%3E%3C/svg%3E";

            if (!product) return fallback;

            if (Array.isArray(product.images) && product.images.length > 0) {
                const img = product.images[0];
                if (typeof img === 'string' && img.startsWith('http')) return img;
                if (img && img.url && img.url.startsWith('http')) return img.url;
            }

            if (product.image && typeof product.image === 'string' && product.image.startsWith('http')) {
                return product.image;
            }

            return fallback;
        }

        function formatStatus(status) {
            status = String(status || '').toLowerCase();
            const map = {
                pending: 'Order placed',
                confirmed: 'Confirmed',
                processing: 'Processing',
                preparing: 'Preparing',
                shipped: 'Shipped',
                out_for_delivery: 'Out for delivery',
                delivered: 'Delivered',
                cancelled: 'Cancelled',
                failed: 'Failed'
            };
            return map[status] || status.charAt(0).toUpperCase() + status.slice(1);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Unknown date';
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            return date.toLocaleString('en-IN', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
        }

        function showEmptyState() {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('ordersContainer').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas ${getToastIcon(type)}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        function getToastIcon(type) {
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-circle-exclamation',
                warning: 'fa-triangle-exclamation',
                info: 'fa-circle-info'
            };
            return icons[type] || icons.info;
        }

        function debounce(fn, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), wait);
            };
        }
    </script>
</body>
</html>
