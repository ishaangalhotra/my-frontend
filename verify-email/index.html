<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Verify your email • QuickLocal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0b12; --card:#151524; --text:#e8e8f0; --muted:#9aa0b4; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .card{width:100%;max-width:440px;background:var(--card);border:1px solid #26263a;
      border-radius:16px;padding:28px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    h1{margin:0 0 8px;font-size:22px} p{margin:0 0 18px;color:var(--muted)}
    .status{padding:12px 14px;border-radius:10px;background:#1c1c2e;margin:12px 0}
    .ok{background:#15271a;border:1px solid #254a2f}
    .err{background:#2a1a1d;border:1px solid #5a3238}
    .btn{display:inline-block;margin-top:14px;padding:10px 14px;border-radius:10px;
      background:#6366f1;color:#fff;text-decoration:none;border:0;cursor:pointer}
    .spinner{display:inline-block;width:18px;height:18px;border:3px solid #454565;
      border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    small{display:block;margin-top:10px;color:#7c8197}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Verifying your email…</h1>
      <p>Please wait while we confirm your account.</p>
      <div id="status" class="status"><span class="spinner"></span> Contacting server…</div>
      <button id="go" class="btn" style="display:none">Go to Seller Dashboard</button>
      <small id="detail"></small>
    </div>
  </div>

  <script src="../js/load-hybrid-auth.js"></script>
  <script>
    (async () => {
      // 1) Your backend base (auth router is mounted at /api/v1/auth)
      const API = (window.QUICKLOCAL_API_BASE || '/api/v1') + '/auth';

      // 2) Get the raw token from /verify-email/<TOKEN> (last path segment)
      const segments = location.pathname.split('/').filter(Boolean);
      const token = segments[segments.length - 1]; // works for /verify-email/<TOKEN> and /verify-email/<TOKEN>/

      const statusEl = document.getElementById('status');
      const detailEl = document.getElementById('detail');
      const goBtn = document.getElementById('go');

      if (!token || token.length < 20) {
        statusEl.className = 'status err';
        statusEl.textContent = 'Invalid verification link.';
        detailEl.textContent = 'No token found in URL.';
        return;
      }

      try {
        const res = await fetch(`${API}/verify-email/${token}`, {
          method: 'POST',
          headers: { 'Accept': 'application/json' },
          credentials: 'include'
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) throw new Error(data.message || data.error || 'Verification failed');

        // Success: backend marks isVerified=true and returns tokens/user
        // (your auth route handles this and sends a success message + tokens) 
        statusEl.className = 'status ok';
        statusEl.textContent = '✅ Email verified successfully!';
        detailEl.textContent = 'You can continue to your seller dashboard.';
        goBtn.style.display = 'inline-block';
        goBtn.onclick = () => location.href = '/seller-dashboard.html';
        // Cookie-first auth: session is managed server-side.

      } catch (err) {
        statusEl.className = 'status err';
        statusEl.textContent = '❌ Verification failed.';
        detailEl.textContent = err.message || 'Invalid or expired verification link.';
      }
    })();
  </script>
</body>
</html>
