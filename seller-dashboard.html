<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuickLocal Seller Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    .toast { 
      position: fixed; top: 1rem; right: 1rem; z-index: 1050; 
      padding: .75rem 1.25rem; color:#fff; border-radius:.5rem; 
      transform: translateX(120%); transition: transform .3s ease; 
      box-shadow:0 8px 24px rgba(0,0,0,.15);
      backdrop-filter: blur(10px);
    }
    .toast.show{ transform: translateX(0); }
    .toast-success{ background: linear-gradient(135deg, #10b981, #059669); } 
    .toast-error{ background: linear-gradient(135deg, #ef4444, #dc2626); }
    .toast-info{ background: linear-gradient(135deg, #3b82f6, #2563eb); }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .product-card {
      transition: all 0.3s ease;
      transform: translateY(0);
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .stat-card {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-left: 4px solid;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      transform: scale(1.02);
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">

  <!-- üîë AUTH SECTION -->
  <section id="auth-section" class="min-h-screen flex items-center justify-center p-4 gradient-bg">
    <div class="glass-card shadow-2xl rounded-2xl w-full max-w-md p-8 fade-in">
      <div class="text-center mb-8">
        <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
          <span class="text-2xl font-bold text-indigo-600">QS</span>
        </div>
        <h2 class="text-3xl font-bold text-gray-800">Seller Hub</h2>
        <p class="text-gray-600 mt-2">Manage your business with ease</p>
      </div>
      
      <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
        <button id="login-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all bg-white text-indigo-600 shadow-sm">Login</button>
        <button id="register-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all text-gray-500 hover:text-gray-700">Register</button>
      </div>

      <!-- Login Form -->
      <form id="login-form" class="space-y-4">
        <div class="relative">
          <input id="login-email" type="email" placeholder="Email" required 
                 class="w-full border-2 border-gray-200 rounded-lg p-3 pl-10 focus:border-indigo-500 focus:outline-none transition-colors" />
          <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
          </svg>
        </div>
        <div class="relative">
          <input id="login-password" type="password" placeholder="Password" required 
                 class="w-full border-2 border-gray-200 rounded-lg p-3 pl-10 focus:border-indigo-500 focus:outline-none transition-colors" />
          <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
          </svg>
        </div>
        <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg">
          <span id="login-btn-text">Login</span>
          <div id="login-spinner" class="loading hidden mx-auto"></div>
        </button>
      </form>

      <!-- Register Form -->
      <form id="register-form" class="space-y-4 hidden">
        <input id="reg-name" type="text" placeholder="Full Name" required class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
        <input id="reg-email" type="email" placeholder="Email" required class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
        <input id="reg-phone" type="tel" placeholder="Phone Number" required class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
        <input id="reg-password" type="password" placeholder="Password" required class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
        <input id="reg-business" type="text" placeholder="Business Name" required class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
        <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 transition-all transform hover:scale-105 shadow-lg">
          <span id="register-btn-text">Create Account</span>
          <div id="register-spinner" class="loading hidden mx-auto"></div>
        </button>
      </form>
    </div>
  </section>

  <!-- üìä DASHBOARD SECTION -->
  <section id="dashboard-section" class="hidden min-h-screen">
    <header class="bg-white shadow-lg border-b">
      <div class="p-6 flex justify-between items-center max-w-7xl mx-auto">
        <div>
          <h2 class="text-3xl font-bold text-gray-800">Welcome back, <span id="sellerName" class="text-indigo-600"></span>! üëã</h2>
          <p id="businessName" class="text-lg text-gray-600 mt-1"></p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <p class="text-sm text-gray-500">Last login</p>
            <p id="lastLogin" class="text-sm font-semibold text-gray-700">Today</p>
          </div>
          <button id="logout-btn" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-2 rounded-lg font-semibold hover:from-red-600 hover:to-red-700 transition-all shadow-lg transform hover:scale-105">
            Logout
          </button>
        </div>
      </div>
      <nav class="max-w-7xl mx-auto px-6">
        <div class="flex border-b border-gray-200">
          <button data-tab="products" class="tab-btn border-b-2 border-indigo-500 text-indigo-600 px-6 py-3 font-semibold transition-all">
            üì¶ Products
          </button>
          <button data-tab="orders" class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-gray-700 transition-all">
            üìã Orders
          </button>
          <button data-tab="analytics" class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-gray-700 transition-all">
            üìà Analytics
          </button>
        </div>
      </nav>
    </header>

    <main class="p-6 max-w-7xl mx-auto">
      <!-- Products Tab -->
      <div id="products-tab" class="tab-content fade-in">
        <div class="flex justify-between items-center mb-8">
          <div>
            <h3 class="text-2xl font-bold text-gray-800">Your Products</h3>
            <p class="text-gray-600">Manage your inventory and product catalog</p>
          </div>
          <button id="addProductBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 shadow-lg">
            ‚ûï Add Product
          </button>
        </div>
        <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
      </div>

      <!-- Orders Tab -->
      <div id="orders-tab" class="tab-content hidden fade-in">
        <div class="mb-8">
          <h3 class="text-2xl font-bold text-gray-800">Customer Orders</h3>
          <p class="text-gray-600">Track and manage your sales</p>
        </div>
        <div class="mb-6 flex flex-wrap gap-2">
          <button class="order-filter-btn bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg font-medium" data-status="all">All Orders</button>
          <button class="order-filter-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-200" data-status="pending">Pending</button>
          <button class="order-filter-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-200" data-status="processing">Processing</button>
          <button class="order-filter-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-200" data-status="completed">Completed</button>
        </div>
        <div id="orders-list" class="bg-white rounded-xl shadow-lg overflow-hidden"></div>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics-tab" class="tab-content hidden fade-in">
        <div class="mb-8">
          <h3 class="text-2xl font-bold text-gray-800">Business Analytics</h3>
          <p class="text-gray-600">Track your performance and growth</p>
        </div>
        <div id="analytics-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"></div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h4 class="text-lg font-semibold mb-4 text-gray-800">Recent Activity</h4>
            <div id="recent-activity" class="space-y-3"></div>
          </div>
          <div class="bg-white p-6 rounded-xl shadow-lg">
            <h4 class="text-lg font-semibold mb-4 text-gray-800">Quick Actions</h4>
            <div class="space-y-3">
              <button class="w-full text-left p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                üìä Download Sales Report
              </button>
              <button class="w-full text-left p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                üìß Contact Support
              </button>
              <button class="w-full text-left p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                ‚öôÔ∏è Account Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </section>

  <!-- Product Modal -->
  <div id="productModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
    <div class="bg-white w-full max-w-2xl p-8 rounded-2xl shadow-2xl transform scale-95 transition-transform">
      <div class="flex justify-between items-center mb-6">
        <h3 id="modalTitle" class="text-2xl font-bold text-gray-800">Add New Product</h3>
        <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-3xl transition-colors">&times;</button>
      </div>
      <form id="product-form" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
            <input id="product-name" type="text" placeholder="Enter product name" required 
                   class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
            <select id="product-category" required class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors">
              <option value="">Select a category</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Price (‚Çπ)</label>
            <input id="product-price" type="number" step="0.01" placeholder="0.00" required 
                   class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Stock Quantity</label>
            <input id="product-stock" type="number" placeholder="0" required 
                   class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Product Image</label>
          <input id="product-image" type="file" accept="image/*" 
                 class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-indigo-500 focus:outline-none transition-colors" />
          <div id="image-preview" class="mt-4"></div>
        </div>
        <div class="flex justify-end space-x-4 pt-4">
          <button type="button" id="cancel-btn" class="bg-gray-300 hover:bg-gray-400 px-6 py-3 rounded-lg font-semibold transition-colors">
            Cancel
          </button>
          <button type="submit" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg">
            <span id="save-btn-text">Save Product</span>
            <div id="save-spinner" class="loading hidden mx-auto"></div>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Connection Status Indicator -->
  <div id="connection-status" class="hidden fixed top-4 left-4 z-50 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg">
    <span class="text-sm font-semibold">‚ö†Ô∏è Connection Issues</span>
  </div>

  <div id="toast-container"></div>

<script>
const App = {
  API_BASE: "https://quicklocal-backend.onrender.com",

  async init() {
    // Check if we're online
    if (!navigator.onLine) {
      this.showToast("You're currently offline. Some features may not work.", "error");
    }
    
    // Listen for online/offline events
    window.addEventListener('online', () => {
      this.showToast("Connection restored!", "success");
    });
    
    window.addEventListener('offline', () => {
      this.showToast("You're now offline. Some features may not work.", "error");
    });
    
    this.bindAuthEvents();
    await this.verifyToken();
  },

  bindAuthEvents() {
    document.getElementById("login-tab").addEventListener("click", () => this.toggleAuth("login"));
    document.getElementById("register-tab").addEventListener("click", () => this.toggleAuth("register"));
    document.getElementById("login-form").addEventListener("submit", this.handleLogin);
    document.getElementById("register-form").addEventListener("submit", this.handleRegister);
  },

  toggleAuth(mode) {
    const isLogin = mode === "login";
    document.getElementById("login-form").classList.toggle("hidden", !isLogin);
    document.getElementById("register-form").classList.toggle("hidden", isLogin);
    
    // Update tab styles
    const loginTab = document.getElementById("login-tab");
    const registerTab = document.getElementById("register-tab");
    
    if (isLogin) {
      loginTab.className = "flex-1 py-2 px-4 rounded-md font-semibold transition-all bg-white text-indigo-600 shadow-sm";
      registerTab.className = "flex-1 py-2 px-4 rounded-md font-semibold transition-all text-gray-500 hover:text-gray-700";
    } else {
      loginTab.className = "flex-1 py-2 px-4 rounded-md font-semibold transition-all text-gray-500 hover:text-gray-700";
      registerTab.className = "flex-1 py-2 px-4 rounded-md font-semibold transition-all bg-white text-indigo-600 shadow-sm";
    }
  },

  showView(viewName) {
    document.getElementById("auth-section").classList.toggle("hidden", viewName !== "auth");
    document.getElementById("dashboard-section").classList.toggle("hidden", viewName !== "dashboard");
  },

  setLoading(formType, isLoading) {
    const btnText = document.getElementById(`${formType}-btn-text`);
    const spinner = document.getElementById(`${formType}-spinner`);
    if (isLoading) {
      btnText.classList.add("hidden");
      spinner.classList.remove("hidden");
    } else {
      btnText.classList.remove("hidden");
      spinner.classList.add("hidden");
    }
  },

  async verifyToken() {
    const token = localStorage.getItem("authToken");
    if (!token) { this.showView("auth"); return; }
    try {
      const data = await this.authenticatedFetch("/api/v1/users/me");
      localStorage.setItem("sellerInfo", JSON.stringify(data.user));
      this.showView("dashboard");
      Dashboard.init();
    } catch {
      localStorage.clear();
      this.showView("auth");
    }
  },

  async handleLogin(e) {
    e.preventDefault();
    App.setLoading("login", true);
    
    // Validate form data
    const email = document.getElementById("login-email").value.trim();
    const password = document.getElementById("login-password").value;
    
    if (!email || !password) {
      App.showToast("Please fill in both email and password", "error");
      App.setLoading("login", false);
      return;
    }
    
    const payload = {
      email,
      password,
      role: "seller"
    };
    
    try {
      // Add timeout to prevent hanging requests
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
      
      const res = await fetch(`${App.API_BASE}/api/v1/auth/login`, {
        method: "POST", 
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        }, 
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      // Check if response is JSON
      const contentType = res.headers.get("content-type");
      if (!contentType || !contentType.includes("application/json")) {
        throw new Error("Server returned invalid response format");
      }
      
      const data = await res.json();
      
      if (!res.ok) {
        throw new Error(data.message || data.error || `Login failed (${res.status})`);
      }
      
      if (!data.token || !data.user) {
        throw new Error("Invalid response from server - missing authentication data");
      }
      
      localStorage.setItem("authToken", data.token);
      localStorage.setItem("sellerInfo", JSON.stringify(data.user));
      App.showToast("Welcome back! Login successful üéâ", "success");
      setTimeout(() => App.init(), 1000);
      
    } catch (err) { 
      console.error("Login error:", err);
      
      let errorMessage = "Login failed. Please try again.";
      
      if (err.name === 'AbortError') {
        errorMessage = "Request timed out. Please check your internet connection and try again.";
      } else if (err.message === 'Failed to fetch') {
        errorMessage = "Unable to connect to server. Please check your internet connection and try again.";
      } else if (err.message.includes('JSON')) {
        errorMessage = "Server is currently unavailable. Please try again later.";
      } else if (err.message) {
        errorMessage = err.message;
      }
      
      App.showToast(errorMessage, "error");
    } finally {
      App.setLoading("login", false);
    }
  },

  async handleRegister(e) {
    e.preventDefault();
    App.setLoading("register", true);
    
    // Validate form data before sending
    const name = document.getElementById("reg-name").value.trim();
    const email = document.getElementById("reg-email").value.trim();
    const phone = document.getElementById("reg-phone").value.trim();
    const password = document.getElementById("reg-password").value;
    const businessName = document.getElementById("reg-business").value.trim();
    
    // Basic validation
    if (!name || !email || !phone || !password || !businessName) {
      App.showToast("Please fill in all required fields", "error");
      App.setLoading("register", false);
      return;
    }
    
    if (password.length < 6) {
      App.showToast("Password must be at least 6 characters long", "error");
      App.setLoading("register", false);
      return;
    }
    
    const payload = {
      name,
      email,
      phone,
      password,
      businessName,
      role: "seller"
    };
    
    try {
      // Add timeout to prevent hanging requests
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
      
      const res = await fetch(`${App.API_BASE}/api/v1/auth/register`, {
        method: "POST", 
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        }, 
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      // Check if response is JSON
      const contentType = res.headers.get("content-type");
      if (!contentType || !contentType.includes("application/json")) {
        throw new Error("Server returned invalid response format");
      }
      
      const data = await res.json();
      
      if (!res.ok) {
        throw new Error(data.message || data.error || `Registration failed (${res.status})`);
      }
      
      if (!data.token || !data.user) {
        throw new Error("Invalid response from server - missing authentication data");
      }
      
      // Store authentication data
      localStorage.setItem("authToken", data.token);
      localStorage.setItem("sellerInfo", JSON.stringify(data.user));
      
      App.showToast("Account created successfully! Welcome aboard üöÄ", "success");
      setTimeout(() => App.init(), 1000);
      
    } catch (err) { 
      console.error("Registration error:", err);
      
      let errorMessage = "Registration failed. Please try again.";
      
      if (err.name === 'AbortError') {
        errorMessage = "Request timed out. Please check your internet connection and try again.";
      } else if (err.message === 'Failed to fetch') {
        errorMessage = "Unable to connect to server. Please check your internet connection and try again.";
      } else if (err.message.includes('JSON')) {
        errorMessage = "Server is currently unavailable. Please try again later.";
      } else if (err.message) {
        errorMessage = err.message;
      }
      
      App.showToast(errorMessage, "error");
    } finally {
      App.setLoading("register", false);
    }
  },

  async authenticatedFetch(endpoint, options = {}) {
    const token = localStorage.getItem("authToken");
    const headers = { 
      "Accept": "application/json",
      ...options.headers 
    };
    
    if (token) headers["Authorization"] = `Bearer ${token}`;
    if (!(options.body instanceof FormData)) {
      headers["Content-Type"] = "application/json";
    }
    
    try {
      // Add timeout for all authenticated requests
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
      
      const res = await fetch(`${this.API_BASE}${endpoint}`, { 
        ...options, 
        headers,
        signal: controller.signal 
      });
      
      clearTimeout(timeoutId);
      
      if (!res.ok) {
        if (res.status === 401 || res.status === 403) {
          localStorage.clear();
          this.showView("auth");
          this.showToast("Session expired. Please login again.", "error");
          return;
        }
        
        // Try to parse error response
        let errorMessage = `Error ${res.status}`;
        try {
          const errorData = await res.json();
          errorMessage = errorData.message || errorData.error || errorMessage;
        } catch (parseError) {
          // If we can't parse the error response, use status text
          errorMessage = res.statusText || errorMessage;
        }
        
        throw new Error(errorMessage);
      }
      
      // Check if response is JSON
      const contentType = res.headers.get("content-type");
      if (contentType && contentType.includes("application/json")) {
        return await res.json();
      } else {
        throw new Error("Server returned invalid response format");
      }
      
    } catch (err) {
      if (err.name === 'AbortError') {
        throw new Error("Request timed out. Please check your internet connection.");
      } else if (err.message === 'Failed to fetch') {
        throw new Error("Unable to connect to server. Please check your internet connection.");
      }
      throw err;
    }
  },

  showToast(message, type = "success") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="flex items-center">
        <span class="mr-2">${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
        <span>${message}</span>
      </div>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add("show"), 100);
    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }
};

const Dashboard = {
  editingId: null,
  uploadedImageUrl: "",
  products: [],
  orders: [],

  init() {
    this.bindEvents();
    const seller = JSON.parse(localStorage.getItem("sellerInfo"));
    document.getElementById("sellerName").textContent = seller.name;
    document.getElementById("businessName").textContent = seller.businessName;
    document.getElementById("lastLogin").textContent = new Date().toLocaleDateString();
    this.fetchCategories();
    this.switchTab("products");
  },

  bindEvents() {
    document.getElementById("logout-btn").addEventListener("click", this.logout);
    document.getElementById("addProductBtn").addEventListener("click", () => this.openModal());
    document.getElementById("closeModal").addEventListener("click", () => this.closeModal());
    document.getElementById("cancel-btn").addEventListener("click", () => this.closeModal());
    document.getElementById("product-form").addEventListener("submit", (e) => this.saveProduct(e));
    document.getElementById("product-image").addEventListener("change", (e) => this.handleImageUpload(e));
    
    document.querySelectorAll(".tab-btn").forEach(btn => 
      btn.addEventListener("click", () => this.switchTab(btn.dataset.tab))
    );
    
    document.querySelectorAll(".order-filter-btn").forEach(btn =>
      btn.addEventListener("click", () => this.filterOrders(btn.dataset.status))
    );
  },

  logout() { 
    localStorage.clear(); 
    App.showToast("Logged out successfully", "info");
    setTimeout(() => location.reload(), 1000);
  },

  switchTab(tab) {
    document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
    document.getElementById(`${tab}-tab`).classList.remove("hidden");
    document.querySelectorAll(".tab-btn").forEach(btn => {
      const isActive = btn.dataset.tab === tab;
      btn.className = isActive 
        ? "tab-btn border-b-2 border-indigo-500 text-indigo-600 px-6 py-3 font-semibold transition-all"
        : "tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-gray-700 transition-all";
    });
    
    if (tab === "products") this.fetchProducts();
    if (tab === "orders") this.fetchOrders();
    if (tab === "analytics") this.fetchAndRenderAnalytics();
  },

  openModal() {
    this.editingId = null;
    document.getElementById("modalTitle").textContent = "Add New Product";
    document.getElementById("product-form").reset();
    document.getElementById("image-preview").innerHTML = "";
    document.getElementById("productModal").classList.remove("hidden");
    setTimeout(() => document.querySelector("#productModal > div").classList.add("scale-100"), 10);
  },
  
  closeModal() { 
    document.querySelector("#productModal > div").classList.remove("scale-100");
    setTimeout(() => document.getElementById("productModal").classList.add("hidden"), 200);
  },

  async fetchCategories() {
    try {
      const data = await App.authenticatedFetch("/api/v1/categories");
      const select = document.getElementById("product-category");
      select.innerHTML = "<option value=''>Select a Category</option>";
      data.data.categories.forEach(cat => {
        select.innerHTML += `<option value="${cat._id}">${cat.name}</option>`;
      });
    } catch (err) { 
      App.showToast(err.message, "error"); 
    }
  },

  async fetchProducts() {
    try {
      const seller = JSON.parse(localStorage.getItem("sellerInfo"));
      const data = await App.authenticatedFetch(`/api/v1/products?seller=${seller._id}`);
      this.products = data.data.products || [];
      
      const list = document.getElementById("product-list");
      if (!this.products.length) {
        list.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="text-6xl mb-4">üì¶</div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">No products yet</h3>
            <p class="text-gray-500">Start by adding your first product to get selling!</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = "";
      this.products.forEach(p => {
        const stockStatus = p.stock > 10 ? 'text-green-600' : p.stock > 0 ? 'text-yellow-600' : 'text-red-600';
        const stockBadge = p.stock > 10 ? 'bg-green-100' : p.stock > 0 ? 'bg-yellow-100' : 'bg-red-100';
        
        list.innerHTML += `
          <div class="product-card bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="relative">
              <img src="${p.images[0]?.url || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                   class="w-full h-48 object-cover" alt="${p.name}">
              <span class="absolute top-2 right-2 ${stockBadge} ${stockStatus} px-2 py-1 rounded-full text-xs font-semibold">
                ${p.stock} in stock
              </span>
            </div>
            <div class="p-6">
              <h4 class="font-bold text-lg text-gray-800 mb-2 line-clamp-2">${p.name}</h4>
              <div class="flex items-center justify-between mb-4">
                <span class="text-2xl font-bold text-indigo-600">‚Çπ${p.price}</span>
                <span class="text-sm text-gray-500">${p.category?.name || 'Uncategorized'}</span>
              </div>
              <div class="flex justify-between space-x-2">
                <button onclick="Dashboard.editProduct('${p._id}')" 
                        class="flex-1 bg-blue-50 text-blue-600 py-2 px-3 rounded-lg font-semibold hover:bg-blue-100 transition-colors">
                  ‚úèÔ∏è Edit
                </button>
                <button onclick="Dashboard.deleteProduct('${p._id}')" 
                        class="flex-1 bg-red-50 text-red-600 py-2 px-3 rounded-lg font-semibold hover:bg-red-100 transition-colors">
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          </div>`;
      });
    } catch (err) { 
      App.showToast(err.message, "error"); 
    }
  },

  async fetchOrders() {
    try {
      const seller = JSON.parse(localStorage.getItem("sellerInfo"));
      const data = await App.authenticatedFetch(`/api/v1/orders?sellerId=${seller._id}`);
      this.orders = data.data.orders || [];
      this.renderOrders();
    } catch (err) { 
      App.showToast(err.message, "error"); 
    }
  },

  renderOrders(filteredOrders = null) {
    const ordersToShow = filteredOrders || this.orders;
    const list = document.getElementById("orders-list");
    
    if (!ordersToShow.length) {
      list.innerHTML = `
        <div class="text-center py-12">
          <div class="text-6xl mb-4">üìã</div>
          <h3 class="text-xl font-semibold text-gray-600 mb-2">No orders found</h3>
          <p class="text-gray-500">Orders will appear here once customers start buying</p>
        </div>
      `;
      return;
    }

    const statusColors = {
      'pending': 'bg-yellow-100 text-yellow-800',
      'processing': 'bg-blue-100 text-blue-800',
      'completed': 'bg-green-100 text-green-800',
      'cancelled': 'bg-red-100 text-red-800'
    };

    const tableRows = ordersToShow.map(o => {
      const statusClass = statusColors[o.status] || 'bg-gray-100 text-gray-800';
      return `
        <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
          <td class="p-4 font-mono text-sm">${o._id.slice(-8)}</td>
          <td class="p-4 font-semibold text-lg">‚Çπ${o.total.toFixed(2)}</td>
          <td class="p-4">
            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
              ${o.status.charAt(0).toUpperCase() + o.status.slice(1)}
            </span>
          </td>
          <td class="p-4 text-gray-600">${new Date(o.createdAt).toLocaleDateString('en-IN')}</td>
          <td class="p-4">${o.items?.length || 0} items</td>
          <td class="p-4">
            <button class="text-indigo-600 hover:text-indigo-800 font-semibold" onclick="Dashboard.viewOrderDetails('${o._id}')">
              View Details
            </button>
          </td>
        </tr>
      `;
    }).join("");

    list.innerHTML = `
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Order ID</th>
              <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Total</th>
              <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
              <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</th>
              <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Items</th>
              <th class="p-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>
    `;
  },

  filterOrders(status) {
    document.querySelectorAll('.order-filter-btn').forEach(btn => {
      const isActive = btn.dataset.status === status;
      btn.className = isActive 
        ? 'order-filter-btn bg-indigo-100 text-indigo-800 px-4 py-2 rounded-lg font-medium'
        : 'order-filter-btn bg-gray-100 text-gray-600 px-4 py-2 rounded-lg font-medium hover:bg-gray-200';
    });

    const filteredOrders = status === 'all' ? this.orders : this.orders.filter(o => o.status === status);
    this.renderOrders(filteredOrders);
  },

  viewOrderDetails(orderId) {
    App.showToast("Order details feature coming soon!", "info");
  },

  async fetchAndRenderAnalytics() {
    const grid = document.getElementById("analytics-grid");
    
    if (!this.orders.length) await this.fetchOrders();
    
    const totalRevenue = this.orders.reduce((sum, o) => sum + (o.total || 0), 0);
    const completedOrders = this.orders.filter(o => o.status === 'completed').length;
    const pendingOrders = this.orders.filter(o => o.status === 'pending').length;
    const avgOrderValue = this.orders.length ? totalRevenue / this.orders.length : 0;

    // Calculate product sales
    const productSales = {};
    this.orders.forEach(o => {
      if (o.items) {
        o.items.forEach(item => {
          const name = item.product?.name || 'Unknown Product';
          productSales[name] = (productSales[name] || 0) + (item.quantity || 0);
        });
      }
    });
    
    const topProducts = Object.entries(productSales)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3);

    grid.innerHTML = `
      <div class="stat-card shadow-lg rounded-xl p-6 border-l-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Revenue</p>
            <p class="text-3xl font-bold text-gray-900">‚Çπ${totalRevenue.toLocaleString('en-IN')}</p>
          </div>
          <div class="text-green-500 text-2xl">üí∞</div>
        </div>
        <p class="text-xs text-green-600 mt-2">‚Üó +12% from last month</p>
      </div>
      
      <div class="stat-card shadow-lg rounded-xl p-6 border-l-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Total Orders</p>
            <p class="text-3xl font-bold text-gray-900">${this.orders.length}</p>
          </div>
          <div class="text-blue-500 text-2xl">üì¶</div>
        </div>
        <p class="text-xs text-blue-600 mt-2">${completedOrders} completed, ${pendingOrders} pending</p>
      </div>
      
      <div class="stat-card shadow-lg rounded-xl p-6 border-l-purple-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Avg Order Value</p>
            <p class="text-3xl font-bold text-gray-900">‚Çπ${avgOrderValue.toFixed(0)}</p>
          </div>
          <div class="text-purple-500 text-2xl">üìä</div>
        </div>
        <p class="text-xs text-purple-600 mt-2">‚Üó +5% from last month</p>
      </div>
      
      <div class="stat-card shadow-lg rounded-xl p-6 border-l-orange-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-gray-600">Products Listed</p>
            <p class="text-3xl font-bold text-gray-900">${this.products.length}</p>
          </div>
          <div class="text-orange-500 text-2xl">üè∑Ô∏è</div>
        </div>
        <p class="text-xs text-orange-600 mt-2">${this.products.filter(p => p.stock > 0).length} in stock</p>
      </div>
    `;

    // Update recent activity
    const recentActivity = document.getElementById("recent-activity");
    const activities = [
      "üì¶ New order #12345 received",
      "‚úÖ Product 'iPhone 15' updated", 
      "üí∞ Payment received for order #12344",
      "üìä Monthly report generated",
      "üîî Low stock alert for 3 products"
    ];
    
    recentActivity.innerHTML = activities.map(activity => `
      <div class="flex items-center p-3 bg-gray-50 rounded-lg">
        <span class="text-sm text-gray-700">${activity}</span>
        <span class="ml-auto text-xs text-gray-500">2h ago</span>
      </div>
    `).join("");
  },

  async handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Show preview immediately
    const reader = new FileReader();
    reader.onload = (e) => {
      document.getElementById("image-preview").innerHTML = `
        <div class="relative">
          <img src="${e.target.result}" class="w-32 h-32 object-cover rounded-lg shadow-md">
          <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-lg">
            <div class="loading"></div>
          </div>
        </div>
      `;
    };
    reader.readAsDataURL(file);

    const formData = new FormData();
    formData.append("image", file);
    
    try {
      const data = await App.authenticatedFetch("/api/v1/upload-image", { 
        method: "POST", 
        body: formData 
      });
      this.uploadedImageUrl = data.image.url;
      document.getElementById("image-preview").innerHTML = `
        <div class="relative">
          <img src="${this.uploadedImageUrl}" class="w-32 h-32 object-cover rounded-lg shadow-md">
          <div class="absolute -top-2 -right-2 bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
            ‚úì
          </div>
        </div>
      `;
      App.showToast("Image uploaded successfully!", "success");
    } catch (err) { 
      App.showToast(err.message, "error");
      document.getElementById("image-preview").innerHTML = "";
    }
  },

  async saveProduct(e) {
    e.preventDefault();
    
    const saveBtn = document.getElementById("save-btn-text");
    const spinner = document.getElementById("save-spinner");
    saveBtn.classList.add("hidden");
    spinner.classList.remove("hidden");

    const productData = {
      name: document.getElementById("product-name").value,
      category: document.getElementById("product-category").value,
      price: parseFloat(document.getElementById("product-price").value),
      stock: parseInt(document.getElementById("product-stock").value),
      seller: JSON.parse(localStorage.getItem("sellerInfo"))._id
    };

    if (this.uploadedImageUrl) {
      productData.images = [{ url: this.uploadedImageUrl }];
    }

    try {
      const endpoint = this.editingId ? `/api/v1/products/${this.editingId}` : "/api/v1/products";
      const method = this.editingId ? "PUT" : "POST";
      
      await App.authenticatedFetch(endpoint, { 
        method, 
        body: JSON.stringify(productData) 
      });
      
      App.showToast(
        this.editingId ? "Product updated successfully! üéâ" : "Product added successfully! üéâ", 
        "success"
      );
      this.closeModal();
      this.fetchProducts();
      this.uploadedImageUrl = "";
    } catch (err) { 
      App.showToast(err.message, "error"); 
    } finally {
      saveBtn.classList.remove("hidden");
      spinner.classList.add("hidden");
    }
  },

  async editProduct(id) {
    try {
      const data = await App.authenticatedFetch(`/api/v1/products/${id}`);
      const product = data.data.product;
      
      this.editingId = product._id;
      document.getElementById("modalTitle").textContent = "Edit Product";
      document.getElementById("product-name").value = product.name;
      document.getElementById("product-category").value = product.category;
      document.getElementById("product-price").value = product.price;
      document.getElementById("product-stock").value = product.stock;
      
      this.uploadedImageUrl = "";
      if (product.images && product.images[0]) {
        document.getElementById("image-preview").innerHTML = `
          <div class="relative">
            <img src="${product.images[0].url}" class="w-32 h-32 object-cover rounded-lg shadow-md">
            <div class="absolute -top-2 -right-2 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
              üì∑
            </div>
          </div>
        `;
      } else {
        document.getElementById("image-preview").innerHTML = "";
      }
      
      document.getElementById("productModal").classList.remove("hidden");
      setTimeout(() => document.querySelector("#productModal > div").classList.add("scale-100"), 10);
    } catch (err) { 
      App.showToast(err.message, "error"); 
    }
  },

  async deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product? This action cannot be undone.")) return;
    
    try {
      await App.authenticatedFetch(`/api/v1/products/${id}`, { method: "DELETE" });
      App.showToast("Product deleted successfully", "success");
      this.fetchProducts();
    } catch (err) { 
      App.showToast(err.message, "error"); 
    }
  }
};

// Initialize app when DOM is loaded
document.addEventListener("DOMContentLoaded", () => App.init());

// Add some utility CSS for line clamping
const style = document.createElement('style');
style.textContent = `
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
`;
document.head.appendChild(style);
</script>
</body>
</html>