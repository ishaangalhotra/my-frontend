<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Central | Inventory</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* Amazon Seller Central Style Palette */
            --nav-bg: #232f3e;
            --nav-text: #ffffff;
            --primary: #007185; /* Link Blue */
            --secondary: #e77600; /* CTA Orange */
            --bg-color: #f1f3f6;
            --white: #ffffff;
            --border: #d5d9d9;
            --text-dark: #0f1111;
            --text-light: #565959;
            --success: #007600;
            --danger: #c40000;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        body { background: var(--bg-color); min-height: 100vh; display: flex; flex-direction: column; font-size: 13px; color: var(--text-dark); }

        /* --- Top Navigation --- */
        .top-nav {
            background: var(--nav-bg);
            color: var(--nav-text);
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .brand { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; gap: 20px; }
        .nav-link { color: #ccc; text-decoration: none; font-weight: 500; cursor: pointer; padding: 15px 0; border-bottom: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: white; border-bottom-color: var(--secondary); }
        .nav-right { display: flex; align-items: center; gap: 15px; }

        /* --- Main Layout --- */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; width: 100%; flex: 1; }

        /* --- Section Visibility --- */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Inventory Toolbar --- */
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .inventory-title { font-size: 24px; font-weight: 700; color: var(--text-dark); }
        
        .filters-bar {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .search-group { display: flex; flex: 1; max-width: 400px; }
        .search-input { width: 100%; padding: 8px 10px; border: 1px solid #888; border-radius: 3px 0 0 3px; border-right: none; outline: none; }
        .search-btn { background: #febd69; border: 1px solid #a88734; border-radius: 0 3px 3px 0; padding: 0 15px; cursor: pointer; }
        
        .filter-group label { margin-right: 5px; font-weight: 700; color: var(--text-light); }
        .filter-select { padding: 6px; border-radius: 3px; border: 1px solid #888; background: #f0f2f2; }

        /* --- Data Table (Amazon Style) --- */
        .data-table-wrapper {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        thead { background: #fafafa; border-bottom: 1px solid var(--border); }
        th { text-align: left; padding: 10px 15px; color: var(--text-light); font-size: 11px; text-transform: uppercase; font-weight: 700; }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
        tr:hover td { background-color: #fafffe; }

        /* Product Cell */
        .product-cell { display: flex; gap: 15px; }
        .product-img { width: 60px; height: 60px; object-fit: contain; border: 1px solid var(--border); background: white; }
        .product-info { display: flex; flex-direction: column; gap: 2px; }
        .product-name { font-weight: 700; color: var(--primary); font-size: 14px; text-decoration: none; display: block; margin-bottom: 2px; }
        .product-meta { color: var(--text-light); font-size: 11px; }

        /* Status Badge */
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; }
        .status-active { color: var(--success); }
        .status-inactive { color: var(--danger); }

        /* Input Fields in Table */
        .editable-input { width: 80px; padding: 5px; border: 1px solid #888; border-radius: 3px; text-align: right; }
        
        /* Action Buttons */
        .btn { cursor: pointer; padding: 6px 12px; border-radius: 3px; font-size: 11px; font-weight: 500; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: #f0c14b; border: 1px solid #a88734; color: #111; box-shadow: 0 1px 0 rgba(255,255,255,0.4) inset; }
        .btn-primary:hover { background: #f4d078; }
        .btn-secondary { background: #e7e9ec; border: 1px solid #adb1b8; color: #111; }
        .btn-secondary:hover { background: #dfe1e5; }
        .btn-danger { background: #fff; border: 1px solid #d00; color: #d00; }
        .btn-danger:hover { background: #fff0f0; }

        /* --- Add/Edit Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-container { background: white; width: 800px; max-height: 90vh; display: flex; flex-direction: column; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border); background: white; padding: 0 20px; }
        .tab-btn { padding: 12px 15px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; color: var(--text-light); font-weight: 500; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--secondary); }

        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .form-section { display: none; }
        .form-section.active { display: block; }

        .form-row { margin-bottom: 15px; display: grid; grid-template-columns: 150px 1fr; gap: 20px; align-items: start; }
        .form-label { font-weight: 700; color: var(--text-dark); font-size: 12px; padding-top: 8px; text-align: right; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #888; border-radius: 3px; }
        .form-helper { font-size: 11px; color: var(--text-light); margin-top: 4px; }

        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); background: #f8f9fa; display: flex; justify-content: flex-end; gap: 10px; }

        /* --- Dashboard Widgets --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .widget-card { background: white; border: 1px solid var(--border); border-radius: 4px; padding: 20px; }
        .widget-title { font-size: 13px; font-weight: 700; color: var(--text-light); margin-bottom: 10px; text-transform: uppercase; }
        .widget-value { font-size: 28px; font-weight: 300; color: var(--text-dark); }
        .widget-sub { font-size: 12px; color: var(--success); display: flex; align-items: center; gap: 5px; margin-top: 5px; }

        /* Order Timeline Styles */
        .order-timeline {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 10px 0 15px;
            position: relative;
            gap: 10px;
            font-size: 11px;
        }

        .timeline-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding-top: 18px;
            color: var(--text-light);
        }

        .timeline-step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: #fff;
            box-sizing: border-box;
        }

        .timeline-step::after {
            content: '';
            position: absolute;
            top: 7px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border);
            z-index: -1;
        }

        .timeline-step:first-child::after {
            left: 50%;
            width: 50%;
        }

        .timeline-step:last-child::after {
            width: 50%;
        }

        .timeline-step:first-child::after,
        .timeline-step:last-child::after {
            transform: translateX(0);
        }

        .timeline-step.active {
            color: var(--primary);
            font-weight: 600;
        }

        .timeline-step.active::before {
            border-color: var(--primary);
            background: var(--primary);
        }

        .timeline-step.completed {
            color: #28a745;
        }

        .timeline-step.completed::before {
            border-color: #28a745;
            background: #28a745;
        }

        .timeline-step-cancelled {
            color: var(--danger);
        }

        .timeline-step-cancelled::before {
            border-color: var(--danger);
            background: var(--danger);
        }

        .timeline-label {
            margin-bottom: 2px;
        }

        .timeline-time {
            font-size: 10px;
            color: var(--text-light);
        }

        /* Alerts */
        .alert-float { position: fixed; top: 70px; right: 20px; padding: 15px 25px; border-radius: 4px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 3000; display: none; }
        .alert-success { background: var(--success); }
        .alert-error { background: var(--danger); }
        .loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; align-items:center; justify-content:center; flex-direction:column; }
    </style>
</head>
<body>

    <div id="loader" class="loader" style="display: flex;">
        <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--secondary); margin-bottom: 15px;"></i>
        <h3>Loading Seller Central...</h3>
    </div>

    <div id="toast" class="alert-float"></div>

    <nav class="top-nav">
        <div class="brand">
            <i class="fas fa-box-open" style="color: var(--secondary);"></i> QuickLocal <span style="font-weight: 300; opacity: 0.8;">Seller Central</span>
        </div>
        <div class="nav-links">
            <a onclick="switchTab('dashboard')" class="nav-link active" id="nav-dashboard">Dashboard</a>
            <a onclick="switchTab('inventory')" class="nav-link" id="nav-inventory">Inventory</a>
            <a onclick="switchTab('orders')" class="nav-link" id="nav-orders">Orders</a>
            <a onclick="switchTab('reports')" class="nav-link" id="nav-reports">Reports</a>
        </div>
        <div class="nav-right">
            <div style="text-align: right; line-height: 1.2;">
                <div style="font-weight: 700;" id="sellerName">Seller</div>
                <div style="font-size: 10px; opacity: 0.8;">India</div>
            </div>
            <button onclick="handleLogout()" class="btn btn-secondary" style="padding: 5px 10px;">Logout</button>
        </div>
    </nav>

    <div class="container">
        
        <div id="dashboard" class="section active">
            <h1 class="inventory-title" style="margin-bottom: 20px;">Performance Overview</h1>
            
            <div class="dashboard-grid">
                <div class="widget-card">
                    <div class="widget-title">Today's Sales</div>
                    <div class="widget-value" id="todaySales">₹0.00</div>
                    <div class="widget-sub"><i class="fas fa-arrow-up"></i> 0% vs yesterday</div>
                </div>
                <div class="widget-card">
                    <div class="widget-title">Total Orders</div>
                    <div class="widget-value" id="totalOrders">0</div>
                    <div class="widget-sub" style="color: var(--text-light);">Last 30 days</div>
                </div>
                <div class="widget-card">
                    <div class="widget-title">Active Listings</div>
                    <div class="widget-value" id="activeListings">0</div>
                    <div class="widget-sub" style="color: var(--primary);">View Inventory</div>
                </div>
            </div>

            <div class="widget-card" style="height: 400px;">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <div id="inventory" class="section">
            <div class="inventory-header">
                <div class="inventory-title">Manage Inventory</div>
                <button class="btn btn-primary" onclick="openProductModal()">
                    <i class="fas fa-plus"></i> Add a Product
                </button>
            </div>

            <div class="filters-bar">
                <div class="filter-group">
                    <label>Status:</label>
                    <select class="filter-select" id="statusFilter" onchange="filterProducts()">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="search-group">
                    <input type="text" id="inventorySearch" class="search-input" placeholder="Search by SKU, Title, ASIN..." onkeyup="filterProducts()">
                    <button class="search-btn"><i class="fas fa-search"></i></button>
                </div>
            </div>

            <div class="data-table-wrapper">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Image</th>
                            <th style="width: 30%;">Product Name</th>
                            <th>Date Created</th>
                            <th>Available</th>
                            <th>Fee Preview</th>
                            <th>Your Price</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                    </tbody>
                </table>
            </div>
            <div id="noProductsMsg" style="text-align: center; padding: 40px; display: none;">
                <i class="fas fa-box-open" style="font-size: 40px; color: #ccc; margin-bottom: 10px;"></i>
                <p>No inventory found matching your criteria.</p>
            </div>
        </div>
        
        <div id="orders" class="section">
            <h1 class="inventory-title">Manage Orders</h1>
            <div class="widget-card">
                <div class="inventory-header">
                    <p>Order management module loaded.</p>
                    <button class="btn btn-primary" onclick="loadSellerOrders()">Refresh Orders</button>
                </div>
                <div class="data-table-wrapper" style="margin-top: 20px;">
                    <table id="ordersTable">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Items</th>
                                <th>Customer</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Actions</th> 
                            </tr>
                        </thead>
                        <tbody id="ordersBody">
                            <tr><td colspan="6" style="text-align: center; padding: 20px;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="reports" class="section">
            <h1 class="inventory-title">Reports</h1>
            <div class="widget-card">
                <p>Advanced reports coming soon.</p>
            </div>
        </div>

    </div>

    <div id="productModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">Add Product</h3>
                <button onclick="closeProductModal()" style="border:none; background:none; cursor:pointer; font-size: 18px;">&times;</button>
            </div>
            
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchFormTab('vital', event)">Vital Info</button>
                <button class="tab-btn" onclick="switchFormTab('offer', event)">Offer</button>
                <button class="tab-btn" onclick="switchFormTab('images', event)">Images</button>
                <button class="tab-btn" onclick="switchFormTab('description', event)">Description</button>
            </div>

            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="editProductId">

                    <div id="tab-vital" class="form-section active">
                        <div class="form-row">
                            <label class="form-label">Product Name <span style="color:red">*</span></label>
                            <div>
                                <input type="text" name="name" id="pName" class="form-control" required>
                                <div class="form-helper">Title should be concise and descriptive.</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Brand Name</label>
                            <div>
                                <input type="text" name="brand" id="pBrand" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Category <span style="color:red">*</span></label>
                            <div>
                                <select name="category" id="pCategory" class="form-control" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="tab-offer" class="form-section">
                        <div class="form-row">
                            <label class="form-label">Your Price (₹) <span style="color:red">*</span></label>
                            <div>
                                <input type="number" name="price" id="pPrice" class="form-control" required step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">MRP (₹)</label>
                            <div>
                                <input type="number" name="originalPrice" id="pOriginalPrice" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Quantity <span style="color:red">*</span></label>
                            <div>
                                <input type="number" name="stock" id="pStock" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div id="tab-images" class="form-section">
                        <div class="form-row">
                            <label class="form-label">Main Image</label>
                            <div>
                                <input type="file" id="pImageInput" accept="image/*" class="form-control" multiple>
                                <div class="form-helper">High quality images on white background recommended.</div>
                                <div id="imagePreview" style="display:flex; gap:10px; margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-description" class="form-section">
                        <div class="form-row">
                            <label class="form-label">Product Description <span style="color:red">*</span></label>
                            <div>
                                <textarea name="description" id="pDescription" class="form-control" rows="8" required></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitProductForm()">Save and Finish</button>
            </div>
        </div>
    </div>

    <div id="orderModal" class="modal-overlay">
        <div class="modal-container" style="width: 700px;">
            <div class="modal-header">
                <h3>Order Details</h3>
                <button onclick="closeOrderModal()" style="border:none; background:none; cursor:pointer; font-size: 18px;">&times;</button>
            </div>
            
            <div class="modal-body">
                <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px; border: 1px solid var(--border);">
                    <h4 style="margin-bottom: 10px; color: var(--primary);">Customer Information</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>Name:</strong> <span id="ordCustName"></span></div>
                        <div><strong>Phone:</strong> <span id="ordCustPhone"></span></div>
                        <div style="grid-column: span 2;"><strong>Email:</strong> <span id="ordCustEmail"></span></div>
                        <div style="grid-column: span 2;">
                            <strong>Shipping Address:</strong><br>
                            <span id="ordCustAddress" style="color: var(--text-light);"></span>
                        </div>
                    </div>
                </div>

                <!-- NEW: ORDER TIMELINE -->
                <h4 style="margin-bottom: 8px; color: var(--text-dark);">Order Timeline</h4>
                <div id="orderTimeline" class="order-timeline"></div>

                <hr style="margin: 15px 0;">
                <h4 style="margin-bottom: 10px; color: var(--text-dark);">Ordered Items</h4>
                <div class="data-table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Product</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="orderItemsBody">
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; text-align: right; font-size: 16px;">
                    <strong>Total Amount: </strong> <span id="ordTotalAmount" style="color: var(--danger); font-weight: bold;"></span>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="js/load-hybrid-auth.js"></script>
    <script>
        const API_URL = window.QUICKLOCAL_API_BASE || '/api/v1';
        let currentUser = null;
        let globalProducts = [];
        let globalOrders = [];
        let salesChartInstance = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initAuth();
                await Promise.all([
                    loadDashboard(),
                    loadInventory(),
                    loadCategories()
                ]);
            } catch (err) {
                console.error(err);
                showToast("Failed to load seller data: " + err.message, 'error');
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        });

        // --- AUTH ---
        async function initAuth() {
            if (!window.HybridAuthClient) throw new Error("Auth client missing");
            
            let tries = 0;
            while(!window.HybridAuthClient.getAuthMethod() && tries < 20) {
                await new Promise(r => setTimeout(r, 100));
                tries++;
            }

            const isAuth = await window.HybridAuthClient.isAuthenticated();
            if (!isAuth) {
                window.location.href = 'seller-login.html';
                return;
            }

            currentUser = window.HybridAuthClient.getCurrentUser();
            document.getElementById('sellerName').textContent = currentUser.name || currentUser.businessName || 'Seller';
            
            if (currentUser.role !== 'seller' && currentUser.role !== 'admin') {
                alert("Unauthorized access");
                window.location.href = 'index.html';
            }
        }

        async function handleLogout() {
            await window.HybridAuthClient.logout();
            window.location.href = 'seller-login.html';
        }

        // --- TABS & NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');

            if(tabId === 'inventory') loadInventory();
            if(tabId === 'orders') loadSellerOrders();
            if(tabId === 'dashboard') loadDashboard();
        }

        function switchFormTab(tabName, ev) {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            if (ev && ev.target) {
                ev.target.classList.add('active');
            }
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            try {
                const res = await window.HybridAuthClient.apiCall('/seller/dashboard');
                if (!res.ok) return;

                const data = await res.json();
                const ov = data?.data?.overview || {};

                const totalOrders = ov.orders?.total ?? ov.totalOrders ?? 0;
                const activeListings = ov.products?.active ?? ov.activeProducts ?? 0;
                const totalRevenue = ov.revenue?.total ?? ov.totalRevenue ?? 0;

                document.getElementById('totalOrders').innerText = totalOrders;
                document.getElementById('activeListings').innerText = activeListings;
                document.getElementById('todaySales').innerText = "₹" + Number(totalRevenue || 0).toLocaleString();

                initChart([1200, 1500, 800, 2300, 1800, 3200, 2500]);
            } catch(e) {
                console.warn("Dashboard load error", e);
            }
        }

        function initChart(dataPoints) {
            const ctx = document.getElementById('salesChart').getContext('2d');

            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Sales (₹)',
                        data: dataPoints,
                        borderColor: '#e77600',
                        backgroundColor: 'rgba(231, 118, 0, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { maintainAspectRatio: false, responsive: true }
            });
        }

        // --- INVENTORY MANAGEMENT ---
        async function loadInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">Loading inventory...</td></tr>';

            try {
                const res = await window.HybridAuthClient.apiCall('/seller/products');
                const data = await res.json();
                
                let products = [];
                if (data.data && Array.isArray(data.data.products)) products = data.data.products;
                else if (Array.isArray(data.data)) products = data.data;
                else if (Array.isArray(data)) products = data;

                globalProducts = products;
                renderInventoryTable(products);

            } catch(err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="8" style="color:red; text-align:center;">Error loading inventory: ${err.message}</td></tr>`;
            }
        }

        function renderInventoryTable(products) {
            const tbody = document.getElementById('inventoryBody');
            
            if(products.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('noProductsMsg').style.display = 'block';
                return;
            }
            
            document.getElementById('noProductsMsg').style.display = 'none';
            
            tbody.innerHTML = products.map(p => {
                const img = (p.images && p.images[0]?.url) ? p.images[0].url : 'https://placehold.co/60x60?text=No+Img';
                const status = p.stock > 0 ? 'Active' : 'Inactive';
                const statusClass = p.stock > 0 ? 'status-active' : 'status-inactive';
                const date = new Date(p.createdAt || Date.now()).toLocaleDateString();
                const fee = (Number(p.price || 0) * 0.15).toFixed(2);
                const id = p._id || p.id || '';

                const sku = id ? id.toString().slice(-6).toUpperCase() : 'SKU';
                const asin = id ? ('B0' + id.toString().slice(-8).toUpperCase()) : 'B0XXXXX';

                return `
                <tr>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td><img src="${img}" class="product-img" alt="Product image"></td>
                    <td>
                        <div class="product-info">
                            <a href="javascript:void(0)" class="product-name" onclick="openEdit('${id}'); return false;">${p.name}</a>
                            <div class="product-meta">SKU: ${sku}</div>
                            <div class="product-meta">ASIN: ${asin}</div>
                        </div>
                    </td>
                    <td style="color:#555;">${date}</td>
                    <td>
                        <input type="number" class="editable-input" value="${p.stock}" onchange="quickUpdate('${id}', 'stock', this.value)">
                    </td>
                    <td style="color:#555;">Est. Fee: ₹${fee}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span>₹</span>
                            <input type="number" class="editable-input" value="${p.price}" onchange="quickUpdate('${id}', 'price', this.value)">
                        </div>
                    </td>
                    <td style="text-align: right;">
                        <button class="btn btn-secondary" onclick="openEdit('${id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteProduct('${id}')" style="margin-left: 5px;">Delete</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // --- FILTERING ---
        function filterProducts() {
            const term = document.getElementById('inventorySearch').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;

            const filtered = globalProducts.filter(p => {
                const name = (p.name || '').toLowerCase();
                const id = (p._id || p.id || '').toString().toLowerCase();

                const matchesSearch = name.includes(term) || id.includes(term);
                const isActive = p.stock > 0;
                
                let matchesStatus = true;
                if(status === 'active') matchesStatus = isActive;
                if(status === 'inactive') matchesStatus = !isActive;

                return matchesSearch && matchesStatus;
            });

            renderInventoryTable(filtered);
        }

        // --- ADD / EDIT LOGIC ---
        function openProductModal() {
            document.getElementById('modalTitle').innerText = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            
            loadCategories();
            
            document.getElementById('productModal').classList.add('active');
            switchFormTab('vital');
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function openEdit(id) {
            const p = globalProducts.find(x => (x._id || x.id || '').toString() === id.toString());
            if(!p) return;

            document.getElementById('modalTitle').innerText = 'Edit Product';
            document.getElementById('editProductId').value = id;
            
            document.getElementById('pName').value = p.name || '';
            document.getElementById('pBrand').value = p.brand || '';
            document.getElementById('pPrice').value = p.price ?? '';
            document.getElementById('pOriginalPrice').value = p.originalPrice ?? '';
            document.getElementById('pStock').value = p.stock ?? '';
            document.getElementById('pDescription').value = p.description || '';
            
            const catSelect = document.getElementById('pCategory');
            if(p.category) {
                const cid = typeof p.category === 'object' ? p.category._id : p.category;
                catSelect.value = cid || '';
            }

            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            if(p.images && p.images.length) {
                p.images.forEach(img => {
                    const i = document.createElement('img');
                    i.src = img.url;
                    i.style.width = '50px';
                    i.style.height = '50px';
                    i.style.border = '1px solid #ccc';
                    i.style.objectFit = 'cover';
                    preview.appendChild(i);
                });
            }

            document.getElementById('productModal').classList.add('active');
            switchFormTab('vital');
        }

        async function submitProductForm() {
            const form = document.getElementById('productForm');
            if(!form.checkValidity()) {
                alert("Please fill all required fields marked with *");
                return;
            }

            const id = document.getElementById('editProductId').value;
            const isEdit = !!id;
            
            const btn = document.querySelector('.modal-footer .btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                const formData = new FormData();
                
                formData.append('name', document.getElementById('pName').value);
                formData.append('brand', document.getElementById('pBrand').value);
                formData.append('description', document.getElementById('pDescription').value);
                formData.append('category', document.getElementById('pCategory').value);
                
                const price = parseFloat(document.getElementById('pPrice').value);
                formData.append('price', price);
                formData.append('finalPrice', price); 
                
                const ogPrice = document.getElementById('pOriginalPrice').value;
                if(ogPrice) {
                    formData.append('originalPrice', parseFloat(ogPrice));
                }

                formData.append('stock', document.getElementById('pStock').value);
                formData.append('unit', 'piece');

                if(currentUser) {
                    formData.append('seller', currentUser._id || currentUser.id || '');
                    formData.append('sellerName', currentUser.storeName || currentUser.name || ''); 
                }

                const files = document.getElementById('pImageInput').files;
                if(files.length > 0) {
                    for(let i=0; i<files.length; i++) {
                        formData.append('images', files[i]);
                    }
                } 

                let url = '/seller/products';
                let method = 'POST';
                if(isEdit) {
                    url = `/seller/products/${id}`;
                    method = 'PUT';
                }

                const res = await window.HybridAuthClient.apiCall(url, { method, body: formData });
                const result = await res.json();

                if(res.ok) {
                    showToast(isEdit ? 'Product updated!' : 'Product created!', 'success');
                    closeProductModal();
                    loadInventory();
                } else {
                    throw new Error(result.message || 'Operation failed');
                }

            } catch(err) {
                console.error('Product submission error:', err);
                showToast(err.message, 'error');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function deleteProduct(id) {
            if(!confirm("Are you sure you want to delete this listing? This cannot be undone.")) return;
            
            try {
                const res = await window.HybridAuthClient.apiCall(`/seller/products/${id}`, { method: 'DELETE' });
                const data = await res.json().catch(() => ({}));
                if(res.ok) {
                    showToast(data.message || "Listing deleted", 'success');
                    loadInventory();
                } else {
                    throw new Error(data.message || "Delete failed");
                }
            } catch(e) {
                console.error(e);
                showToast(e.message, 'error');
            }
        }

        // --- QUICK UPDATE (Inline Editing) ---
        async function quickUpdate(id, field, value) {
            try {
                const formData = new FormData();
                formData.append(field, value);
                
                const res = await window.HybridAuthClient.apiCall(`/seller/products/${id}`, { method: 'PUT', body: formData });
                const data = await res.json().catch(() => ({}));
                
                if(res.ok) showToast(`${field} updated`, 'success');
                else showToast(data.message || `Failed to update ${field}`, 'error');
            } catch(e) {
                console.error(e);
                showToast(`Error updating ${field}`, 'error');
            }
        }

        // --- CATEGORIES ---
        async function loadCategories() {
            try {
                const cacheBuster = `_t=${Date.now()}`;
                let res;
                
                if (window.HybridAuthClient) {
                    res = await window.HybridAuthClient.apiCall(`/categories?limit=50&${cacheBuster}`, {
                        method: 'GET'
                    });
                } else {
                    res = await fetch(`${API_URL}/categories?limit=50&${cacheBuster}`, {
                        method: 'GET'
                    });
                }

                const data = await res.json();

                let categories = [];
                if (data.success && data.data) {
                    categories = Array.isArray(data.data) ? data.data : 
                                (data.data.categories ? data.data.categories : []);
                } else if (Array.isArray(data)) {
                    categories = data;
                } else if (data.categories) {
                    categories = data.categories;
                }

                const select = document.getElementById('pCategory');
                select.innerHTML = '<option value="">Select Category...</option>';
                
                categories.forEach(c => {
                    if (!c || !c._id) return;
                    const name = c.name || 'Unnamed Category';
                    select.innerHTML += `<option value="${c._id}">${name}</option>`;
                });

            } catch(e) {
                console.error("Category load error", e);
                showToast("Failed to load categories", 'error');
                
                const select = document.getElementById('pCategory');
                select.innerHTML = `
                    <option value="">Select Category...</option>
                    <option value="electronics">Electronics</option>
                    <option value="clothing">Clothing</option>
                    <option value="home">Home & Garden</option>
                    <option value="groceries">Groceries</option>
                    <option value="fruits">Fruits & Vegetables</option>
                    <option value="dairy">Dairy</option>
                    <option value="bakery">Bakery</option>
                `;
            }
        }

        // --- ORDER TIMELINE HELPERS ---
        function getOrderStatusForTimeline(order) {
            const statuses = [];

            if (order.status) {
                statuses.push(String(order.status).toLowerCase());
            }

            if (Array.isArray(order.items)) {
                order.items.forEach(it => {
                    if (it.status) {
                        statuses.push(String(it.status).toLowerCase());
                    }
                });
            }

            if (!statuses.length) return 'pending';

            if (statuses.some(s => ['cancelled', 'failed'].includes(s))) return 'cancelled';
            if (statuses.some(s => ['delivered'].includes(s))) return 'delivered';
            if (statuses.some(s => ['shipped', 'dispatched', 'out_for_delivery', 'ready_to_ship'].includes(s))) return 'shipped';
            if (statuses.some(s => ['processing', 'confirmed', 'preparing', 'ready'].includes(s))) return 'processing';

            return 'pending';
        }

        function renderOrderTimeline(order) {
            const container = document.getElementById('orderTimeline');
            if (!container) return;

            const createdAt = order.createdAt ? new Date(order.createdAt) : null;
            const currentStatus = getOrderStatusForTimeline(order);

            const steps = [
                { key: 'placed', label: 'Order Placed' },
                { key: 'processing', label: 'Processing' },
                { key: 'shipped', label: 'Shipped' },
                { key: 'delivered', label: 'Delivered' }
            ];

            const statusToIndex = {
                pending: 0,
                placed: 0,
                confirmed: 1,
                processing: 1,
                preparing: 1,
                ready: 1,
                ready_to_ship: 2,
                shipped: 2,
                dispatched: 2,
                out_for_delivery: 2,
                delivered: 3
            };

            const idx = statusToIndex[currentStatus] ?? 0;

            // Build HTML
            container.innerHTML = steps.map((step, i) => {
                let cls = 'timeline-step';
                if (currentStatus === 'cancelled') {
                    if (i === 0) cls += ' completed';
                } else {
                    if (i < idx) cls += ' completed';
                    if (i === idx) cls += ' active';
                }

                // Only show timestamp on first step (placed)
                let timeLabel = '';
                if (i === 0 && createdAt) {
                    timeLabel = createdAt.toLocaleString();
                }

                return `
                    <div class="${cls}">
                        <div class="timeline-label">${step.label}</div>
                        ${timeLabel ? `<div class="timeline-time">${timeLabel}</div>` : ''}
                    </div>
                `;
            }).join('');

            if (currentStatus === 'cancelled') {
                container.innerHTML += `
                    <div style="margin-top: 6px; text-align:center; font-size: 11px; color: var(--danger);">
                        This order was cancelled.
                    </div>
                `;
            }
        }

        // --- ORDERS LIST + STATUS CHANGE ---
        async function loadSellerOrders() {
            const tbody = document.getElementById('ordersBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading orders...</td></tr>';
            try {
                const res = await window.HybridAuthClient.apiCall('/seller/orders');
                const data = await res.json();
                const orders = data.data || [];
                globalOrders = orders;

                if(!orders.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">No orders found.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = orders.map(o => {
                    const id = (o.orderNumber || o._id || '').toString();
                    const orderCode = id ? id.slice(-8).toUpperCase() : 'ORDER';
                    const itemsCount = o.items?.length || 0;
                    
                    const shipping = o.shippingAddress || o.shipping || {};
                    const customerName = shipping.fullName || shipping.name || 'Customer';

                    const firstItem = o.items && o.items[0] ? o.items[0] : null;
                    const status = (o.status || firstItem?.status || 'pending').toLowerCase();
                    
                    let badgeClass = 'status-inactive';
                    if (status === 'delivered') badgeClass = 'status-active';
                    else if (status === 'shipped' || status === 'processing') badgeClass = 'status-active';

                    const total = typeof o.totalAmount === 'number' ? o.totalAmount : (o.subtotal || 0);
                    const orderId = o._id || o.id || '';

                    return `
                        <tr>
                            <td style="color:var(--primary); font-weight:bold;">#${orderCode}</td>
                            <td>${itemsCount} item(s)</td>
                            <td>${customerName}</td>
                            <td><span class="status-badge ${badgeClass}">${status}</span></td>
                            <td style="font-weight:700;">₹${total.toFixed(2)}</td>
                            <td>
                                <select onchange="changeOrderStatus('${orderId}', this.value)" style="font-size:11px; padding:3px 5px; margin-bottom:4px;">
                                    <option value="">Update status</option>
                                    <option value="pending">Pending</option>
                                    <option value="processing">Processing</option>
                                    <option value="shipped">Shipped</option>
                                    <option value="delivered">Delivered</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <button class="btn btn-primary" style="padding: 4px 10px;" onclick="viewOrderDetails('${orderId}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Failed to load orders.</td></tr>';
            }
        }

        // --- CHANGE ORDER STATUS (CALLS BACKEND) ---
        async function changeOrderStatus(orderId, newStatus) {
            if (!newStatus) return;

            try {
                const res = await window.HybridAuthClient.apiCall(`/seller/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newStatus })
                });

                const data = await res.json().catch(() => ({}));

                if (!res.ok || data.success === false) {
                    throw new Error(data.message || 'Failed to update order status');
                }

                showToast('Order status updated', 'success');
                loadSellerOrders();
            } catch (e) {
                console.error('Status update error', e);
                showToast(e.message || 'Failed to update order status', 'error');
            }
        }

        // --- ORDER DETAILS MODAL ---
        function viewOrderDetails(orderId) {
            const order = globalOrders.find(o => (o._id || o.id) == orderId);
            if (!order) return showToast('Order details not found', 'error');

            // NEW: Render order timeline
            renderOrderTimeline(order);

            // 1. Populate Customer Info
            const shipping = order.shippingAddress || order.shipping || {}; 
            
            document.getElementById('ordCustName').textContent = shipping.name || shipping.fullName || 'N/A';
            
            document.getElementById('ordCustPhone').textContent = 
                shipping.phoneNumber || 
                shipping.phone || 
                order.user?.phone || 
                'N/A';

            document.getElementById('ordCustEmail').textContent = order.user?.email || shipping.email || 'N/A';
            
            const addressParts = [
                shipping.address,
                shipping.city,
                shipping.state,
                shipping.postalCode || shipping.pincode,
                shipping.country
            ].filter(Boolean).join(', ');
            
            document.getElementById('ordCustAddress').textContent = addressParts || 'No address provided';

            const tbody = document.getElementById('orderItemsBody');
            tbody.innerHTML = '';
            
            if (order.items && order.items.length > 0) {
                order.items.forEach(item => {
                    const product = item.product || {};
                    const name = product.name || 'Product Item';
                    const img = (product.images && product.images[0]?.url) || product.image || 'https://placehold.co/50';
                    const qty = item.quantity || 1;
                    const price = item.price || product.price || 0;
                    const itemTotal = price * qty;

                    tbody.innerHTML += `
                        <tr>
                            <td><img src="${img}" style="width:40px; height:40px; object-fit:cover; border-radius:4px;"></td>
                            <td>
                                <div style="font-weight:bold; font-size:12px;">${name}</div>
                                <div style="font-size:10px; color:#666;">SKU: ${(product._id || '').slice(-6)}</div>
                            </td>
                            <td>${qty}</td>
                            <td>₹${price}</td>
                            <td>₹${itemTotal}</td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No items data available</td></tr>';
            }

            const total = typeof order.totalAmount === 'number' ? order.totalAmount : (order.subtotal || 0);
            document.getElementById('ordTotalAmount').textContent = '₹' + total.toFixed(2);

            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        // --- UTILS ---
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `alert-float alert-${type}`;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        document.getElementById('pImageInput').addEventListener('change', function(e) {
            const div = document.getElementById('imagePreview');
            div.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.style.width = '50px';
                    img.style.height = '50px';
                    img.style.objectFit = 'cover';
                    img.style.border = '1px solid #ccc';
                    div.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

    </script>
</body>
</html>
