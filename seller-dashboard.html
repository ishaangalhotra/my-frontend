<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Central | Inventory</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* Amazon Seller Central Style Palette */
            --nav-bg: #232f3e;
            --nav-text: #ffffff;
            --primary: #007185; /* Link Blue */
            --secondary: #e77600; /* CTA Orange */
            --bg-color: #f1f3f6;
            --white: #ffffff;
            --border: #d5d9d9;
            --text-dark: #0f1111;
            --text-light: #565959;
            --success: #007600;
            --danger: #c40000;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
        body { background: var(--bg-color); min-height: 100vh; display: flex; flex-direction: column; font-size: 13px; color: var(--text-dark); }

        /* --- Top Navigation --- */
        .top-nav {
            background: var(--nav-bg);
            color: var(--nav-text);
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .brand { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; gap: 20px; }
        .nav-link { color: #ccc; text-decoration: none; font-weight: 500; cursor: pointer; padding: 15px 0; border-bottom: 3px solid transparent; }
        .nav-link:hover, .nav-link.active { color: white; border-bottom-color: var(--secondary); }
        .nav-right { display: flex; align-items: center; gap: 15px; }

        /* --- Main Layout --- */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; width: 100%; flex: 1; }

        /* --- Section Visibility --- */
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Inventory Toolbar --- */
        .inventory-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .inventory-title { font-size: 24px; font-weight: 700; color: var(--text-dark); }
        
        .filters-bar {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .search-group { display: flex; flex: 1; max-width: 400px; }
        .search-input { width: 100%; padding: 8px 10px; border: 1px solid #888; border-radius: 3px 0 0 3px; border-right: none; outline: none; }
        .search-btn { background: #febd69; border: 1px solid #a88734; border-radius: 0 3px 3px 0; padding: 0 15px; cursor: pointer; }
        
        .filter-group label { margin-right: 5px; font-weight: 700; color: var(--text-light); }
        .filter-select { padding: 6px; border-radius: 3px; border: 1px solid #888; background: #f0f2f2; }

        /* --- Data Table (Amazon Style) --- */
        .data-table-wrapper {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        thead { background: #fafafa; border-bottom: 1px solid var(--border); }
        th { text-align: left; padding: 10px 15px; color: var(--text-light); font-size: 11px; text-transform: uppercase; font-weight: 700; }
        td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
        tr:hover td { background-color: #fafffe; }

        /* Product Cell */
        .product-cell { display: flex; gap: 15px; }
        .product-img { width: 60px; height: 60px; object-fit: contain; border: 1px solid var(--border); background: white; }
        .product-info { display: flex; flex-direction: column; gap: 2px; }
        .product-name { font-weight: 700; color: var(--primary); font-size: 14px; text-decoration: none; display: block; margin-bottom: 2px; }
        .product-meta { color: var(--text-light); font-size: 11px; }

        /* Status Badge */
        .status-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; }
        .status-active { color: var(--success); }
        .status-inactive { color: var(--danger); }

        /* Input Fields in Table */
        .editable-input { width: 80px; padding: 5px; border: 1px solid #888; border-radius: 3px; text-align: right; }
        
        /* Action Buttons */
        .btn { cursor: pointer; padding: 6px 12px; border-radius: 3px; font-size: 11px; font-weight: 500; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: #f0c14b; border: 1px solid #a88734; color: #111; box-shadow: 0 1px 0 rgba(255,255,255,0.4) inset; }
        .btn-primary:hover { background: #f4d078; }
        .btn-secondary { background: #e7e9ec; border: 1px solid #adb1b8; color: #111; }
        .btn-secondary:hover { background: #dfe1e5; }
        .btn-danger { background: #fff; border: 1px solid #d00; color: #d00; }
        .btn-danger:hover { background: #fff0f0; }

        /* --- Add/Edit Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-container { background: white; width: 800px; max-height: 90vh; display: flex; flex-direction: column; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border); background: white; padding: 0 20px; }
        .tab-btn { padding: 12px 15px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; color: var(--text-light); font-weight: 500; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--secondary); }

        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .form-section { display: none; }
        .form-section.active { display: block; }

        .form-row { margin-bottom: 15px; display: grid; grid-template-columns: 150px 1fr; gap: 20px; align-items: start; }
        .form-label { font-weight: 700; color: var(--text-dark); font-size: 12px; padding-top: 8px; text-align: right; }
        .form-control { width: 100%; padding: 8px; border: 1px solid #888; border-radius: 3px; }
        .form-helper { font-size: 11px; color: var(--text-light); margin-top: 4px; }

        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); background: #f8f9fa; display: flex; justify-content: flex-end; gap: 10px; }

        /* --- Dashboard Widgets --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .widget-card { background: white; border: 1px solid var(--border); border-radius: 4px; padding: 20px; }
        .widget-title { font-size: 13px; font-weight: 700; color: var(--text-light); margin-bottom: 10px; text-transform: uppercase; }
        .widget-value { font-size: 28px; font-weight: 300; color: var(--text-dark); }
        .widget-sub { font-size: 12px; color: var(--success); display: flex; align-items: center; gap: 5px; margin-top: 5px; }

        /* Alerts */
        .alert-float { position: fixed; top: 70px; right: 20px; padding: 15px 25px; border-radius: 4px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 3000; display: none; }
        .alert-success { background: var(--success); }
        .alert-error { background: var(--danger); }
        .loader { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; align-items:center; justify-content:center; flex-direction:column; }
    </style>
</head>
<body>

    <div id="loader" class="loader" style="display: flex;">
        <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--secondary); margin-bottom: 15px;"></i>
        <h3>Loading Seller Central...</h3>
    </div>

    <div id="toast" class="alert-float"></div>

    <nav class="top-nav">
        <div class="brand">
            <i class="fas fa-box-open" style="color: var(--secondary);"></i> QuickLocal <span style="font-weight: 300; opacity: 0.8;">Seller Central</span>
        </div>
        <div class="nav-links">
            <a onclick="switchTab('dashboard')" class="nav-link active" id="nav-dashboard">Dashboard</a>
            <a onclick="switchTab('inventory')" class="nav-link" id="nav-inventory">Inventory</a>
            <a onclick="switchTab('orders')" class="nav-link" id="nav-orders">Orders</a>
            <a onclick="switchTab('reports')" class="nav-link" id="nav-reports">Reports</a>
        </div>
        <div class="nav-right">
            <div style="text-align: right; line-height: 1.2;">
                <div style="font-weight: 700;" id="sellerName">Seller</div>
                <div style="font-size: 10px; opacity: 0.8;">India</div>
            </div>
            <button onclick="handleLogout()" class="btn btn-secondary" style="padding: 5px 10px;">Logout</button>
        </div>
    </nav>

    <div class="container">
        
        <div id="dashboard" class="section active">
            <h1 class="inventory-title" style="margin-bottom: 20px;">Performance Overview</h1>
            
            <div class="dashboard-grid">
                <div class="widget-card">
                    <div class="widget-title">Today's Sales</div>
                    <div class="widget-value" id="todaySales">‚Çπ0.00</div>
                    <div class="widget-sub"><i class="fas fa-arrow-up"></i> 0% vs yesterday</div>
                </div>
                <div class="widget-card">
                    <div class="widget-title">Total Orders</div>
                    <div class="widget-value" id="totalOrders">0</div>
                    <div class="widget-sub" style="color: var(--text-light);">Last 30 days</div>
                </div>
                <div class="widget-card">
                    <div class="widget-title">Active Listings</div>
                    <div class="widget-value" id="activeListings">0</div>
                    <div class="widget-sub" style="color: var(--primary);">View Inventory</div>
                </div>
            </div>

            <div class="widget-card" style="height: 400px;">
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <div id="inventory" class="section">
            <div class="inventory-header">
                <div class="inventory-title">Manage Inventory</div>
                <button class="btn btn-primary" onclick="openProductModal()">
                    <i class="fas fa-plus"></i> Add a Product
                </button>
            </div>

            <div class="filters-bar">
                <div class="filter-group">
                    <label>Status:</label>
                    <select class="filter-select" id="statusFilter" onchange="filterProducts()">
                        <option value="all">All</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="search-group">
                    <input type="text" id="inventorySearch" class="search-input" placeholder="Search by SKU, Title, ASIN..." onkeyup="filterProducts()">
                    <button class="search-btn"><i class="fas fa-search"></i></button>
                </div>
            </div>

            <div class="data-table-wrapper">
                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Image</th>
                            <th style="width: 30%;">Product Name</th>
                            <th>Date Created</th>
                            <th>Available</th>
                            <th>Fee Preview</th>
                            <th>Your Price</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryBody">
                        </tbody>
                </table>
            </div>
            <div id="noProductsMsg" style="text-align: center; padding: 40px; display: none;">
                <i class="fas fa-box-open" style="font-size: 40px; color: #ccc; margin-bottom: 10px;"></i>
                <p>No inventory found matching your criteria.</p>
            </div>
        </div>
        
        <div id="orders" class="section">
             <h1 class="inventory-title">Manage Orders</h1>
             <div class="widget-card">
                 <p>Order management module loaded.</p>
                 <button class="btn btn-primary" onclick="loadSellerOrders()">Refresh Orders</button>
                 <div class="data-table-wrapper" style="margin-top: 20px;">
                     <table id="ordersTable">
                         <thead>
                             <tr>
                                 <th>Order ID</th>
                                 <th>Product</th>
                                 <th>Customer</th>
                                 <th>Status</th>
                                 <th>Total</th>
                             </tr>
                         </thead>
                         <tbody id="ordersBody">
                             <tr><td colspan="5" style="text-align: center; padding: 20px;">Loading...</td></tr>
                         </tbody>
                     </table>
                 </div>
             </div>
        </div>

    </div>

    <div id="productModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitle">Add Product</h3>
                <button onclick="closeProductModal()" style="border:none; background:none; cursor:pointer; font-size: 18px;">&times;</button>
            </div>
            
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchFormTab('vital')">Vital Info</button>
                <button class="tab-btn" onclick="switchFormTab('offer')">Offer</button>
                <button class="tab-btn" onclick="switchFormTab('images')">Images</button>
                <button class="tab-btn" onclick="switchFormTab('description')">Description</button>
            </div>

            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="editProductId">

                    <div id="tab-vital" class="form-section active">
                        <div class="form-row">
                            <label class="form-label">Product Name <span style="color:red">*</span></label>
                            <div>
                                <input type="text" name="name" id="pName" class="form-control" required>
                                <div class="form-helper">Title should be concise and descriptive.</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Brand Name</label>
                            <div>
                                <input type="text" name="brand" id="pBrand" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Category <span style="color:red">*</span></label>
                            <div>
                                <select name="category" id="pCategory" class="form-control" required>
                                    <option value="">Select...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="tab-offer" class="form-section">
                        <div class="form-row">
                            <label class="form-label">Your Price (‚Çπ) <span style="color:red">*</span></label>
                            <div>
                                <input type="number" name="price" id="pPrice" class="form-control" required step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">MRP (‚Çπ)</label>
                            <div>
                                <input type="number" name="originalPrice" id="pOriginalPrice" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">Quantity <span style="color:red">*</span></label>
                            <div>
                                <input type="number" name="stock" id="pStock" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div id="tab-images" class="form-section">
                        <div class="form-row">
                            <label class="form-label">Main Image</label>
                            <div>
                                <input type="file" id="pImageInput" accept="image/*" class="form-control" multiple>
                                <div class="form-helper">High quality images on white background recommended.</div>
                                <div id="imagePreview" style="display:flex; gap:10px; margin-top:10px;"></div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-description" class="form-section">
                        <div class="form-row">
                            <label class="form-label">Product Description <span style="color:red">*</span></label>
                            <div>
                                <textarea name="description" id="pDescription" class="form-control" rows="8" required></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitProductForm()">Save and Finish</button>
            </div>
        </div>
    </div>

    <script src="https://ecommerce-backend-mlik.onrender.com/hybrid-auth-client.js"></script>
    <script>
        const API_URL = 'https://ecommerce-backend-mlik.onrender.com/api/v1';
        let currentUser = null;
        let globalProducts = [];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initAuth();
                await Promise.all([
                    loadDashboard(),
                    loadInventory(),
                    loadCategories()
                ]);
                document.getElementById('loader').style.display = 'none';
            } catch (err) {
                console.error(err);
                showToast("Failed to load seller data: " + err.message, 'error');
                document.getElementById('loader').style.display = 'none';
            }
        });

        // --- AUTH ---
        async function initAuth() {
            if (!window.HybridAuthClient) throw new Error("Auth client missing");
            
            // Wait for client init
            let tries = 0;
            while(!window.HybridAuthClient.getAuthMethod() && tries < 20) {
                await new Promise(r => setTimeout(r, 100));
                tries++;
            }

            const isAuth = await window.HybridAuthClient.isAuthenticated();
            if (!isAuth) {
                window.location.href = 'seller-login.html';
                return;
            }

            currentUser = window.HybridAuthClient.getCurrentUser();
            document.getElementById('sellerName').textContent = currentUser.name || currentUser.businessName || 'Seller';
            
            if (currentUser.role !== 'seller' && currentUser.role !== 'admin') {
                alert("Unauthorized access");
                window.location.href = 'index.html';
            }
        }

        async function handleLogout() {
            await window.HybridAuthClient.logout();
            window.location.href = 'seller-login.html';
        }

        // --- TABS & NAVIGATION ---
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');

            if(tabId === 'inventory') loadInventory();
            if(tabId === 'orders') loadSellerOrders();
            if(tabId === 'dashboard') loadDashboard();
        }

        function switchFormTab(tabName) {
            document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        // --- DASHBOARD ---
        async function loadDashboard() {
            try {
                let res = await window.HybridAuthClient.apiCall('/seller/enterprise/dashboard');
                if(!res.ok) res = await window.HybridAuthClient.apiCall('/seller/dashboard');
                
                if(res.ok) {
                    const data = await res.json();
                    const ov = data.data.overview;
                    document.getElementById('totalOrders').innerText = ov.orders?.total || ov.totalOrders || 0;
                    document.getElementById('activeListings').innerText = ov.products?.active || ov.activeProducts || 0;
                    document.getElementById('todaySales').innerText = "‚Çπ" + (ov.revenue?.total || ov.totalRevenue || 0).toLocaleString();
                    
                    initChart([1200, 1500, 800, 2300, 1800, 3200, 2500]); // Mock data for demo
                }
            } catch(e) { console.warn("Dashboard load error", e); }
        }

        function initChart(dataPoints) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Sales (‚Çπ)',
                        data: dataPoints,
                        borderColor: '#e77600',
                        backgroundColor: 'rgba(231, 118, 0, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { maintainAspectRatio: false, responsive: true }
            });
        }

        // --- INVENTORY MANAGEMENT (FIXED) ---
        async function loadInventory() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">Loading inventory...</td></tr>';

            try {
                console.log('üîÑ Loading inventory...');
                
                // CRITICAL FIX 1: Clear service worker cache before loading
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        type: 'CLEAR_API_CACHE'
                    });
                    await new Promise(resolve => setTimeout(resolve, 150));
                }

                // CRITICAL FIX 2: Add cache-busting parameter
                const cacheBuster = `_t=${Date.now()}&_r=${Math.random()}`;
                
                // CRITICAL FIX 3: Try multiple endpoint formats
                let res;
                let products = [];
                let errorMsg = '';
                
                // Try primary endpoint: /seller/products
                try {
                    console.log('üì° Attempting: /seller/products');
                    res = await window.HybridAuthClient.apiCall(`/seller/products?${cacheBuster}`, {
                        method: 'GET'
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        console.log('‚úÖ Response from /seller/products:', data);
                        
                        // CRITICAL FIX 4: Robust data extraction with multiple fallbacks
                        if (data.success && data.data) {
                            if (Array.isArray(data.data.products)) {
                                products = data.data.products;
                            } else if (Array.isArray(data.data)) {
                                products = data.data;
                            } else if (data.data.products && typeof data.data.products === 'object') {
                                products = Object.values(data.data.products);
                            }
                        } else if (Array.isArray(data.products)) {
                            products = data.products;
                        } else if (Array.isArray(data)) {
                            products = data;
                        }
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è /seller/products failed:', err.message);
                    errorMsg = err.message;
                }

                // Fallback: Try /products endpoint with seller filter
                if (products.length === 0 && currentUser) {
                    try {
                        console.log('üì° Attempting fallback: /products');
                        res = await window.HybridAuthClient.apiCall(`/products?seller=${currentUser._id || currentUser.id}&${cacheBuster}`, {
                            method: 'GET'
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            console.log('‚úÖ Response from /products:', data);
                            
                            if (data.success && data.data) {
                                if (Array.isArray(data.data)) {
                                    products = data.data;
                                } else if (Array.isArray(data.data.products)) {
                                    products = data.data.products;
                                }
                            } else if (Array.isArray(data)) {
                                products = data;
                            }
                        }
                    } catch (err) {
                        console.warn('‚ö†Ô∏è /products fallback failed:', err.message);
                    }
                }

                // CRITICAL FIX 5: Validate and filter products
                products = products.filter(p => {
                    // Ensure product belongs to current seller
                    const productSellerId = p.seller?._id || p.seller?.id || p.seller;
                    const currentSellerId = currentUser._id || currentUser.id;
                    return productSellerId === currentSellerId;
                });

                console.log(`‚úÖ Loaded ${products.length} products`);
                
                // Store and render
                globalProducts = products;
                renderInventoryTable(products);

            } catch(err) {
                console.error('‚ùå Critical inventory load error:', err);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="color:red; text-align:center; padding:20px;">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Error loading inventory: ${err.message}<br>
                            <button class="btn btn-primary" onclick="loadInventory()" style="margin-top:10px;">
                                <i class="fas fa-sync"></i> Retry
                            </button>
                        </td>
                    </tr>
                `;
            }
        }

        function renderInventoryTable(products) {
            const tbody = document.getElementById('inventoryBody');
            const noProductsMsg = document.getElementById('noProductsMsg');
            
            console.log('üé® Rendering', products.length, 'products');
            
            if(!products || products.length === 0) {
                tbody.innerHTML = '';
                noProductsMsg.style.display = 'block';
                noProductsMsg.innerHTML = `
                    <i class="fas fa-box-open" style="font-size: 40px; color: #ccc; margin-bottom: 10px;"></i>
                    <p>No inventory found.</p>
                    <button class="btn btn-primary" onclick="openProductModal()" style="margin-top: 10px;">
                        <i class="fas fa-plus"></i> Add Your First Product
                    </button>
                `;
                return;
            }
            
            noProductsMsg.style.display = 'none';
            
            tbody.innerHTML = products.map(p => {
                // CRITICAL FIX 6: Safe property access with fallbacks
                const img = p.images?.[0]?.url || 'https://placehold.co/60x60?text=No+Img';
                const status = (p.stock > 0 && p.status === 'active') ? 'Active' : 'Inactive';
                const statusClass = status === 'Active' ? 'status-active' : 'status-inactive';
                const date = new Date(p.createdAt || Date.now()).toLocaleDateString();
                const fee = (p.price * 0.15).toFixed(2);
                const id = p._id || p.id;
                
                // Safe name extraction
                const name = p.name || 'Unnamed Product';
                const sku = id ? id.slice(-6).toUpperCase() : 'N/A';
                const asin = id ? `B0${id.slice(-8).toUpperCase()}` : 'N/A';
                
                return `
                <tr data-product-id="${id}">
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td><img src="${img}" class="product-img" alt="${name}"></td>
                    <td>
                        <div class="product-info">
                            <a href="#" class="product-name" onclick="event.preventDefault(); openEdit('${id}')">${name}</a>
                            <div class="product-meta">SKU: ${sku}</div>
                            <div class="product-meta">ASIN: ${asin}</div>
                        </div>
                    </td>
                    <td style="color:#555;">${date}</td>
                    <td>
                        <input type="number" class="editable-input" value="${p.stock || 0}" 
                               onchange="quickUpdate('${id}', 'stock', this.value)"
                               min="0">
                    </td>
                    <td style="color:#555;">Est. Fee: ‚Çπ${fee}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span>‚Çπ</span>
                            <input type="number" class="editable-input" value="${p.price || 0}" 
                                   onchange="quickUpdate('${id}', 'price', this.value)"
                                   min="0" step="0.01">
                        </div>
                    </td>
                    <td style="text-align: right;">
                        <button class="btn btn-secondary" onclick="openEdit('${id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteProduct('${id}')" style="margin-left: 5px;">Delete</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // --- FILTERING ---
        function filterProducts() {
            const term = document.getElementById('inventorySearch').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;

            const filtered = globalProducts.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(term) || ((p._id || p.id).includes(term));
                const isActive = p.stock > 0;
                
                let matchesStatus = true;
                if(status === 'active') matchesStatus = isActive;
                if(status === 'inactive') matchesStatus = !isActive;

                return matchesSearch && matchesStatus;
            });

            renderInventoryTable(filtered);
        }

        // --- ADD / EDIT LOGIC ---
        function openProductModal() {
            document.getElementById('modalTitle').innerText = 'Add Product';
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('productModal').classList.add('active');
            switchFormTab('vital'); // Reset to first tab
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        function openEdit(id) {
            const p = globalProducts.find(x => (x._id || x.id) === id);
            if(!p) return;

            document.getElementById('modalTitle').innerText = 'Edit Product';
            document.getElementById('editProductId').value = id;
            
            // Populate Fields
            document.getElementById('pName').value = p.name;
            document.getElementById('pBrand').value = p.brand || '';
            document.getElementById('pPrice').value = p.price;
            document.getElementById('pOriginalPrice').value = p.originalPrice || '';
            document.getElementById('pStock').value = p.stock;
            document.getElementById('pDescription').value = p.description;
            
            // Select Category
            const catSelect = document.getElementById('pCategory');
            // Try to match value or text
            if(p.category) catSelect.value = (typeof p.category === 'object') ? p.category._id : p.category;

            // Show current images (Mock preview)
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            if(p.images && p.images.length) {
                p.images.forEach(img => {
                    const i = document.createElement('img');
                    i.src = img.url;
                    i.style.width = '50px';
                    i.style.height = '50px';
                    i.style.border = '1px solid #ccc';
                    preview.appendChild(i);
                });
            }

            document.getElementById('productModal').classList.add('active');
            switchFormTab('vital');
        }

        async function submitProductForm() {
            const form = document.getElementById('productForm');
            if(!form.checkValidity()) {
                alert("Please fill all required fields marked with *");
                return;
            }

            const id = document.getElementById('editProductId').value;
            const isEdit = !!id;
            
            const btn = document.querySelector('.modal-footer .btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";
            btn.disabled = true;

            try {
                const formData = new FormData();
                
                // Core fields
                formData.append('name', document.getElementById('pName').value);
                formData.append('brand', document.getElementById('pBrand').value);
                formData.append('price', document.getElementById('pPrice').value);
                formData.append('stock', document.getElementById('pStock').value);
                formData.append('description', document.getElementById('pDescription').value);
                formData.append('category', document.getElementById('pCategory').value);
                
                const ogPrice = document.getElementById('pOriginalPrice').value;
                if(ogPrice) formData.append('originalPrice', ogPrice);

                if(currentUser) {
                    formData.append('seller', currentUser._id || currentUser.id);
                    formData.append('storeName', currentUser.storeName || currentUser.name);
                }

                // Images
                const files = document.getElementById('pImageInput').files;
                for(let i=0; i<files.length; i++) {
                    formData.append('images', files[i]);
                }

                let url = '/products';
                let method = 'POST';
                if(isEdit) {
                    url = `/products/${id}`;
                    method = 'PUT';
                }

                const res = await window.HybridAuthClient.apiCall(url, { method, body: formData });
                const result = await res.json();

                if(res.ok) {
                    showToast(isEdit ? 'Product updated!' : 'Product created!', 'success');
                    closeProductModal();
                    loadInventory();
                } else {
                    throw new Error(result.message || 'Operation failed');
                }

            } catch(err) {
                showToast(err.message, 'error');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function deleteProduct(id) {
            if(!confirm("Are you sure you want to delete this listing? This cannot be undone.")) return;
            
            const row = document.querySelector(`tr[data-product-id="${id}"]`);
            if (row) {
                row.style.opacity = '0.5';
                row.style.pointerEvents = 'none';
            }
            
            try {
                console.log('üóëÔ∏è Deleting product:', id);
                
                const res = await window.HybridAuthClient.apiCall(`/products/${id}`, { 
                    method: 'DELETE' 
                });
                
                if(res.ok || res.status === 204) {
                    showToast("Listing deleted successfully", 'success');
                    
                    // Clear cache
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'CLEAR_API_CACHE'
                        });
                    }
                    
                    // Remove from global array
                    globalProducts = globalProducts.filter(p => (p._id || p.id) !== id);
                    
                    // Re-render
                    renderInventoryTable(globalProducts);
                } else {
                    throw new Error(`Delete failed with status ${res.status}`);
                }
            } catch(e) {
                console.error('‚ùå Delete error:', e);
                showToast(`Failed to delete: ${e.message}`, 'error');
                
                // Restore row
                if (row) {
                    row.style.opacity = '1';
                    row.style.pointerEvents = 'auto';
                }
            }
        }

        // --- QUICK UPDATE (Inline Editing) ---
        async function quickUpdate(id, field, value) {
            const input = event?.target;
            const originalValue = input?.dataset.originalValue || input?.defaultValue;
            
            if (input) {
                input.disabled = true;
                input.dataset.originalValue = originalValue;
            }
            
            try {
                console.log(`‚ö° Quick update: ${field} = ${value} for product ${id}`);
                
                const formData = new FormData();
                formData.append(field, value);
                
                const res = await window.HybridAuthClient.apiCall(`/products/${id}`, { 
                    method: 'PUT', 
                    body: formData 
                });
                
                if(res.ok) {
                    showToast(`${field} updated successfully`, 'success');
                    
                    // Update in global array
                    const product = globalProducts.find(p => (p._id || p.id) === id);
                    if (product) {
                        product[field] = field === 'stock' || field === 'price' ? Number(value) : value;
                    }
                } else {
                    throw new Error(`Update failed`);
                }
            } catch(e) {
                console.error('‚ùå Quick update error:', e);
                showToast(`Failed to update ${field}`, 'error');
                
                // Restore original value
                if (input && originalValue) {
                    input.value = originalValue;
                }
            } finally {
                if (input) {
                    input.disabled = false;
                }
            }
        }

        // --- CATEGORIES ---
        async function loadCategories() {
            try {
                let res = await window.HybridAuthClient.apiCall('/seller/categories');
                if(!res.ok) res = await fetch(`${API_URL}/categories`);
                const data = await res.json();
                
                const cats = data.data?.categories || data.categories || [];
                const select = document.getElementById('pCategory');
                select.innerHTML = '<option value="">Select Category...</option>';
                cats.forEach(c => {
                    select.innerHTML += `<option value="${c._id}">${c.name}</option>`;
                });
            } catch(e) { console.error("Cat load error", e); }
        }

        // --- ORDERS (Placeholder Logic) ---
        async function loadSellerOrders() {
            const tbody = document.getElementById('ordersBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading orders...</td></tr>';
            try {
                const res = await window.HybridAuthClient.apiCall('/seller/orders');
                const data = await res.json();
                const orders = data.data || [];

                if(!orders.length) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No orders found.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = orders.map(o => `
                    <tr>
                        <td style="color:var(--primary); font-weight:bold;">#${(o.orderNumber || o._id).slice(-8).toUpperCase()}</td>
                        <td>${o.items?.length || 0} items</td>
                        <td>${o.shippingAddress?.fullName || 'Guest'}</td>
                        <td><span class="status-badge status-${o.items?.[0]?.status === 'delivered' ? 'active' : 'inactive'}">${o.items?.[0]?.status}</span></td>
                        <td style="font-weight:700;">‚Çπ${(o.total || 0).toFixed(2)}</td>
                    </tr>
                `).join('');
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Failed to load orders.</td></tr>';
            }
        }

        // --- UTILS ---
        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `alert-float alert-${type}`;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // Image Preview Handler
        document.getElementById('pImageInput').addEventListener('change', function(e) {
            const div = document.getElementById('imagePreview');
            div.innerHTML = '';
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.style.width = '50px';
                    img.style.height = '50px';
                    img.style.objectFit = 'cover';
                    img.style.border = '1px solid #ccc';
                    div.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        });

    </script>
</body>
</html>