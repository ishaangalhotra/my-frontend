<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuickLocal — Seller Dashboard</title>
  <meta name="color-scheme" content="light dark">

  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* =====================
       Clean, Minimal UI with Dark Mode
       ===================== */
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --ink-900: #0f172a;
      --ink-700: #334155;
      --ink-500: #64748b;
      --line: #e5e7eb;
      --brand: #6d5ef9;
      --brand-600: #5b4df4;
      --ok: #16a34a; --warn: #f59e0b; --err: #ef4444;
      --shadow: 0 6px 18px rgba(15,23,42,.06);
      --radius: 14px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #111827;
        --panel: #1f2937;
        --ink-900: #f3f4f6;
        --ink-700: #9ca3af;
        --ink-500: #6b7280;
        --line: #374151;
        --shadow: 0 6px 18px rgba(0,0,0,.15);
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--ink-900); background: var(--bg);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background-color .2s ease, color .2s ease;
    }
    .hidden { display: none !important; }

    /* Layout */
    .app { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
    header.appbar { position: sticky; top: 0; z-index: 20; background: rgba(255,255,255,.8); backdrop-filter: saturate(150%) blur(8px); border-bottom: 1px solid var(--line); }
    @media (prefers-color-scheme: dark) { header.appbar { background: rgba(31,41,55,.8); } }
    header .wrap { max-width: 1200px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
    main { max-width: 1200px; margin: 0 auto; padding: 24px; }

    /* Sidebar */
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: #101827; color: #fff; border-right: 1px solid rgba(255,255,255,.06); padding: 14px; z-index: 30; transition: transform .25s ease; display:flex; flex-direction:column; }
    .sb-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .sb-title { font-weight: 800; font-size: 1.2rem; }
    nav { display: grid; gap: 4px; }
    nav a { display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,.85); text-decoration: none; padding: 10px 12px; border-radius: 10px; }
    nav a:hover { background: rgba(255,255,255,.08); }
    nav a.active { background: var(--brand); color: #fff; }
    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; z-index: 25; }
    .backdrop.show { display: block; }
    @media (max-width: 1024px) { .app { grid-template-columns: 1fr; } .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } }

    /* Containers & Grids */
    .grid-stats { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 1rem; }
    .grid-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-top: 1rem; }
    .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem; }
    @media (max-width: 900px) { .grid-stats { grid-template-columns: repeat(2, minmax(0,1fr)); } .grid-layout { grid-template-columns: 1fr; } }
    @media (max-width: 560px) { .grid-stats { grid-template-columns: 1fr; } }

    .card { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1rem; }
    .section { display: none; }
    .section.show { display: block; }

    /* Controls & Elements */
    .btn { display: inline-flex; align-items: center; justify-content:center; gap: 8px; padding: 10px 16px; border-radius: 12px; border: 1.5px solid var(--brand); background: var(--brand); color: #fff; font-weight: 600; cursor: pointer; transition: background-color .2s ease; }
    .btn:hover { background: var(--brand-600); border-color: var(--brand-600); }
    .btn.ghost { background: transparent; color: var(--brand); }
    .btn.ghost:hover { background: rgba(109,94,249,.1); }
    .btn.danger { border-color: var(--err); background: var(--err); }
    .btn:disabled { background: var(--ink-500); border-color: var(--ink-500); cursor: not-allowed; }

    .input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid var(--line); border-radius: 12px; outline: none; background: var(--panel); color: var(--ink-900); font-size: 1rem; }
    .input:focus, select:focus, textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 4px rgba(109,94,249,.1); }

    .form-grid { display: grid; gap: 1rem; grid-template-columns: repeat(2,minmax(0,1fr)); }
    @media(max-width: 720px){ .form-grid { grid-template-columns: 1fr; } }
    .form-grid .full-span { grid-column: 1 / -1; }

    .badge { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: .75rem; font-weight:600; background: #eef2ff; color: #3730a3; }
    .product-img { width: 100%; height: 160px; border-radius: 12px; object-fit: cover; background: #e5e7eb; }

    /* Toast */
    #toast { position: fixed; right: 1rem; top: 1rem; z-index: 60; display: none; align-items: center; gap: .5rem; padding: .9rem 1rem; border-radius: 12px; color: #fff; }
    #toast.show { display: flex; }
    .toast-success { background: linear-gradient(135deg, #16a34a, #22c55e); }
    .toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* Modal */
    #modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 70; }
    #modal.show { display: flex; }
    .modal-card { width: min(560px, 92vw); }

    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, rgba(0,0,0,.06) 25%, rgba(255,255,255,.35) 50%, rgba(0,0,0,.06) 75%); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
    @media (prefers-color-scheme: dark) { .skeleton { background: linear-gradient(90deg, rgba(255,255,255,.06) 25%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.06) 75%); background-size: 200% 100%; animation: shimmer 1.2s infinite; } }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    
    .status-badge { 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 12px; 
      font-weight: 500; 
    }
    .status-active { 
      background: #dcfce7; 
      color: #166534; 
    }
    .status-draft { 
      background: #fef3c7; 
      color: #92400e; 
    }
  </style>
</head>
<body>
  <section id="auth" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem">
    <div class="card" style="width:min(440px, 92vw)">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:.5rem"><i data-lucide="store"></i><h1 style="font-size:1.2rem; margin:0;">QuickLocal Seller</h1></div>
      <p style="color:var(--ink-500);margin-top:0;margin-bottom:1rem">Sign in or create your seller account.</p>
      <div style="display:flex;gap:.5rem;margin-bottom:1rem">
        <button id="tab-login" class="btn" style="flex:1"><i data-lucide="log-in"></i>Login</button>
        <button id="tab-register" class="btn ghost" style="flex:1"><i data-lucide="user-plus"></i>Register</button>
      </div>
      <form id="form-login" style="display:grid;gap:.75rem">
        <input id="login-email" type="email" class="input" placeholder="Email" required>
        <input id="login-pass" type="password" class="input" placeholder="Password" required>
        <label style="display:flex;align-items:center;gap:8px;font-size:.9rem;color:var(--ink-700)">
          <input id="remember-me" type="checkbox">
          Remember me for 30 days
        </label>
        <button class="btn" type="submit"><i data-lucide="arrow-right"></i> Sign in</button>
      </form>
      <form id="form-register" class="hidden" style="display:grid;gap:.75rem">
        <input id="reg-name" type="text" class="input" placeholder="Full name" required>
        <input id="reg-email" type="email" class="input" placeholder="Email" required>
        <input id="reg-pass" type="password" class="input" placeholder="Password (min 6 chars)" minlength="6" required>
        <input id="reg-phone" type="tel" class="input" placeholder="Phone number (optional)">
        <button class="btn" type="submit"><i data-lucide="sparkles"></i> Create Seller Account</button>
      </form>
    </div>
  </section>

  <section id="app" class="hidden">
    <div class="app">
      <aside class="sidebar" id="sidebar">
        <div class="sb-head">
          <div class="sb-title">QuickLocal</div>
          <button id="close-sidebar" class="btn ghost" style="padding:6px 8px; color:white;" aria-label="Close sidebar"><i data-lucide="x"></i></button>
        </div>
        <nav>
          <a href="#" class="active" data-page="dashboard"><i data-lucide="layout-dashboard"></i>Dashboard</a>
          <a href="#" data-page="products"><i data-lucide="package"></i>Products <span class="badge" id="badge-products">0</span></a>
          <a href="#" data-page="orders"><i data-lucide="shopping-cart"></i>Orders <span class="badge" id="badge-orders">0</span></a>
          <a href="#" data-page="customers"><i data-lucide="users"></i>Customers</a>
          <a href="#" data-page="analytics"><i data-lucide="bar-chart-3"></i>Analytics</a>
          <a href="#" data-page="settings"><i data-lucide="settings"></i>Settings</a>
        </nav>
        <div style="margin-top:auto">
          <button id="btn-logout" class="btn danger" style="width:100%"><i data-lucide="log-out"></i>Logout</button>
        </div>
      </aside>
      <div class="backdrop" id="backdrop"></div>

      <div>
        <header class="appbar">
          <div class="wrap">
            <div style="display:flex;align-items:center;gap:10px">
              <button id="open-sidebar" class="btn ghost" style="padding:6px 8px" aria-label="Open sidebar"><i data-lucide="menu"></i></button>
              <div style="font-weight:700; font-size:1.1rem">Seller Dashboard</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <span class="badge" style="background:#ecfdf5;color:#065f46">Online</span>
              <span id="whoami" style="font-weight:600">Seller</span>
            </div>
          </div>
        </header>

        <main>
          <section id="page-dashboard" class="section show">
            <div class="grid-stats">
              <div class="card"><div style="color:var(--ink-500)">Total Sales</div><div style="font-size:1.5rem;font-weight:800" id="stat-sales">₹0</div></div>
              <div class="card"><div style="color:var(--ink-500)">Orders</div><div style="font-size:1.5rem;font-weight:800" id="stat-orders">0</div></div>
              <div class="card"><div style="color:var(--ink-500)">Products</div><div style="font-size:1.5rem;font-weight:800" id="stat-products">0</div></div>
              <div class="card"><div style="color:var(--ink-500)">Customers</div><div style="font-size:1.5rem;font-weight:800" id="stat-customers">0</div></div>
            </div>
            <div class="grid-layout">
              <div class="card">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><h2>Sales Overview</h2><span style="color:var(--ink-500)">Last 7 days</span></div>
                <canvas id="salesChart" height="120"></canvas>
              </div>
              <div class="card">
                <h2>Recent Activity</h2>
                <div id="recent-activity" style="margin-top:.75rem;"></div>
              </div>
            </div>
          </section>

          <section id="page-products" class="section">
            <div class="card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
                <h2>Product Management</h2>
                <div style="display:flex;gap:10px;">
                  <button id="btn-reset" class="btn ghost"><i data-lucide="rotate-ccw"></i>Reset Form</button>
                </div>
              </div>
              <form id="form-product" class="form-grid">
                <div><label for="p-name">Product Name *</label><input id="p-name" class="input" required placeholder="e.g., Premium Running Shoes" maxlength="100"/></div>
                <div><label for="p-category">Category *</label><select id="p-category" class="input" required><option value="">Select category</option></select></div>
                <div><label for="p-price">Selling Price (₹) *</label><input id="p-price" class="input" type="number" min="0" step="0.01" required /></div>
                <div><label for="p-original-price">Original Price (₹)</label><input id="p-original-price" class="input" type="number" min="0" step="0.01" placeholder="For discount display" /></div>
                <div><label for="p-stock">Stock Quantity *</label><input id="p-stock" class="input" type="number" min="0" required /></div>
                <div><label for="p-cost">Cost per Item (₹)</label><input id="p-cost" class="input" type="number" min="0" step="0.01" placeholder="For profit tracking" /></div>
                <div class="full-span"><label for="p-desc">Description</label><textarea id="p-desc" class="input" rows="3" placeholder="Describe your product..." maxlength="1000"></textarea></div>
                <div class="full-span"><label for="p-tags">Tags</label><input id="p-tags" class="input" placeholder="e.g., shoes, running, sports (comma separated)"/></div>
                <div class="full-span">
                  <label>Product Images (Max 8)</label>
                  <div id="drop" class="card" style="text-align:center;border-style:dashed;cursor:pointer;padding:1.5rem;">
                    <div style="color:var(--ink-500);display:flex;align-items:center;justify-content:center;gap:.5rem;"><i data-lucide="upload-cloud"></i> Drag & drop images, or click to browse</div>
                    <input id="p-images" type="file" accept="image/*" multiple class="hidden" />
                  </div>
                  <div id="previews" class="grid-cards" style="margin-top:1rem"></div>
                </div>
                <div class="full-span" style="display:flex;gap:10px;align-items:center;">
                  <label style="display:flex;align-items:center;gap:8px;">
                    <input id="p-published" type="checkbox" checked>
                    Publish immediately
                  </label>
                </div>
                <div class="full-span" style="display:flex;gap:10px">
                  <button class="btn" type="submit" id="btn-save"><i data-lucide="save"></i><span id="save-text">Save Product</span></button>
                  <button class="btn danger" type="button" id="btn-delete" disabled><i data-lucide="trash-2"></i>Delete Product</button>
                </div>
              </form>
            </div>

            <div class="card" style="margin-top:1rem">
              <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1rem">
                <h2>Your Products</h2>
                <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
                  <select id="filter-status" class="input" style="width:120px;">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="draft">Draft</option>
                  </select>
                  <input id="q" class="input" placeholder="Search products..." style="width:220px" />
                  <button id="btn-search" class="btn ghost" aria-label="Search"><i data-lucide="search"></i></button>
                </div>
              </div>
              <div id="grid" class="grid-cards"></div>
              <div id="pagination" style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:1rem;"></div>
            </div>
          </section>

          <section id="page-orders" class="section"><div class="card"><h2>Order Management</h2><div id="orders" style="display:grid;gap:.75rem;margin-top:1rem"></div></div></section>
          <section id="page-analytics" class="section"><div class="card"><h2>Business Analytics</h2><canvas id="analyticsChart" height="160" style="margin-top:1rem"></canvas></div></section>
          <section id="page-customers" class="section"><div class="card"><h2>Customers</h2><div id="customers" style="display:grid;gap:.75rem;margin-top:1rem"></div></div></section>
          <section id="page-settings" class="section">
            <div class="card">
              <h2>Store Settings</h2>
              <div style="display:grid;gap:1rem;margin-top:1rem;">
                <label style="display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--line);border-radius:12px">
                  <span>Store Status</span>
                  <input id="toggle-store" type="checkbox" checked>
                </label>
                <label style="display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--line);border-radius:12px">
                  <span>Low Stock Alerts</span>
                  <input id="toggle-lowstock" type="checkbox" checked>
                </label>
                <label style="display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--line);border-radius:12px">
                  <span>Email Notifications</span>
                  <input id="toggle-email" type="checkbox" checked>
                </label>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </section>

  <div id="toast" role="status" aria-live="polite"></div>
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="card modal-card">
      <div style="display:flex;align-items:center;justify-content:space-between"><strong id="modal-title">Confirm Action</strong><button id="modal-x" class="btn ghost" style="padding:6px 8px" aria-label="Close modal"><i data-lucide="x"></i></button></div>
      <div id="modal-body" style="margin:10px 0;color:var(--ink-700)">Are you sure you want to proceed?</div>
      <div style="display:flex;gap:8px;justify-content:end"><button id="modal-cancel" class="btn ghost">Cancel</button><button id="modal-ok" class="btn">OK</button></div>
    </div>
  </div>

<script>
// ====== CONFIG ======
const API_BASE = 'https://quicklocal-backend.onrender.com/api/v1';
const ENDPOINTS = {
  auth: { 
    login: API_BASE + '/auth/login', 
    register: API_BASE + '/auth/register', 
    me: API_BASE + '/auth/me',
    logout: API_BASE + '/auth/logout'
  },
  categories: API_BASE + '/categories',
  products: {
    listMine: API_BASE + '/seller/products',
    create: API_BASE + '/seller/products',
    update: id => API_BASE + '/seller/products/' + id,
    remove: id => API_BASE + '/seller/products/' + id,
  },
  orders: { 
    listMine: API_BASE + '/seller/orders', 
    updateStatus: id => API_BASE + '/seller/orders/' + id + '/status' 
  },
  customers: API_BASE + '/seller/customers',
  dashboard: API_BASE + '/seller/dashboard'
};

// Enhanced axios instance with better error handling
const api = axios.create({ 
  baseURL: API_BASE, 
  withCredentials: true, 
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  }
});

// Request interceptor
api.interceptors.request.use(config => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    config.headers.Authorization = 'Bearer ' + token;
  }
  return config;
}, error => Promise.reject(error));

// Response interceptor 
api.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('seller');
      setAuth(false);
      toast('Session expired. Please log in again.', 'error');
    }
    return Promise.reject(error);
  }
);

// ====== UTILITIES ======
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function icon() {
  try { 
    lucide.createIcons(); 
  } catch(e) { 
    console.warn('Lucide icons failed to load:', e); 
  }
}

function inr(n) {
  try {
    return new Intl.NumberFormat('en-IN', {
      style: 'currency',
      currency: 'INR',
      maximumFractionDigits: 0
    }).format(n || 0);
  } catch {
    return '₹' + (n || 0);
  }
}

function toast(msg, type = 'success', ms = 3000) {
  const el = $('#toast');
  el.textContent = '';
  el.className = '';
  el.classList.add(type === 'success' ? 'toast-success' : 'toast-error', 'show');
  el.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'x-circle'}"></i><span>${msg}</span>`;
  icon();
  setTimeout(() => {
    el.classList.remove('show');
  }, ms);
}

function modal({ title = 'Confirm', body = 'Are you sure?', onOk = null }) {
  $('#modal-title').textContent = title;
  $('#modal-body').textContent = body;
  const m = $('#modal');
  m.classList.add('show');
  const close = () => m.classList.remove('show');
  $('#modal-x').onclick = close;
  $('#modal-cancel').onclick = close;
  $('#modal-ok').onclick = () => {
    if (onOk) onOk();
    close();
  };
}

function setAuth(isAuthenticated) {
  $('#auth').classList.toggle('hidden', isAuthenticated);
  $('#app').classList.toggle('hidden', !isAuthenticated);
}

// ====== NAVIGATION ======
let currentPage = 'dashboard';
let currentProductPage = 1;

function setPage(pageId) {
  currentPage = pageId;
  
  // Hide all sections
  $$('.section').forEach(s => s.classList.remove('show'));
  $('#page-' + pageId).classList.add('show');

  // Update nav active state
  $$('nav a').forEach(a => a.classList.remove('active'));
  const navLink = $(`nav a[data-page="${pageId}"]`);
  if (navLink) navLink.classList.add('active');

  // Load page-specific data
  switch (pageId) {
    case 'dashboard':
      loadDashboard();
      break;
    case 'products':
      loadCategories();
      listMyProducts();
      break;
    case 'orders':
      listOrders();
      break;
    case 'customers':
      listCustomers();
      break;
    case 'analytics':
      loadAnalytics();
      break;
  }

  icon();
}

// ====== AUTHENTICATION ======
async function doLogin(e) {
  e.preventDefault();
  
  const email = $('#login-email').value.trim();
  const password = $('#login-pass').value;
  const remember = $('#remember-me').checked;

  if (!email || !password) {
    toast('Please fill in all fields', 'error');
    return;
  }

  const btn = e.target.querySelector('button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i data-lucide="loader-2"></i> Signing in...';
  btn.disabled = true;

  try {
    const { data } = await api.post(ENDPOINTS.auth.login, {
      email,
      password,
      remember
    });

    if (data?.success) {
      // Find the access token and user object, wherever they are
      const accessToken = data.accessToken || data.data?.accessToken;
      const user = data.user || data.data?.user || {};

      if (!accessToken) {
        throw new Error('Login successful, but no access token received.');
      }

      localStorage.setItem('accessToken', accessToken);
      localStorage.setItem('seller', JSON.stringify(user));
      
      await loadUserProfile();
      setAuth(true);
      setPage('dashboard');
      toast(`Welcome back, ${user?.name || 'Seller'}!`, 'success');

    } else {
      throw new Error(data?.message || 'Invalid response from server');
    }
  } catch (err) {
    console.error('Login error:', err);
    const message = err?.response?.data?.message || err.message || 'Login failed';
    toast(message, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
    icon();
  }
}

async function doRegister(e) {
  e.preventDefault();
  
  const name = $('#reg-name').value.trim();
  const email = $('#reg-email').value.trim();
  const password = $('#reg-pass').value;
  const phone = $('#reg-phone').value.trim();

  if (!name || !email || !password) {
    toast('Please fill in all required fields', 'error');
    return;
  }
  
  if (password.length < 6) {
    toast('Password must be at least 6 characters', 'error');
    return;
  }

  const btn = e.target.querySelector('button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i data-lucide="loader-2"></i> Creating account...';
  btn.disabled = true;

  try {
    const requestData = {
      name,
      email,
      password,
      role: 'seller'
    };
    
    if (phone) {
      requestData.phone = phone;
    }

    const { data } = await api.post(ENDPOINTS.auth.register, requestData);

    if (data?.success) {
      toast(data.message || 'Seller account created successfully!', 'success');
      $('#tab-login').click();
      $('#form-register').reset();
    } else {
      throw new Error(data?.message || 'Registration failed');
    }
  } catch (err) {
    console.error('Registration error:', err);
    let message = 'Registration failed';
    
    if (err?.response?.data?.message) {
      message = err.response.data.message;
    } else if (err?.response?.data?.errors && Array.isArray(err.response.data.errors)) {
      message = err.response.data.errors.map(e => e.msg || e.message).join(', ');
    } else if (err.message) {
      message = err.message;
    }
    
    toast(message, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
    icon();
  }
}


async function doLogout(e) {
  if (e && e.preventDefault) e.preventDefault();
  
  try {
    await api.post(ENDPOINTS.auth.logout);
  } catch (err) {
    console.warn('Logout API call failed:', err);
  } finally {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('seller');
    setAuth(false);
    toast('Logged out successfully', 'success');
  }
}

async function loadUserProfile() {
  try {
    const { data } = await api.get(ENDPOINTS.auth.me);
    
    // Safely find the user object, whether it's at the top level or nested.
    const user = data?.user || data?.data?.user || JSON.parse(localStorage.getItem('seller') || '{}');
    
    $('#whoami').textContent = user?.name || user?.email || 'Seller';
    return user;
  } catch (err) {
    console.warn('Failed to load user profile:', err);
    // Fallback to localStorage if the API call fails
    const user = JSON.parse(localStorage.getItem('seller') || '{}');
    $('#whoami').textContent = user?.name || user?.email || 'Seller';
    return user;
  }
}

// ====== CATEGORIES & PRODUCTS ======
async function loadCategories() {
  try {
    const { data } = await api.get(ENDPOINTS.categories);
    
    // Safely find the array of categories within the response
    let categories = [];
    if (Array.isArray(data?.data)) {
      categories = data.data;
    } else if (Array.isArray(data)) {
      categories = data;
    } else if (Array.isArray(data?.data?.categories)) {
      categories = data.data.categories;
    }
    
    const select = $('#p-category');
    select.innerHTML = '<option value="">Select category</option>' + 
      categories.map(cat => `<option value="${cat._id || cat.id}">${cat.name}</option>`).join('');
  } catch (err) {
    console.error('Failed to load categories:', err);
    toast('Failed to load categories', 'error');
  }
}

async function listMyProducts(page = 1, search = '', status = 'all') {
  const grid = $('#grid');
  const pagination = $('#pagination');
  
  // Show loading skeleton
  grid.innerHTML = Array.from({length: 8}).map(() => 
    `<div class='card skeleton' style='height:280px'></div>`
  ).join('');
  pagination.innerHTML = '';

  try {
    const params = new URLSearchParams({
      page: page.toString(),
      limit: '12'
    });
    
    if (search.trim()) params.append('search', search.trim());
    if (status !== 'all') params.append('status', status);

    const { data } = await api.get(ENDPOINTS.products.listMine + '?' + params.toString());
    
    const products = data?.data?.products || data?.data || data || [];
    const totalProducts = data?.data?.pagination?.totalProducts || products.length;
    const currentPageNum = data?.data?.pagination?.currentPage || page;
    const totalPages = data?.data?.pagination?.totalPages || 1;

    renderProducts(products);
    renderPagination(currentPageNum, totalPages, totalProducts);
    
    // Update badges
    $('#badge-products').textContent = totalProducts;
    $('#stat-products').textContent = totalProducts;

  } catch (err) {
    console.error('Failed to load products:', err);
    grid.innerHTML = `<div class='card' style='text-align:center;padding:2rem;color:var(--ink-500)'>
      <i data-lucide="alert-circle" style="margin-bottom:1rem;"></i>
      <div>Failed to load products</div>
      <button class="btn" style="margin-top:1rem;" onclick="listMyProducts(1)">Retry</button>
    </div>`;
    toast('Failed to load products', 'error');
  }
  
  icon();
}

function renderProducts(products) {
  const grid = $('#grid');
  
  if (!products || products.length === 0) {
    grid.innerHTML = `<div class='card' style='grid-column: 1 / -1; text-align:center;padding:2rem;color:var(--ink-500)'>
      <i data-lucide="package" style="margin-bottom:1rem;"></i>
      <div>No products found</div>
      <div style="margin-top:0.5rem;font-size:0.9rem;">Add your first product to get started!</div>
    </div>`;
    icon();
    return;
  }

  grid.innerHTML = products.map(product => {
    const id = product._id || product.id;
    const imageUrl = product.images?.[0]?.url || product.imageUrl || 'https://via.placeholder.com/400x300?text=No+Image';
    const categoryName = product.category?.name || 'Uncategorized';
    const statusClass = product.status === 'active' ? 'status-active' : 'status-draft';
    const discountText = product.discountPercentage > 0 ? 
      `<span class="badge" style="background:#fee2e2;color:#991b1b">${product.discountPercentage}% OFF</span>` : '';

    return `<div class='card' style="padding:0.75rem">
      <img class='product-img' src='${imageUrl}' alt='${product.name || ''}' 
           onerror="this.src='https://via.placeholder.com/400x300?text=No+Image'"/>
      <div style='margin-top:0.75rem'>
        <div style='display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:0.5rem'>
          <div style='font-weight:700;line-height:1.2;flex:1'>${product.name || ''}</div>
          <div style='text-align:right'>
            <div style='font-weight:800;color:var(--brand)'>${inr(product.price)}</div>
            ${product.originalPrice ? `<div style='font-size:0.8rem;color:var(--ink-500);text-decoration:line-through'>${inr(product.originalPrice)}</div>` : ''}
          </div>
        </div>
        <div style='display:flex;gap:0.5rem;margin-bottom:0.75rem;flex-wrap:wrap'>
          <span class='badge'>${categoryName}</span>
          <span class='badge' style='background:#ecfeff;color:#155e75'>Stock: ${product.stock || 0}</span>
          <span class='status-badge ${statusClass}'>${product.status || 'draft'}</span>
          ${discountText}
        </div>
        <div style='display:flex;gap:0.5rem'>
          <button class='btn' onclick="editProduct('${id}')" style="flex:1">
            <i data-lucide="edit"></i>Edit
          </button>
          <button class='btn danger' onclick="confirmDeleteProduct('${id}')" aria-label="Delete">
            <i data-lucide="trash-2"></i>
          </button>
        </div>
      </div>
    </div>`;
  }).join('');

  icon();
}

function renderPagination(currentPage, totalPages, totalProducts) {
  const pagination = $('#pagination');
  
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }

  let paginationHTML = `<div style="color:var(--ink-500);font-size:0.9rem">
    Showing page ${currentPage} of ${totalPages} (${totalProducts} products)
  </div>`;

  paginationHTML += '<div style="display:flex;gap:0.5rem;align-items:center;">';

  // Previous button
  if (currentPage > 1) {
    paginationHTML += `<button class="btn ghost" onclick="changePage(${currentPage - 1})">
      <i data-lucide="chevron-left"></i>Previous
    </button>`;
  }

  // Page numbers
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    paginationHTML += `<button class="btn ghost" onclick="changePage(1)">1</button>`;
    if (startPage > 2) paginationHTML += '<span>...</span>';
  }

  for (let i = startPage; i <= endPage; i++) {
    const isActive = i === currentPage ? 'btn' : 'btn ghost';
    paginationHTML += `<button class="${isActive}" onclick="changePage(${i})">${i}</button>`;
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) paginationHTML += '<span>...</span>';
    paginationHTML += `<button class="btn ghost" onclick="changePage(${totalPages})">${totalPages}</button>`;
  }

  // Next button
  if (currentPage < totalPages) {
    paginationHTML += `<button class="btn ghost" onclick="changePage(${currentPage + 1})">
      Next<i data-lucide="chevron-right"></i>
    </button>`;
  }

  paginationHTML += '</div>';
  pagination.innerHTML = paginationHTML;
  icon();
}

function changePage(page) {
  currentProductPage = page;
  const search = $('#q').value.trim();
  const status = $('#filter-status').value;
  listMyProducts(page, search, status);
}

function editProduct(productId) {
  // Find product in current data and fill form
  // This is a simplified version - in production you might want to fetch fresh data
  setPage('products');
  $('#form-product').dataset.editId = productId;
  $('#save-text').textContent = 'Update Product';
  $('#btn-delete').disabled = false;
  
  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // You could fetch the specific product here and fill the form
  toast('Product loaded for editing', 'success');
}

async function confirmDeleteProduct(productId) {
  modal({
    title: 'Delete Product',
    body: 'This action cannot be undone. Are you sure you want to delete this product?',
    onOk: () => deleteProduct(productId)
  });
}

async function deleteProduct(productId) {
  try {
    await api.delete(ENDPOINTS.products.remove(productId));
    toast('Product deleted successfully', 'success');
    listMyProducts(currentProductPage);
    
    // Clear form if this product was being edited
    if ($('#form-product').dataset.editId === productId) {
      resetProductForm();
    }
  } catch (err) {
    console.error('Delete product error:', err);
    toast('Failed to delete product', 'error');
  }
}

// ====== PRODUCT FORM ======
function resetProductForm() {
  $('#form-product').reset();
  delete $('#form-product').dataset.editId;
  $('#previews').innerHTML = '';
  $('#save-text').textContent = 'Save Product';
  $('#btn-delete').disabled = true;
  $('#p-published').checked = true;
  toast('Form reset', 'success');
}

async function saveProduct(e) {
  e.preventDefault();
  
  const form = $('#form-product');
  const isEditing = !!form.dataset.editId;
  
  const btn = $('#btn-save');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i data-lucide="loader-2"></i> Saving...';
  btn.disabled = true;

  try {
    const formData = new FormData();
    
    // Basic product data
    formData.append('name', $('#p-name').value.trim());
    formData.append('category', $('#p-category').value);
    formData.append('price', $('#p-price').value);
    formData.append('stock', $('#p-stock').value);
    formData.append('description', $('#p-desc').value.trim());
    formData.append('isPublished', $('#p-published').checked);
    
    // Optional fields
    const originalPrice = $('#p-original-price').value;
    if (originalPrice) formData.append('originalPrice', originalPrice);
    
    const cost = $('#p-cost').value;
    if (cost) formData.append('costPerItem', cost);
    
    const tags = $('#p-tags').value.trim();
    if (tags) formData.append('tags', tags);

    // Handle images
    const imageFiles = Array.from($('#previews').querySelectorAll('img'))
      .map(img => img.file)
      .filter(Boolean);
    
    imageFiles.forEach(file => formData.append('images', file));

    let response;
    if (isEditing) {
      response = await api.put(ENDPOINTS.products.update(form.dataset.editId), formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      toast('Product updated successfully', 'success');
    } else {
      response = await api.post(ENDPOINTS.products.create, formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      toast('Product created successfully', 'success');
    }

    resetProductForm();
    listMyProducts(currentProductPage);

  } catch (err) {
    console.error('Save product error:', err);
    let message = 'Failed to save product';
    
    if (err?.response?.data?.message) {
      message = err.response.data.message;
    } else if (err?.response?.data?.errors) {
      message = Array.isArray(err.response.data.errors) 
        ? err.response.data.errors.map(e => e.msg || e.message).join(', ')
        : 'Validation failed';
    }
    
    toast(message, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
    icon();
  }
}

// ====== IMAGE HANDLING ======
function addImagePreview(file) {
  if (!file || !file.type.startsWith('image/')) {
    toast('Only image files are allowed', 'error');
    return;
  }
  
  if (file.size > 5 * 1024 * 1024) {
    toast('Image size must be less than 5MB', 'error');
    return;
  }

  const existingPreviews = $('#previews').children.length;
  if (existingPreviews >= 8) {
    toast('Maximum 8 images allowed', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    const wrapper = document.createElement('div');
    wrapper.className = 'card';
    wrapper.style.position = 'relative';
    wrapper.style.padding = '0.25rem';

    const img = document.createElement('img');
    img.src = e.target.result;
    img.className = 'product-img';
    img.file = file;
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn danger';
    removeBtn.style.position = 'absolute';
    removeBtn.style.top = '8px';
    removeBtn.style.right = '8px';
    removeBtn.style.padding = '4px 8px';
    removeBtn.innerHTML = '<i data-lucide="x"></i>';
    removeBtn.onclick = () => wrapper.remove();

    wrapper.appendChild(img);
    wrapper.appendChild(removeBtn);
    $('#previews').appendChild(wrapper);
    
    icon();
  };
  
  reader.readAsDataURL(file);
}

// ====== ORDERS ======
async function listOrders() {
  const container = $('#orders');
  container.innerHTML = `<div class='card skeleton' style='height:120px'></div>`;

  try {
    const { data } = await api.get(ENDPOINTS.orders.listMine);
    const orders = data?.data || data || [];
    
    $('#badge-orders').textContent = orders.length;
    $('#stat-orders').textContent = orders.length;
    
    if (orders.length === 0) {
      container.innerHTML = `<div class='card' style='text-align:center;padding:2rem;color:var(--ink-500)'>
        <i data-lucide="shopping-cart" style="margin-bottom:1rem;"></i>
        <div>No orders yet</div>
        <div style="margin-top:0.5rem;font-size:0.9rem;">Orders will appear here once customers start buying your products.</div>
      </div>`;
    } else {
      container.innerHTML = orders.map(order => {
        const orderId = order._id || order.id || '';
        const items = (order.items || []).map(item => 
          `${item.quantity || 1}× ${item.name || 'Item'}`
        ).join(', ');
        const total = inr(order.subtotal || order.total || 0);
        const createdAt = new Date(order.createdAt || Date.now()).toLocaleDateString('en-IN');

        return `<div class='card'>
          <div style='display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem'>
            <div>
              <strong>Order #${orderId.slice(-6)}</strong>
              <div style='color:var(--ink-500);font-size:0.8rem'>${createdAt}</div>
            </div>
            <div style='display:flex;align-items:center;gap:0.5rem'>
              <div style='font-weight:800'>${total}</div>
              <button class='btn' onclick="updateOrderStatus('${orderId}')">
                <i data-lucide="arrow-right"></i>Process
              </button>
            </div>
          </div>
          <div style='color:var(--ink-700);font-size:0.9rem'>${items || 'No items'}</div>
          ${order.shipping ? `<div style='color:var(--ink-500);font-size:0.8rem;margin-top:0.25rem'>
            Ship to: ${order.shipping.fullName || ''}, ${order.shipping.city || ''}
          </div>` : ''}
        </div>`;
      }).join('');
    }
  } catch (err) {
    console.error('Failed to load orders:', err);
    container.innerHTML = `<div class='card' style='text-align:center;padding:2rem;color:var(--ink-500)'>
      <i data-lucide="alert-circle" style="margin-bottom:1rem;"></i>
      <div>Failed to load orders</div>
    </div>`;
  }
  
  icon();
}

async function updateOrderStatus(orderId) {
  try {
    await api.patch(ENDPOINTS.orders.updateStatus(orderId), {
      newStatus: 'processing'
    });
    toast('Order status updated', 'success');
    listOrders();
  } catch (err) {
    console.error('Failed to update order:', err);
    toast('Failed to update order status', 'error');
  }
}

// ====== CUSTOMERS ======
async function listCustomers() {
  const container = $('#customers');
  container.innerHTML = `<div class='card skeleton' style='height:100px'></div>`;

  try {
    const { data } = await api.get(ENDPOINTS.customers);
    const customers = data?.data || data || [];
    
    $('#stat-customers').textContent = customers.length;
    
    if (customers.length === 0) {
      container.innerHTML = `<div class='card' style='text-align:center;padding:2rem;color:var(--ink-500)'>
        <i data-lucide="users" style="margin-bottom:1rem;"></i>
        <div>No customers yet</div>
      </div>`;
    } else {
      container.innerHTML = customers.map(customer => `
        <div class='card' style='display:flex;align-items:center;justify-content:space-between'>
          <div style='display:flex;align-items:center;gap:12px'>
            <div style='width:42px;height:42px;border-radius:50%;background:var(--brand);color:white;display:flex;align-items:center;justify-content:center;font-weight:600'>
              ${(customer.name || customer.email || 'C').charAt(0).toUpperCase()}
            </div>
            <div>
              <div style='font-weight:700'>${customer.name || 'Customer'}</div>
              <div style='color:var(--ink-500);font-size:0.8rem'>${customer.email || ''}</div>
            </div>
          </div>
          <div style='text-align:right'>
            <strong>${customer.totalOrders || 0} orders</strong>
            <div style='color:var(--ink-500);font-size:0.8rem'>${inr(customer.totalSpent || 0)} spent</div>
          </div>
        </div>
      `).join('');
    }
  } catch (err) {
    console.error('Failed to load customers:', err);
    container.innerHTML = `<div class='card'>Failed to load customers</div>`;
  }
  
  icon();
}

// ====== DASHBOARD & ANALYTICS ======
async function loadDashboard() {
  try {
    // Load dashboard data in parallel
    const [productsRes, ordersRes] = await Promise.allSettled([
      api.get(ENDPOINTS.products.listMine + '?limit=100'),
      api.get(ENDPOINTS.orders.listMine)
    ]);

    const products = productsRes.status === 'fulfilled' 
      ? (productsRes.value?.data?.data?.products || productsRes.value?.data?.data || [])
      : [];
      
    const orders = ordersRes.status === 'fulfilled'
      ? (ordersRes.value?.data?.data || [])
      : [];

    // Update stats
    $('#stat-products').textContent = products.length;
    $('#badge-products').textContent = products.length;
    $('#stat-orders').textContent = orders.length;
    $('#badge-orders').textContent = orders.length;

    // Calculate total sales
    const totalSales = orders.reduce((sum, order) => sum + (order.subtotal || order.total || 0), 0);
    $('#stat-sales').textContent = inr(totalSales);

    // Get unique customers count
    const customerIds = new Set(orders.map(order => order.user).filter(Boolean));
    $('#stat-customers').textContent = customerIds.size;

    // Generate sales chart data (last 7 days)
    const salesData = generateSalesChartData(orders);
    renderSalesChart(salesData);

    // Recent activity
    renderRecentActivity(orders.slice(0, 5));

  } catch (err) {
    console.error('Dashboard load error:', err);
  }
}

function generateSalesChartData(orders) {
  const last7Days = Array.from({length: 7}, (_, i) => {
    const date = new Date();
    date.setDate(date.getDate() - (6 - i));
    return {
      date: date.toDateString(),
      label: date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }),
      value: 0
    };
  });

  orders.forEach(order => {
    const orderDate = new Date(order.createdAt).toDateString();
    const dayData = last7Days.find(day => day.date === orderDate);
    if (dayData) {
      dayData.value += order.subtotal || order.total || 0;
    }
  });

  return last7Days;
}

function renderSalesChart(data) {
  const ctx = $('#salesChart');
  if (!ctx) return;

  if (window.salesChart) {
    window.salesChart.destroy();
  }

  window.salesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => d.label),
      datasets: [{
        label: 'Sales',
        data: data.map(d => d.value),
        borderColor: '#6d5ef9',
        backgroundColor: 'rgba(109, 94, 249, 0.1)',
        tension: 0.4,
        fill: true,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => inr(value).replace('₹', '₹')
          }
        }
      }
    }
  });
}

function renderRecentActivity(recentOrders) {
  const container = $('#recent-activity');
  
  if (!recentOrders.length) {
    container.innerHTML = `<div style="color:var(--ink-500);text-align:center;padding:1rem">
      No recent activity
    </div>`;
    return;
  }

  container.innerHTML = recentOrders.map(order => {
    const timeAgo = getTimeAgo(new Date(order.createdAt));
    const total = inr(order.subtotal || order.total || 0);
    
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--line)">
      <div>
        <div style="font-weight:600">New order</div>
        <div style="color:var(--ink-500);font-size:0.8rem">${timeAgo}</div>
      </div>
      <div style="font-weight:700;color:var(--brand)">${total}</div>
    </div>`;
  }).join('');
}

function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffHours / 24);
  
  if (diffDays > 0) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
  if (diffHours > 0) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
  return 'Just now';
}

async function loadAnalytics() {
  const ctx = $('#analyticsChart');
  if (!ctx) return;

  // Sample analytics data - in production this would come from your API
  const data = [
    { label: 'Fashion', value: 40 },
    { label: 'Electronics', value: 25 },
    { label: 'Home & Garden', value: 20 },
    { label: 'Sports', value: 10 },
    { label: 'Other', value: 5 }
  ];

  if (window.analyticsChart) {
    window.analyticsChart.destroy();
  }

  window.analyticsChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.map(d => d.label),
      datasets: [{
        data: data.map(d => d.value),
        backgroundColor: [
          '#6d5ef9',
          '#7a5af8', 
          '#22c55e',
          '#ef4444',
          '#f59e0b'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 16
          }
        }
      }
    }
  });
}

// ====== EVENT LISTENERS & INITIALIZATION ======
document.addEventListener('DOMContentLoaded', () => {
  icon();

  // Auth tabs
  $('#tab-login').onclick = (e) => {
    e.preventDefault();
    $('#form-login').classList.remove('hidden');
    $('#form-register').classList.add('hidden');
    $('#tab-login').classList.remove('ghost');
    $('#tab-register').classList.add('ghost');
  };

  $('#tab-register').onclick = (e) => {
    e.preventDefault();
    $('#form-login').classList.add('hidden');
    $('#form-register').classList.remove('hidden');
    $('#tab-register').classList.remove('ghost');
    $('#tab-login').classList.add('ghost');
  };

  // Auth forms
  $('#form-login').addEventListener('submit', doLogin);
  $('#form-register').addEventListener('submit', doRegister);
  $('#btn-logout').addEventListener('click', doLogout);

  // Navigation
  $$('nav a').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const page = link.dataset.page;
      if (page) setPage(page);
      
      const sidebar = $('#sidebar');
      if (sidebar.classList.contains('open')) {
          sidebar.classList.remove('open');
          $('#backdrop').classList.remove('show');
      }
    });
  });

  // Sidebar mobile
  const sidebar = $('#sidebar');
  const backdrop = $('#backdrop');
  
  $('#open-sidebar').onclick = () => {
    sidebar.classList.add('open');
    backdrop.classList.add('show');
  };
  
  const closeSidebar = () => {
    sidebar.classList.remove('open');
    backdrop.classList.remove('show');
  };
  
  $('#close-sidebar').onclick = closeSidebar;
  backdrop.onclick = closeSidebar;

  // Product form
  $('#form-product').addEventListener('submit', saveProduct);
  $('#btn-reset').addEventListener('click', (e) => {
    e.preventDefault();
    resetProductForm();
  });

  // Image upload
  const dropZone = $('#drop');
  const fileInput = $('#p-images');
  
  dropZone.onclick = () => fileInput.click();
  
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = 'var(--brand)';
  });
  
  dropZone.addEventListener('dragleave', () => {
    dropZone.style.borderColor = 'var(--line)';
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.borderColor = 'var(--line)';
    Array.from(e.dataTransfer.files).forEach(addImagePreview);
  });
  
  fileInput.addEventListener('change', () => {
    Array.from(fileInput.files).forEach(addImagePreview);
  });

  // Search functionality
  const performSearch = () => {
    const search = $('#q').value.trim();
    const status = $('#filter-status').value;
    currentProductPage = 1; // Reset to first page on search
    listMyProducts(1, search, status);
  };
  
  $('#btn-search').onclick = performSearch;
  $('#q').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      performSearch();
    }
  });
  
  $('#filter-status').addEventListener('change', performSearch);

  // Auto-login if token exists
  const token = localStorage.getItem('accessToken');
  if (token) {
    loadUserProfile().then(() => {
      setAuth(true);
      setPage('dashboard');
    }).catch(() => {
      // Token might be invalid, clear it
      localStorage.removeItem('accessToken');
      localStorage.removeItem('seller');
    });
  }
});

// Global functions for onclick handlers
window.editProduct = editProduct;
window.confirmDeleteProduct = confirmDeleteProduct;
window.updateOrderStatus = updateOrderStatus;
window.changePage = changePage;
</script>
</body>
</html>