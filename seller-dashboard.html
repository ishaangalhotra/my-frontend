<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuickLocal — Seller Dashboard (Fixed Categories)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    /* ===== Shared UI Polish (from v3) ===== */
    .toast{position:fixed;top:1rem;right:1rem;z-index:1050;padding:.75rem 1rem;border-radius:.5rem;color:#fff;opacity:.95;transform:translateX(120%);transition:transform .25s ease;max-width:400px;word-wrap:break-word}
    .toast.show{transform:translateX(0)}
    .toast-success{background:#16a34a}.toast-error{background:#ef4444}.toast-info{background:#3b82f6}.toast-warning{background:#f59e0b}
    .modal-backdrop{background:rgba(0,0,0,.55);backdrop-filter:blur(3px)}
    .gradient-primary{background:linear-gradient(135deg,#7c3aed,#a855f7)}
    .focus-ring{transition:all .2s ease}
    .focus-ring:focus{outline:none;box-shadow:0 0 0 3px rgba(124,58,237,.35)}
    .product-card{transition:all .3s ease}
    .product-card:hover{transform:translateY(-4px);box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}
    .imagekit-upload{border:2px dashed #d1d5db;transition:all .3s ease;cursor:pointer}
    .imagekit-upload:hover{border-color:#7c3aed;background-color:#f8fafc}
    .imagekit-upload.dragover{border-color:#16a34a;background-color:#f0fdf4}
    .line-clamp-2{overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .loading-spinner{border:2px solid #f3f3f3;border-top:2px solid #3498db;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .progress-bar{height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden}
    .progress-bar-fill{height:100%;background:#7c3aed;transition:width .3s ease}
    /* ===== Extras from v1 ===== */
    .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
    @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .price-input{position:relative}
    .price-input::before{content:'₹';position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#6b7280;font-weight:500}
    .price-input input{padding-left:30px!important}
    /* ===== Status dots from v4 ===== */
    .status-indicator{width:8px;height:8px;border-radius:50%;display:inline-block}
    .status-active{background-color:#10b981}.status-inactive{background-color:#ef4444}
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <section id="auth-section" class="min-h-screen flex items-center justify-center p-4 gradient-primary">
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8">
      <div class="text-center mb-8">
        <div class="mx-auto w-16 h-16 bg-purple-50 rounded-full flex items-center justify-center mb-4">
          <i data-lucide="store" class="text-purple-600 w-8 h-8"></i>
        </div>
        <h1 class="text-3xl font-bold text-gray-800">QuickLocal Seller</h1>
        <p class="text-gray-600 mt-2">Manage your products and grow your business</p>
      </div>

      <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
        <button id="login-tab" class="flex-1 py-2 px-4 rounded-md font-semibold transition-all bg-white text-purple-600 shadow-sm">Login</button>
        <button id="register-tab" class="flex-1 py-2 px-4 rounded-md font-medium transition-all text-gray-600">Register</button>
      </div>

      <form id="login-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <div class="relative">
            <i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
            <input id="login-email" type="email" placeholder="Enter your email" required class="w-full border border-gray-300 rounded-lg p-3 pl-10 focus-ring">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <div class="relative">
            <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
            <input id="login-password" type="password" placeholder="Enter your password" required class="w-full border border-gray-300 rounded-lg p-3 pl-10 focus-ring">
          </div>
        </div>
        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-colors flex items-center justify-center">
          <span id="login-btn-text">Sign In</span>
          <div id="login-spinner" class="loading-spinner ml-2 hidden"></div>
        </button>
        <div class="flex items-center justify-between text-sm pt-2">
          <button id="forgot-password-btn" type="button" class="text-purple-600 hover:underline">Forgot password?</button>
        </div>
      </form>

      <form id="register-form" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
            <input id="reg-name" type="text" placeholder="John Doe" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
            <input id="reg-phone" type="tel" placeholder="9876543210" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input id="reg-email" type="email" placeholder="john@example.com" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Business Name</label>
          <input id="reg-business" type="text" placeholder="Your Business Name" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input id="reg-password" type="password" placeholder="Minimum 6 characters" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
          <input id="reg-confirm-password" type="password" placeholder="Confirm your password" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
        </div>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors flex items-center justify-center">
          <span id="register-btn-text">Create Account & Start Selling</span>
          <div id="register-spinner" class="loading-spinner ml-2 hidden"></div>
        </button>
        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
          <p class="text-green-700 text-sm font-medium">✨ No email verification required!</p>
          <p class="text-green-600 text-xs mt-1">Start selling immediately after registration</p>
        </div>
      </form>
    </div>
  </section>

  <section id="dashboard-section" class="hidden">
    <header class="bg-white shadow-sm border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center space-x-4">
            <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center">
              <i data-lucide="store" class="text-white w-4 h-4"></i>
            </div>
            <div>
              <h1 class="text-xl font-bold text-gray-900">QuickLocal Seller</h1>
              <p class="text-sm text-gray-500">Welcome back, <span id="seller-name">Seller</span></p>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <div class="hidden md:flex items-center space-x-2 bg-gray-100 rounded-lg px-3 py-2">
              <span class="text-sm font-medium text-gray-700">Wallet: ₹<span id="wallet-balance">0.00</span></span>
            </div>
            <button id="toggle-debug" title="Toggle debug" class="hidden md:inline-flex items-center gap-1 text-xs px-2 py-1 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-600">
              <i data-lucide="bug" class="w-4 h-4"></i>Debug
            </button>
            <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
              <i data-lucide="log-out" class="w-4 h-4 mr-2 inline"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Total Products</p><p id="stat-products" class="text-2xl font-bold text-gray-900">0</p></div><i data-lucide="package" class="h-8 w-8 text-blue-600"></i></div></div>
        <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Total Sales</p><p id="stat-sales" class="text-2xl font-bold text-gray-900">₹0</p></div><i data-lucide="dollar-sign" class="h-8 w-8 text-green-600"></i></div></div>
        <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Orders</p><p id="stat-orders" class="text-2xl font-bold text-gray-900">0</p></div><i data-lucide="shopping-cart" class="h-8 w-8 text-amber-600"></i></div></div>
        <div class="bg-white rounded-lg shadow p-6"><div class="flex items-center justify-between"><div><p class="text-sm font-medium text-gray-500">Rating</p><p id="stat-rating" class="text-2xl font-bold text-gray-900">4.8</p></div><i data-lucide="star" class="h-8 w-8 text-purple-600"></i></div></div>
      </div>

      <div class="bg-white rounded-lg shadow">
        <div class="p-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
            <div>
              <h2 class="text-lg font-semibold text-gray-900">Product Management</h2>
              <p class="text-sm text-gray-500">Manage your product inventory and details</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
              <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                <input id="product-search" type="text" placeholder="Search products..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus-ring w-full sm:w-auto">
              </div>
              <select id="category-filter" class="border border-gray-300 rounded-lg px-3 py-2 focus-ring w-full sm:w-auto">
                <option value="">All Categories</option>
              </select>
              <button id="add-product-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>Add Product
              </button>
            </div>
          </div>

          <div id="products-loading" class="text-center py-8 hidden">
            <div class="flex justify-center items-center">
              <div class="loading-spinner mr-2"></div>
              <div class="text-gray-500">Loading products...</div>
            </div>
          </div>

          <div id="products-empty" class="text-center py-8 hidden">
            <i data-lucide="package" class="mx-auto h-12 w-12 text-gray-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No products yet</h3>
            <p class="text-gray-500 mb-4">Get started by adding your first product!</p>
            <button id="add-first-product-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
              <i data-lucide="plus" class="w-4 h-4 mr-2 inline"></i>Add Your First Product
            </button>
          </div>

          <div id="products-skeleton" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden">
          </div>

          <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden"></div>

          <div id="pagination" class="flex items-center justify-between border-t border-gray-200 pt-4 mt-6 hidden">
            <div class="flex-1 flex justify-between sm:hidden">
              <button id="prev-page-mobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</button>
              <button id="next-page-mobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
              <div>
                <p class="text-sm text-gray-700">
                  Showing <span id="pagination-start" class="font-medium">1</span> to <span id="pagination-end" class="font-medium">10</span> of <span id="pagination-total" class="font-medium">0</span> results
                </p>
              </div>
              <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                  <button id="prev-page" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Previous</span>
                    <i data-lucide="chevron-left" class="h-5 w-5"></i>
                  </button>
                  <span id="pagination-pages" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700"></span>
                  <button id="next-page" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Next</span>
                    <i data-lucide="chevron-right" class="h-5 w-5"></i>
                  </button>
                </nav>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="debug-info" class="bg-gray-100 border border-gray-200 rounded-lg p-3 text-xs text-gray-600 mt-6 hidden">
        <p class="font-semibold">Debug Info</p>
        <p>Seller ID: <span id="debug-seller-id">-</span></p>
        <p>Token: <span id="debug-token">-</span></p>
        <p>API Base: <span id="debug-api-base">-</span></p>
        <p>Categories loaded: <span id="debug-categories-count">0</span></p>
        <p>Last category API response: <span id="debug-last-category-response">-</span></p>
      </div>

    </main>
  </section>

  <div id="product-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 id="modal-title" class="text-xl font-bold text-gray-800 flex items-center gap-2">
          <i data-lucide="info" class="w-5 h-5 text-purple-600"></i>
          <span>Add New Product</span>
        </h3>
        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
      </div>

      <form id="product-form" class="space-y-6">
        <div class="space-y-4">
          <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <i data-lucide="info" class="w-4 h-4 text-purple-600"></i>Basic Information
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Product Name *</label>
              <input id="product-name" placeholder="Enter product name" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
              <p class="text-xs text-gray-500 mt-1">Minimum 2 characters, no special characters</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
              <select id="product-category" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
                <option value="" class="category-loading">Loading categories...</option>
              </select>
              <button type="button" id="refresh-categories-btn" class="mt-1 text-xs text-purple-600 hover:underline">
                <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>Refresh categories
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="price-input">
              <label class="block text-sm font-medium text-gray-700 mb-1">Price (₹) *</label>
              <input id="product-price" type="number" min="0" step="0.01" placeholder="0.00" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity *</label>
              <input id="product-stock" type="number" min="0" step="1" placeholder="0" required class="w-full border border-gray-300 rounded-lg p-3 focus-ring">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea id="product-description" rows="3" placeholder="Enter product description..." class="w-full border border-gray-300 rounded-lg p-3 focus-ring" maxlength="500"></textarea>
            <p class="text-xs text-gray-500 mt-1">Maximum 500 characters</p>
          </div>
        </div>

        <div class="space-y-4">
          <h4 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <i data-lucide="image" class="w-4 h-4 text-purple-600"></i>Images
          </h4>
          <div id="upload-drop" class="imagekit-upload rounded-lg p-6 text-center">
            <input id="product-images" type="file" multiple accept="image/*" class="hidden">
            <p class="text-gray-600">Drag & drop images here or <button type="button" id="pick-images" class="text-purple-600 underline">browse</button></p>
            <p class="text-xs text-gray-500 mt-1">You can upload up to 6 images. First image is used as cover.</p>
          </div>
          <div id="upload-previews" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
          <div class="progress-bar hidden" id="upload-progress">
            <div class="progress-bar-fill" id="upload-progress-fill" style="width:0%"></div>
          </div>
        </div>

        <div class="flex items-center justify-end gap-3">
          <button type="button" id="cancel-product" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700">Cancel</button>
          <button type="submit" id="save-product" class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white font-semibold">Save Product</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    // ===================== CONFIG =====================
    const API_BASE = localStorage.getItem('API_BASE') || 'https://quicklocal-backend.onrender.com/api/v1';
    const PAGE_SIZE = 12;

    // ===================== STATE =====================
    const state = {
      token: localStorage.getItem('accessToken') || '',
      seller: JSON.parse(localStorage.getItem('seller') || 'null'),
      categories: [],
      products: [],
      page: 1,
      total: 0,
      editing: null,
      uploads: [] // {file, url}
    };

    // ===================== UTILITIES =====================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function showToast(msg, type='success'){
      const el = $('#toast');
      el.textContent = msg;
      el.className = `toast toast-${type} show`;
      setTimeout(()=>{ el.classList.remove('show'); }, 2500);
    }

    function setLoading(id, show){
      const el = $(id);
      if(!el) return;
      el.classList.toggle('hidden', !show);
    }

    function formatINR(n){
      if(n === null || n === undefined || isNaN(n)) return '0';
      return new Intl.NumberFormat('en-IN').format(Number(n));
    }

    function authHeader(){
      return state.token ? { Authorization: `Bearer ${state.token}` } : {};
    }

    function updateDebug(){
      $('#debug-seller-id').textContent = state.seller?.id || state.seller?._id || '-';
      $('#debug-token').textContent = state.token ? `${state.token.slice(0,12)}…${state.token.slice(-6)}` : '-';
      $('#debug-api-base').textContent = API_BASE;
      $('#debug-categories-count').textContent = state.categories.length;
    }

    function initSkeleton(count=8){
        const grid = $('#products-skeleton');
        if (!grid) return;
        grid.innerHTML = '';
        const cardHTML = `
            <div class="bg-white rounded-lg shadow p-4 space-y-3">
                <div class="h-40 rounded-md skeleton"></div>
                <div class="h-5 w-3/4 rounded-md skeleton"></div>
                <div class="h-4 w-1/2 rounded-md skeleton"></div>
                <div class="h-9 w-full rounded-md skeleton"></div>
            </div>
        `;
        for (let i = 0; i < count; i++) {
            grid.insertAdjacentHTML('beforeend', cardHTML);
        }
        grid.classList.remove('hidden');
    }

    // ===================== AUTH =====================
    function switchTab(to){
      const isLogin = to === 'login';
      $('#login-tab').classList.toggle('bg-white', isLogin);
      $('#login-tab').classList.toggle('text-purple-600', isLogin);
      $('#register-tab').classList.toggle('bg-white', !isLogin);
      $('#register-tab').classList.toggle('text-purple-600', !isLogin);
      $('#login-form').classList.toggle('hidden', !isLogin);
      $('#register-form').classList.toggle('hidden', isLogin);
    }

    function showDashboard(){
      $('#auth-section').classList.add('hidden');
      $('#dashboard-section').classList.remove('hidden');
      lucide.createIcons();
    }

    function showAuth(){
      $('#dashboard-section').classList.add('hidden');
      $('#auth-section').classList.remove('hidden');
      lucide.createIcons();
    }

    async function handleLogin(e){
      e.preventDefault();
      $('#login-spinner').classList.remove('hidden');
      $('#login-btn-text').textContent = 'Signing in…';
      try{
        const email = $('#login-email').value.trim();
        const password = $('#login-password').value;
        const { data } = await axios.post(`${API_BASE}/auth/login`, { email, password });
        state.token = data?.accessToken || data?.token || '';
        state.seller = data?.user || data?.seller || null;
        localStorage.setItem('accessToken', state.token);
        localStorage.setItem('seller', JSON.stringify(state.seller||{}));
        showToast('Logged in successfully');
        $('#seller-name').textContent = state.seller?.name || state.seller?.fullName || 'Seller';
        updateDebug();
        showDashboard();
        await bootstrapAfterAuth();
      }catch(err){
        console.error(err);
        showToast(err?.response?.data?.message || 'Login failed', 'error');
      }finally{
        $('#login-spinner').classList.add('hidden');
        $('#login-btn-text').textContent = 'Sign In';
      }
    }

    async function handleRegister(e){
      e.preventDefault();
      $('#register-spinner').classList.remove('hidden');
      $('#register-btn-text').textContent = 'Creating…';
      try{
        const payload = {
          name: $('#reg-name').value.trim(),
          phone: $('#reg-phone').value.trim(),
          email: $('#reg-email').value.trim(),
          businessName: $('#reg-business').value.trim(),
          password: $('#reg-password').value,
          confirmPassword: $('#reg-confirm-password').value,
          role: 'seller'
        };
        const { data } = await axios.post(`${API_BASE}/auth/register`, payload);
        showToast('Account created! Please login.','success');
        switchTab('login');
      }catch(err){
        console.error(err);
        showToast(err?.response?.data?.message || 'Registration failed','error');
      }finally{
        $('#register-spinner').classList.add('hidden');
        $('#register-btn-text').textContent = 'Create Account & Start Selling';
      }
    }

    function logout(){
      state.token=''; state.seller=null;
      localStorage.removeItem('accessToken');
      localStorage.removeItem('seller');
      showAuth();
    }

    // ===================== CATEGORIES =====================
    async function loadCategories(showToastOnFail = true) {
      const sel = $('#product-category');
      const filterSel = $('#category-filter');
      if (sel) sel.innerHTML = `<option value="" class="category-loading">Loading categories...</option>`;
      
      try {
        console.log('Loading categories from:', `${API_BASE}/categories`);
        
        // Try multiple possible endpoints for categories
        let response;
        let categoriesData = [];
        
        try {
          // First try the main categories endpoint
          response = await axios.get(`${API_BASE}/categories`, { headers: authHeader() });
          console.log('Categories response:', response.data);
          $('#debug-last-category-response').textContent = JSON.stringify(response.data).slice(0, 100) + '...';
        } catch (firstError) {
          console.log('First endpoint failed, trying alternative...');
          try {
            // Try alternative endpoint
            response = await axios.get(`${API_BASE}/category`, { headers: authHeader() });
            console.log('Alternative categories response:', response.data);
            $('#debug-last-category-response').textContent = JSON.stringify(response.data).slice(0, 100) + '...';
          } catch (secondError) {
            // If both fail, create some default categories
            console.log('Both endpoints failed, using fallback categories');
            categoriesData = [
              { _id: 'electronics', name: 'Electronics', id: 'electronics' },
              { _id: 'clothing', name: 'Clothing & Fashion', id: 'clothing' },
              { _id: 'home', name: 'Home & Garden', id: 'home' },
              { _id: 'books', name: 'Books & Media', id: 'books' },
              { _id: 'sports', name: 'Sports & Outdoors', id: 'sports' },
              { _id: 'health', name: 'Health & Beauty', id: 'health' },
              { _id: 'food', name: 'Food & Beverages', id: 'food' },
              { _id: 'automotive', name: 'Automotive', id: 'automotive' },
              { _id: 'toys', name: 'Toys & Games', id: 'toys' },
              { _id: 'other', name: 'Other', id: 'other' }
            ];
            $('#debug-last-category-response').textContent = 'Using fallback categories';
          }
        }

        // Extract categories from response if we got one
        if (response && response.data) {
          const data = response.data;
          if (Array.isArray(data?.categories)) {
            categoriesData = data.categories;
          } else if (Array.isArray(data?.data)) {
            categoriesData = data.data;
          } else if (Array.isArray(data)) {
            categoriesData = data;
          } else if (data.success && Array.isArray(data.categories)) {
            categoriesData = data.categories;
          }
        }

        state.categories = categoriesData;
        console.log('Final categories:', state.categories);

        const options = categoriesData.map(c => {
          const id = c._id || c.id || c.categoryId;
          const name = c.name || c.categoryName || c.title || 'Unnamed Category';
          return `<option value="${id}">${name}</option>`;
        }).join('');

        if (sel) {
          sel.innerHTML = `<option value="">Select a category</option>` + options;
        }
        if (filterSel) {
          filterSel.innerHTML = `<option value="">All Categories</option>` + options;
        }

        updateDebug();

        if (categoriesData.length === 0 && showToastOnFail) {
          showToast('No categories found. Using default categories.', 'warning');
        }

      } catch (err) {
        console.error('Categories loading error:', err);
        if (showToastOnFail) showToast('Failed to load categories', 'warning');
        
        // Use fallback categories on complete failure
        state.categories = [
          { _id: 'electronics', name: 'Electronics' },
          { _id: 'clothing', name: 'Clothing & Fashion' },
          { _id: 'home', name: 'Home & Garden' },
          { _id: 'books', name: 'Books & Media' },
          { _id: 'sports', name: 'Sports & Outdoors' },
          { _id: 'health', name: 'Health & Beauty' },
          { _id: 'food', name: 'Food & Beverages' },
          { _id: 'automotive', name: 'Automotive' },
          { _id: 'toys', name: 'Toys & Games' },
          { _id: 'other', name: 'Other' }
        ];

        const fallbackOptions = state.categories.map(c => `<option value="${c._id}">${c.name}</option>`).join('');
        if (sel) sel.innerHTML = `<option value="">Select a category</option>` + fallbackOptions;
        if (filterSel) filterSel.innerHTML = `<option value="">All Categories</option>` + fallbackOptions;
        
        $('#debug-last-category-response').textContent = 'Error: ' + (err.message || 'Unknown error');
        updateDebug();
      }
    }

    // ===================== PRODUCTS =====================
    async function fetchProducts() {
      const q = $('#product-search').value.trim();
      const cat = $('#category-filter').value;
      const page = state.page;
      const params = { page, limit: PAGE_SIZE };
      if (q) params.search = q;
      if (cat) params.category = cat;

      $('#products-grid').classList.add('hidden');
      $('#products-empty').classList.add('hidden');
      initSkeleton(8);
      setLoading('#products-loading', true);

      try {
        const { data } = await axios.get(`${API_BASE}/seller/products`, { params, headers: authHeader() });

        let items = [];
        if (Array.isArray(data?.products)) items = data.products;
        else if (Array.isArray(data?.items)) items = data.items;
        else if (Array.isArray(data)) items = data;

        state.total = Number.isFinite(data?.total) ? data.total
                     : Number.isFinite(data?.count) ? data.count
                     : items.length;

        state.products = items;
        renderProducts();
      } catch (err) {
        console.error(err);
        showToast('Failed to fetch products', 'error');
        state.products = [];
        renderProducts();
      } finally {
        setLoading('#products-loading', false);
        $('#products-skeleton').classList.add('hidden');
      }
    }

    function renderProducts(){
      const grid = $('#products-grid');
      grid.innerHTML = '';
      if(!state.products.length){
        $('#products-empty').classList.remove('hidden');
        $('#products-grid').classList.add('hidden');
        updatePagination(0,0,0);
        return;
      }
      state.products.forEach(p=>{
        const active = p.active !== false; // default true if missing
        const img = (p.images && p.images[0]) || p.image || 'https://via.placeholder.com/400x300?text=Product';
        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg shadow product-card overflow-hidden flex flex-col';
        card.innerHTML = `
          <div class="relative">
            <img src="${img}" alt="${p.name||'Product'}" class="w-full h-40 object-cover">
            <span class="absolute top-2 left-2 status-indicator ${active?'status-active':'status-inactive'}" title="${active?'Active':'Inactive'}"></span>
          </div>
          <div class="p-4 flex-1 flex flex-col">
            <h3 class="font-semibold text-gray-900 line-clamp-2">${p.name||'Unnamed'}</h3>
            <p class="text-sm text-gray-500 mt-1">Stock: ${p.stock ?? 0}</p>
            <p class="text-lg font-bold text-gray-900 mt-2">₹${formatINR(p.price || 0)}</p>
            <div class="mt-auto pt-4 grid grid-cols-3 gap-2">
              <button class="px-2 py-2 text-sm rounded-lg bg-gray-100 hover:bg-gray-200" data-action="edit">Edit</button>
              <button class="px-2 py-2 text-sm rounded-lg bg-red-100 hover:bg-red-200 text-red-700" data-action="delete">Delete</button>
              <button class="px-2 py-2 text-sm rounded-lg ${active?'bg-amber-100 text-amber-700 hover:bg-amber-200':'bg-green-100 text-green-700 hover:bg-green-200'}" data-action="toggle">${active?'Disable':'Enable'}</button>
            </div>
          </div>`;
        card.querySelector('[data-action="edit"]').addEventListener('click', ()=> openProductModal('edit', p));
        card.querySelector('[data-action="delete"]').addEventListener('click', ()=> deleteProduct(p));
        card.querySelector('[data-action="toggle"]').addEventListener('click', ()=> toggleProductStatus(p));
        grid.appendChild(card);
      });
      grid.classList.remove('hidden');
      // Pagination calc
      const total = state.total;
      const start = (state.page-1)*PAGE_SIZE + 1;
      const end = Math.min(state.page*PAGE_SIZE, total);
      updatePagination(start, end, total);
    }

    function updatePagination(start, end, total){
      $('#pagination-start').textContent = start || 0;
      $('#pagination-end').textContent = end || 0;
      $('#pagination-total').textContent = total || 0;
      const pages = Math.max(1, Math.ceil((total||0)/PAGE_SIZE));
      const container = $('#pagination');
      container.classList.toggle('hidden', pages<=1);
      const span = $('#pagination-pages');
      span.textContent = `Page ${state.page} / ${pages}`;
      $('#prev-page').onclick = ()=>{ if(state.page>1){ state.page--; fetchProducts(); } };
      $('#next-page').onclick = ()=>{ if(state.page<pages){ state.page++; fetchProducts(); } };
      $('#prev-page-mobile').onclick = $('#prev-page').onclick;
      $('#next-page-mobile').onclick = $('#next-page').onclick;
    }

    // ===================== MODAL / PRODUCT CRUD =====================
    function resetProductForm(){
      $('#product-form').reset();
      $('#upload-previews').innerHTML = '';
      $('#upload-progress').classList.add('hidden');
      state.uploads = [];
    }

    function openProductModal(mode='add', product=null){
      resetProductForm();
      state.editing = mode==='edit' ? (product?._id || product?.id || product) : null;
      $('#modal-title span').textContent = mode==='edit' ? 'Edit Product' : 'Add New Product';
      if(mode==='edit' && product){
        $('#product-name').value = product.name || '';
        $('#product-price').value = product.price || 0;
        $('#product-stock').value = product.stock || 0;
        $('#product-description').value = product.description || '';
        const catId = product.category?._id || product.category?.id || product.category || '';
        if(catId) $('#product-category').value = catId;
        // Previews
        (product.images||[]).slice(0,6).forEach(url=> addPreview(null, url));
      }
      $('#product-modal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeProductModal(){
      $('#product-modal').classList.add('hidden');
    }

    function addPreview(file, url){
      const wrap = document.createElement('div');
      wrap.className = 'relative group';
      const imgUrl = url || URL.createObjectURL(file);
      wrap.innerHTML = `
        <img src="${imgUrl}" class="w-full h-28 object-cover rounded-lg border"/>
        <button type="button" class="absolute top-1 right-1 bg-white/90 hover:bg-white text-gray-700 rounded-full p-1 shadow" title="Remove">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>`;
      wrap.querySelector('button').onclick = ()=>{ wrap.remove(); state.uploads = state.uploads.filter(u=>u.url!==imgUrl); };
      $('#upload-previews').appendChild(wrap);
      state.uploads.push({ file, url: imgUrl });
      lucide.createIcons();
    }

    function bindUploadArea(){
      const drop = $('#upload-drop');
      const input = $('#product-images');
      $('#pick-images').onclick = ()=> input.click();
      input.onchange = (e)=> Array.from(e.target.files).slice(0,6 - state.uploads.length).forEach(f=> addPreview(f));
      ;['dragenter','dragover'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('dragover'); }));
      ;['dragleave','drop'].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('dragover'); }));
      drop.addEventListener('drop', e=>{
        const files = Array.from(e.dataTransfer.files).filter(f=>/image\//.test(f.type));
        files.slice(0,6 - state.uploads.length).forEach(f=> addPreview(f));
      });
    }

    async function saveProduct(e){
      e.preventDefault();
      const name = $('#product-name').value.trim();
      const category = $('#product-category').value;
      const price = parseFloat($('#product-price').value || '0');
      const stock = parseInt($('#product-stock').value || '0',10);
      const description = $('#product-description').value.trim();
      if(!name || !category){ showToast('Name and category are required','warning'); return; }

      // Prepare form-data for images + fields
      const fd = new FormData();
      fd.append('name', name);
      fd.append('category', category);
      fd.append('price', price);
      fd.append('stock', stock);
      if(description) fd.append('description', description);
      state.uploads.forEach((u,idx)=>{ if(u.file) fd.append('images', u.file, u.file.name || `img_${idx}.jpg`); });

      const isEdit = !!state.editing;
      const url = isEdit ? `${API_BASE}/seller/products/${state.editing}` : `${API_BASE}/seller/products`;
      const method = isEdit ? 'put' : 'post';

      const bar = $('#upload-progress');
      const fill = $('#upload-progress-fill');
      bar.classList.remove('hidden'); fill.style.width = '0%';

      try{
        await axios({ method, url, data: fd, headers:{...authHeader(), 'Content-Type':'multipart/form-data'}, onUploadProgress: (e)=>{
          if(e.total){ const pct = Math.round( (e.loaded/e.total)*100 ); fill.style.width = pct+'%'; }
        }});
        showToast(isEdit?'Product updated':'Product created','success');
        closeProductModal();
        await fetchProducts();
      }catch(err){
        console.error(err);
        showToast(err?.response?.data?.message || 'Save failed','error');
      }finally{
        bar.classList.add('hidden');
      }
    }

    async function deleteProduct(p){
      if(!confirm(`Delete "${p.name}"?`)) return;
      try{
        await axios.delete(`${API_BASE}/seller/products/${p._id || p.id}`, { headers: authHeader() });
        showToast('Product deleted','success');
        await fetchProducts();
      }catch(err){
        console.error(err);
        showToast('Delete failed','error');
      }
    }

    async function toggleProductStatus(p){
      try{
        const active = !(p.active !== false); // invert
        await axios.patch(`${API_BASE}/seller/products/${p._id || p.id}`, { active: !active }, { headers: authHeader() });
        showToast(active? 'Disabled' : 'Enabled', 'info');
        await fetchProducts();
      }catch(err){
        console.error(err);
        showToast('Status update failed','error');
      }
    }

    // ===================== BOOTSTRAP =====================
    function bindAuthUI(){
      $('#login-tab').onclick = ()=> switchTab('login');
      $('#register-tab').onclick = ()=> switchTab('register');
      $('#login-form').addEventListener('submit', handleLogin);
      $('#register-form').addEventListener('submit', handleRegister);
      $('#forgot-password-btn').onclick = ()=> showToast('Password reset flow coming soon','info');
    }

    function bindDashboardUI(){
      $('#logout-btn').onclick = logout;
      $('#add-product-btn').onclick = ()=> openProductModal('add');
      $('#add-first-product-btn').onclick = ()=> openProductModal('add');
      $('#product-search').addEventListener('input', ()=> { state.page=1; fetchProducts(); });
      $('#category-filter').addEventListener('change', ()=> { state.page=1; fetchProducts(); });
      $('#refresh-categories-btn').onclick = ()=> loadCategories(false);
      $('#toggle-debug').onclick = ()=> $('#debug-info').classList.toggle('hidden');

      // Modal
      $('#close-modal-btn').onclick = closeProductModal;
      $('#cancel-product').onclick = closeProductModal;
      $('#product-form').addEventListener('submit', saveProduct);
      bindUploadArea();
    }

    async function bootstrapAfterAuth(){
      $('#seller-name').textContent = state.seller?.name || state.seller?.fullName || 'Seller';
      $('#wallet-balance').textContent = (state.seller?.walletBalance!=null) ? formatINR(state.seller.walletBalance) : '0.00';
      updateDebug();
      await loadCategories();
      await fetchProducts();
    }

    async function init(){
      bindAuthUI();
      bindDashboardUI();
      if(state.token){
        try{
          showDashboard();
          await bootstrapAfterAuth();
        }catch(err){
          console.warn('Auto-login failed, clearing.', err);
          logout();
        }
      }else{
        showAuth();
      }
      lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>