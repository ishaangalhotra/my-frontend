<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QuickLocal — Seller Dashboard</title>
  <meta name="color-scheme" content="light dark">

  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* =====================
       Clean, Minimal UI with Dark Mode
       ===================== */
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --ink-900: #0f172a;
      --ink-700: #334155;
      --ink-500: #64748b;
      --line: #e5e7eb;
      --brand: #6d5ef9;
      --brand-600: #5b4df4;
      --ok: #16a34a; --warn: #f59e0b; --err: #ef4444;
      --shadow: 0 6px 18px rgba(15,23,42,.06);
      --radius: 14px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #111827;
        --panel: #1f2937;
        --ink-900: #f3f4f6;
        --ink-700: #9ca3af;
        --ink-500: #6b7280;
        --line: #374151;
        --shadow: 0 6px 18px rgba(0,0,0,.15);
      }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--ink-900); background: var(--bg);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      transition: background-color .2s ease, color .2s ease;
    }
    .hidden { display: none !important; }

    /* Layout */
    .app { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
    header.appbar { position: sticky; top: 0; z-index: 20; background: rgba(255,255,255,.8); backdrop-filter: saturate(150%) blur(8px); border-bottom: 1px solid var(--line); }
    @media (prefers-color-scheme: dark) { header.appbar { background: rgba(31,41,55,.8); } }
    header .wrap { max-width: 1200px; margin: 0 auto; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
    main { max-width: 1200px; margin: 0 auto; padding: 24px; }

    /* Sidebar */
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 260px; background: #101827; color: #fff; border-right: 1px solid rgba(255,255,255,.06); padding: 14px; z-index: 30; transition: transform .25s ease; display:flex; flex-direction:column; }
    .sb-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .sb-title { font-weight: 800; font-size: 1.2rem; }
    nav { display: grid; gap: 4px; }
    nav a { display: flex; align-items: center; gap: 10px; color: rgba(255,255,255,.85); text-decoration: none; padding: 10px 12px; border-radius: 10px; }
    nav a:hover { background: rgba(255,255,255,.08); }
    nav a.active { background: var(--brand); color: #fff; }
    .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; z-index: 25; }
    .backdrop.show { display: block; }
    @media (max-width: 1024px) { .app { grid-template-columns: 1fr; } .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } }

    /* Containers & Grids */
    .grid-stats { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 1rem; }
    .grid-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-top: 1rem; }
    .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem; }
    @media (max-width: 900px) { .grid-stats { grid-template-columns: repeat(2, minmax(0,1fr)); } .grid-layout { grid-template-columns: 1fr; } }
    @media (max-width: 560px) { .grid-stats { grid-template-columns: 1fr; } }

    .card { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); padding: 1rem; }
    .section { display: none; }
    .section.show { display: block; }

    /* Controls & Elements */
    .btn { display: inline-flex; align-items: center; justify-content:center; gap: 8px; padding: 10px 16px; border-radius: 12px; border: 1.5px solid var(--brand); background: var(--brand); color: #fff; font-weight: 600; cursor: pointer; transition: background-color .2s ease; }
    .btn:hover { background: var(--brand-600); border-color: var(--brand-600); }
    .btn.ghost { background: transparent; color: var(--brand); }
    .btn.ghost:hover { background: rgba(109,94,249,.1); }
    .btn.danger { border-color: var(--err); background: var(--err); }
    .btn:disabled { background: var(--ink-500); border-color: var(--ink-500); cursor: not-allowed; }

    .input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid var(--line); border-radius: 12px; outline: none; background: var(--panel); color: var(--ink-900); font-size: 1rem; }
    .input:focus, select:focus, textarea:focus { border-color: var(--brand); box-shadow: 0 0 0 4px rgba(109,94,249,.1); }

    .form-grid { display: grid; gap: 1rem; grid-template-columns: repeat(2,minmax(0,1fr)); }
    @media(max-width: 720px){ .form-grid { grid-template-columns: 1fr; } }
    .form-grid .full-span { grid-column: 1 / -1; }

    .badge { display: inline-block; padding: 4px 10px; border-radius: 999px; font-size: .75rem; font-weight:600; background: #eef2ff; color: #3730a3; }
    .product-img { width: 100%; height: 160px; border-radius: 12px; object-fit: cover; background: #e5e7eb; }

    /* Toast */
    #toast { position: fixed; right: 1rem; top: 1rem; z-index: 60; display: none; align-items: center; gap: .5rem; padding: .9rem 1rem; border-radius: 12px; color: #fff; }
    #toast.show { display: flex; }
    .toast-success { background: linear-gradient(135deg, #16a34a, #22c55e); }
    .toast-error { background: linear-gradient(135deg, #ef4444, #dc2626); }

    /* Modal */
    #modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); z-index: 70; }
    #modal.show { display: flex; }
    .modal-card { width: min(560px, 92vw); }

    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, rgba(0,0,0,.06) 25%, rgba(255,255,255,.35) 50%, rgba(0,0,0,.06) 75%); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
    @media (prefers-color-scheme: dark) { .skeleton { background: linear-gradient(90deg, rgba(255,255,255,.06) 25%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.06) 75%); background-size: 200% 100%; animation: shimmer 1.2s infinite; } }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    
    .status-badge { 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 12px; 
      font-weight: 500; 
    }
    .status-active { 
      background: #dcfce7; 
      color: #166534; 
    }
    .status-draft { 
      background: #fef3c7; 
      color: #92400e; 
    }
  </style>
</head>
<body>
  <section id="auth" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1rem">
    <div class="card" style="width:min(440px, 92vw)">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:.5rem"><i data-lucide="store"></i><h1 style="font-size:1.2rem; margin:0;">QuickLocal Seller</h1></div>
      <p style="color:var(--ink-500);margin-top:0;margin-bottom:1rem">Sign in or create your seller account.</p>
      <div style="display:flex;gap:.5rem;margin-bottom:1rem">
        <button id="tab-login" class="btn" style="flex:1"><i data-lucide="log-in"></i>Login</button>
        <button id="tab-register" class="btn ghost" style="flex:1"><i data-lucide="user-plus"></i>Register</button>
      </div>
      <form id="form-login" style="display:grid;gap:.75rem">
        <input id="login-email" type="email" class="input" placeholder="Email" required>
        <input id="login-pass" type="password" class="input" placeholder="Password" required>
        <label style="display:flex;align-items:center;gap:8px;font-size:.9rem;color:var(--ink-700)">
          <input id="remember-me" type="checkbox">
          Remember me for 30 days
        </label>
        <button class="btn" type="submit"><i data-lucide="arrow-right"></i> Sign in</button>
      </form>
      <form id="form-register" class="hidden" style="display:grid;gap:.75rem">
        <input id="reg-name" type="text" class="input" placeholder="Full name" required>
        <input id="reg-email" type="email" class="input" placeholder="Email" required>
        <input id="reg-pass" type="password" class="input" placeholder="Password (min 6 chars)" minlength="6" required>
        <input id="reg-phone" type="tel" class="input" placeholder="Phone number (optional)">
        <button class="btn" type="submit"><i data-lucide="sparkles"></i> Create Seller Account</button>
      </form>
    </div>
  </section>

  <section id="app" class="hidden">
    <div class="app">
      <aside class="sidebar" id="sidebar">
        <div class="sb-head">
          <div class="sb-title">QuickLocal</div>
          <button id="close-sidebar" class="btn ghost" style="padding:6px 8px; color:white;" aria-label="Close sidebar"><i data-lucide="x"></i></button>
        </div>
        <nav>
          <a href="#" class="active" data-page="dashboard"><i data-lucide="layout-dashboard"></i>Dashboard</a>
          <a href="#" data-page="products"><i data-lucide="package"></i>Products <span class="badge" id="badge-products">0</span></a>
          <a href="#" data-page="orders"><i data-lucide="shopping-cart"></i>Orders <span class="badge" id="badge-orders">0</span></a>
          <a href="#" data-page="customers"><i data-lucide="users"></i>Customers</a>
          <a href="#" data-page="analytics"><i data-lucide="bar-chart-3"></i>Analytics</a>
          <a href="#" data-page="settings"><i data-lucide="settings"></i>Settings</a>
        </nav>
        <div style="margin-top:auto">
          <button id="btn-logout" class="btn danger" style="width:100%"><i data-lucide="log-out"></i>Logout</button>
        </div>
      </aside>
      <div class="backdrop" id="backdrop"></div>

      <div>
        <header class="appbar">
          <div class="wrap">
            <div style="display:flex;align-items:center;gap:10px">
              <button id="open-sidebar" class="btn ghost" style="padding:6px 8px" aria-label="Open sidebar"><i data-lucide="menu"></i></button>
              <div style="font-weight:700; font-size:1.1rem">Seller Dashboard</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px">
              <span class="badge" style="background:#ecfdf5;color:#065f46">Online</span>
              <span id="whoami" style="font-weight:600">Seller</span>
            </div>
          </div>
        </header>

        <main>
          <section id="page-dashboard" class="section show">
            <div class="grid-stats">
              <div class="card"><div style="color:var(--ink-500)">Total Sales</div><div style="font-size:1.5rem;font-weight:800" id="stat-sales">₹0</div></div>
              <div class="card"><div style="color:var(--ink-500)">Orders</div><div style="font-size:1.5rem;font-weight:800" id="stat-orders">0</div></div>
              <div class="card"><div style="color:var(--ink-500)">Products</div><div style="font-size:1.5rem;font-weight:800" id="stat-products">0</div></div>
              <div class="card"><div style="color:var(--ink-500)">Customers</div><div style="font-size:1.5rem;font-weight:800" id="stat-customers">0</div></div>
            </div>
            <div class="grid-layout">
              <div class="card">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><h2>Sales Overview</h2><span style="color:var(--ink-500)">Last 7 days</span></div>
                <canvas id="salesChart" height="120"></canvas>
              </div>
              <div class="card">
                <h2>Recent Activity</h2>
                <div id="recent-activity" style="margin-top:.75rem;"></div>
              </div>
            </div>
          </section>

          <section id="page-products" class="section">
            <div class="card">
              <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
                <h2>Product Management</h2>
                <div style="display:flex;gap:10px;">
                  <button id="btn-reset" class="btn ghost"><i data-lucide="rotate-ccw"></i>Reset Form</button>
                </div>
              </div>
              <form id="form-product" class="form-grid">
                <div><label for="p-name">Product Name *</label><input id="p-name" class="input" required placeholder="e.g., Premium Running Shoes" maxlength="100"/></div>
                <div><label for="p-category">Category *</label><select id="p-category" class="input" required><option value="">Select category</option></select></div>
                <div><label for="p-price">Selling Price (₹) *</label><input id="p-price" class="input" type="number" min="0" step="0.01" required /></div>
                <div><label for="p-original-price">Original Price (₹)</label><input id="p-original-price" class="input" type="number" min="0" step="0.01" placeholder="For discount display" /></div>
                <div><label for="p-stock">Stock Quantity *</label><input id="p-stock" class="input" type="number" min="0" required /></div>
                <div><label for="p-cost">Cost per Item (₹)</label><input id="p-cost" class="input" type="number" min="0" step="0.01" placeholder="For profit tracking" /></div>
                <div class="full-span"><label for="p-desc">Description</label><textarea id="p-desc" class="input" rows="3" placeholder="Describe your product..." maxlength="1000"></textarea></div>
                <div class="full-span"><label for="p-tags">Tags</label><input id="p-tags" class="input" placeholder="e.g., shoes, running, sports (comma separated)"/></div>
                <div class="full-span">
                  <label>Product Images (Max 8)</label>
                  <div id="drop" class="card" style="text-align:center;border-style:dashed;cursor:pointer;padding:1.5rem;">
                    <div style="color:var(--ink-500);display:flex;align-items:center;justify-content:center;gap:.5rem;"><i data-lucide="upload-cloud"></i> Drag & drop images, or click to browse</div>
                    <input id="p-images" type="file" accept="image/*" multiple class="hidden" />
                  </div>
                  <div id="previews" class="grid-cards" style="margin-top:1rem"></div>
                </div>
                <div class="full-span" style="display:flex;gap:10px;align-items:center;">
                  <label style="display:flex;align-items:center;gap:8px;">
                    <input id="p-published" type="checkbox" checked>
                    Publish immediately
                  </label>
                </div>
                <div class="full-span" style="display:flex;gap:10px">
                  <button class="btn" type="submit" id="btn-save"><i data-lucide="save"></i><span id="save-text">Save Product</span></button>
                  <button class="btn danger" type="button" id="btn-delete" disabled><i data-lucide="trash-2"></i>Delete Product</button>
                </div>
              </form>
            </div>

            <div class="card" style="margin-top:1rem">
              <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1rem">
                <h2>Your Products</h2>
                <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;">
                  <select id="filter-status" class="input" style="width:120px;">
                    <option value="all">All Status</option>
                    <option value="active">Active</option>
                    <option value="draft">Draft</option>
                  </select>
                  <input id="q" class="input" placeholder="Search products..." style="width:220px" />
                  <button id="btn-search" class="btn ghost" aria-label="Search"><i data-lucide="search"></i></button>
                </div>
              </div>
              <div id="grid" class="grid-cards"></div>
              <div id="pagination" style="display:flex;justify-content:center;align-items:center;gap:10px;margin-top:1rem;"></div>
            </div>
          </section>

          <section id="page-orders" class="section"><div class="card"><h2>Order Management</h2><div id="orders" style="display:grid;gap:.75rem;margin-top:1rem"></div></div></section>
          <section id="page-analytics" class="section"><div class="card"><h2>Business Analytics</h2><canvas id="analyticsChart" height="160" style="margin-top:1rem"></canvas></div></section>
          <section id="page-customers" class="section"><div class="card"><h2>Customers</h2><div id="customers" style="display:grid;gap:.75rem;margin-top:1rem"></div></div></section>
          <section id="page-settings" class="section">
            <div class="card">
              <h2>Store Settings</h2>
              <div style="display:grid;gap:1rem;margin-top:1rem;">
                <label style="display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--line);border-radius:12px">
                  <span>Store Status</span>
                  <input id="toggle-store" type="checkbox" checked>
                </label>
                <label style="display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--line);border-radius:12px">
                  <span>Low Stock Alerts</span>
                  <input id="toggle-lowstock" type="checkbox" checked>
                </label>
                <label style="display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--line);border-radius:12px">
                  <span>Email Notifications</span>
                  <input id="toggle-email" type="checkbox" checked>
                </label>
              </div>
            </div>
          </section>
        </main>
      </div>
    </div>
  </section>

  <div id="toast" role="status" aria-live="polite"></div>
  <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="card modal-card">
      <div style="display:flex;align-items:center;justify-content:space-between"><strong id="modal-title">Confirm Action</strong><button id="modal-x" class="btn ghost" style="padding:6px 8px" aria-label="Close modal"><i data-lucide="x"></i></button></div>
      <div id="modal-body" style="margin:10px 0;color:var(--ink-700)">Are you sure you want to proceed?</div>
      <div style="display:flex;gap:8px;justify-content:end"><button id="modal-cancel" class="btn ghost">Cancel</button><button id="modal-ok" class="btn">OK</button></div>
    </div>
  </div>

<script>
// ====== CONFIG ======
const API_BASE = 'https://quicklocal-backend.onrender.com/api/v1';
const ENDPOINTS = {
  auth: { 
    login: API_BASE + '/auth/login', 
    register: API_BASE + '/auth/register', 
    me: API_BASE + '/auth/me',
    logout: API_BASE + '/auth/logout',
    refreshToken: API_BASE + '/auth/refresh-token'
  },
  categories: API_BASE + '/categories',
  products: {
    listMine: API_BASE + '/seller/products',
    create: API_BASE + '/seller/products',
    update: id => API_BASE + '/seller/products/' + id,
    remove: id => API_BASE + '/seller/products/' + id,
  },
  orders: { 
    listMine: API_BASE + '/seller/orders', 
    updateStatus: id => API_BASE + '/seller/orders/' + id + '/status' 
  },
  customers: API_BASE + '/seller/customers',
  dashboard: API_BASE + '/seller/dashboard'
};

// Enhanced axios instance with better error handling
const api = axios.create({ 
  baseURL: API_BASE, 
  withCredentials: true, 
  timeout: 60000, // FIX 2: Increased timeout to 60 seconds
  headers: {
    'Content-Type': 'application/json'
  }
});

// Request interceptor
api.interceptors.request.use(config => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    config.headers.Authorization = 'Bearer ' + token;
  }
  return config;
}, error => Promise.reject(error));

// FIX 1: Enhanced response interceptor with token refresh
api.interceptors.response.use(
  (response) => {
    // IMPROVEMENT: Normalize successful responses
    if (response.data && Array.isArray(response.data.data)) {
      return response.data.data;
    }
    return response.data;
  },
  async (error) => {
    const originalRequest = error.config;
    
    // Check if the error is 401 and we haven't already tried refreshing
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true; // Mark that we've tried once

      try {
        // Attempt to get a new access token
        const { data } = await api.post(ENDPOINTS.auth.refreshToken);
        if (data.accessToken) {
            localStorage.setItem('accessToken', data.accessToken);
        }
        // Retry the original request that failed
        return api(originalRequest);
      } catch (refreshError) {
        // If refreshing fails, then log the user out
        localStorage.removeItem('accessToken');
        localStorage.removeItem('seller');
        setAuth(false);
        toast('Session expired. Please log in again.', 'error');
        return Promise.reject(refreshError);
      }
    }
    return Promise.reject(error);
  }
);

// ====== UTILITIES ======
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function icon() {
  try { 
    lucide.createIcons(); 
  } catch(e) { 
    console.warn('Lucide icons failed to load:', e); 
  }
}

function inr(n) {
  try {
    return new Intl.NumberFormat('en-IN', {
      style: 'currency',
      currency: 'INR',
      maximumFractionDigits: 0
    }).format(n || 0);
  } catch {
    return '₹' + (n || 0);
  }
}

function toast(msg, type = 'success', ms = 3000) {
  const el = $('#toast');
  el.textContent = '';
  el.className = '';
  el.classList.add(type === 'success' ? 'toast-success' : 'toast-error', 'show');
  el.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'x-circle'}"></i><span>${msg}</span>`;
  icon();
  setTimeout(() => {
    el.classList.remove('show');
  }, ms);
}

function modal({ title = 'Confirm', body = 'Are you sure?', onOk = null }) {
  $('#modal-title').textContent = title;
  $('#modal-body').textContent = body;
  const m = $('#modal');
  m.classList.add('show');
  const close = () => m.classList.remove('show');
  $('#modal-x').onclick = close;
  $('#modal-cancel').onclick = close;
  $('#modal-ok').onclick = () => {
    if (onOk) onOk();
    close();
  };
}

function setAuth(isAuthenticated) {
  $('#auth').classList.toggle('hidden', isAuthenticated);
  $('#app').classList.toggle('hidden', !isAuthenticated);
}

// ====== NAVIGATION ======
let currentPage = 'dashboard';
let currentProductPage = 1;

function setPage(pageId) {
  currentPage = pageId;
  
  // Hide all sections
  $$('.section').forEach(s => s.classList.remove('show'));
  $('#page-' + pageId).classList.add('show');

  // Update nav active state
  $$('nav a').forEach(a => a.classList.remove('active'));
  const navLink = $(`nav a[data-page="${pageId}"]`);
  if (navLink) navLink.classList.add('active');

  // Load page-specific data
  switch (pageId) {
    case 'dashboard':
      loadDashboard();
      break;
    case 'products':
      loadCategories();
      listMyProducts();
      break;
    case 'orders':
      listOrders();
      break;
    case 'customers':
      listCustomers();
      break;
    case 'analytics':
      loadAnalytics();
      break;
  }

  icon();
}

// ====== AUTHENTICATION ======
async function doLogin(e) {
  e.preventDefault();
  
  const email = $('#login-email').value.trim();
  const password = $('#login-pass').value;
  const remember = $('#remember-me').checked;

  if (!email || !password) {
    toast('Please fill in all fields', 'error');
    return;
  }

  const btn = e.target.querySelector('button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i data-lucide="loader-2"></i> Signing in...';
  btn.disabled = true;

  try {
    const { data } = await api.post(ENDPOINTS.auth.login, {
      email,
      password,
      remember
    });

    if (data?.success) {
      const accessToken = data.accessToken || data.data?.accessToken;
      const user = data.user || data.data?.user || { email: email, name: email.split('@')[0] };
      
      if (accessToken) {
        localStorage.setItem('accessToken', accessToken);
      }
      localStorage.setItem('seller', JSON.stringify(user));
      
      await loadUserProfile();
      setAuth(true);
      setPage('dashboard');
      
      toast(`Welcome back, ${user.name || 'Seller'}!`, 'success');
    } else {
      throw new Error(data?.message || 'Invalid response from server');
    }
  } catch (err) {
    console.error('Login error:', err);
    const message = err?.response?.data?.message || err.message || 'Login failed';
    toast(message, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
    icon();
  }
}

async function doRegister(e) {
  e.preventDefault();
  
  const name = $('#reg-name').value.trim();
  const email = $('#reg-email').value.trim();
  const password = $('#reg-pass').value;
  const phone = $('#reg-phone').value.trim();

  if (!name || !email || !password) {
    toast('Please fill in all required fields', 'error');
    return;
  }
  
  if (password.length < 6) {
    toast('Password must be at least 6 characters', 'error');
    return;
  }

  const btn = e.target.querySelector('button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i data-lucide="loader-2"></i> Creating account...';
  btn.disabled = true;

  try {
    const requestData = {
      name,
      email,
      password,
      role: 'seller'
    };
    
    if (phone) {
      requestData.phone = phone;
    }

    const { data } = await api.post(ENDPOINTS.auth.register, requestData);

    if (data?.success) {
      toast(data.message || 'Seller account created successfully!', 'success');
      $('#tab-login').click();
      $('#form-register').reset();
    } else {
      throw new Error(data?.message || 'Registration failed');
    }
  } catch (err) {
    console.error('Registration error:', err);
    let message = 'Registration failed';
    
    if (err?.response?.data?.message) {
      message = err.response.data.message;
    } else if (err?.response?.data?.errors && Array.isArray(err.response.data.errors)) {
      message = err.response.data.errors.map(e => e.msg || e.message).join(', ');
    } else if (err.message) {
      message = err.message;
    }
    
    toast(message, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
    icon();
  }
}

async function doLogout(e) {
  if (e && e.preventDefault) e.preventDefault();
  
  try {
    await api.post(ENDPOINTS.auth.logout);
  } catch (err) {
    console.warn('Logout API call failed:', err);
  } finally {
    localStorage.removeItem('accessToken');
    localStorage.removeItem('seller');
    setAuth(false);
    toast('Logged out successfully', 'success');
  }
}

async function loadUserProfile() {
  try {
    const { data } = await api.get(ENDPOINTS.auth.me);
    // Handle different possible response structures
    const user = data?.user || data?.data?.user || data?.data || JSON.parse(localStorage.getItem('seller') || '{}');
    $('#whoami').textContent = user?.name || user?.email || 'Seller';
    return user;
  } catch (err) {
    console.warn('Failed to load user profile:', err);
    const user = JSON.parse(localStorage.getItem('seller') || '{}');
    $('#whoami').textContent = user?.name || user?.email || 'Seller';
    return user;
  }
}

// ====== CATEGORIES & PRODUCTS ======
async function loadCategories() {
  try {
    const { data } = await api.get(ENDPOINTS.categories);
    
    // Handle different response structures
    let categories = [];
    if (Array.isArray(data)) {
      categories = data;
    } else if (Array.isArray(data?.data)) {
      categories = data.data;
    } else if (data?.data?.categories) {
      categories = data.data.categories;
    } else if (data?.categories) {
      categories = data.categories;
    }
    
    const select = $('#p-category');
    select.innerHTML = '<option value="">Select category</option>';
    
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat._id || cat.id;
      option.textContent = cat.name;
      select.appendChild(option);
    });
  } catch (err) {
    console.error('Failed to load categories:', err);
    toast('Could not load categories', 'error');
  }
}

async function listMyProducts(page = 1) {
  try {
    const status = $('#filter-status').value;
    const q = $('#q').value.trim();
    
    let url = `${ENDPOINTS.products.listMine}?page=${page}&limit=12`;
    if (status !== 'all') url += `&status=${status}`;
    if (q) url += `&q=${encodeURIComponent(q)}`;
    
    const products = await api.get(url);
    
    // Handle different response structures
    let productsList = [];
    let paginationInfo = { totalPages: 1, currentPage: page };
    
    if (Array.isArray(products)) {
      productsList = products;
    } else if (Array.isArray(products?.data)) {
      productsList = products.data;
      paginationInfo = products.pagination || { totalPages: 1, currentPage: page };
    } else if (Array.isArray(products?.data?.products)) {
      productsList = products.data.products;
      paginationInfo = products.data.pagination || { totalPages: 1, currentPage: page };
    }
    
    renderProducts(productsList);
    renderPagination(paginationInfo);
    
    // Update product count badges
    const count = productsList.length;
    $('#badge-products').textContent = count;
    $('#stat-products').textContent = count;
  } catch (err) {
    console.error('Failed to load products:', err);
    toast('Could not load products', 'error');
  }
}

function renderProducts(products) {
  const grid = $('#grid');
  
  if (!products || products.length === 0) {
    grid.innerHTML = `<div class="card" style="text-align:center;padding:2rem;grid-column:1/-1"><i data-lucide="package" style="font-size:3rem;opacity:.3"></i><p style="margin-top:1rem;color:var(--ink-500)">No products found</p></div>`;
    icon();
    return;
  }
  
  grid.innerHTML = products.map(p => `
    <div class="card" data-id="${p._id || p.id}" style="cursor:pointer">
      <div style="position:relative">
        <img src="${p.images?.[0] || 'https://via.placeholder.com/300x200?text=No+Image'}" class="product-img" alt="${p.name}">
        <span class="status-badge ${p.status === 'active' ? 'status-active' : 'status-draft'}" style="position:absolute;top:8px;left:8px">
          ${p.status === 'active' ? 'Active' : 'Draft'}
        </span>
      </div>
      <div style="margin-top:.5rem">
        <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:.5rem">
          <span style="font-weight:700">${inr(p.price)}</span>
          <span style="color:var(--ink-500)">Stock: ${p.stock || 0}</span>
        </div>
      </div>
    </div>
  `).join('');
  
  // Add click handlers
  $$('#grid > .card').forEach(el => {
    el.addEventListener('click', () => editProduct(el.dataset.id, products.find(p => (p._id || p.id) === el.dataset.id)));
  });
  
  icon();
}

function renderPagination({ totalPages, currentPage }) {
  const container = $('#pagination');
  
  if (totalPages <= 1) {
    container.innerHTML = '';
    return;
  }
  
  let html = '';
  
  // Previous button
  html += `<button class="btn ghost" ${currentPage <= 1 ? 'disabled' : ''} data-page="${currentPage - 1}"><i data-lucide="chevron-left"></i></button>`;
  
  // Page numbers
  for (let i = 1; i <= totalPages; i++) {
    if (i === currentPage) {
      html += `<button class="btn" disabled>${i}</button>`;
    } else {
      html += `<button class="btn ghost" data-page="${i}">${i}</button>`;
    }
  }
  
  // Next button
  html += `<button class="btn ghost" ${currentPage >= totalPages ? 'disabled' : ''} data-page="${currentPage + 1}"><i data-lucide="chevron-right"></i></button>`;
  
  container.innerHTML = html;
  
  // Add event listeners
  $$('#pagination button[data-page]').forEach(btn => {
    btn.addEventListener('click', () => {
      currentProductPage = parseInt(btn.dataset.page);
      listMyProducts(currentProductPage);
    });
  });
  
  icon();
}

function editProduct(id, product) {
  if (!product) return;
  
  // Populate form
  $('#p-name').value = product.name || '';
  $('#p-category').value = product.category?._id || product.category || '';
  $('#p-price').value = product.price || '';
  $('#p-original-price').value = product.originalPrice || '';
  $('#p-stock').value = product.stock || '';
  $('#p-cost').value = product.cost || '';
  $('#p-desc').value = product.description || '';
  $('#p-tags').value = product.tags?.join(', ') || '';
  $('#p-published').checked = product.status === 'active';
  
  // Set form mode
  $('#form-product').dataset.mode = 'edit';
  $('#form-product').dataset.id = id;
  $('#save-text').textContent = 'Update Product';
  $('#btn-delete').disabled = false;
  
  // Show images
  const previews = $('#previews');
  previews.innerHTML = '';
  
  if (product.images && product.images.length > 0) {
    product.images.forEach(img => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<img src="${img}" class="product-img" style="height:120px"><button type="button" class="btn danger" style="width:100%;margin-top:.5rem"><i data-lucide="trash-2"></i> Remove</button>`;
      previews.appendChild(div);
    });
  }
  
  // Scroll to form
  $('#form-product').scrollIntoView({ behavior: 'smooth' });
  icon();
}

async function saveProduct(e) {
  e.preventDefault();
  
  const form = e.target;
  const isEdit = form.dataset.mode === 'edit';
  const id = form.dataset.id;
  
  // Basic validation
  const name = $('#p-name').value.trim();
  const category = $('#p-category').value;
  const price = parseFloat($('#p-price').value);
  const stock = parseInt($('#p-stock').value);
  
  if (!name || !category || isNaN(price) || price <= 0 || isNaN(stock) || stock < 0) {
    toast('Please fill in all required fields with valid values', 'error');
    return;
  }
  
  const btn = $('#btn-save');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<i data-lucide="loader-2"></i> Saving...';
  btn.disabled = true;
  
  try {
    const productData = {
      name,
      category,
      price,
      stock,
      description: $('#p-desc').value.trim(),
      status: $('#p-published').checked ? 'active' : 'draft'
    };
    
    // Optional fields
    const originalPrice = parseFloat($('#p-original-price').value);
    if (!isNaN(originalPrice) && originalPrice > 0) {
      productData.originalPrice = originalPrice;
    }
    
    const cost = parseFloat($('#p-cost').value);
    if (!isNaN(cost) && cost >= 0) {
      productData.cost = cost;
    }
    
    const tags = $('#p-tags').value.split(',').map(t => t.trim()).filter(t => t);
    if (tags.length > 0) {
      productData.tags = tags;
    }
    
    let result;
    if (isEdit) {
      result = await api.put(ENDPOINTS.products.update(id), productData);
    } else {
      result = await api.post(ENDPOINTS.products.create, productData);
    }
    
    toast(`Product ${isEdit ? 'updated' : 'created'} successfully`, 'success');
    
    // Reset form and refresh list
    form.reset();
    delete form.dataset.mode;
    delete form.dataset.id;
    $('#save-text').textContent = 'Save Product';
    $('#btn-delete').disabled = true;
    $('#previews').innerHTML = '';
    
    listMyProducts(currentProductPage);
  } catch (err) {
    console.error('Failed to save product:', err);
    const message = err?.response?.data?.message || err.message || `Failed to ${isEdit ? 'update' : 'create'} product`;
    toast(message, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
    icon();
  }
}

async function deleteProduct() {
  const id = $('#form-product').dataset.id;
  if (!id) return;
  
  modal({
    title: 'Delete Product',
    body: 'Are you sure you want to delete this product? This action cannot be undone.',
    onOk: async () => {
      try {
        await api.delete(ENDPOINTS.products.remove(id));
        toast('Product deleted successfully', 'success');
        
        // Reset form and refresh list
        $('#form-product').reset();
        delete $('#form-product').dataset.mode;
        delete $('#form-product').dataset.id;
        $('#save-text').textContent = 'Save Product';
        $('#btn-delete').disabled = true;
        $('#previews').innerHTML = '';
        
        listMyProducts(currentProductPage);
      } catch (err) {
        console.error('Failed to delete product:', err);
        const message = err?.response?.data?.message || err.message || 'Failed to delete product';
        toast(message, 'error');
      }
    }
  });
}

// ====== ORDERS ======
async function listOrders() {
  try {
    const orders = await api.get(ENDPOINTS.orders.listMine);
    
    // Handle different response structures
    let ordersList = [];
    if (Array.isArray(orders)) {
      ordersList = orders;
    } else if (Array.isArray(orders?.data)) {
      ordersList = orders.data;
    } else if (Array.isArray(orders?.data?.orders)) {
      ordersList = orders.data.orders;
    }
    
    renderOrders(ordersList);
    
    // Update order count badge
    const count = ordersList.length;
    $('#badge-orders').textContent = count;
    $('#stat-orders').textContent = count;
  } catch (err) {
    console.error('Failed to load orders:', err);
    toast('Could not load orders', 'error');
  }
}

function renderOrders(orders) {
  const container = $('#orders');
  
  if (!orders || orders.length === 0) {
    container.innerHTML = `<div class="card" style="text-align:center;padding:2rem"><i data-lucide="shopping-cart" style="font-size:3rem;opacity:.3"></i><p style="margin-top:1rem;color:var(--ink-500)">No orders yet</p></div>`;
    icon();
    return;
  }
  
  container.innerHTML = orders.map(order => `
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem">
        <div>
          <div style="font-weight:600">Order #${order.orderId || order._id || order.id}</div>
          <div style="color:var(--ink-500);font-size:.9rem">${new Date(order.createdAt || order.date).toLocaleDateString()}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">${inr(order.totalAmount || order.amount || 0)}</div>
          <span class="badge" style="background:#fef3c7;color:#92400e">${order.status || 'pending'}</span>
        </div>
      </div>
      <div style="margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--line)">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>${order.items?.length || 0} items</div>
          <div>
            <select class="input" data-id="${order._id || order.id}" style="width:140px;padding:4px 8px;font-size:.9rem">
              <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
              <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
              <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
              <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  `).join('');
  
  // Add event listeners for status changes
  $$('#orders select').forEach(select => {
    select.addEventListener('change', async e => {
      const orderId = e.target.dataset.id;
      const newStatus = e.target.value;
      
      try {
        await api.patch(ENDPOINTS.orders.updateStatus(orderId), { status: newStatus });
        toast('Order status updated', 'success');
      } catch (err) {
        console.error('Failed to update order status:', err);
        toast('Failed to update order status', 'error');
        // Revert the select value
        e.target.value = order.status;
      }
    });
  });
  
  icon();
}

// ====== CUSTOMERS ======
async function listCustomers() {
  try {
    const customers = await api.get(ENDPOINTS.customers);
    
    // Handle different response structures
    let customersList = [];
    if (Array.isArray(customers)) {
      customersList = customers;
    } else if (Array.isArray(customers?.data)) {
      customersList = customers.data;
    } else if (Array.isArray(customers?.data?.customers)) {
      customersList = customers.data.customers;
    }
    
    renderCustomers(customersList);
    
    // Update customer count
    const count = customersList.length;
    $('#stat-customers').textContent = count;
  } catch (err) {
    console.error('Failed to load customers:', err);
    toast('Could not load customers', 'error');
  }
}

function renderCustomers(customers) {
  const container = $('#customers');
  
  if (!customers || customers.length === 0) {
    container.innerHTML = `<div class="card" style="text-align:center;padding:2rem"><i data-lucide="users" style="font-size:3rem;opacity:.3"></i><p style="margin-top:1rem;color:var(--ink-500)">No customers yet</p></div>`;
    icon();
    return;
  }
  
  container.innerHTML = customers.map(customer => `
    <div class="card">
      <div style="display:flex;align-items:center;gap:.75rem">
        <div style="width:48px;height:48px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:700;color:#6b7280">
          ${customer.name ? customer.name.charAt(0).toUpperCase() : customer.email ? customer.email.charAt(0).toUpperCase() : 'C'}
        </div>
        <div style="flex:1">
          <div style="font-weight:600">${customer.name || 'Unknown Customer'}</div>
          <div style="color:var(--ink-500);font-size:.9rem">${customer.email || 'No email'}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700">${customer.ordersCount || 0} orders</div>
          <div style="color:var(--ink-500);font-size:.9rem">${inr(customer.totalSpent || 0)} spent</div>
        </div>
      </div>
    </div>
  `).join('');
}

// ====== DASHBOARD ======
async function loadDashboard() {
  try {
    const dashboardData = await api.get(ENDPOINTS.dashboard);
    
    // Handle different response structures
    let stats = {};
    let recentActivity = [];
    let salesData = [];
    
    if (dashboardData?.data) {
      stats = dashboardData.data.stats || dashboardData.data;
      recentActivity = dashboardData.data.recentActivity || dashboardData.data.activities || [];
      salesData = dashboardData.data.salesData || dashboardData.data.chartData || [];
    } else {
      stats = dashboardData.stats || dashboardData;
      recentActivity = dashboardData.recentActivity || dashboardData.activities || [];
      salesData = dashboardData.salesData || dashboardData.chartData || [];
    }
    
    // Update stats
    $('#stat-sales').textContent = inr(stats.totalSales || stats.sales || 0);
    $('#stat-orders').textContent = stats.totalOrders || stats.orders || 0;
    $('#stat-products').textContent = stats.totalProducts || stats.products || 0;
    $('#stat-customers').textContent = stats.totalCustomers || stats.customers || 0;
    
    // Render sales chart
    renderSalesChart(salesData);
    
    // Render recent activity
    renderRecentActivity(recentActivity);
  } catch (err) {
    console.error('Failed to load dashboard:', err);
    toast('Could not load dashboard data', 'error');
  }
}

function renderSalesChart(data) {
  const ctx = $('#salesChart');
  if (!ctx) return;
  
  // FIX 3.1: Use instanceof check to avoid chart errors
  if (window.salesChart instanceof Chart) {
    window.salesChart.destroy();
  }
  
  // Default data if none provided
  const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const values = data && data.length > 0 ? data : [120, 190, 300, 500, 200, 300, 450];
  
  window.salesChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Sales (₹)',
        data: values,
        borderColor: '#6d5ef9',
        backgroundColor: 'rgba(109, 94, 249, 0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(0,0,0,0.05)' }
        },
        x: {
          grid: { display: false }
        }
      }
    }
  });
}

function renderRecentActivity(activities) {
  const container = $('#recent-activity');
  
  if (!activities || activities.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:1rem;color:var(--ink-500)">No recent activity</div>`;
    return;
  }
  
  container.innerHTML = activities.slice(0, 5).map(activity => `
    <div style="display:flex;align-items:flex-start;gap:.5rem;padding:.5rem 0;border-bottom:1px solid var(--line)">
      <div style="padding:4px;background:#eef2ff;border-radius:6px;color:#3730a3">
        <i data-lucide="${getActivityIcon(activity.type)}" style="width:16px;height:16px"></i>
      </div>
      <div style="flex:1">
        <div style="font-size:.9rem">${activity.message || 'Activity'}</div>
        <div style="font-size:.75rem;color:var(--ink-500)">${formatTimeAgo(activity.timestamp || activity.date)}</div>
      </div>
    </div>
  `).join('');
  
  icon();
}

function getActivityIcon(type) {
  const icons = {
    order: 'shopping-cart',
    product: 'package',
    customer: 'user',
    payment: 'credit-card',
    default: 'activity'
  };
  return icons[type] || icons.default;
}

function formatTimeAgo(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins} min ago`;
  if (diffHours < 24) return `${diffHours} hr ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
  return date.toLocaleDateString();
}

// ====== ANALYTICS ======
async function loadAnalytics() {
  try {
    // In a real app, this would fetch from an analytics endpoint
    // For now, we'll generate some sample data
    
    // FIX 3.2: Use instanceof check to avoid chart errors
    if (window.analyticsChart instanceof Chart) {
      window.analyticsChart.destroy();
    }
    
    const ctx = $('#analyticsChart');
    if (!ctx) return;
    
    // Sample data for analytics
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const salesData = [65, 59, 80, 81, 56, 55, 72, 68, 75, 80, 85, 90];
    const ordersData = [28, 48, 40, 45, 36, 35, 42, 50, 46, 52, 54, 60];
    
    window.analyticsChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: months,
        datasets: [
          {
            label: 'Sales (₹)',
            data: salesData,
            backgroundColor: 'rgba(109, 94, 249, 0.7)',
            borderColor: '#6d5ef9',
            borderWidth: 1
          },
          {
            label: 'Orders',
            data: ordersData,
            backgroundColor: 'rgba(34, 197, 94, 0.7)',
            borderColor: '#22c55e',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  } catch (err) {
    console.error('Failed to load analytics:', err);
    toast('Could not load analytics data', 'error');
  }
}

// ====== EVENT LISTENERS ======
function setupEventListeners() {
  // Auth tabs
  $('#tab-login').addEventListener('click', () => {
    $('#tab-login').classList.add('btn');
    $('#tab-login').classList.remove('btn', 'ghost');
    $('#tab-register').classList.remove('btn');
    $('#tab-register').classList.add('btn', 'ghost');
    $('#form-login').classList.remove('hidden');
    $('#form-register').classList.add('hidden');
  });
  
  $('#tab-register').addEventListener('click', () => {
    $('#tab-register').classList.add('btn');
    $('#tab-register').classList.remove('btn', 'ghost');
    $('#tab-login').classList.remove('btn');
    $('#tab-login').classList.add('btn', 'ghost');
    $('#form-register').classList.remove('hidden');
    $('#form-login').classList.add('hidden');
  });
  
  // Auth forms
  $('#form-login').addEventListener('submit', doLogin);
  $('#form-register').addEventListener('submit', doRegister);
  $('#btn-logout').addEventListener('click', doLogout);
  
  // Navigation
  $$('nav a').forEach(a => {
    a.addEventListener('click', e => {
      e.preventDefault();
      setPage(a.dataset.page);
    });
  });
  
  // Mobile sidebar
  $('#open-sidebar').addEventListener('click', () => {
    $('#sidebar').classList.add('open');
    $('#backdrop').classList.add('show');
  });
  
  $('#close-sidebar').addEventListener('click', () => {
    $('#sidebar').classList.remove('open');
    $('#backdrop').classList.remove('show');
  });
  
  $('#backdrop').addEventListener('click', () => {
    $('#sidebar').classList.remove('open');
    $('#backdrop').classList.remove('show');
  });
  
  // Product management
  $('#form-product').addEventListener('submit', saveProduct);
  $('#btn-delete').addEventListener('click', deleteProduct);
  $('#btn-reset').addEventListener('click', () => {
    $('#form-product').reset();
    delete $('#form-product').dataset.mode;
    delete $('#form-product').dataset.id;
    $('#save-text').textContent = 'Save Product';
    $('#btn-delete').disabled = true;
    $('#previews').innerHTML = '';
  });
  
  // Product search and filter
  $('#filter-status').addEventListener('change', () => listMyProducts(1));
  $('#btn-search').addEventListener('click', () => listMyProducts(1));
  $('#q').addEventListener('keypress', e => {
    if (e.key === 'Enter') listMyProducts(1);
  });
  
  // Image upload
  $('#drop').addEventListener('click', () => $('#p-images').click());
  $('#drop').addEventListener('dragover', e => {
    e.preventDefault();
    $('#drop').style.borderColor = '#6d5ef9';
  });
  $('#drop').addEventListener('dragleave', () => {
    $('#drop').style.borderColor = '';
  });
  $('#drop').addEventListener('drop', e => {
    e.preventDefault();
    $('#drop').style.borderColor = '';
    // Handle file drop
  });
  
  // Modal
  $('#modal-x').addEventListener('click', () => $('#modal').classList.remove('show'));
  $('#modal-cancel').addEventListener('click', () => $('#modal').classList.remove('show'));
}

// ====== INITIALIZATION ======
async function init() {
  setupEventListeners();
  icon();
  
  // Check if user is already logged in
  const token = localStorage.getItem('accessToken');
  const seller = localStorage.getItem('seller');
  
  if (token && seller) {
    try {
      await loadUserProfile();
      setAuth(true);
      setPage('dashboard');
    } catch (err) {
      console.error('Auth check failed:', err);
      localStorage.removeItem('accessToken');
      localStorage.removeItem('seller');
      setAuth(false);
    }
  }
}

// Start the app
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>