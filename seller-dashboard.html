<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>QuickLocal Seller Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fonts & Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-RXf+QSDCUQs6Q0yC6t5QbqFKdC5u1z9kQ1Z2gKZbZx0r7N3XrV94P3G1QFq7nXK3kqJ5uMZk9H0Z4w5q5Yf5w=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- Base styles (adjust paths if needed) -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/mobile-responsive.css" />

  <style>
    body {
      background: #f4f5fb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
    }

    .seller-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header.seller-header {
      background: #111827;
      color: #f9fafb;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
    }

    .seller-header .brand {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .seller-header .brand i {
      color: #22c55e;
    }

    .seller-header .actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .seller-header button {
      border-radius: 999px;
      border: none;
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .seller-header button.primary {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }

    .seller-header button.secondary {
      background: #1f2937;
      color: #e5e7eb;
    }

    main.seller-main {
      flex: 1;
      padding: 1rem 1.5rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.9rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: #ffffff;
      border-radius: 0.9rem;
      padding: 0.9rem 1rem;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .stat-card .label {
      font-size: 0.8rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .stat-card .value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #111827;
    }

    .stat-card .sub {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 1rem;
      gap: 0.25rem;
      flex-wrap: wrap;
    }

    .tab {
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      border-radius: 999px 999px 0 0;
      cursor: pointer;
      color: #6b7280;
      border: 1px solid transparent;
      border-bottom: none;
      background: transparent;
    }

    .tab.active {
      background: #ffffff;
      color: #111827;
      border-color: #e5e7eb;
      border-bottom: 1px solid #ffffff;
      font-weight: 600;
    }

    .tab-content {
      background: #ffffff;
      border-radius: 0 0 0.9rem 0.9rem;
      border: 1px solid #e5e7eb;
      padding: 1rem;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
      margin-bottom: 2rem;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.9rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .section-header h2 {
      font-size: 1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .section-header .right-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .section-header select,
    .section-header input {
      font-size: 0.85rem;
      padding: 0.35rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      min-width: 160px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .btn.primary {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }

    .btn.outline {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #374151;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      border-radius: 999px;
      padding: 0.15rem 0.5rem;
      font-size: 0.75rem;
      background: #f3f4f6;
      color: #4b5563;
    }

    .product-table,
    .orders-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .product-table th,
    .product-table td,
    .orders-table th,
    .orders-table td {
      padding: 0.6rem 0.5rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: middle;
    }

    .product-table th,
    .orders-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #4b5563;
    }

    .product-name {
      font-weight: 600;
      color: #111827;
    }

    .chip {
      border-radius: 999px;
      padding: 0.05rem 0.5rem;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .chip.green {
      background: #dcfce7;
      color: #166534;
    }

    .chip.amber {
      background: #fef3c7;
      color: #92400e;
    }

    .chip.red {
      background: #fee2e2;
      color: #991b1b;
    }

    .empty-state {
      text-align: center;
      padding: 1.5rem 0.5rem;
      color: #9ca3af;
      font-size: 0.9rem;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: #ffffff;
      border-radius: 1rem;
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.45);
    }

    .modal-header {
      padding: 0.9rem 1.1rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .modal-body {
      padding: 0.9rem 1.1rem 1rem;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 0.7rem 1.1rem 0.9rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .modal-close-btn {
      border: none;
      background: transparent;
      color: #6b7280;
      cursor: pointer;
      padding: 0.2rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .form-control {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .form-control label {
      font-size: 0.8rem;
      color: #4b5563;
    }

    .form-control input,
    .form-control textarea,
    .form-control select {
      border-radius: 0.7rem;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      padding: 0.4rem 0.6rem;
    }

    .form-control textarea {
      resize: vertical;
      min-height: 60px;
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .category-item {
      border-radius: 0.8rem;
      padding: 0.6rem 0.6rem;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.3rem;
      transition: background 0.15s ease, transform 0.08s ease, border-color 0.15s ease;
      font-size: 0.8rem;
    }

    .category-item i {
      font-size: 1rem;
      color: #2563eb;
    }

    .category-item span {
      font-weight: 500;
      color: #111827;
    }

    .category-item.selected {
      background: #dbeafe;
      border-color: #2563eb;
      transform: translateY(-1px);
    }

    .category-hint {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.1rem;
    }

    .text-danger {
      color: #b91c1c;
      font-size: 0.8rem;
    }

    .pill {
      border-radius: 999px;
      padding: 0.1rem 0.55rem;
      font-size: 0.75rem;
      background: #eff6ff;
      color: #1d4ed8;
    }

    @media (max-width: 640px) {
      .tab-content {
        padding: 0.8rem;
      }

      header.seller-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
    }
  </style>

  <!-- Hybrid Auth client from backend -->
  <script src="https://ecommerce-backend-mlik.onrender.com/hybrid-auth-client.js"></script>
</head>
<body>
<div class="seller-shell">
  <header class="seller-header">
    <div class="brand">
      <i class="fas fa-store"></i>
      <span>QuickLocal Seller</span>
      <span class="badge">
        <i class="fas fa-bolt"></i> Dashboard
      </span>
    </div>
    <div class="actions">
      <span id="sellerUserInfo" class="pill">
        <i class="fas fa-user"></i> Loading...
      </span>
      <button class="secondary" id="btnGoMarketplace">
        <i class="fas fa-shopping-basket"></i> Marketplace
      </button>
      <button class="primary" id="btnLogout">
        <i class="fas fa-right-from-bracket"></i> Logout
      </button>
    </div>
  </header>

  <main class="seller-main">
    <!-- Stats -->
    <section class="stats-grid">
      <article class="stat-card">
        <div class="label">Total Products</div>
        <div class="value" id="statTotalProducts">0</div>
        <div class="sub">Active listings in your shop</div>
      </article>
      <article class="stat-card">
        <div class="label">Today’s Orders</div>
        <div class="value" id="statOrdersToday">0</div>
        <div class="sub">Orders placed in last 24 hours</div>
      </article>
      <article class="stat-card">
        <div class="label">Revenue (30d)</div>
        <div class="value" id="statRevenue30d">₹0</div>
        <div class="sub">Approximate gross revenue</div>
      </article>
      <article class="stat-card">
        <div class="label">Order Status</div>
        <div class="value" id="statPendingOrders">0</div>
        <div class="sub">Orders waiting to be processed</div>
      </article>
    </section>

    <!-- Tabs -->
    <section>
      <div class="tabs">
        <button class="tab active" data-tab="products">
          <i class="fas fa-box-open"></i> Products
        </button>
        <button class="tab" data-tab="orders">
          <i class="fas fa-receipt"></i> Orders
        </button>
        <button class="tab" data-tab="analytics">
          <i class="fas fa-chart-line"></i> Analytics
        </button>
      </div>

      <div class="tab-content">
        <!-- Products tab -->
        <div class="tab-panel active" id="tab-products">
          <div class="section-header">
            <h2>
              <i class="fas fa-box-open"></i> Your Products
            </h2>
            <div class="right-controls">
              <select id="categoryFilter">
                <option value="">All categories</option>
              </select>
              <input
                type="search"
                id="searchProducts"
                placeholder="Search products..."
              />
              <button class="btn primary" id="btnOpenAddProductModal">
                <i class="fas fa-plus"></i> Add Product
              </button>
            </div>
          </div>

          <div id="productsContainer">
            <table class="product-table">
              <thead>
              <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Status</th>
                <th></th>
              </tr>
              </thead>
              <tbody id="productsTableBody">
              <tr>
                <td colspan="6" class="empty-state">
                  No products yet. Click <strong>Add Product</strong> to create your first listing.
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Orders tab -->
        <div class="tab-panel" id="tab-orders">
          <div class="section-header">
            <h2>
              <i class="fas fa-receipt"></i> Orders
            </h2>
            <div class="right-controls">
              <select id="orderStatusFilter">
                <option value="">All statuses</option>
                <option value="pending">Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="shipped">Shipped</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>

          <div id="ordersContainer">
            <table class="orders-table">
              <thead>
              <tr>
                <th>Order</th>
                <th>Date</th>
                <th>Items</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
              </thead>
              <tbody id="ordersTableBody">
              <tr>
                <td colspan="5" class="empty-state">
                  No orders yet.
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Analytics tab -->
        <div class="tab-panel" id="tab-analytics">
          <div class="section-header">
            <h2>
              <i class="fas fa-chart-line"></i> Analytics
            </h2>
          </div>
          <div class="empty-state">
            Basic analytics will appear here (orders, revenue, top products).
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal-backdrop" id="addProductModal">
  <div class="modal">
    <div class="modal-header">
      <h3>
        <i class="fas fa-box"></i> Add Product
      </h3>
      <button class="modal-close-btn" data-close-modal="addProductModal">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="addProductForm">
        <div class="form-grid">
          <div class="form-control">
            <label for="productName">Product Name</label>
            <input
              type="text"
              id="productName"
              name="name"
              required
              placeholder="e.g. Fresh Tomatoes (1kg)"
            />
          </div>

          <div class="form-control">
            <label for="productPrice">Price (₹)</label>
            <input
              type="number"
              min="0"
              step="0.5"
              id="productPrice"
              name="price"
              required
              placeholder="e.g. 49"
            />
          </div>

          <div class="form-control">
            <label for="productStock">Stock Quantity</label>
            <input
              type="number"
              min="0"
              step="1"
              id="productStock"
              name="stock"
              required
              placeholder="e.g. 25"
            />
          </div>

          <div class="form-control">
            <label for="productUnit">Unit</label>
            <input
              type="text"
              id="productUnit"
              name="unit"
              placeholder="e.g. 1kg, 500g, 1 piece"
            />
          </div>
        </div>

        <div class="form-control">
          <label for="productDescription">Description</label>
          <textarea
            id="productDescription"
            name="description"
            placeholder="Short description for buyers..."
          ></textarea>
        </div>

        <div class="form-control">
          <label>Category</label>
          <div class="category-hint">
            Choose the most relevant category. This works like <strong>add-product.html</strong>.
          </div>
          <div id="categoryOptions" class="category-grid">
            <!-- Filled dynamically -->
          </div>
          <input type="hidden" id="productCategory" name="category" />
          <div id="categoryError" class="text-danger" style="display:none;">
            Please select a category.
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn outline" data-close-modal="addProductModal">
        Cancel
      </button>
      <button class="btn primary" id="btnSaveProduct">
        <i class="fas fa-floppy-disk"></i> Save Product
      </button>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const API_BASE_URL = window.API_BASE_URL || 'https://ecommerce-backend-mlik.onrender.com/api/v1';

  let currentSeller = null;
  let globalCategories = [];
  let selectedCategory = null;
  let allProducts = [];
  let allOrders = [];

  // ====== UTIL ======
  function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  function formatCurrency(amount) {
    const value = Number(amount) || 0;
    return '₹' + value.toFixed(0);
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    return d.toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });
  }

  // ====== AUTH ======
  async function ensureHybridAuth() {
    if (!window.HybridAuthClient) {
      console.error('[Seller] HybridAuthClient not available');
      return false;
    }
    try {
      if (!window.HybridAuthClient.isInitialized) {
        await window.HybridAuthClient.init();
      }
      return true;
    } catch (err) {
      console.error('[Seller] Error initializing HybridAuthClient:', err);
      return false;
    }
  }

  async function getCurrentUser() {
    try {
      const user = await window.HybridAuthClient.getCurrentUser();
      return user;
    } catch (err) {
      console.error('[Seller] Failed to get current user:', err);
      return null;
    }
  }

  async function apiCall(path, options = {}) {
    if (!ensureHybridAuth()) {
      throw new Error('Hybrid auth not ready');
    }
    // HybridAuthClient.apiCall expects path starting with / or full URL
    return window.HybridAuthClient.apiCall(path, options);
  }

  // ====== CATEGORIES (like add-product.html) ======
  async function loadCategories() {
    if (!(await ensureHybridAuth())) return;

    console.log('[Seller] Fetching categories for dashboard...');
    const categoryOptions = document.getElementById('categoryOptions');
    const categorySelect = document.getElementById('categoryFilter');

    try {
      let response;
      if (window.HybridAuthClient) {
        response = await window.HybridAuthClient.apiCall('/categories?limit=50');
      } else {
        response = await fetch(API_BASE_URL + '/categories?limit=50');
      }

      const result = await response.json();
      let categories = [];

      if (result && result.success && result.data) {
        const raw = result.data;
        categories = Array.isArray(raw) ? raw : (raw.categories || []);
      }

      if (!Array.isArray(categories) || !categories.length) {
        console.warn('[Seller] No categories returned');
        if (categoryOptions) {
          categoryOptions.innerHTML = '<p class="empty-state">No categories found.</p>';
        }
        if (categorySelect) {
          categorySelect.innerHTML = '<option value="">All categories</option>';
        }
        globalCategories = [];
        return;
      }

      globalCategories = categories;
      populateCategoryFilters();
      console.log('[Seller] Categories loaded in dashboard:', categories.length);
    } catch (error) {
      console.error('[Seller] Categories load error:', error);
      const categoryOptions = document.getElementById('categoryOptions');
      if (categoryOptions) {
        categoryOptions.innerHTML =
          '<p class="empty-state">Error loading categories.</p>';
      }
    }
  }

  function populateCategoryFilters() {
    const categoryOptions = document.getElementById('categoryOptions');
    const categorySelect = document.getElementById('categoryFilter');

    const categoryIcons = {
      'Electronics': 'fas fa-mobile-alt',
      'Clothing': 'fas fa-tshirt',
      'Home & Garden': 'fas fa-home',
      'Sports & Fitness': 'fas fa-futbol',
      'Bedsheets': 'fas fa-bed',
      'Sofa': 'fas fa-couch',
      'Fruits': 'fas fa-apple-alt',
      'Vegetables': 'fas fa-carrot',
      'Dairy': 'fas fa-glass-whiskey',
      'Bakery': 'fas fa-bread-slice',
      'Meat & Fish': 'fas fa-fish',
      'Groceries': 'fas fa-shopping-basket'
    };

    // Filter dropdown
    if (categorySelect) {
      categorySelect.innerHTML =
        '<option value="">All categories</option>' +
        globalCategories
          .map(
            (cat) =>
              `<option value="${cat._id}">${escapeHtml(cat.name)}</option>`
          )
          .join('');
    }

    // Category grid in modal
    if (categoryOptions) {
      categoryOptions.innerHTML = globalCategories
        .map(
          (cat) => `
            <div class="category-item"
                 data-category-id="${cat._id}"
                 data-category-name="${escapeHtml(cat.name)}">
              <i class="${categoryIcons[cat.name] || 'fas fa-tag'}"></i>
              <span>${escapeHtml(cat.name)}</span>
            </div>
          `
        )
        .join('');

      const hiddenInput = document.getElementById('productCategory');
      const items = categoryOptions.querySelectorAll('.category-item');

      items.forEach((item) => {
        item.addEventListener('click', () => {
          items.forEach((i) => i.classList.remove('selected'));
          item.classList.add('selected');

          selectedCategory = item.dataset.categoryId;
          if (hiddenInput) {
            hiddenInput.value = selectedCategory;
          }

          document.getElementById('categoryError').style.display = 'none';
          console.log('[Seller] Selected category:', item.dataset.categoryName);
        });
      });
    }
  }

  // ====== PRODUCTS ======
  async function loadProducts() {
    if (!(await ensureHybridAuth())) return;

    try {
      const res = await apiCall('/seller/products');
      const result = await res.json();
      let products = [];

      if (result && result.success && result.data) {
        products = Array.isArray(result.data)
          ? result.data
          : (result.data.products || []);
      }

      allProducts = products || [];
      renderProductsTable();
      updateProductStats();
    } catch (err) {
      console.error('[Seller] Error loading products:', err);
    }
  }

  function renderProductsTable() {
    const tbody = document.getElementById('productsTableBody');
    if (!tbody) return;

    const searchTerm = (document.getElementById('searchProducts')?.value || '')
      .toLowerCase()
      .trim();
    const categoryFilter = document.getElementById('categoryFilter')?.value || '';

    let filtered = allProducts.slice();

    if (searchTerm) {
      filtered = filtered.filter((p) =>
        (p.name || '').toLowerCase().includes(searchTerm)
      );
    }
    if (categoryFilter) {
      filtered = filtered.filter(
        (p) => String(p.category?._id || p.category) === String(categoryFilter)
      );
    }

    if (!filtered.length) {
      tbody.innerHTML =
        '<tr><td colspan="6" class="empty-state">No products match your filters.</td></tr>';
      return;
    }

    const rows = filtered
      .map((p) => {
        const categoryName =
          (p.category && (p.category.name || p.category.title)) || '—';
        const price = formatCurrency(p.price);
        const stock = p.stock ?? p.quantity ?? 0;
        const isActive = p.status === 'active' || p.isActive;

        const chipClass = isActive ? 'green' : 'amber';
        const chipLabel = isActive ? 'Active' : 'Inactive';

        return `
        <tr>
          <td>
            <div class="product-name">${escapeHtml(p.name || '')}</div>
            <div style="font-size:0.8rem;color:#6b7280;">
              SKU: ${escapeHtml(p.sku || p._id || '')}
            </div>
          </td>
          <td>${escapeHtml(categoryName)}</td>
          <td>${price}</td>
          <td>${stock}</td>
          <td>
            <span class="chip ${chipClass}">
              <i class="fas fa-circle"></i> ${chipLabel}
            </span>
          </td>
          <td>
            <button class="btn outline btn-sm" data-product-id="${p._id || ''}">
              <i class="fas fa-pen"></i>
            </button>
          </td>
        </tr>
      `;
      })
      .join('');

    tbody.innerHTML = rows;
  }

  function updateProductStats() {
    const total = allProducts.length;
    document.getElementById('statTotalProducts').textContent = total;
  }

  // ====== ORDERS ======
  async function loadOrders() {
    if (!(await ensureHybridAuth())) return;

    try {
      const res = await apiCall('/seller/orders');
      const result = await res.json();
      let orders = [];

      if (result && result.success && result.data) {
        orders = Array.isArray(result.data)
          ? result.data
          : (result.data.orders || []);
      }

      allOrders = orders || [];
      renderOrdersTable();
      updateOrderStats();
    } catch (err) {
      console.error('[Seller] Error loading orders:', err);
    }
  }

  function renderOrdersTable() {
    const tbody = document.getElementById('ordersTableBody');
    if (!tbody) return;

    const statusFilter =
      document.getElementById('orderStatusFilter')?.value || '';

    let filtered = allOrders.slice();

    if (statusFilter) {
      filtered = filtered.filter(
        (o) => (o.status || '').toLowerCase() === statusFilter.toLowerCase()
      );
    }

    if (!filtered.length) {
      tbody.innerHTML =
        '<tr><td colspan="5" class="empty-state">No orders match this filter.</td></tr>';
      return;
    }

    const rows = filtered
      .map((o) => {
        const status = (o.status || 'pending').toLowerCase();
        let chipClass = 'amber';
        if (status === 'delivered') chipClass = 'green';
        if (status === 'cancelled') chipClass = 'red';

        return `
        <tr>
          <td>
            <div class="product-name">#${escapeHtml(o._id || '')}</div>
            <div style="font-size:0.8rem;color:#6b7280;">
              ${escapeHtml(o.customerName || o.user?.name || '')}
            </div>
          </td>
          <td>${formatDate(o.createdAt)}</td>
          <td>${(o.items?.length || 0)} items</td>
          <td>${formatCurrency(o.total || o.amount || 0)}</td>
          <td>
            <span class="chip ${chipClass}">
              <i class="fas fa-circle"></i> ${escapeHtml(status)}
            </span>
          </td>
        </tr>
      `;
      })
      .join('');

    tbody.innerHTML = rows;
  }

  function updateOrderStats() {
    const today = new Date();
    const last24h = allOrders.filter((o) => {
      const created = new Date(o.createdAt);
      return (
        !isNaN(created.getTime()) &&
        today.getTime() - created.getTime() <= 24 * 60 * 60 * 1000
      );
    });

    document.getElementById('statOrdersToday').textContent = last24h.length;

    const pendingCount = allOrders.filter(
      (o) => (o.status || '').toLowerCase() === 'pending'
    ).length;
    document.getElementById('statPendingOrders').textContent = pendingCount;

    const revenue30d = allOrders
      .filter((o) => {
        const created = new Date(o.createdAt);
        return (
          !isNaN(created.getTime()) &&
          today.getTime() - created.getTime() <= 30 * 24 * 60 * 60 * 1000
        );
      })
      .reduce((sum, o) => sum + (Number(o.total || o.amount || 0) || 0), 0);

    document.getElementById('statRevenue30d').textContent =
      formatCurrency(revenue30d);
  }

  // ====== ADD PRODUCT FLOW ======
  function openModal(id) {
    const el = document.getElementById(id);
    if (el) el.classList.add('show');
  }

  function closeModal(id) {
    const el = document.getElementById(id);
    if (el) el.classList.remove('show');
  }

  async function handleSaveProduct() {
    const form = document.getElementById('addProductForm');
    if (!form) return;

    const name = form.productName.value.trim();
    const price = Number(form.productPrice.value);
    const stock = Number(form.productStock.value);
    const unit = form.productUnit.value.trim();
    const description = form.productDescription.value.trim();
    const categoryId = document.getElementById('productCategory').value;

    if (!categoryId) {
      document.getElementById('categoryError').style.display = 'block';
      return;
    }

    const payload = {
      name,
      price,
      stock,
      unit,
      description,
      category: categoryId
    };

    try {
      const res = await apiCall('/seller/products', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (!res.ok || !result.success) {
        console.error('[Seller] Failed to create product:', result);
        alert(result.message || 'Failed to create product.');
        return;
      }

      alert('Product created successfully!');
      closeModal('addProductModal');
      form.reset();
      document.getElementById('productCategory').value = '';
      selectedCategory = null;

      // Reload products
      await loadProducts();
    } catch (err) {
      console.error('[Seller] Error creating product:', err);
      alert('Error creating product. Please try again.');
    }
  }

  // ====== TABS & INITIALIZATION ======
  function setupTabs() {
    const tabs = document.querySelectorAll('.tab');
    const panels = {
      products: document.getElementById('tab-products'),
      orders: document.getElementById('tab-orders'),
      analytics: document.getElementById('tab-analytics')
    };

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const target = tab.getAttribute('data-tab');

        tabs.forEach((t) => t.classList.remove('active'));
        Object.values(panels).forEach((p) => p.classList.remove('active'));

        tab.classList.add('active');
        if (panels[target]) {
          panels[target].classList.add('active');
        }
      });
    });
  }

  async function initSellerDashboard() {
    console.log('[Seller] Initializing dashboard...');

    if (!(await ensureHybridAuth())) {
      alert('Authentication not available. Please log in again.');
      window.location.href = '/login.html';
      return;
    }

    currentSeller = await getCurrentUser();
    console.log('[Seller] Current user:', currentSeller);

    const info = document.getElementById('sellerUserInfo');
    if (info && currentSeller) {
      const name = currentSeller.name || currentSeller.fullName || currentSeller.email;
      info.innerHTML = `<i class="fas fa-user"></i> ${escapeHtml(name || 'Seller')}`;
    }

    await loadCategories();
    await loadProducts();
    await loadOrders();

    console.log('[Seller] Dashboard ready.');
  }

  // ====== EVENT LISTENERS ======
  document.addEventListener('DOMContentLoaded', () => {
    setupTabs();

    document
      .getElementById('btnOpenAddProductModal')
      ?.addEventListener('click', () => openModal('addProductModal'));

    document
      .querySelectorAll('[data-close-modal="addProductModal"]')
      .forEach((btn) =>
        btn.addEventListener('click', () => closeModal('addProductModal'))
      );

    document
      .getElementById('btnSaveProduct')
      ?.addEventListener('click', (e) => {
        e.preventDefault();
        handleSaveProduct();
      });

    document.getElementById('searchProducts')?.addEventListener('input', () => {
      renderProductsTable();
    });

    document.getElementById('categoryFilter')?.addEventListener('change', () => {
      renderProductsTable();
    });

    document.getElementById('orderStatusFilter')?.addEventListener('change', () => {
      renderOrdersTable();
    });

    document.getElementById('btnLogout')?.addEventListener('click', async () => {
      if (window.HybridAuthClient) {
        try {
          await window.HybridAuthClient.logout();
        } catch (e) {
          console.error('[Seller] Logout error:', e);
        }
      }
      window.location.href = '/login.html';
    });

    document
      .getElementById('btnGoMarketplace')
      ?.addEventListener('click', () => {
        window.location.href = '/marketplace.html';
      });

    initSellerDashboard();
  });
</script>
</body>
</html>
