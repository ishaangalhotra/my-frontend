<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Reset Password • QuickLocal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0b12; --card:#151524; --text:#e8e8f0; --muted:#9aa0b4; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{min-height:100vh;display:grid;place-items:center;padding:24px}
    .card{width:100%;max-width:440px;background:var(--card);border:1px solid #26263a;border-radius:16px;padding:28px}
    h1{margin:0 0 8px;font-size:22px} p{margin:0 0 18px;color:var(--muted)}
    input{width:100%;padding:12px;border-radius:10px;border:1px solid #2a2a3f;background:#111123;color:#e8e8f0;margin:8px 0}
    .btn{width:100%;padding:12px;border-radius:10px;background:#6366f1;color:#fff;border:0;cursor:pointer;margin-top:8px}
    .btn:disabled{background:#4a4a5c;cursor:not-allowed}
    .status{padding:12px;border-radius:10px;background:#1c1c2e;margin:12px 0}
    .ok{background:#15271a;border:1px solid #254a2f}
    .err{background:#2a1a1d;border:1px solid #5a3238}
    .loading{background:#1a1a2e;border:1px solid #3b3b5c}
    small{display:block;margin-top:10px;color:#7c8197}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid #ffffff;border-radius:50%;border-top:2px solid transparent;animation:spin 1s linear infinite;margin-right:8px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Set a new password</h1>
      <p>Enter and confirm your new password.</p>
      <div id="status" class="status" style="display:none"></div>
      <input id="pw" type="password" placeholder="New password (min 6 characters)" />
      <input id="cpw" type="password" placeholder="Confirm new password" />
      <button id="submit" class="btn">Reset Password</button>
      <small id="detail"></small>
    </div>
  </div>

  <script>
    (function(){
      const API = 'https://quicklocal-backend.onrender.com/api/v1/auth';

      const segments = location.pathname.split('/').filter(Boolean);
      const token = segments[segments.length - 1]; // /reset-password/:token
      const statusEl = document.getElementById('status');
      const detailEl = document.getElementById('detail');
      const submitBtn = document.getElementById('submit');

      function setStatus(msg, type = 'info'){
        statusEl.style.display = 'block';
        statusEl.className = `status ${type}`;
        statusEl.innerHTML = msg;
      }

      function setLoading(loading) {
        submitBtn.disabled = loading;
        if (loading) {
          submitBtn.innerHTML = '<span class="spinner"></span>Resetting Password...';
        } else {
          submitBtn.innerHTML = 'Reset Password';
        }
      }

      // Save token helper
      function saveToken(accessToken) {
        try {
          localStorage.setItem('accessToken', accessToken);
          return true;
        } catch (e) {
          console.error('Failed to save token:', e);
          return false;
        }
      }

      submitBtn.onclick = async () => {
        const password = document.getElementById('pw').value;
        const confirmPassword = document.getElementById('cpw').value;

        // Client-side validation
        if (!password || !confirmPassword) {
          return setStatus('Please enter both password fields.', 'err');
        }

        if (password.length < 6) {
          return setStatus('Password must be at least 6 characters long.', 'err');
        }

        if (password !== confirmPassword) {
          return setStatus('Passwords do not match.', 'err');
        }

        setLoading(true);
        setStatus('Resetting your password...', 'loading');
        detailEl.textContent = '';

        try {
          const res = await fetch(`${API}/reset-password/${encodeURIComponent(token)}`, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json', 
              Accept: 'application/json' 
            },
            credentials: 'include',
            body: JSON.stringify({ password, confirmPassword })
          });

          const data = await res.json().catch(() => ({}));
          
          if (!res.ok) {
            throw new Error(data.message || (data.errors && data.errors[0]?.msg) || 'Reset failed');
          }

          // Success! Save the access token for auto-login
          const accessToken = data.accessToken || data.token;
          if (accessToken) {
            saveToken(accessToken);
            
            // Also save user info if available
            if (data.user) {
              const sellerId = data.user.id || data.user._id;
              if (sellerId) {
                localStorage.setItem('sellerId', sellerId);
                localStorage.setItem('sellerInfo', JSON.stringify(data.user));
              }
            }
          }

          setStatus('✅ Password reset successful!', 'ok');
          detailEl.textContent = 'Redirecting to Seller Dashboard...';
          
          // Redirect to seller dashboard after 2 seconds
          setTimeout(() => {
            window.location.href = '/seller-dashboard.html';
          }, 2000);

        } catch (err) {
          setLoading(false);
          setStatus('❌ ' + (err.message || 'Reset failed'), 'err');
          
          if (err.message && (err.message.includes('token') || err.message.includes('expired') || err.message.includes('invalid'))) {
            detailEl.textContent = 'The reset link may be invalid or expired. Please request a new reset link from the login page.';
          } else {
            detailEl.textContent = 'Please try again or contact support if the problem persists.';
          }
        }
      };

      // Allow Enter key to submit
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !submitBtn.disabled) {
          submitBtn.click();
        }
      });

      // Validate token on page load
      if (!token || token.length < 10) {
        setStatus('❌ Invalid reset link', 'err');
        detailEl.textContent = 'This reset link appears to be invalid. Please request a new password reset from the login page.';
        submitBtn.disabled = true;
      }
    })();
  </script>
</body>
</html>