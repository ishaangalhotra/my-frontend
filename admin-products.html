<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Product Management • QuickLocal Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --info: #0891b2;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: #f5f5f5; color: var(--gray-800); }
    .container { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar { width: 280px; background: linear-gradient(180deg, var(--gray-900) 0%, var(--gray-800) 100%); color: white; padding: 20px 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 1000; }
    .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 20px; }
    .sidebar-header h2 { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .sidebar-nav { padding: 0 15px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--gray-300); text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; font-size: 0.95rem; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.08); color: white; }
    .nav-item.active { background: var(--primary); color: white; font-weight: 500; }
    .nav-item i { width: 20px; text-align: center; font-size: 1.1rem; }

    .content { flex: 1; margin-left: 280px; padding: 25px 30px; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--gray-200); }
    .header-left h1 { font-size: 1.6rem; font-weight: 700; color: var(--gray-900); margin-bottom: 5px; }
    .header-left p { color: var(--gray-500); font-size: 0.9rem; }
    .header-actions { display: flex; gap: 12px; }

    /* Stats */
    .quick-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border: 1px solid var(--gray-100); }
    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 1.3rem; }
    .stat-icon.active { background: #dcfce7; color: var(--success); }
    .stat-icon.inactive { background: #f3f4f6; color: var(--gray-600); }
    .stat-icon.pending { background: #fef3c7; color: var(--warning); }
    .stat-icon.rejected { background: #fee2e2; color: var(--danger); }
    .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
    .stat-label { color: var(--gray-500); font-size: 0.9rem; }

    /* Filters */
    .filters-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .filters-title { font-weight: 600; color: var(--gray-800); }
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .filter-group { display: flex; flex-direction: column; gap: 8px; }
    .filter-label { font-size: 0.85rem; font-weight: 500; color: var(--gray-700); }
    .filter-input, .filter-select { padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 0.9rem; width: 100%; }
    .date-range { display: flex; gap: 10px; }

    /* Buttons */
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
    .btn-secondary:hover { background: var(--gray-200); }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

    /* Table */
    .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom: 25px; }
    .table-responsive { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    .data-table thead { background: var(--gray-50); }
    .data-table th { padding: 16px; text-align: left; font-weight: 600; color: var(--gray-700); font-size: 0.9rem; border-bottom: 2px solid var(--gray-200); }
    .data-table td { padding: 16px; border-bottom: 1px solid var(--gray-100); font-size: 0.9rem; vertical-align: middle; }
    .product-image { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--gray-200); }
    
    /* Badges */
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; display: inline-block; }
    .badge.active { background: #dcfce7; color: var(--success); }
    .badge.inactive { background: #f3f4f6; color: var(--gray-600); }
    .badge.pending { background: #fef3c7; color: var(--warning); }
    .badge.rejected { background: #fee2e2; color: var(--danger); }

    /* Dropdown */
    .action-dropdown { position: relative; display: inline-block; }
    .action-btn { padding: 6px 12px; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .dropdown-menu { position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); min-width: 160px; z-index: 100; display: none; }
    .dropdown-item { padding: 10px 15px; display: flex; align-items: center; gap: 10px; color: var(--gray-700); text-decoration: none; font-size: 0.85rem; }
    .dropdown-item:hover { background: var(--gray-50); }

    /* Pagination */
    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .pagination-controls { display: flex; gap: 8px; align-items: center; }
    .pagination-btn { padding: 8px 16px; background: white; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-numbers { display: flex; gap: 4px; }
    .page-number { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
    .page-number.active { background: var(--primary); color: white; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center; }
    .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); }
    .modal-header { padding: 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 1.25rem; font-weight: 600; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px; }

    /* Bulk Actions */
    .bulk-actions { padding: 15px 20px; background: var(--gray-50); border-bottom: 1px solid var(--gray-200); display: none; align-items: center; gap: 15px; }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 1200px) { .sidebar { width: 80px; } .sidebar .nav-item span { display: none; } .content { margin-left: 80px; } }
    @media (max-width: 768px) { .content { padding: 15px; } .quick-stats { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2><i class="fas fa-store"></i> QuickLocal</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="admin-dashboard.html" class="nav-item">
        <i class="fas fa-home"></i><span>Dashboard</span>
      </a>
      <a href="admin-orders.html" class="nav-item">
        <i class="fas fa-shopping-bag"></i><span>Orders</span>
      </a>
      <a href="admin-users.html" class="nav-item">
        <i class="fas fa-users"></i><span>Users</span>
      </a>
      <a href="admin-products.html" class="nav-item active">
        <i class="fas fa-box"></i><span>Products</span>
      </a>
      <a href="admin-categories.html" class="nav-item">
        <i class="fas fa-tags"></i><span>Categories</span>
      </a>
      <a href="admin-analytics.html" class="nav-item">
        <i class="fas fa-chart-bar"></i><span>Analytics</span>
      </a>
      <a href="admin-settings.html" class="nav-item">
        <i class="fas fa-cog"></i><span>Settings</span>
      </a>
      <a href="admin-login.html" class="nav-item" style="margin-top: 20px;">
        <i class="fas fa-sign-out-alt"></i><span>Logout</span>
      </a>
    </nav>
  </aside>

  <main class="content">
    <div class="header">
      <div class="header-left">
        <h1>Product Management</h1>
        <p>Manage all products in your marketplace</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportProducts()">
          <i class="fas fa-download"></i> Export
        </button>
        <button class="btn btn-primary" onclick="showAddProductModal()">
          <i class="fas fa-plus"></i> Add Product
        </button>
      </div>
    </div>

    <div class="quick-stats" id="statsContainer">
      <div class="stat-card">
        <div class="stat-icon active"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-label">Active Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon inactive"><i class="fas fa-pause-circle"></i></div>
        <div class="stat-value" id="inactiveCount">0</div>
        <div class="stat-label">Inactive Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon pending"><i class="fas fa-clock"></i></div>
        <div class="stat-value" id="pendingCount">0</div>
        <div class="stat-label">Pending Review</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon rejected"><i class="fas fa-times-circle"></i></div>
        <div class="stat-value" id="rejectedCount">0</div>
        <div class="stat-label">Rejected</div>
      </div>
    </div>

    <div class="bulk-actions" id="bulkActions">
      <span id="selectedCount">0 products selected</span>
      <select class="filter-select" id="bulkActionSelect">
        <option value="">Bulk Action</option>
        <option value="activate">Activate</option>
        <option value="deactivate">Deactivate</option>
        <option value="delete">Delete</option>
        <option value="export">Export Selected</option>
      </select>
      <button class="btn btn-sm btn-primary" onclick="applyBulkAction()">Apply</button>
      <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear</button>
    </div>

    <div class="filters-container">
      <div class="filters-header">
        <div class="filters-title">Filters & Search</div>
        <button class="btn btn-secondary btn-sm" onclick="resetFilters()">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Search Products</label>
          <input type="text" id="searchInput" class="filter-input" placeholder="Name, SKU, description..." />
        </div>
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select id="statusFilter" class="filter-select">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="pending">Pending</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Category</label>
          <select id="categoryFilter" class="filter-select">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Price Range</label>
          <div style="display: flex; gap: 10px;">
            <input type="number" id="minPrice" class="filter-input" placeholder="Min" style="flex: 1;" />
            <input type="number" id="maxPrice" class="filter-input" placeholder="Max" style="flex: 1;" />
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Stock Range</label>
          <div style="display: flex; gap: 10px;">
            <input type="number" id="minStock" class="filter-input" placeholder="Min" style="flex: 1;" />
            <input type="number" id="maxStock" class="filter-input" placeholder="Max" style="flex: 1;" />
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Date Range</label>
          <div class="date-range">
            <input type="date" id="startDate" class="filter-input" />
            <input type="date" id="endDate" class="filter-input" />
          </div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-responsive">
        <table class="data-table" id="productsTable">
          <thead>
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" id="selectAll" />
              </th>
              <th style="width: 80px;">Image</th>
              <th style="min-width: 200px;">Product Name</th>
              <th style="min-width: 120px;">Seller</th>
              <th style="min-width: 120px;">Category</th>
              <th style="width: 100px;">Price</th>
              <th style="width: 80px;">Stock</th>
              <th style="width: 100px;">Sales</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 100px;">Created</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody id="productsTableBody">
            </tbody>
        </table>
      </div>
    </div>

    <div class="pagination">
      <div class="pagination-info">
        Showing <span id="startIndex">0</span> to <span id="endIndex">0</span> of <span id="totalProducts">0</span> products
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" id="firstPage" onclick="goToPage(1)">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="pagination-btn" id="prevPage" onclick="prevPage()">
          <i class="fas fa-chevron-left"></i> Prev
        </button>
        
        <div class="page-numbers" id="pageNumbers"></div>
        
        <button class="pagination-btn" id="nextPage" onclick="nextPage()">
          Next <i class="fas fa-chevron-right"></i>
        </button>
        <button class="pagination-btn" id="lastPage" onclick="goToLastPage()">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </div>
  </main>
</div>

<div class="modal" id="productModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Add New Product</div>
      <button class="btn btn-secondary btn-sm" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="productForm" onsubmit="saveProduct(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div class="filter-group">
            <label class="filter-label">Product Name *</label>
            <input type="text" id="productName" class="filter-input" required />
          </div>
          <div class="filter-group">
            <label class="filter-label">SKU *</label>
            <input type="text" id="productSKU" class="filter-input" required />
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label class="filter-label">Description</label>
          <textarea id="productDescription" class="filter-input" rows="3"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
          <div class="filter-group">
            <label class="filter-label">Price *</label>
            <input type="number" id="productPrice" class="filter-input" step="0.01" required />
          </div>
          <div class="filter-group">
            <label class="filter-label">Stock *</label>
            <input type="number" id="productStock" class="filter-input" required />
          </div>
          <div class="filter-group">
            <label class="filter-label">Category *</label>
            <select id="productCategory" class="filter-select" required></select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Status *</label>
            <select id="productStatus" class="filter-select" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
        </div>
        
        <div class="filter-group" style="margin-bottom: 20px;">
          <label class="filter-label">Tags</label>
          <select id="productTags" class="filter-select" multiple style="height: 100px;">
            </select>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label class="filter-label">Product Images</label>
          <div id="imageUpload" style="border: 2px dashed var(--gray-300); border-radius: 8px; padding: 30px; text-align: center; cursor: pointer;">
            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--gray-400); margin-bottom: 10px;"></i>
            <p>Click to upload or drag and drop</p>
            <p style="font-size: 0.8rem; color: var(--gray-500);">PNG, JPG, GIF up to 10MB</p>
          </div>
          <div id="imagePreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
        </div>
        
        <input type="hidden" id="productId" />
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" type="submit" form="productForm">Save Product</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  // Configuration
  const API_BASE = "https://ecommerce-backend-mlik.onrender.com";
  const API_V1 = API_BASE + "/api/v1";
  
  // State Management
  let state = {
    currentPage: 1,
    totalPages: 1,
    totalProducts: 0,
    limit: 20,
    selectedProducts: new Set(),
    categories: [],
    tags: []
  };

  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', () => {
    checkAdminAuth();
    initializeFilters();
    loadCategories();
    loadProducts();

    // Add ESC key handler for dropdowns and modal
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
        closeModal();
      }
    });

    // Close modal on backdrop click
    document.getElementById('productModal').addEventListener('click', (e) => {
      if (e.target.id === 'productModal') {
        closeModal();
      }
    });

    // Global click listener for closing action dropdowns
    window.onclick = function(event) {
      if (!event.target.matches('.action-btn')) {
        document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
      }
    }
  });

  function checkAdminAuth() {
    const token = localStorage.getItem("adminToken");
    if (!token) {
      window.location.href = "admin-login.html";
    }
  }

  // --- API HELPER ---
  async function fetchAPI(endpoint, options = {}) {
    const token = localStorage.getItem("adminToken");
    const defaultHeaders = {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json",
      "Accept": "application/json"
    };

    try {
      const response = await fetch(`${API_V1}${endpoint}`, {
        ...options,
        headers: { ...defaultHeaders, ...options.headers }
      });

      if (response.status === 401) {
        alert("Session expired. Please login again.");
        window.location.href = "admin-login.html";
        return null;
      }

      const data = await response.json();
      if (!response.ok) throw new Error(data.message || 'API Error');
      return data;
    } catch (error) {
      console.error("API Error:", error);
      throw error;
    }
  }

  // --- DATA LOADING ---
  async function loadCategories() {
    try {
      const data = await fetchAPI('/categories');
      if (!data) return;

      if (Array.isArray(data)) state.categories = data;
      else if (data.data && Array.isArray(data.data)) state.categories = data.data;
      else if (data.categories && Array.isArray(data.categories)) state.categories = data.categories;
      else state.categories = [];

      populateCategoryDropdowns();
    } catch (error) {
      console.warn("Failed to load categories", error);
    }
  }

  async function loadProducts() {
    showLoadingState();
    
    const params = new URLSearchParams({
      page: state.currentPage,
      limit: state.limit
    });

    const filters = {
      search: document.getElementById('searchInput').value.trim(),
      status: document.getElementById('statusFilter').value,
      category: document.getElementById('categoryFilter').value,
      minPrice: document.getElementById('minPrice').value,
      maxPrice: document.getElementById('maxPrice').value,
      minStock: document.getElementById('minStock').value,
      maxStock: document.getElementById('maxStock').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value
    };

    Object.keys(filters).forEach(key => {
      if (filters[key] && filters[key] !== 'all') params.append(key, filters[key]);
    });

    try {
      let data;
      try {
        data = await fetchAPI(`/admin/products?${params}`);
      } catch (e) {
        console.log("Admin endpoint failed, trying public...");
        data = await fetchAPI(`/products?${params}`);
      }

      let products = [];
      if (Array.isArray(data)) {
        products = data;
      } else if (data.data && Array.isArray(data.data)) {
        products = data.data;
      } else if (data.products && Array.isArray(data.products)) {
        products = data.products;
      } else if (data.data && data.data.products) {
        products = data.data.products;
      }

      state.totalProducts = data.total || data.count || products.length;
      state.totalPages = data.pages || Math.ceil(state.totalProducts / state.limit) || 1;
      
      renderProductsTable(products);
      updatePaginationUI();
      updateStatsUI(data.stats);

    } catch (error) {
      document.getElementById('productsTableBody').innerHTML = `
        <tr><td colspan="11" style="text-align: center; padding: 20px; color: var(--danger);">
          Error loading products. <button class="btn btn-sm btn-secondary" onclick="loadProducts()">Retry</button>
        </td></tr>`;
      showError(error.message);
    }
  }

  // --- RENDERING ---
  function renderProductsTable(products) {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';

    if (products.length === 0) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 30px; color: #6b7280;">No products found</td></tr>`;
      return;
    }

    products.forEach(product => {
      const id = product._id || product.id;
      const imgUrl = getSafeImageUrl(product);
      const isChecked = state.selectedProducts.has(id);
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="checkbox" class="product-checkbox" value="${id}" ${isChecked ? 'checked' : ''} onchange="toggleProductSelection('${id}')"></td>
        <td>
          <img src="${imgUrl}" class="product-image" onerror="this.src='https://via.placeholder.com/60?text=No+Img'">
        </td>
        <td>
          <div style="font-weight: 500;">${product.name || 'No Name'}</div>
          <div style="font-size: 0.8rem; color: #6b7280;">SKU: ${product.sku || 'N/A'}</div>
        </td>
        <td>${product.seller?.name || 'Unknown'}</td>
        <td>${product.category?.name || 'Uncategorized'}</td>
        <td style="font-weight: 600;">₹${(product.price || 0).toLocaleString()}</td>
        <td><span class="${(product.stock || 0) < 10 ? 'text-danger' : ''}">${product.stock || 0}</span></td>
        <td>${product.sold || product.salesCount || 0}</td>
        <td><span class="badge ${product.status || 'inactive'}">${product.status || 'inactive'}</span></td>
        <td>${new Date(product.createdAt).toLocaleDateString()}</td>
        <td>
          <div class="action-dropdown">
            <button class="action-btn" onclick="toggleDropdown(this)">Actions <i class="fas fa-caret-down"></i></button>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item" onclick="openEditModal('${id}')"><i class="fas fa-edit"></i> Edit</a>
              <a href="#" class="dropdown-item" onclick="updateStatus('${id}', 'active')"><i class="fas fa-check"></i> Activate</a>
              <a href="#" class="dropdown-item" onclick="updateStatus('${id}', 'inactive')"><i class="fas fa-ban"></i> Deactivate</a>
              <div style="border-top:1px solid #eee; margin:5px 0;"></div>
              <a href="#" class="dropdown-item" style="color:red;" onclick="deleteProduct('${id}')"><i class="fas fa-trash"></i> Delete</a>
            </div>
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function getSafeImageUrl(product) {
    if (product.image) return product.image;
    if (product.images && product.images.length > 0) {
      return typeof product.images[0] === 'string' ? product.images[0] : product.images[0].url;
    }
    return 'https://via.placeholder.com/60?text=No+Img';
  }

  function populateCategoryDropdowns() {
    const filterSelect = document.getElementById('categoryFilter');
    const modalSelect = document.getElementById('productCategory');
    
    while (filterSelect.options.length > 1) filterSelect.remove(1);
    modalSelect.innerHTML = '<option value="">Select Category</option>';

    state.categories.forEach(cat => {
      const id = cat._id || cat.id;
      const name = cat.name;
      filterSelect.add(new Option(name, id));
      modalSelect.add(new Option(name, id));
    });

    if (jQuery.fn.select2) $(modalSelect).select2({ dropdownParent: $('#productModal') });
  }

  // --- ACTIONS (CRUD) ---
  
  async function saveProduct(event) {
    event.preventDefault();
    const id = document.getElementById('productId').value;
    const isEdit = !!id;
    
    const payload = {
      name: document.getElementById('productName').value,
      sku: document.getElementById('productSKU').value,
      description: document.getElementById('productDescription').value,
      price: Number(document.getElementById('productPrice').value),
      stock: Number(document.getElementById('productStock').value),
      category: document.getElementById('productCategory').value,
      status: document.getElementById('productStatus').value,
    };

    try {
      const url = isEdit ? `/admin/products/${id}` : `/admin/products`;
      const method = isEdit ? 'PUT' : 'POST';
      
      await fetchAPI(url, {
        method: method,
        body: JSON.stringify(payload)
      });

      alert(`Product ${isEdit ? 'updated' : 'created'} successfully!`);
      closeModal();
      loadProducts();
    } catch (error) {
      alert("Failed to save product: " + error.message);
    }
  }

  async function deleteProduct(id) {
    const row = document.querySelector(`input.product-checkbox[value="${id}"]`)?.closest('tr');
    const productName = row?.querySelector('td:nth-child(3) div')?.textContent || 'this product';
    
    if (!confirm(`Delete "${productName}"?\n\nThis action cannot be undone.`)) return;
    
    try {
      await fetchAPI(`/admin/products/${id}`, { method: 'DELETE' });
      
      // Remove row with animation
      if (row) {
        row.style.opacity = '0.5';
        row.style.transition = 'opacity 0.3s';
        setTimeout(() => {
          loadProducts();
        }, 300);
      } else {
        loadProducts();
      }
      
    } catch (error) {
      alert("Delete failed: " + error.message);
      if (row) row.style.opacity = '1';
    }
  }

  async function updateStatus(id, status) {
    if (!confirm(`Change product status to "${status}"?`)) return;
    
    try {
      await fetchAPI(`/admin/products/${id}/status`, {
        method: 'PATCH',
        body: JSON.stringify({ status })
      });
      
      // Update UI optimistically without full reload
      const badge = document.querySelector(`tr:has(input[value="${id}"]) .badge`);
      if (badge) {
        badge.className = `badge ${status}`;
        badge.textContent = status;
      }
      
      // Also reload to get fresh data
      loadProducts();
      
    } catch (error) {
      console.error(error);
      alert("Failed to update status: " + error.message);
    }
  }

  // --- MODAL HANDLING ---
  
  async function openEditModal(id) {
    try {
      showLoadingModal();
      
      const data = await fetchAPI(`/admin/products/${id}`);
      const product = data.product || data.data || data;
      
      document.getElementById('modalTitle').innerText = "Edit Product";
      document.getElementById('productId').value = product._id || product.id;
      document.getElementById('productName').value = product.name || '';
      document.getElementById('productSKU').value = product.sku || '';
      document.getElementById('productDescription').value = product.description || '';
      document.getElementById('productPrice').value = product.price || 0;
      document.getElementById('productStock').value = product.stock || 0;
      document.getElementById('productStatus').value = product.status || 'active';
      
      const catId = product.category?._id || product.category || '';
      document.getElementById('productCategory').value = catId;
      
      if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
        $('#productCategory').val(catId).trigger('change');
      }
      
      document.getElementById('productModal').style.display = 'flex';
      
    } catch (error) {
      alert("Could not load product details: " + error.message);
      closeModal();
    }
  }

  function showLoadingModal() {
    document.getElementById('modalTitle').innerText = "Loading...";
    document.getElementById('productModal').style.display = 'flex';
  }

  function showAddProductModal() {
    document.getElementById('modalTitle').innerText = "Add New Product";
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = "";
    
    if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
      $('#productCategory').val('').trigger('change');
    }
    
    document.getElementById('productModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('productModal').style.display = 'none';
    document.getElementById('productForm').reset();
  }

  // --- BULK ACTIONS ---
  
  async function applyBulkAction() {
    const action = document.getElementById('bulkActionSelect').value;
    
    if (!action) {
      alert("Please select an action");
      return;
    }
    
    if (state.selectedProducts.size === 0) {
      alert("No products selected");
      return;
    }
    
    const productIds = Array.from(state.selectedProducts);
    
    if (!confirm(`Apply "${action}" to ${productIds.length} product(s)?`)) {
      return;
    }
    
    try {
      if (action === 'export') {
        exportSelectedProducts(productIds);
        return;
      }
      
      await fetchAPI('/admin/products/bulk', {
        method: 'POST',
        body: JSON.stringify({
          productIds: productIds,
          action: action
        })
      });
      
      alert(`Bulk action "${action}" completed successfully!`);
      clearSelection();
      loadProducts();
      
    } catch (error) {
      alert("Bulk action failed: " + error.message);
    }
  }

  function exportSelectedProducts(productIds) {
    alert(`Exporting ${productIds.length} products... (Not yet implemented)`);
    // Ideally this would trigger a download endpoint accepting a list of IDs
  }

  function toggleProductSelection(id) {
    if (state.selectedProducts.has(id)) state.selectedProducts.delete(id);
    else state.selectedProducts.add(id);
    updateBulkUI();
  }

  function toggleSelectAll(e) {
    const checkboxes = document.querySelectorAll('.product-checkbox');
    checkboxes.forEach(cb => {
      cb.checked = e.target.checked;
      if (e.target.checked) state.selectedProducts.add(cb.value);
      else state.selectedProducts.delete(cb.value);
    });
    updateBulkUI();
  }

  function updateBulkUI() {
    const bar = document.getElementById('bulkActions');
    if (state.selectedProducts.size > 0) {
      bar.style.display = 'flex';
      document.getElementById('selectedCount').innerText = `${state.selectedProducts.size} selected`;
    } else {
      bar.style.display = 'none';
    }
  }
  
  function clearSelection() {
    state.selectedProducts.clear();
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
    updateBulkUI();
  }

  document.getElementById('selectAll').addEventListener('change', toggleSelectAll);

  // --- EXPORT ---
  async function exportProducts() {
    if (!confirm("Export all products matching current filters to CSV?")) return;
    
    try {
      const params = new URLSearchParams();
      
      const filters = {
        search: document.getElementById('searchInput').value.trim(),
        status: document.getElementById('statusFilter').value,
        category: document.getElementById('categoryFilter').value,
        minPrice: document.getElementById('minPrice').value,
        maxPrice: document.getElementById('maxPrice').value,
        minStock: document.getElementById('minStock').value,
        maxStock: document.getElementById('maxStock').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value
      };

      Object.keys(filters).forEach(key => {
        if (filters[key] && filters[key] !== 'all') params.append(key, filters[key]);
      });
      
      const token = localStorage.getItem("adminToken");
      const url = `${API_V1}/admin/products/export?${params}`;
      
      const response = await fetch(url, {
        headers: { "Authorization": "Bearer " + token }
      });
      
      if (!response.ok) throw new Error('Export failed');
      
      const blob = await response.blob();
      const downloadUrl = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = downloadUrl;
      a.download = `products_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(downloadUrl);
      
    } catch (error) {
      alert("Export failed: " + error.message);
    }
  }

  // --- UI UTILITIES ---

  function updatePaginationUI() {
    const start = ((state.currentPage - 1) * state.limit) + 1;
    const end = Math.min(state.currentPage * state.limit, state.totalProducts);
    
    document.getElementById('startIndex').innerText = state.totalProducts > 0 ? start : 0;
    document.getElementById('endIndex').innerText = end;
    document.getElementById('totalProducts').innerText = state.totalProducts;

    const btnContainer = document.getElementById('pageNumbers');
    btnContainer.innerHTML = '';
    
    const range = [];
    const maxVisible = 5;
    let startPage = Math.max(1, state.currentPage - Math.floor(maxVisible / 2));
    let endPage = Math.min(state.totalPages, startPage + maxVisible - 1);
    
    if (endPage - startPage + 1 < maxVisible) {
      startPage = Math.max(1, endPage - maxVisible + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      range.push(i);
    }

    range.forEach(page => {
      const btn = document.createElement('div');
      btn.className = `page-number ${page === state.currentPage ? 'active' : ''}`;
      btn.innerText = page;
      btn.onclick = () => goToPage(page);
      btnContainer.appendChild(btn);
    });

    document.getElementById('firstPage').disabled = state.currentPage === 1;
    document.getElementById('prevPage').disabled = state.currentPage === 1;
    document.getElementById('nextPage').disabled = state.currentPage >= state.totalPages;
    document.getElementById('lastPage').disabled = state.currentPage >= state.totalPages;
  }

  function goToPage(page) {
    if (page < 1 || page > state.totalPages) return;
    state.currentPage = page;
    loadProducts();
  }

  function goToLastPage() {
    goToPage(state.totalPages);
  }

  function prevPage() { 
    if (state.currentPage > 1) goToPage(state.currentPage - 1); 
  }

  function nextPage() { 
    if (state.currentPage < state.totalPages) goToPage(state.currentPage + 1); 
  }

  function initializeFilters() {
    let timeout;
    const inputs = document.querySelectorAll('.filter-input, .filter-select');
    inputs.forEach(input => {
      input.addEventListener('change', () => {
        state.currentPage = 1;
        loadProducts();
      });
      if (input.type === 'text') {
        input.addEventListener('input', () => {
          clearTimeout(timeout);
          timeout = setTimeout(() => {
            state.currentPage = 1;
            loadProducts();
          }, 600);
        });
      }
    });
  }

  function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    document.getElementById('minStock').value = '';
    document.getElementById('maxStock').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    
    if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
      $('#categoryFilter').val('').trigger('change');
    }
    
    state.currentPage = 1;
    loadProducts();
  }

  function toggleDropdown(btn) {
    document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
    const menu = btn.nextElementSibling;
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }

  function showLoadingState() {
    document.getElementById('productsTableBody').innerHTML = 
      `<tr><td colspan="11" style="text-align:center; padding: 40px;"><div class="loading"></div> Loading...</td></tr>`;
  }

  function updateStatsUI(stats) {
    if (!stats) return;
    document.getElementById('activeCount').innerText = stats.active || 0;
    document.getElementById('inactiveCount').innerText = stats.inactive || 0;
    document.getElementById('pendingCount').innerText = stats.pending || 0;
    document.getElementById('rejectedCount').innerText = stats.rejected || 0;
  }

  function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
      position: fixed; top: 20px; right: 20px; background: #fee2e2; color: #dc2626;
      padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999; max-width: 400px; display: flex; align-items: center; gap: 10px;
    `;
    errorDiv.innerHTML = `
      <i class="fas fa-exclamation-circle"></i>
      <span>${message}</span>
      <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; cursor: pointer; font-size: 1.2rem;">&times;</button>
    `;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 5000);
  }
</script>
</body>
</html>