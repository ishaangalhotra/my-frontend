<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Products • QuickLocal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 240px;
      background: #111827;
      color: white;
      padding: 20px;
    }
    .sidebar a {
      display: block;
      padding: 10px;
      margin-bottom: 6px;
      color: #e5e7eb;
      text-decoration: none;
      border-radius: 6px;
    }
    .sidebar a.active, .sidebar a:hover {
      background: #4f46e5;
      color: white;
    }
    .content {
      flex: 1;
      padding: 25px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.4rem;
      margin-bottom: 15px;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .filters input, .filters select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    table {
      width: 100%;
      background: white;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table th, table td {
      padding: 10px;
      border: 1px solid #e5e5e5;
      font-size: 0.9rem;
      text-align: left;
    }
    table th {
      background: #f3f4f6;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      color: white;
    }
    .badge.active { background: #22c55e; }
    .badge.inactive { background: #6b7280; }
    .badge.pending { background: #f59e0b; }
    .badge.rejected { background: #ef4444; }
    .action-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #4f46e5;
      color: white;
    }
    .pagination {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    .pagination button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: white;
    }
  </style>
</head>
<body>
<div class="container">

  <aside class="sidebar">
    <h2>Admin Panel</h2>
    <a href="admin-dashboard.html">Dashboard</a>
    <a href="admin-orders.html">Orders</a>
    <a href="admin-users.html">Users</a>
    <a class="active" href="admin-products.html">Products</a>
    <a href="admin-login.html">Logout</a>
  </aside>

  <main class="content">
    <h1>Manage Products</h1>

    <div class="filters">
      <input id="searchInput" type="text" placeholder="Search products..." />
      <select id="statusFilter">
        <option value="all">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="pending">Pending</option>
        <option value="rejected">Rejected</option>
      </select>
      <input id="sellerFilter" type="text" placeholder="Seller ID/email" />
      <input id="categoryFilter" type="text" placeholder="Category" />
    </div>

    <table id="productsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Seller</th>
          <th>Category</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Status</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="pagination">
      <button onclick="prevPage()">Prev</button>
      <button onclick="nextPage()">Next</button>
    </div>

  </main>
</div>

<script>
/* -----------------------------------------
   CONFIG
----------------------------------------- */
const API_BASE = "https://ecommerce-backend-mlik.onrender.com";
const API_V1 = API_BASE + "/api/v1";   
let currentPage = 1;

/* -----------------------------------------
   LOAD PRODUCTS
----------------------------------------- */
async function loadProducts(page = 1) {
  const token = localStorage.getItem("adminToken");
  const search = document.getElementById('searchInput').value.trim();
  const status = document.getElementById('statusFilter').value;
  const seller = document.getElementById('sellerFilter').value.trim();
  const category = document.getElementById('categoryFilter').value.trim();

  const params = new URLSearchParams({
    page,
    limit: 20
  });

  if (search) params.append("search", search);
  if (seller) params.append("seller", seller);
  if (category) params.append("category", category);
  if (status !== "all") params.append("status", status);

  try {
    const res = await fetch(`${API_V1}/products?` + params.toString(), {
      headers: {
        "Authorization": "Bearer " + token,
        "Accept": "application/json"
      }
    });

    const data = await res.json();

    // ⭐ DEBUG LOG: See exactly what the API returns in the console
    console.log("DEBUG products API response:", data);

    if (!res.ok) {
      console.error("Products API error:", data);
      return;
    }

    // ⭐ FIX: Robust check for the array location
    // This handles: { products: [] }, { data: [] }, { docs: [] }, etc.
    const products = 
      data.products || 
      data.data || 
      data.docs || 
      data.result || 
      [];

    if (!Array.isArray(products)) {
      console.error("Critical Error: 'products' is not an array!", products);
      return;
    }

    renderProducts(products);
  } catch (err) {
    console.error("Load products error:", err);
  }
}

/* -----------------------------------------
   RENDER TABLE
----------------------------------------- */
function renderProducts(products) {
  const tbody = document.querySelector("#productsTable tbody");
  tbody.innerHTML = "";

  if (!products || products.length === 0) {
    tbody.innerHTML = "<tr><td colspan='7'>No products found.</td></tr>";
    return;
  }

  products.forEach(p => {
    const tr = document.createElement("tr");

    // Handle potential missing seller object
    const sellerEmail = p.seller ? (p.seller.email || p.seller) : "N/A";

    tr.innerHTML = `
      <td>${p.name || "Unknown"}</td>
      <td>${sellerEmail}</td>
      <td>${p.category || "N/A"}</td>
      <td>₹${p.price || 0}</td>
      <td>${p.stock || 0}</td>
      <td><span class="badge ${p.status || 'inactive'}">${p.status || 'inactive'}</span></td>
      <td><button class="action-btn" onclick="updateStatus('${p._id}')">Update</button></td>
    `;

    tbody.appendChild(tr);
  });
}

/* -----------------------------------------
   UPDATE STATUS
----------------------------------------- */
async function updateStatus(id) {
  const token = localStorage.getItem("adminToken");

  const newStatus = prompt("Enter new status: active / inactive / pending / rejected");
  if (!newStatus) return;

  try {
    const res = await fetch(`${API_V1}/products/${id}`, {
      method: "PUT",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ status: newStatus })
    });

    const data = await res.json();

    if (!res.ok) {
      alert("Update failed: " + (data.message || "Unknown error"));
      return;
    }

    alert("Product updated successfully!");
    loadProducts(currentPage);
  } catch (err) {
    alert("Error updating product");
    console.error(err);
  }
}

/* -----------------------------------------
   PAGINATION
----------------------------------------- */
function nextPage() {
  currentPage++;
  loadProducts(currentPage);
}
function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    loadProducts(currentPage);
  }
}

/* -----------------------------------------
   INIT
----------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  if (!localStorage.getItem("adminToken")) {
    alert("Please login as admin.");
    window.location.href = "admin-login.html";
    return;
  }
  loadProducts();
});
</script>
</body>
</html>