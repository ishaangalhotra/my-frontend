<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Product Management • QuickLocal Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --info: #0891b2;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f5f5;
      color: var(--gray-800);
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, var(--gray-900) 0%, var(--gray-800) 100%);
      color: white;
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }

    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }

    .sidebar-header h2 {
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-nav {
      padding: 0 15px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      color: var(--gray-300);
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 5px;
      transition: all 0.2s;
      font-size: 0.95rem;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
    }

    .nav-item.active {
      background: var(--primary);
      color: white;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
    }

    .nav-item i {
      width: 20px;
      text-align: center;
      font-size: 1.1rem;
    }

    .content {
      flex: 1;
      margin-left: 280px;
      padding: 25px 30px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-200);
    }

    .header-left h1 {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 5px;
    }

    .header-left p {
      color: var(--gray-500);
      font-size: 0.9rem;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* Quick Stats */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--gray-100);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }

    .stat-icon.active { background: #dcfce7; color: var(--success); }
    .stat-icon.inactive { background: #f3f4f6; color: var(--gray-600); }
    .stat-icon.pending { background: #fef3c7; color: var(--warning); }
    .stat-icon.rejected { background: #fee2e2; color: var(--danger); }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      color: var(--gray-500);
      font-size: 0.9rem;
    }

    /* Filters */
    .filters-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .filters-title {
      font-weight: 600;
      color: var(--gray-800);
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--gray-700);
    }

    .filter-input, .filter-select {
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 0.9rem;
      transition: all 0.2s;
      width: 100%;
    }

    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .date-range {
      display: flex;
      gap: 10px;
    }

    /* Action Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn-secondary:hover {
      background: var(--gray-200);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    /* Table */
    .table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }

    .table-responsive {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1200px;
    }

    .data-table thead {
      background: var(--gray-50);
    }

    .data-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      color: var(--gray-700);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--gray-200);
      white-space: nowrap;
    }

    .data-table td {
      padding: 16px;
      border-bottom: 1px solid var(--gray-100);
      font-size: 0.9rem;
      vertical-align: middle;
    }

    .data-table tr:hover {
      background: var(--gray-50);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    /* Product Image */
    .product-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid var(--gray-200);
    }

    /* Badges */
    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: inline-block;
    }

    .badge.active { background: #dcfce7; color: var(--success); }
    .badge.inactive { background: #f3f4f6; color: var(--gray-600); }
    .badge.pending { background: #fef3c7; color: var(--warning); }
    .badge.rejected { background: #fee2e2; color: var(--danger); }

    /* Action Dropdown */
    .action-dropdown {
      position: relative;
      display: inline-block;
    }

    .action-btn {
      padding: 6px 12px;
      background: var(--gray-100);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      min-width: 160px;
      z-index: 100;
      display: none;
    }

    .dropdown-item {
      padding: 10px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--gray-700);
      text-decoration: none;
      transition: background 0.2s;
      font-size: 0.85rem;
    }

    .dropdown-item:hover {
      background: var(--gray-50);
    }

    .dropdown-item i {
      width: 16px;
      color: var(--gray-500);
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .pagination-info {
      color: var(--gray-600);
      font-size: 0.9rem;
    }

    .pagination-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pagination-btn {
      padding: 8px 16px;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pagination-btn:hover:not(:disabled) {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-numbers {
      display: flex;
      gap: 4px;
    }

    .page-number {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .page-number.active {
      background: var(--primary);
      color: white;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--gray-900);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Bulk Actions */
    .bulk-actions {
      padding: 15px 20px;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      display: none;
      align-items: center;
      gap: 15px;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .sidebar {
        width: 80px;
      }
      .sidebar .nav-item span {
        display: none;
      }
      .content {
        margin-left: 80px;
      }
    }

    @media (max-width: 768px) {
      .content {
        padding: 15px;
      }
      .quick-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2><i class="fas fa-store"></i> QuickLocal</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="admin-dashboard.html" class="nav-item">
        <i class="fas fa-home"></i><span>Dashboard</span>
      </a>
      <a href="admin-orders.html" class="nav-item">
        <i class="fas fa-shopping-bag"></i><span>Orders</span>
      </a>
      <a href="admin-users.html" class="nav-item">
        <i class="fas fa-users"></i><span>Users</span>
      </a>
      <a href="admin-products.html" class="nav-item active">
        <i class="fas fa-box"></i><span>Products</span>
      </a>
      <a href="admin-categories.html" class="nav-item">
        <i class="fas fa-tags"></i><span>Categories</span>
      </a>
      <a href="admin-analytics.html" class="nav-item">
        <i class="fas fa-chart-bar"></i><span>Analytics</span>
      </a>
      <a href="admin-settings.html" class="nav-item">
        <i class="fas fa-cog"></i><span>Settings</span>
      </a>
      <a href="admin-login.html" class="nav-item" style="margin-top: 20px;">
        <i class="fas fa-sign-out-alt"></i><span>Logout</span>
      </a>
    </nav>
  </aside>

  <main class="content">
    <div class="header">
      <div class="header-left">
        <h1>Product Management</h1>
        <p>Manage all products in your marketplace</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportProducts()">
          <i class="fas fa-download"></i> Export
        </button>
        <button class="btn btn-primary" onclick="showAddProductModal()">
          <i class="fas fa-plus"></i> Add Product
        </button>
      </div>
    </div>

    <div class="quick-stats" id="statsContainer">
      <div class="stat-card">
        <div class="stat-icon active">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-label">Active Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon inactive">
          <i class="fas fa-pause-circle"></i>
        </div>
        <div class="stat-value" id="inactiveCount">0</div>
        <div class="stat-label">Inactive Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon pending">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-value" id="pendingCount">0</div>
        <div class="stat-label">Pending Review</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon rejected">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-value" id="rejectedCount">0</div>
        <div class="stat-label">Rejected</div>
      </div>
    </div>

    <div class="bulk-actions" id="bulkActions">
      <span id="selectedCount">0 products selected</span>
      <select class="filter-select" id="bulkActionSelect">
        <option value="">Bulk Action</option>
        <option value="activate">Activate</option>
        <option value="deactivate">Deactivate</option>
        <option value="delete">Delete</option>
        <option value="export">Export Selected</option>
      </select>
      <button class="btn btn-sm btn-primary" onclick="applyBulkAction()">Apply</button>
      <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear</button>
    </div>

    <div class="filters-container">
      <div class="filters-header">
        <div class="filters-title">Filters & Search</div>
        <button class="btn btn-secondary btn-sm" onclick="resetFilters()">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Search Products</label>
          <input type="text" id="searchInput" class="filter-input" placeholder="Name, SKU, description..." />
        </div>
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select id="statusFilter" class="filter-select">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="pending">Pending</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Category</label>
          <select id="categoryFilter" class="filter-select">
            <option value="">All Categories</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Price Range</label>
          <div style="display: flex; gap: 10px;">
            <input type="number" id="minPrice" class="filter-input" placeholder="Min" style="flex: 1;" />
            <input type="number" id="maxPrice" class="filter-input" placeholder="Max" style="flex: 1;" />
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Stock Range</label>
          <div style="display: flex; gap: 10px;">
            <input type="number" id="minStock" class="filter-input" placeholder="Min" style="flex: 1;" />
            <input type="number" id="maxStock" class="filter-input" placeholder="Max" style="flex: 1;" />
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Date Range</label>
          <div class="date-range">
            <input type="date" id="startDate" class="filter-input" />
            <input type="date" id="endDate" class="filter-input" />
          </div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-responsive">
        <table class="data-table" id="productsTable">
          <thead>
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" id="selectAll" />
              </th>
              <th style="width: 80px;">Image</th>
              <th style="min-width: 200px;">Product Name</th>
              <th style="min-width: 120px;">Seller</th>
              <th style="min-width: 120px;">Category</th>
              <th style="width: 100px;">Price</th>
              <th style="width: 80px;">Stock</th>
              <th style="width: 100px;">Sales</th>
              <th style="width: 100px;">Status</th>
              <th style="width: 100px;">Created</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody id="productsTableBody">
            </tbody>
        </table>
      </div>
    </div>

    <div class="pagination">
      <div class="pagination-info">
        Showing <span id="startIndex">0</span> to <span id="endIndex">0</span> of <span id="totalProducts">0</span> products
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" id="firstPage" onclick="goToPage(1)">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="pagination-btn" id="prevPage" onclick="prevPage()">
          <i class="fas fa-chevron-left"></i> Prev
        </button>
        
        <div class="page-numbers" id="pageNumbers">
          </div>
        
        <button class="pagination-btn" id="nextPage" onclick="nextPage()">
          Next <i class="fas fa-chevron-right"></i>
        </button>
        <button class="pagination-btn" id="lastPage" onclick="goToPage(totalPages)">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </div>
  </main>
</div>

<div class="modal" id="productModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Add New Product</div>
      <button class="btn btn-secondary btn-sm" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="productForm" onsubmit="saveProduct(event)">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
          <div class="filter-group">
            <label class="filter-label">Product Name *</label>
            <input type="text" id="productName" class="filter-input" required />
          </div>
          <div class="filter-group">
            <label class="filter-label">SKU *</label>
            <input type="text" id="productSKU" class="filter-input" required />
          </div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label class="filter-label">Description</label>
          <textarea id="productDescription" class="filter-input" rows="3"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
          <div class="filter-group">
            <label class="filter-label">Price *</label>
            <input type="number" id="productPrice" class="filter-input" step="0.01" required />
          </div>
          <div class="filter-group">
            <label class="filter-label">Stock *</label>
            <input type="number" id="productStock" class="filter-input" required />
          </div>
          <div class="filter-group">
            <label class="filter-label">Category *</label>
            <select id="productCategory" class="filter-select" required></select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Status *</label>
            <select id="productStatus" class="filter-select" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
        </div>
        
        <div class="filter-group" style="margin-bottom: 20px;">
          <label class="filter-label">Tags</label>
          <select id="productTags" class="filter-select" multiple style="height: 100px;">
            </select>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label class="filter-label">Product Images</label>
          <div id="imageUpload" style="border: 2px dashed var(--gray-300); border-radius: 8px; padding: 30px; text-align: center; cursor: pointer;">
            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--gray-400); margin-bottom: 10px;"></i>
            <p>Click to upload or drag and drop</p>
            <p style="font-size: 0.8rem; color: var(--gray-500);">PNG, JPG, GIF up to 10MB</p>
          </div>
          <div id="imagePreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
        </div>
        
        <input type="hidden" id="productId" />
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" type="submit" form="productForm">Save Product</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  // Configuration
  const API_BASE = "https://ecommerce-backend-mlik.onrender.com";
  const API_V1 = API_BASE + "/api/v1";
  
  let currentPage = 1;
  let totalPages = 1;
  let totalProducts = 0;
  let limit = 20;
  let selectedProducts = new Set();
  let allCategories = [];
  let allTags = [];

  // Fix 2: Initialize with proper error handling and sequencing
  document.addEventListener('DOMContentLoaded', () => {
    checkAdminAuth();
    initializeFilters();
    loadProducts();
    setupEventListeners();
    // Load categories separately with a slight delay to ensure tokens are ready/UI is painted
    setTimeout(loadCategories, 500);
    // Add this line to debug your data if needed:
    // debugProductImages();
  });

  // Admin Authentication
  function checkAdminAuth() {
    const token = localStorage.getItem("adminToken");
    if (!token) {
      alert("Please login as admin.");
      window.location.href = "admin-login.html";
    }
  }

  // Initialize Filters with Debounce
  function initializeFilters() {
    const debounce = (func, wait) => {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    };

    const updateProducts = debounce(() => {
      currentPage = 1;
      loadProducts();
    }, 500);

    // Search input
    document.getElementById('searchInput').addEventListener('input', updateProducts);
    
    // Filters
    ['statusFilter', 'categoryFilter', 'minPrice', 'maxPrice', 'minStock', 'maxStock', 'startDate', 'endDate']
      .forEach(id => {
        document.getElementById(id).addEventListener('change', updateProducts);
      });

    // Select All checkbox
    document.getElementById('selectAll').addEventListener('change', toggleSelectAll);
  }

  // Fix 2: Robust Category Loading
  async function loadCategories() {
    try {
      const token = localStorage.getItem("adminToken");
      if (!token) return;
      
      console.log("Loading categories...");
      const response = await fetch(`${API_V1}/categories`, {
        headers: { 
          "Authorization": "Bearer " + token,
          "Accept": "application/json"
        }
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log("Categories response:", data);
        
        // Handle different response structures
        if (data.success && data.data) {
          allCategories = Array.isArray(data.data) ? data.data : [];
        } else if (Array.isArray(data)) {
          allCategories = data;
        } else if (data.categories && Array.isArray(data.categories)) {
          allCategories = data.categories;
        } else {
          allCategories = [];
        }
        
        if (allCategories.length > 0) {
          populateCategoryFilters();
        } else {
          console.warn("No categories found or empty array");
        }
      } else {
        console.warn("Categories API error:", response.status);
      }
    } catch (error) {
      console.error("Error loading categories:", error);
      // Continue without categories
      allCategories = [];
    }
  }

  // Fix 2: Robust Product Loading (Retry logic & Structure check)
  async function loadProducts() {
    showLoading();
    
    const token = localStorage.getItem("adminToken");
    if (!token) {
      alert("Please login as admin.");
      window.location.href = "admin-login.html";
      return;
    }
    
    // Build query params
    const params = buildQueryParams();
    console.log("Loading products with params:", params.toString());
    
    try {
      // Try different endpoints in order to handle potential router mismatches
      let endpoints = [
        `${API_V1}/admin/products?${params}`,
        `${API_V1}/products?${params}`
      ];
      
      let response = null;
      let data = null;
      
      // Try each endpoint
      for (const endpoint of endpoints) {
        try {
          console.log("Trying endpoint:", endpoint);
          response = await fetch(endpoint, {
            headers: {
              "Authorization": "Bearer " + token,
              "Accept": "application/json"
            }
          });
          
          if (response.ok) {
            data = await response.json();
            console.log("Products response from", endpoint, ":", data);
            break;
          }
        } catch (err) {
          console.warn("Failed with endpoint:", endpoint, err);
          continue;
        }
      }
      
      if (!response || !response.ok) {
        throw new Error(`All endpoints failed. Last status: ${response?.status}`);
      }
      
      // Handle different response structures
      let products = [];
      let pagination = {};
      let stats = {};
      
      if (data.success) {
        // Standard response format
        if (Array.isArray(data.data)) {
          products = data.data;
        } else if (data.data && Array.isArray(data.data.products)) {
          products = data.data.products;
        } else if (Array.isArray(data.products)) {
          products = data.products;
        }
        
        pagination = data.pagination || data.meta || {};
        stats = data.stats || {};
      } else if (Array.isArray(data)) {
        // Direct array response
        products = data;
      }
      
      renderProducts(products);
      updatePagination(pagination);
      updateStats(stats);
      
    } catch (error) {
      console.error("Error loading products:", error);
      showError("Failed to load products. Please check console for details.");
      
      // Show empty state
      renderProducts([]);
      updatePagination({ page: 1, total: 0, pages: 1 });
    } finally {
      hideLoading();
    }
  }

  // Fix 2: Build Query Parameters (Simplified and Robust)
  function buildQueryParams() {
    const params = new URLSearchParams({
      page: currentPage.toString(),
      limit: limit.toString()
    });

    const search = document.getElementById('searchInput').value.trim();
    if (search) params.append("search", search);
    
    const status = document.getElementById('statusFilter').value;
    if (status !== 'all') params.append("status", status);
    
    const category = document.getElementById('categoryFilter').value;
    if (category) params.append("category", category);
    
    // Only add filters that have values
    const minPrice = document.getElementById('minPrice').value;
    const maxPrice = document.getElementById('maxPrice').value;
    if (minPrice) params.append("minPrice", minPrice);
    if (maxPrice) params.append("maxPrice", maxPrice);
    
    const minStock = document.getElementById('minStock').value;
    const maxStock = document.getElementById('maxStock').value;
    if (minStock) params.append("minStock", minStock);
    if (maxStock) params.append("maxStock", maxStock);
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (startDate) params.append("startDate", startDate);
    if (endDate) params.append("endDate", endDate);

    return params.toString();
  }

  // HELPER: Get image URL from multiple possible locations
  function getProductImageUrl(product) {
    if (!product) return '';
    
    // Try different image property names and formats
    const imageSources = [
      // Array of images
      () => product.images && product.images[0] ? extractUrl(product.images[0]) : '',
      () => product.imageGallery && product.imageGallery[0] ? extractUrl(product.imageGallery[0]) : '',
      
      // Single image properties
      () => product.image ? extractUrl(product.image) : '',
      () => product.thumbnail ? extractUrl(product.thumbnail) : '',
    ];
    
    for (const getImage of imageSources) {
      const url = getImage();
      if (url) return url;
    }
    
    return '';
  }

  // HELPER: Extract URL from different formats (string or object)
  function extractUrl(imageData) {
    if (!imageData) return '';
    
    if (typeof imageData === 'string') {
      return imageData;
    }
    
    if (typeof imageData === 'object') {
      return imageData.url || 
             imageData.secure_url || 
             imageData.public_id || 
             '';
    }
    
    return '';
  }

  // UPDATED: Render Products with Robust Image Handling
  function renderProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';
    
    if (!products || products.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="11" style="text-align: center; padding: 40px;">
            <i class="fas fa-box-open" style="font-size: 3rem; color: var(--gray-300); margin-bottom: 15px;"></i>
            <p style="color: var(--gray-500);">No products found</p>
            <button class="btn btn-secondary btn-sm" onclick="loadProducts()">
              <i class="fas fa-redo"></i> Retry
            </button>
          </td>
        </tr>
      `;
      return;
    }

    products.forEach(product => {
      const row = document.createElement('tr');
      // Handle both _id and id
      const productId = product._id || product.id || '';
      const isSelected = selectedProducts.has(productId);
      
      // Safe data extraction with defaults
      const productName = product.name || 'Unnamed Product';
      const productSku = product.sku || 'N/A';
      const sellerName = product.seller?.name || product.sellerName || 'N/A';
      const sellerEmail = product.seller?.email || '';
      const categoryName = product.category?.name || product.categoryName || 'N/A';
      const price = product.price || product.sellingPrice || 0;
      const stock = product.stock || product.stockQuantity || 0;
      const salesCount = product.salesCount || 0;
      const status = product.status || 'unknown';
      const createdAt = product.createdAt || new Date();
      
      // Use the helper function to get a valid URL
      const imageUrl = getProductImageUrl(product);
      
      // Placeholder HTML to use on error or if no image exists
      const placeholderHtml = `<div class="product-image" style="background: var(--gray-200); display: flex; align-items: center; justify-content: center;"><i class="fas fa-image" style="color: var(--gray-400);"></i></div>`;
      
      const imageHtml = imageUrl 
        ? `<img src="${imageUrl}" class="product-image" alt="${productName}" onerror="this.onerror=null;this.parentElement.innerHTML='${placeholderHtml.replace(/"/g, "'")}'">`
        : placeholderHtml;
      
      row.innerHTML = `
        <td><input type="checkbox" class="product-checkbox" value="${productId}" ${isSelected ? 'checked' : ''} /></td>
        <td>${imageHtml}</td>
        <td>
          <div style="font-weight: 500; margin-bottom: 5px;">${productName}</div>
          <div style="font-size: 0.8rem; color: var(--gray-500);">SKU: ${productSku}</div>
        </td>
        <td>
          <div style="font-weight: 500;">${sellerName}</div>
          <div style="font-size: 0.8rem; color: var(--gray-500);">${sellerEmail}</div>
        </td>
        <td>${categoryName}</td>
        <td style="font-weight: 600;">₹${formatPrice(price)}</td>
        <td>
          <span style="font-weight: 500; ${stock <= 10 ? 'color: var(--danger);' : ''}">
            ${stock}
          </span>
        </td>
        <td>${salesCount}</td>
        <td><span class="badge ${status}">${status}</span></td>
        <td style="font-size: 0.85rem; color: var(--gray-600);">
          ${formatDate(createdAt)}
        </td>
        <td>
          <div class="action-dropdown">
            <button class="action-btn" onclick="toggleDropdown(this)">
              <i class="fas fa-ellipsis-h"></i> Actions
            </button>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item" onclick="editProduct('${productId}')">
                <i class="fas fa-edit"></i> Edit
              </a>
              <a href="#" class="dropdown-item" onclick="viewProduct('${productId}')">
                <i class="fas fa-eye"></i> View
              </a>
              <a href="#" class="dropdown-item" onclick="changeStatus('${productId}', '${status}')">
                <i class="fas fa-exchange-alt"></i> Change Status
              </a>
              <div style="border-top: 1px solid var(--gray-200); margin: 5px 0;"></div>
              <a href="#" class="dropdown-item" style="color: var(--danger);" onclick="deleteProduct('${productId}')">
                <i class="fas fa-trash"></i> Delete
              </a>
            </div>
          </div>
        </td>
      `;
      
      tbody.appendChild(row);
    });

    // Add event listeners to checkboxes
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', handleProductSelection);
    });
  }

  // Pagination Functions
  function updatePagination(pagination) {
    if (!pagination) return;
    
    totalPages = pagination.pages || 1;
    totalProducts = pagination.total || 0;
    currentPage = pagination.page || 1;
    
    document.getElementById('startIndex').textContent = ((currentPage - 1) * limit) + 1;
    document.getElementById('endIndex').textContent = Math.min(currentPage * limit, totalProducts);
    document.getElementById('totalProducts').textContent = totalProducts;
    
    updatePaginationButtons();
    generatePageNumbers();
  }

  function updatePaginationButtons() {
    document.getElementById('firstPage').disabled = currentPage === 1;
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
    document.getElementById('lastPage').disabled = currentPage === totalPages;
  }

  function generatePageNumbers() {
    const container = document.getElementById('pageNumbers');
    container.innerHTML = '';
    
    const maxVisiblePages = 5;
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
    
    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }
    
    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('div');
      pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
      pageBtn.textContent = i;
      pageBtn.onclick = () => goToPage(i);
      container.appendChild(pageBtn);
    }
  }

  function goToPage(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    loadProducts();
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      loadProducts();
    }
  }

  function nextPage() {
    if (currentPage < totalPages) {
      currentPage++;
      loadProducts();
    }
  }

  // Fix 2: Populate Category Filters (Safe fallback)
  function populateCategoryFilters() {
    const categoryFilter = document.getElementById('categoryFilter');
    const productCategory = document.getElementById('productCategory');
    
    // Clear existing options (except first)
    while (categoryFilter.options.length > 1) {
      categoryFilter.remove(1);
    }
    while (productCategory.options.length > 0) {
      productCategory.remove(0);
    }
    
    // Add default option for modal
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select Category';
    productCategory.appendChild(defaultOption);
    
    // Add categories
    if (Array.isArray(allCategories) && allCategories.length > 0) {
      allCategories.forEach(category => {
        // Handle different category structures
        const categoryId = category._id || category.id || category.value || '';
        const categoryName = category.name || category.label || category.text || 'Unnamed Category';
        
        if (categoryId && categoryName) {
          const option1 = document.createElement('option');
          option1.value = categoryId;
          option1.textContent = categoryName;
          categoryFilter.appendChild(option1.cloneNode(true));
          
          const option2 = document.createElement('option');
          option2.value = categoryId;
          option2.textContent = categoryName;
          productCategory.appendChild(option2);
        }
      });
      
      // Initialize Select2 only if jQuery is available
      if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
        $(productCategory).select2({
          placeholder: "Select Category",
          allowClear: true
        });
      }
    } else {
      console.warn("No categories available to populate");
    }
  }

  // Product Selection
  function handleProductSelection(event) {
    const productId = event.target.value;
    
    if (event.target.checked) {
      selectedProducts.add(productId);
    } else {
      selectedProducts.delete(productId);
    }
    
    updateBulkActions();
  }

  function toggleSelectAll(event) {
    const checkboxes = document.querySelectorAll('.product-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.checked = event.target.checked;
      if (event.target.checked) {
        selectedProducts.add(checkbox.value);
      } else {
        selectedProducts.delete(checkbox.value);
      }
    });
    
    updateBulkActions();
  }

  function updateBulkActions() {
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    selectedCount.textContent = `${selectedProducts.size} products selected`;
    
    if (selectedProducts.size > 0) {
      bulkActions.style.display = 'flex';
    } else {
      bulkActions.style.display = 'none';
    }
  }

  function clearSelection() {
    selectedProducts.clear();
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
    updateBulkActions();
  }

  // Bulk Actions
  async function applyBulkAction() {
    const action = document.getElementById('bulkActionSelect').value;
    if (!action) {
      alert('Please select an action');
      return;
    }
    
    if (selectedProducts.size === 0) {
      alert('No products selected');
      return;
    }
    
    const productIds = Array.from(selectedProducts);
    
    if (!confirm(`Are you sure you want to ${action} ${productIds.length} product(s)?`)) {
      return;
    }
    
    try {
      const token = localStorage.getItem("adminToken");
      const response = await fetch(`${API_V1}/admin/products/bulk`, {
        method: 'POST',
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          action: action,
          productIds: productIds
        })
      });
      
      if (response.ok) {
        alert('Bulk action completed successfully');
        clearSelection();
        loadProducts();
      } else {
        throw new Error('Bulk action failed');
      }
    } catch (error) {
      alert('Failed to apply bulk action');
      console.error(error);
    }
  }

  // Add/Edit Product
  function showAddProductModal() {
    document.getElementById('modalTitle').textContent = 'Add New Product';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('imagePreview').innerHTML = '';
    
    // Show modal
    document.getElementById('productModal').style.display = 'flex';
  }

  function editProduct(productId) {
    // Fetch product details and populate form
    fetchProductDetails(productId);
    document.getElementById('modalTitle').textContent = 'Edit Product';
    document.getElementById('productModal').style.display = 'flex';
  }

  async function fetchProductDetails(productId) {
    try {
      const token = localStorage.getItem("adminToken");
      const response = await fetch(`${API_V1}/admin/products/${productId}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      
      if (response.ok) {
        const data = await response.json();
        // Handle nested data structures for single product
        const product = data.data || data.product || data;
        populateProductForm(product);
      }
    } catch (error) {
      console.error("Error fetching product details:", error);
    }
  }

  function populateProductForm(product) {
    document.getElementById('productId').value = product._id;
    document.getElementById('productName').value = product.name;
    document.getElementById('productSKU').value = product.sku || '';
    document.getElementById('productDescription').value = product.description || '';
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productStock').value = product.stock;
    
    // Handle nested category object or ID
    const catId = product.category?._id || product.category || '';
    document.getElementById('productCategory').value = catId;
    
    document.getElementById('productStatus').value = product.status;
    
    // Populate tags
    if (product.tags && product.tags.length > 0) {
      const tagSelect = document.getElementById('productTags');
      product.tags.forEach(tag => {
        // Only add if doesn't exist to prevent duplicates
        if (!tagSelect.querySelector(`option[value="${tag}"]`)) {
             const option = new Option(tag, tag, true, true);
             tagSelect.add(option);
        }
      });
    }
    
    // Populate images
    const imagePreview = document.getElementById('imagePreview');
    imagePreview.innerHTML = '';
    
    if (product.images && product.images.length > 0) {
      product.images.forEach(image => {
        const imgDiv = document.createElement('div');
        imgDiv.style.position = 'relative';
        
        // Extract URL for preview as well
        const imgUrl = extractUrl(image);
        
        imgDiv.innerHTML = `
          <img src="${imgUrl}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
          <button onclick="removeImage(this)" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;">×</button>
        `;
        imagePreview.appendChild(imgDiv);
      });
    }
    
    // Update Select2 if active
    if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
      $(document.getElementById('productCategory')).trigger('change');
      $(document.getElementById('productTags')).trigger('change');
    }
  }

  async function saveProduct(event) {
    event.preventDefault();
    
    const productId = document.getElementById('productId').value;
    const isEdit = !!productId;
    
    const productData = {
      name: document.getElementById('productName').value,
      sku: document.getElementById('productSKU').value,
      description: document.getElementById('productDescription').value,
      price: parseFloat(document.getElementById('productPrice').value),
      stock: parseInt(document.getElementById('productStock').value),
      category: document.getElementById('productCategory').value,
      status: document.getElementById('productStatus').value,
      tags: Array.from(document.getElementById('productTags').selectedOptions).map(opt => opt.value)
    };
    
    try {
      const token = localStorage.getItem("adminToken");
      const url = isEdit 
        ? `${API_V1}/admin/products/${productId}`
        : `${API_V1}/admin/products`;
      
      const method = isEdit ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method: method,
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(productData)
      });
      
      if (response.ok) {
        alert(`Product ${isEdit ? 'updated' : 'created'} successfully!`);
        closeModal();
        loadProducts();
      } else {
        throw new Error('Failed to save product');
      }
    } catch (error) {
      alert(`Failed to ${isEdit ? 'update' : 'create'} product`);
      console.error(error);
    }
  }

  function closeModal() {
    document.getElementById('productModal').style.display = 'none';
  }

  // Change Product Status
  function changeStatus(productId, currentStatus) {
    const newStatus = prompt(`Current status: ${currentStatus}\n\nEnter new status (active/inactive/pending/rejected):`, currentStatus);
    
    if (newStatus && ['active', 'inactive', 'pending', 'rejected'].includes(newStatus.toLowerCase())) {
      if (confirm(`Change status from ${currentStatus} to ${newStatus}?`)) {
        updateProductStatus(productId, newStatus.toLowerCase());
      }
    }
  }

  async function updateProductStatus(productId, status) {
    try {
      const token = localStorage.getItem("adminToken");
      const response = await fetch(`${API_V1}/admin/products/${productId}/status`, {
        method: 'PATCH',
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ status: status })
      });
      
      if (response.ok) {
        alert('Status updated successfully!');
        loadProducts();
      } else {
        throw new Error('Failed to update status');
      }
    } catch (error) {
      alert('Failed to update status');
      console.error(error);
    }
  }

  // Delete Product
  async function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
      return;
    }
    
    try {
      const token = localStorage.getItem("adminToken");
      const response = await fetch(`${API_V1}/admin/products/${productId}`, {
        method: 'DELETE',
        headers: { "Authorization": "Bearer " + token }
      });
      
      if (response.ok) {
        alert('Product deleted successfully!');
        loadProducts();
      } else {
        throw new Error('Failed to delete product');
      }
    } catch (error) {
      alert('Failed to delete product');
      console.error(error);
    }
  }

  // Export Products
  async function exportProducts() {
    try {
      const token = localStorage.getItem("adminToken");
      const params = buildQueryParams();
      
      const response = await fetch(`${API_V1}/admin/products/export?${params}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `products_export_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } else {
        throw new Error('Export failed');
      }
    } catch (error) {
      alert('Failed to export products');
      console.error(error);
    }
  }

  // View Product Details
  function viewProduct(productId) {
    window.open(`/admin/product-details.html?id=${productId}`, '_blank');
  }

  // Reset Filters
  function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    document.getElementById('minStock').value = '';
    document.getElementById('maxStock').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    
    currentPage = 1;
    loadProducts();
  }

  // Update Stats
  function updateStats(stats) {
    if (!stats) return;
    
    document.getElementById('activeCount').textContent = stats.active || 0;
    document.getElementById('inactiveCount').textContent = stats.inactive || 0;
    document.getElementById('pendingCount').textContent = stats.pending || 0;
    document.getElementById('rejectedCount').textContent = stats.rejected || 0;
  }

  // Utility Functions
  function formatPrice(price) {
    return parseFloat(price).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  }

  function showLoading() {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = `
      <tr>
        <td colspan="11" style="text-align: center; padding: 40px;">
          <div class="loading" style="margin: 0 auto 15px;"></div>
          <p style="color: var(--gray-500);">Loading products...</p>
        </td>
      </tr>
    `;
  }

  function hideLoading() {
    // Hidden by renderProducts
  }

  function showError(message) {
    console.error(message);
    // Optional: show toast
  }

  function toggleDropdown(button) {
    const dropdown = button.nextElementSibling;
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    
    // Close other dropdowns
    document.querySelectorAll('.dropdown-menu').forEach(menu => {
      if (menu !== dropdown) menu.style.display = 'none';
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', (event) => {
    if (!event.target.closest('.action-dropdown')) {
      document.querySelectorAll('.dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
      });
    }
  });

  // Setup event listeners
  function setupEventListeners() {
    // Image upload
    const imageUpload = document.getElementById('imageUpload');
    if (imageUpload) {
      imageUpload.addEventListener('click', () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.multiple = true;
        input.onchange = handleImageUpload;
        input.click();
      });
    }
  }

  function handleImageUpload(event) {
    const files = event.target.files;
    const imagePreview = document.getElementById('imagePreview');
    
    for (let file of files) {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const imgDiv = document.createElement('div');
          imgDiv.style.position = 'relative';
          imgDiv.innerHTML = `
            <img src="${e.target.result}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
            <button onclick="removeImage(this)" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;">×</button>
          `;
          imagePreview.appendChild(imgDiv);
        };
        reader.readAsDataURL(file);
      }
    }
  }

  function removeImage(button) {
    button.parentElement.remove();
  }
  
  // Debug Script for checking data structure
  function debugProductImages() {
    const token = localStorage.getItem("adminToken");
    
    fetch(`${API_V1}/products?limit=1`, {
      headers: { "Authorization": "Bearer " + token }
    })
    .then(response => response.json())
    .then(data => {
      console.log("Product data structure:", data);
      
      if (data.data && data.data[0]) {
        const product = data.data[0];
        console.log("First product:", product);
        console.log("Product images property:", product.images);
        console.log("Type of images:", typeof product.images);
        console.log("Is array?", Array.isArray(product.images));
        
        if (product.images && Array.isArray(product.images)) {
          console.log("First image:", product.images[0]);
          console.log("Type of first image:", typeof product.images[0]);
          
          if (product.images[0] && typeof product.images[0] === 'object') {
            console.log("Image object keys:", Object.keys(product.images[0]));
          }
        }
      }
    })
    .catch(error => console.error("Debug error:", error));
  }
</script>
</body>
</html>