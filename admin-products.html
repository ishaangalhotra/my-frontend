<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Product Management ‚Ä¢ QuickLocal Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --info: #0891b2;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: #f5f5f5; color: var(--gray-800); }
    .container { display: flex; min-height: 100vh; }

    /* Sidebar - unchanged */
    .sidebar { width: 280px; background: linear-gradient(180deg, var(--gray-900) 0%, var(--gray-800) 100%); color: white; padding: 20px 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 1000; }
    .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 20px; }
    .sidebar-header h2 { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .sidebar-nav { padding: 0 15px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--gray-300); text-decoration: none; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; font-size: 0.95rem; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.08); color: white; }
    .nav-item.active { background: var(--primary); color: white; font-weight: 500; }
    .nav-item i { width: 20px; text-align: center; font-size: 1.1rem; }

    .content { flex: 1; margin-left: 280px; padding: 25px 30px; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--gray-200); }
    .header-left h1 { font-size: 1.6rem; font-weight: 700; color: var(--gray-900); margin-bottom: 5px; }
    .header-left p { color: var(--gray-500); font-size: 0.9rem; }
    .header-actions { display: flex; gap: 12px; }

    /* Stats */
    .quick-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); border: 1px solid var(--gray-100); }
    .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; font-size: 1.3rem; }
    .stat-icon.active { background: #dcfce7; color: var(--success); }
    .stat-icon.inactive { background: #f3f4f6; color: var(--gray-600); }
    .stat-icon.pending { background: #fef3c7; color: var(--warning); }
    .stat-icon.rejected { background: #fee2e2; color: var(--danger); }
    .stat-icon.draft { background: #dbeafe; color: var(--primary); }
    .stat-icon.out-of-stock { background: #fef3c7; color: #f59e0b; }
    .stat-icon.archived { background: #f3e8ff; color: #8b5cf6; }
    .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
    .stat-label { color: var(--gray-500); font-size: 0.9rem; }

    /* Bulk Actions - IMPROVED */
    .bulk-actions {
      padding: 15px 20px;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
      display: none;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .bulk-action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .bulk-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }
    .bulk-btn.activate { background: #dcfce7; color: var(--success); }
    .bulk-btn.deactivate { background: #f3f4f6; color: var(--gray-600); }
    .bulk-btn.delete { background: #fee2e2; color: var(--danger); }
    .bulk-btn.restore { background: #dbeafe; color: var(--primary); }

    /* Filters - UPDATED for missing statuses */
    .filters-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .filters-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .filters-title { font-weight: 600; color: var(--gray-800); }
    .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .filter-group { display: flex; flex-direction: column; gap: 8px; }
    .filter-label { font-size: 0.85rem; font-weight: 500; color: var(--gray-700); }
    .filter-input, .filter-select { padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 0.9rem; width: 100%; transition: border-color 0.2s; }
    .filter-input:focus, .filter-select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .date-range { display: flex; gap: 10px; }

    /* Buttons */
    .btn { padding: 10px 20px; border-radius: 8px; border: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: var(--gray-100); color: var(--gray-700); }
    .btn-secondary:hover { background: var(--gray-200); }
    .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

    /* Table */
    .table-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); margin-bottom: 25px; }
    .table-responsive { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    .data-table thead { background: var(--gray-50); }
    .data-table th { padding: 16px; text-align: left; font-weight: 600; color: var(--gray-700); font-size: 0.9rem; border-bottom: 2px solid var(--gray-200); }
    .data-table td { padding: 16px; border-bottom: 1px solid var(--gray-100); font-size: 0.9rem; vertical-align: middle; }
    .product-image { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--gray-200); cursor: pointer; transition: transform 0.2s; }
    .product-image:hover { transform: scale(1.05); }
    
    /* Badges - UPDATED with all statuses */
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase; display: inline-block; }
    .badge.active { background: #dcfce7; color: var(--success); }
    .badge.inactive { background: #f3f4f6; color: var(--gray-600); }
    .badge.pending { background: #fef3c7; color: var(--warning); }
    .badge.rejected { background: #fee2e2; color: var(--danger); }
    .badge.out_of_stock { background: #fef3c7; color: #f59e0b; }
    .badge.draft { background: #dbeafe; color: var(--primary); }
    .badge.archived { background: #f3e8ff; color: #8b5cf6; border: 1px solid #c4b5fd; }

    /* Image Preview Modal */
    .image-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 3000;
      align-items: center;
      justify-content: center;
    }
    .image-modal-content {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
      position: relative;
    }
    .image-modal-content img {
      width: 100%;
      height: auto;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 8px;
    }
    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-modal-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .image-modal-prev { left: 20px; }
    .image-modal-next { right: 20px; }

    /* Dropdown */
    .action-dropdown { position: relative; display: inline-block; }
    .action-btn { padding: 6px 12px; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
    .dropdown-menu { position: absolute; top: 100%; right: 0; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); min-width: 160px; z-index: 100; display: none; }
    .dropdown-item { padding: 10px 15px; display: flex; align-items: center; gap: 10px; color: var(--gray-700); text-decoration: none; font-size: 0.85rem; transition: background 0.2s; }
    .dropdown-item:hover { background: var(--gray-50); }
    .dropdown-item.restore { color: var(--success); }
    .dropdown-item.delete { color: var(--danger); }

    /* Pagination */
    .pagination { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); }
    .pagination-controls { display: flex; gap: 8px; align-items: center; }
    .pagination-btn { padding: 8px 16px; background: white; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .page-numbers { display: flex; gap: 4px; }
    .page-number { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
    .page-number:hover { background: var(--gray-100); }
    .page-number.active { background: var(--primary); color: white; }

    /* Modal - UPDATED with more fields */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal-content { background: white; border-radius: 16px; width: 90%; max-width: 1000px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15); animation: modalSlideIn 0.3s ease; }
    @keyframes modalSlideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 10; border-radius: 16px 16px 0 0; }
    .modal-title { font-size: 1.25rem; font-weight: 600; color: var(--gray-900); }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 20px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px; position: sticky; bottom: 0; background: white; z-index: 10; border-radius: 0 0 16px 16px; }

    /* Form Grid */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .form-full-width { grid-column: 1 / -1; }

    /* Section Header for Form */
    .form-section-title { font-size: 0.95rem; font-weight: 600; color: var(--gray-800); margin: 25px 0 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; gap: 8px; }
    .form-section-title i { color: var(--primary); }

    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--gray-200); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 1200px) { .sidebar { width: 80px; } .sidebar .nav-item span { display: none; } .content { margin-left: 80px; } }
    @media (max-width: 768px) { .content { padding: 15px; } .quick-stats { grid-template-columns: repeat(2, 1fr); } .form-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div class="container">
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2><i class="fas fa-store"></i> QuickLocal</h2>
    </div>
    <nav class="sidebar-nav">
      <a href="admin-dashboard.html" class="nav-item">
        <i class="fas fa-home"></i><span>Dashboard</span>
      </a>
      <a href="admin-orders.html" class="nav-item">
        <i class="fas fa-shopping-bag"></i><span>Orders</span>
      </a>
      <a href="admin-users.html" class="nav-item">
        <i class="fas fa-users"></i><span>Users</span>
      </a>
      <a href="admin-products.html" class="nav-item active">
        <i class="fas fa-box"></i><span>Products</span>
      </a>
      <a href="admin-categories.html" class="nav-item">
        <i class="fas fa-tags"></i><span>Categories</span>
      </a>
      <a href="admin-analytics.html" class="nav-item">
        <i class="fas fa-chart-bar"></i><span>Analytics</span>
      </a>
      <a href="admin-settings.html" class="nav-item">
        <i class="fas fa-cog"></i><span>Settings</span>
      </a>
      <a href="admin-login.html" class="nav-item" style="margin-top: 20px;">
        <i class="fas fa-sign-out-alt"></i><span>Logout</span>
      </a>
    </nav>
  </aside>

  <main class="content">
    <div class="header">
      <div class="header-left">
        <h1>Product Management</h1>
        <p>Manage all products in your marketplace</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="exportProducts()">
          <i class="fas fa-download"></i> Export
        </button>
        <button class="btn btn-primary" onclick="showAddProductModal()">
          <i class="fas fa-plus"></i> Add Product
        </button>
      </div>
    </div>

    <!-- Updated Stats with all statuses -->
    <div class="quick-stats" id="statsContainer">
      <div class="stat-card">
        <div class="stat-icon active"><i class="fas fa-check-circle"></i></div>
        <div class="stat-value" id="activeCount">0</div>
        <div class="stat-label">Active Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon inactive"><i class="fas fa-pause-circle"></i></div>
        <div class="stat-value" id="inactiveCount">0</div>
        <div class="stat-label">Inactive Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon pending"><i class="fas fa-clock"></i></div>
        <div class="stat-value" id="pendingCount">0</div>
        <div class="stat-label">Pending Review</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon draft"><i class="fas fa-file-alt"></i></div>
        <div class="stat-value" id="draftCount">0</div>
        <div class="stat-label">Draft Products</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon out-of-stock"><i class="fas fa-exclamation-triangle"></i></div>
        <div class="stat-value" id="outOfStockCount">0</div>
        <div class="stat-label">Out of Stock</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon archived"><i class="fas fa-archive"></i></div>
        <div class="stat-value" id="archivedCount">0</div>
        <div class="stat-label">Archived/Deleted</div>
      </div>
    </div>

    <!-- Enhanced Bulk Actions -->
    <div class="bulk-actions" id="bulkActions">
      <span id="selectedCount">0 products selected</span>
      <div class="bulk-action-buttons">
        <button class="bulk-btn activate" onclick="bulkAction('activate')">
          <i class="fas fa-check"></i> Activate
        </button>
        <button class="bulk-btn deactivate" onclick="bulkAction('deactivate')">
          <i class="fas fa-ban"></i> Deactivate
        </button>
        <button class="bulk-btn delete" onclick="bulkAction('delete')">
          <i class="fas fa-trash"></i> Move to Trash
        </button>
        <button class="bulk-btn restore" onclick="bulkAction('restore')">
          <i class="fas fa-trash-restore"></i> Restore
        </button>
        <button class="btn btn-sm btn-secondary" onclick="clearSelection()">
          <i class="fas fa-times"></i> Clear
        </button>
      </div>
    </div>

    <div class="filters-container">
      <div class="filters-header">
        <div class="filters-title">Filters & Search</div>
        <button class="btn btn-secondary btn-sm" onclick="resetFilters()">
          <i class="fas fa-redo"></i> Reset
        </button>
      </div>
      <div class="filters-grid">
        <div class="filter-group">
          <label class="filter-label">Search Products</label>
          <input type="text" id="searchInput" class="filter-input" placeholder="Name, SKU, description..." />
        </div>
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select id="statusFilter" class="filter-select">
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="pending">Pending</option>
            <option value="rejected">Rejected</option>
            <option value="draft">Draft</option>
            <option value="out_of_stock">Out of Stock</option>
            <option value="archived" style="color:var(--danger); font-weight:600;">üóëÔ∏è Trash / Deleted</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Category</label>
          <select id="categoryFilter" class="filter-select">
            <option value="">All Categories</option>
            <!-- Categories will be loaded dynamically -->
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Seller</label>
          <select id="sellerFilter" class="filter-select">
            <option value="">All Sellers</option>
            <!-- Sellers will be loaded dynamically -->
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Price Range</label>
          <div style="display: flex; gap: 10px;">
            <input type="number" id="minPrice" class="filter-input" placeholder="Min" style="flex: 1;" />
            <input type="number" id="maxPrice" class="filter-input" placeholder="Max" style="flex: 1;" />
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Stock Range</label>
          <div style="display: flex; gap: 10px;">
            <input type="number" id="minStock" class="filter-input" placeholder="Min" style="flex: 1;" />
            <input type="number" id="maxStock" class="filter-input" placeholder="Max" style="flex: 1;" />
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Date Range</label>
          <div class="date-range">
            <input type="date" id="startDate" class="filter-input" />
            <input type="date" id="endDate" class="filter-input" />
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-label">Sort By</label>
          <select id="sortFilter" class="filter-select">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="price_asc">Price: Low to High</option>
            <option value="price_desc">Price: High to Low</option>
            <option value="name_asc">Name: A-Z</option>
            <option value="name_desc">Name: Z-A</option>
            <option value="stock_low">Stock: Low to High</option>
            <option value="stock_high">Stock: High to Low</option>
          </select>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-responsive">
        <table class="data-table" id="productsTable">
          <thead>
            <tr>
              <th style="width: 40px;">
                <input type="checkbox" id="selectAll" />
              </th>
              <th style="width: 80px;">Image</th>
              <th style="min-width: 200px;">Product Name</th>
              <th style="min-width: 120px;">Seller</th>
              <th style="min-width: 120px;">Category</th>
              <th style="width: 100px;">Price</th>
              <th style="width: 80px;">Stock</th>
              <th style="width: 100px;">Sales</th>
              <th style="width: 120px;">Status</th>
              <th style="width: 100px;">Created</th>
              <th style="width: 150px;">Actions</th>
            </tr>
          </thead>
          <tbody id="productsTableBody">
            <!-- Products will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="pagination">
      <div class="pagination-info">
        Showing <span id="startIndex">0</span> to <span id="endIndex">0</span> of <span id="totalProducts">0</span> products
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" id="firstPage" onclick="goToPage(1)">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button class="pagination-btn" id="prevPage" onclick="prevPage()">
          <i class="fas fa-chevron-left"></i> Prev
        </button>
        
        <div class="page-numbers" id="pageNumbers"></div>
        
        <button class="pagination-btn" id="nextPage" onclick="nextPage()">
          Next <i class="fas fa-chevron-right"></i>
        </button>
        <button class="pagination-btn" id="lastPage" onclick="goToLastPage()">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </div>
  </main>
</div>

<!-- Image Preview Modal -->
<div class="image-modal" id="imageModal">
  <button class="image-modal-close" onclick="closeImageModal()">
    <i class="fas fa-times"></i>
  </button>
  <button class="image-modal-nav image-modal-prev" onclick="prevImage()">
    <i class="fas fa-chevron-left"></i>
  </button>
  <div class="image-modal-content">
    <img id="modalImage" src="" alt="Product Image">
  </div>
  <button class="image-modal-nav image-modal-next" onclick="nextImage()">
    <i class="fas fa-chevron-right"></i>
  </button>
</div>

<!-- Product Modal - UPDATED with all fields -->
<div class="modal" id="productModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Add New Product</div>
      <button class="btn btn-secondary btn-sm" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form id="productForm" onsubmit="saveProduct(event)">
        
        <div class="form-section-title"><i class="fas fa-info-circle"></i> Basic Information</div>
        <div class="form-grid">
          <div class="filter-group">
            <label class="filter-label">Product Name *</label>
            <input type="text" id="productName" class="filter-input" required placeholder="e.g. Wireless Headphones" />
          </div>
          <div class="filter-group">
            <label class="filter-label">SKU (Auto-generated if empty)</label>
            <input type="text" id="productSKU" class="filter-input" placeholder="e.g. WH-1000XM4" />
          </div>
          <div class="filter-group">
            <label class="filter-label">Brand</label>
            <input type="text" id="productBrand" class="filter-input" placeholder="e.g. Sony" />
          </div>
          <div class="filter-group">
            <label class="filter-label">Seller *</label>
            <select id="productSeller" class="filter-select" required></select>
          </div>
        </div>
        
        <div class="filter-group" style="margin-bottom: 20px;">
          <label class="filter-label">Description</label>
          <textarea id="productDescription" class="filter-input" rows="4" placeholder="Describe the product features, specs, etc."></textarea>
        </div>
        
        <div class="form-section-title"><i class="fas fa-tag"></i> Pricing & Inventory</div>
        <div class="form-grid">
          <div class="filter-group">
            <label class="filter-label">Price (‚Çπ) *</label>
            <input type="number" id="productPrice" class="filter-input" step="0.01" required placeholder="0.00" />
          </div>
          <div class="filter-group">
            <label class="filter-label">Stock Qty *</label>
            <input type="number" id="productStock" class="filter-input" required placeholder="0" />
          </div>
          <div class="filter-group">
            <label class="filter-label">Category *</label>
            <select id="productCategory" class="filter-select" required></select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Status *</label>
            <select id="productStatus" class="filter-select" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="pending">Pending</option>
              <option value="rejected">Rejected</option>
              <option value="draft">Draft</option>
              <option value="out_of_stock">Out of Stock</option>
            </select>
          </div>
        </div>
        
        <div class="form-section-title"><i class="fas fa-cube"></i> Product Details</div>
        <div class="form-grid">
          <div class="filter-group">
            <label class="filter-label">Weight (kg)</label>
            <input type="number" id="productWeight" class="filter-input" step="0.01" placeholder="0.5" />
          </div>
          <div class="filter-group">
            <label class="filter-label">Dimensions (L√óW√óH)</label>
            <input type="text" id="productDimensions" class="filter-input" placeholder="10√ó5√ó2 cm" />
          </div>
          <div class="filter-group">
            <label class="filter-label">Featured Product</label>
            <select id="productFeatured" class="filter-select">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
        </div>
        
        <div class="filter-group" style="margin-bottom: 20px;">
          <label class="filter-label">Tags (Select multiple)</label>
          <select id="productTags" class="filter-select" multiple style="width: 100%;"></select>
        </div>
        
        <div class="form-section-title"><i class="fas fa-search"></i> SEO Metadata</div>
        <div class="form-grid">
          <div class="filter-group">
            <label class="filter-label">Meta Title</label>
            <input type="text" id="metaTitle" class="filter-input" placeholder="SEO Title (max 60 chars)" maxlength="60">
            <div style="font-size: 0.75rem; color: var(--gray-400); text-align: right;">Max 60 chars</div>
          </div>
          <div class="filter-group">
            <label class="filter-label">Canonical URL</label>
            <input type="text" id="canonicalUrl" class="filter-input" placeholder="https://example.com/product/...">
          </div>
        </div>
        <div class="filter-group" style="margin-bottom: 15px;">
          <label class="filter-label">Meta Keywords (Comma separated)</label>
          <input type="text" id="metaKeywords" class="filter-input" placeholder="electronics, headphones, wireless, sony">
        </div>
        <div class="filter-group" style="margin-bottom: 10px;">
          <label class="filter-label">Meta Description</label>
          <textarea id="metaDescription" class="filter-input" rows="2" placeholder="SEO Description (max 160 chars)" maxlength="160"></textarea>
          <div style="font-size: 0.75rem; color: var(--gray-400); text-align: right;">Max 160 chars</div>
        </div>
        
        <div class="form-section-title"><i class="fas fa-images"></i> Product Images</div>
        <div style="margin-bottom: 20px;">
          <div id="imageUpload" style="border: 2px dashed var(--gray-300); border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s;">
            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--gray-400); margin-bottom: 10px;"></i>
            <p style="color: var(--gray-600); font-weight: 500;">Click to upload or drag and drop</p>
            <p style="font-size: 0.8rem; color: var(--gray-500);">PNG, JPG, GIF up to 10MB</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
          </div>
          <div id="imagePreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
        </div>
        
        <input type="hidden" id="productId" />
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" type="submit" form="productForm">Save Product</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="js/load-hybrid-auth.js"></script>
<script>
  // Configuration
  const API_BASE = window.QUICKLOCAL_BACKEND_ORIGIN || "https://ecommerce-backend-mlik.onrender.com";
  const API_V1 = API_BASE + "/api/v1";
  
  // State Management
  let state = {
    currentPage: 1,
    totalPages: 1,
    totalProducts: 0,
    limit: 20,
    selectedProducts: new Set(),
    categories: [],
    sellers: [],
    tags: [],
    currentProductImages: [],
    currentImageIndex: 0
  };

  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', async () => {
    const authed = await checkAdminAuth();
    if (!authed) return;
    initializeFilters();
    loadCategories();
    loadSellers();
    loadTags();
    loadProducts();
    setupImageUpload();

    // Initialize Select2
    if (jQuery.fn.select2) {
      $('#productTags').select2({
        tags: true,
        tokenSeparators: [',', ' '],
        placeholder: "Select or type tags",
        dropdownParent: $('#productModal')
      });
      
      $('#productCategory').select2({ dropdownParent: $('#productModal') });
      $('#productSeller').select2({ dropdownParent: $('#productModal') });
      $('#categoryFilter').select2({ placeholder: "All Categories" });
      $('#sellerFilter').select2({ placeholder: "All Sellers" });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
        closeModal();
        closeImageModal();
      }
    });

    document.getElementById('productModal').addEventListener('click', (e) => {
      if (e.target.id === 'productModal') closeModal();
    });

    document.getElementById('imageModal').addEventListener('click', (e) => {
      if (e.target.id === 'imageModal') closeImageModal();
    });

    window.onclick = function(event) {
      if (!event.target.matches('.action-btn') && !event.target.closest('.action-btn')) {
        document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
      }
    }
  });

  async function checkAdminAuth() {
    try {
      const response = await fetch(`${API_V1}/admin/validate`, {
        method: 'GET',
        credentials: 'include',
        headers: { 'Accept': 'application/json' }
      });
      if (!response.ok) {
        window.location.href = "admin-login.html";
        return false;
      }
      return true;
    } catch (_) {
      window.location.href = "admin-login.html";
      return false;
    }
  }

  // --- API HELPER ---
  async function fetchAPI(endpoint, options = {}) {
    const defaultHeaders = {
      "Content-Type": "application/json",
      "Accept": "application/json"
    };

    try {
      const response = await fetch(`${API_V1}${endpoint}`, {
        ...options,
        credentials: 'include',
        headers: { ...defaultHeaders, ...options.headers }
      });

      if (response.status === 401 || response.status === 403) {
        alert("Session expired. Please login again.");
        window.location.href = "admin-login.html";
        return null;
      }

      const data = await response.json();
      if (!response.ok) throw new Error(data.message || 'API Error');
      return data;
    } catch (error) {
      console.error("API Error:", error);
      throw error;
    }
  }

  // --- DATA LOADING ---
  async function loadCategories() {
    try {
      const data = await fetchAPI('/categories');
      if (data && data.success) {
        state.categories = data.data || data.categories || [];
        populateCategoryDropdowns();
      }
    } catch (error) {
      console.warn("Failed to load categories", error);
      // Fallback to default categories
      state.categories = [
        { _id: "1", name: "Electronics" },
        { _id: "2", name: "Fashion" },
        { _id: "3", name: "Home & Kitchen" }
      ];
      populateCategoryDropdowns();
    }
  }

  async function loadSellers() {
    try {
      const data = await fetchAPI('/admin/users');
      if (data && data.success) {
        // Filter users with seller role
        state.sellers = (data.data || data.users || []).filter(user => 
          user.role === 'seller' || user.role === 'admin'
        );
        populateSellerDropdowns();
      }
    } catch (error) {
      console.warn("Failed to load sellers", error);
    }
  }

  async function loadTags() {
    try {
      const data = await fetchAPI('/admin/products/tags');
      if (data && data.success) {
        state.tags = data.tags || [];
      }
    } catch (error) {
      console.warn("Failed to load tags", error);
    }
  }

  async function loadProducts() {
    showLoadingState();
    
    const params = new URLSearchParams({
      page: state.currentPage,
      limit: state.limit,
      sort: document.getElementById('sortFilter').value
    });

    const filters = {
      search: document.getElementById('searchInput').value.trim(),
      status: document.getElementById('statusFilter').value,
      category: document.getElementById('categoryFilter').value,
      seller: document.getElementById('sellerFilter').value,
      minPrice: document.getElementById('minPrice').value,
      maxPrice: document.getElementById('maxPrice').value,
      minStock: document.getElementById('minStock').value,
      maxStock: document.getElementById('maxStock').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value
    };

    Object.keys(filters).forEach(key => {
      if (filters[key] && filters[key] !== 'all' && filters[key] !== '') {
        params.append(key, filters[key]);
      }
    });

    try {
      const data = await fetchAPI(`/admin/products?${params}`);
      
      let products = [];
      let stats = {};
      if (data && data.success) {
        products = data.data || [];
        stats = data.stats || {};
      }

      state.totalProducts = data.total || products.length;
      state.totalPages = data.pagination?.pages || Math.ceil(state.totalProducts / state.limit) || 1;
      
      renderProductsTable(products);
      updatePaginationUI();
      updateStatsUI(stats);

    } catch (error) {
      document.getElementById('productsTableBody').innerHTML = `
        <tr><td colspan="11" style="text-align: center; padding: 20px; color: var(--danger);">
          Error loading products. <button class="btn btn-sm btn-secondary" onclick="loadProducts()">Retry</button>
        </td></tr>`;
      console.error(error);
    }
  }

  // --- RENDERING ---
  function renderProductsTable(products) {
    const tbody = document.getElementById('productsTableBody');
    tbody.innerHTML = '';

    if (!products || products.length === 0) {
      tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 30px; color: #6b7280;">No products found</td></tr>`;
      return;
    }

    products.forEach(product => {
      const id = product._id || product.id;
      const images = getProductImages(product);
      const mainImage = images.length > 0 ? images[0] : 'https://via.placeholder.com/60?text=No+Img';
      const isChecked = state.selectedProducts.has(id);
      
      // Check if product is in "Trash" (archived status or isDeleted flag)
      const isTrash = product.status === 'archived' || product.isDeleted;
      
      const rowStyle = isTrash ? 'opacity: 0.7; background-color: #fef2f2;' : '';
      
      // Status Badge logic
      const statusBadge = isTrash 
        ? `<span class="badge archived" title="Deleted"><i class="fas fa-trash-alt"></i> Trash</span>`
        : `<span class="badge ${product.status || 'inactive'}">${product.status || 'inactive'}</span>`;

      const row = document.createElement('tr');
      row.style = rowStyle;
      
      row.innerHTML = `
        <td><input type="checkbox" class="product-checkbox" value="${id}" ${isChecked ? 'checked' : ''} onchange="toggleProductSelection('${id}')"></td>
        <td>
          ${images.length > 0 ? 
            `<img src="${mainImage}" class="product-image" onclick="openImageModal('${id}')" onerror="this.src='https://via.placeholder.com/60?text=No+Img'">` :
            `<img src="${mainImage}" class="product-image">`
          }
          ${images.length > 1 ? `<div style="font-size:0.7rem; color:#6b7280; text-align:center;">+${images.length-1}</div>` : ''}
        </td>
        <td>
          <div style="font-weight: 500;">${product.name || 'No Name'}</div>
          <div style="font-size: 0.8rem; color: #6b7280;">SKU: ${product.sku || 'N/A'}</div>
          ${product.description ? `<div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${product.description}</div>` : ''}
        </td>
        <td>${product.seller?.name || product.seller?.businessName || 'Unknown'}</td>
        <td>${product.category?.name || 'Uncategorized'}</td>
        <td style="font-weight: 600;">‚Çπ${(product.price || 0).toLocaleString()}</td>
        <td><span class="${(product.stock || 0) < 10 ? 'text-danger' : ''}">${product.stock || 0}</span></td>
        <td>${product.totalSales || product.salesCount || 0}</td>
        <td>${statusBadge}</td>
        <td>${new Date(product.createdAt).toLocaleDateString()}</td>
        <td>
          <div class="action-dropdown">
            <button class="action-btn" onclick="toggleDropdown(this)">Actions <i class="fas fa-caret-down"></i></button>
            <div class="dropdown-menu">
              <a href="#" class="dropdown-item" onclick="openEditModal('${id}')"><i class="fas fa-edit"></i> Edit</a>
              ${!isTrash ? `
              <a href="#" class="dropdown-item" onclick="updateStatus('${id}', 'active')"><i class="fas fa-check"></i> Activate</a>
              <a href="#" class="dropdown-item" onclick="updateStatus('${id}', 'inactive')"><i class="fas fa-ban"></i> Deactivate</a>
              <a href="#" class="dropdown-item" onclick="updateStatus('${id}', 'out_of_stock')"><i class="fas fa-exclamation-triangle"></i> Mark Out of Stock</a>
              <div style="border-top:1px solid #eee; margin:5px 0;"></div>
              <a href="#" class="dropdown-item delete" onclick="deleteProduct('${id}')"><i class="fas fa-trash"></i> Trash</a>
              ` : `
              <a href="#" class="dropdown-item restore" onclick="restoreProduct('${id}')"><i class="fas fa-trash-restore"></i> Restore</a>
              `}
            </div>
          </div>
        </td>
      `;
      tbody.appendChild(row);
      
      // Store images for this product for modal viewing
      if (!window.productImages) window.productImages = {};
      window.productImages[id] = images;
    });
  }

  function getProductImages(product) {
    if (!product.images || !Array.isArray(product.images)) return [];
    return product.images.map(img => {
      if (typeof img === 'string') return img;
      if (img.url) return img.url;
      if (img.path) return img.path;
      return '';
    }).filter(img => img);
  }

  function populateCategoryDropdowns() {
    const filterSelect = document.getElementById('categoryFilter');
    const modalSelect = document.getElementById('productCategory');
    
    // Reset options but keep the first one
    while (filterSelect.options.length > 1) filterSelect.remove(1);
    modalSelect.innerHTML = '<option value="">Select Category</option>';

    state.categories.forEach(cat => {
      const id = cat._id || cat.id;
      const name = cat.name;
      filterSelect.add(new Option(name, id));
      modalSelect.add(new Option(name, id));
    });

    if (jQuery.fn.select2) {
      $(filterSelect).trigger('change');
      $(modalSelect).trigger('change');
    }
  }

  function populateSellerDropdowns() {
    const filterSelect = document.getElementById('sellerFilter');
    const modalSelect = document.getElementById('productSeller');
    
    while (filterSelect.options.length > 1) filterSelect.remove(1);
    modalSelect.innerHTML = '<option value="">Select Seller</option>';

    state.sellers.forEach(seller => {
      const id = seller._id || seller.id;
      const name = seller.name || seller.businessName || seller.email;
      filterSelect.add(new Option(name, id));
      modalSelect.add(new Option(name, id));
    });

    if (jQuery.fn.select2) {
      $(filterSelect).trigger('change');
      $(modalSelect).trigger('change');
    }
  }

  // --- IMAGE HANDLING ---
  function setupImageUpload() {
    const uploadArea = document.getElementById('imageUpload');
    const fileInput = document.getElementById('fileInput');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--primary)';
      uploadArea.style.backgroundColor = 'var(--gray-50)';
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.style.borderColor = 'var(--gray-300)';
      uploadArea.style.backgroundColor = 'transparent';
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.style.borderColor = 'var(--gray-300)';
      uploadArea.style.backgroundColor = 'transparent';
      if (e.dataTransfer.files.length > 0) {
        handleImageFiles(e.dataTransfer.files);
      }
    });
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleImageFiles(e.target.files);
      }
    });
  }

  function handleImageFiles(files) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
      if (!file.type.startsWith('image/')) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative';
        imgContainer.style.width = '100px';
        imgContainer.style.height = '100px';
        
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.style.position = 'absolute';
        removeBtn.style.top = '5px';
        removeBtn.style.right = '5px';
        removeBtn.style.background = 'rgba(0,0,0,0.7)';
        removeBtn.style.color = 'white';
        removeBtn.style.border = 'none';
        removeBtn.style.borderRadius = '50%';
        removeBtn.style.width = '24px';
        removeBtn.style.height = '24px';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.display = 'flex';
        removeBtn.style.alignItems = 'center';
        removeBtn.style.justifyContent = 'center';
        removeBtn.onclick = () => {
          imgContainer.remove();
          // Remove from state.currentProductImages if it exists
          state.currentProductImages = state.currentProductImages.filter(img => img !== e.target.result);
        };
        
        imgContainer.appendChild(img);
        imgContainer.appendChild(removeBtn);
        preview.appendChild(imgContainer);
        
        // Store in state
        state.currentProductImages.push(e.target.result);
      };
      reader.readAsDataURL(file);
    });
  }

  function openImageModal(productId) {
    const images = window.productImages[productId] || [];
    if (images.length === 0) return;
    
    state.currentProductImages = images;
    state.currentImageIndex = 0;
    
    document.getElementById('modalImage').src = images[0];
    document.getElementById('imageModal').style.display = 'flex';
    
    // Update navigation buttons visibility
    document.querySelector('.image-modal-prev').style.display = images.length > 1 ? 'flex' : 'none';
    document.querySelector('.image-modal-next').style.display = images.length > 1 ? 'flex' : 'none';
  }

  function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
    state.currentProductImages = [];
    state.currentImageIndex = 0;
  }

  function prevImage() {
    if (state.currentProductImages.length <= 1) return;
    state.currentImageIndex = (state.currentImageIndex - 1 + state.currentProductImages.length) % state.currentProductImages.length;
    document.getElementById('modalImage').src = state.currentProductImages[state.currentImageIndex];
  }

  function nextImage() {
    if (state.currentProductImages.length <= 1) return;
    state.currentImageIndex = (state.currentImageIndex + 1) % state.currentProductImages.length;
    document.getElementById('modalImage').src = state.currentProductImages[state.currentImageIndex];
  }

  // --- ACTIONS (CRUD) ---
  
  async function saveProduct(event) {
    event.preventDefault();
    const id = document.getElementById('productId').value;
    const isEdit = !!id;
    
    // Construct Payload
    const payload = {
      name: document.getElementById('productName').value,
      sku: document.getElementById('productSKU').value,
      description: document.getElementById('productDescription').value,
      price: Number(document.getElementById('productPrice').value),
      stock: Number(document.getElementById('productStock').value),
      category: document.getElementById('productCategory').value,
      status: document.getElementById('productStatus').value,
      seller: document.getElementById('productSeller').value,
      brand: document.getElementById('productBrand').value,
      weight: document.getElementById('productWeight').value || undefined,
      dimensions: document.getElementById('productDimensions').value || undefined,
      isFeatured: document.getElementById('productFeatured').value === 'true',
      images: state.currentProductImages, // Base64 images from upload
      
      // Handle SEO Metadata
      seoMetadata: {
        metaTitle: document.getElementById('metaTitle').value,
        metaDescription: document.getElementById('metaDescription').value,
        canonicalUrl: document.getElementById('canonicalUrl').value,
        keywords: document.getElementById('metaKeywords').value.split(',').map(k => k.trim()).filter(k => k)
      }
    };
    
    // Handle Tags
    if (jQuery.fn.select2) {
      payload.tags = $('#productTags').val() || [];
    }

    try {
      const url = isEdit ? `/admin/products/${id}` : `/admin/products`;
      const method = isEdit ? 'PUT' : 'POST';
      
      await fetchAPI(url, {
        method: method,
        body: JSON.stringify(payload)
      });

      showToast(`Product ${isEdit ? 'updated' : 'created'} successfully!`, 'success');
      closeModal();
      loadProducts();
    } catch (error) {
      showToast("Failed to save product: " + error.message, 'error');
    }
  }

  // DELETE (Moves to Archive/Trash)
  async function deleteProduct(id) {
    if (!confirm(`Move to Trash? Items can be restored later.`)) return;
    try {
      await fetchAPI(`/admin/products/${id}`, { method: 'DELETE' });
      showToast("Product moved to trash.", 'success');
      loadProducts();
    } catch (error) {
      showToast("Action failed: " + error.message, 'error');
    }
  }

  // RESTORE (Recovers from Trash)
  async function restoreProduct(id) {
    if (!confirm(`Restore this product from Trash?`)) return;
    try {
      await fetchAPI(`/admin/products/${id}/restore`, { method: 'POST' });
      showToast("Product restored successfully.", 'success');
      loadProducts();
    } catch (error) {
      showToast("Restore failed: " + error.message, 'error');
    }
  }

  // UPDATE STATUS
  async function updateStatus(id, status) {
    if (!confirm(`Change product status to "${status}"?`)) return;
    try {
      await fetchAPI(`/admin/products/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ status })
      });
      showToast("Status updated successfully.", 'success');
      loadProducts();
    } catch (error) {
      showToast("Failed to update status: " + error.message, 'error');
    }
  }

  // BULK ACTIONS
  async function bulkAction(action) {
    if (state.selectedProducts.size === 0) {
      showToast("Please select products first.", 'warning');
      return;
    }
    
    if (!confirm(`Apply "${action}" to ${state.selectedProducts.size} products?`)) return;
    
    try {
      const productIds = Array.from(state.selectedProducts);
      await fetchAPI('/admin/products/bulk', {
        method: 'POST',
        body: JSON.stringify({ productIds, action })
      });
      
      showToast(`${action} applied to ${state.selectedProducts.size} products.`, 'success');
      clearSelection();
      loadProducts();
    } catch (error) {
      showToast("Bulk action failed: " + error.message, 'error');
    }
  }

  // --- MODAL HANDLING ---
  
  async function openEditModal(id) {
    try {
      showLoadingModal();
      const data = await fetchAPI(`/admin/products/${id}`);
      const product = data.data || data;
      
      // Clear image state
      state.currentProductImages = getProductImages(product);
      
      // Populate Basic Fields
      document.getElementById('modalTitle').innerText = "Edit Product";
      document.getElementById('productId').value = product._id || product.id;
      document.getElementById('productName').value = product.name || '';
      document.getElementById('productSKU').value = product.sku || '';
      document.getElementById('productBrand').value = product.brand || '';
      document.getElementById('productDescription').value = product.description || '';
      document.getElementById('productPrice').value = product.price || 0;
      document.getElementById('productStock').value = product.stock || 0;
      document.getElementById('productStatus').value = product.status || 'active';
      document.getElementById('productWeight').value = product.weight || '';
      document.getElementById('productDimensions').value = product.dimensions || '';
      document.getElementById('productFeatured').value = product.isFeatured ? 'true' : 'false';
      
      // Populate SEO Fields
      const seo = product.seoMetadata || {};
      document.getElementById('metaTitle').value = seo.metaTitle || '';
      document.getElementById('metaDescription').value = seo.metaDescription || '';
      document.getElementById('canonicalUrl').value = seo.canonicalUrl || '';
      document.getElementById('metaKeywords').value = seo.keywords ? seo.keywords.join(', ') : '';

      // Populate Category and Seller
      const catId = product.category?._id || product.category || '';
      const sellerId = product.seller?._id || product.seller || '';
      
      if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
        $('#productCategory').val(catId).trigger('change');
        $('#productSeller').val(sellerId).trigger('change');
        
        // Tags
        const tagsSelect = $('#productTags');
        tagsSelect.val(null).trigger('change');
        if (product.tags && product.tags.length > 0) {
          product.tags.forEach(tag => {
            if (tagsSelect.find("option[value='" + tag + "']").length === 0) {
              var newOption = new Option(tag, tag, true, true);
              tagsSelect.append(newOption);
            }
          });
          tagsSelect.val(product.tags).trigger('change');
        }
      } else {
        document.getElementById('productCategory').value = catId;
        document.getElementById('productSeller').value = sellerId;
      }
      
      // Display images
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = '';
      state.currentProductImages.forEach((imgSrc, index) => {
        const imgContainer = document.createElement('div');
        imgContainer.style.position = 'relative';
        imgContainer.style.width = '100px';
        imgContainer.style.height = '100px';
        
        const img = document.createElement('img');
        img.src = imgSrc;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '8px';
        
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.style.position = 'absolute';
        removeBtn.style.top = '5px';
        removeBtn.style.right = '5px';
        removeBtn.style.background = 'rgba(0,0,0,0.7)';
        removeBtn.style.color = 'white';
        removeBtn.style.border = 'none';
        removeBtn.style.borderRadius = '50%';
        removeBtn.style.width = '24px';
        removeBtn.style.height = '24px';
        removeBtn.style.cursor = 'pointer';
        removeBtn.style.display = 'flex';
        removeBtn.style.alignItems = 'center';
        removeBtn.style.justifyContent = 'center';
        removeBtn.onclick = () => {
          imgContainer.remove();
          state.currentProductImages.splice(index, 1);
        };
        
        imgContainer.appendChild(img);
        imgContainer.appendChild(removeBtn);
        preview.appendChild(imgContainer);
      });
      
      document.getElementById('productModal').style.display = 'flex';
      
    } catch (error) {
      showToast("Could not load product: " + error.message, 'error');
      closeModal();
    }
  }

  function showLoadingModal() {
    document.getElementById('modalTitle').innerText = "Loading...";
    document.getElementById('productModal').style.display = 'flex';
  }

  function showAddProductModal() {
    document.getElementById('modalTitle').innerText = "Add New Product";
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = "";
    state.currentProductImages = [];
    document.getElementById('imagePreview').innerHTML = '';
    
    // Reset Select2 fields
    if (typeof jQuery !== 'undefined' && jQuery.fn.select2) {
      $('#productCategory').val('').trigger('change');
      $('#productSeller').val('').trigger('change');
      $('#productTags').val(null).trigger('change');
    }
    document.getElementById('productModal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('productModal').style.display = 'none';
    state.currentProductImages = [];
  }

  // --- SELECTION HANDLING ---
  function toggleProductSelection(id) {
    if (state.selectedProducts.has(id)) state.selectedProducts.delete(id);
    else state.selectedProducts.add(id);
    updateBulkUI();
  }

  function toggleSelectAll(e) {
    document.querySelectorAll('.product-checkbox').forEach(cb => {
      cb.checked = e.target.checked;
      if (e.target.checked) state.selectedProducts.add(cb.value);
      else state.selectedProducts.delete(cb.value);
    });
    updateBulkUI();
  }

  function updateBulkUI() {
    const bar = document.getElementById('bulkActions');
    bar.style.display = state.selectedProducts.size > 0 ? 'flex' : 'none';
    document.getElementById('selectedCount').innerText = `${state.selectedProducts.size} selected`;
  }
  
  function clearSelection() {
    state.selectedProducts.clear();
    document.getElementById('selectAll').checked = false;
    document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
    updateBulkUI();
  }

  document.getElementById('selectAll').addEventListener('change', toggleSelectAll);

  // --- UTILS ---
  function updatePaginationUI() {
    const start = ((state.currentPage - 1) * state.limit) + 1;
    const end = Math.min(state.currentPage * state.limit, state.totalProducts);
    document.getElementById('startIndex').innerText = state.totalProducts > 0 ? start : 0;
    document.getElementById('endIndex').innerText = end;
    document.getElementById('totalProducts').innerText = state.totalProducts;
  }

  function goToPage(page) {
    if (page < 1 || page > state.totalPages) return;
    state.currentPage = page;
    loadProducts();
  }
  function prevPage() { if (state.currentPage > 1) goToPage(state.currentPage - 1); }
  function nextPage() { if (state.currentPage < state.totalPages) goToPage(state.currentPage + 1); }
  function goToLastPage() { goToPage(state.totalPages); }

  function initializeFilters() {
    let timeout;
    document.querySelectorAll('.filter-input, .filter-select').forEach(input => {
      input.addEventListener('change', () => { state.currentPage = 1; loadProducts(); });
      if (input.type === 'text') {
        input.addEventListener('input', () => {
          clearTimeout(timeout);
          timeout = setTimeout(() => { state.currentPage = 1; loadProducts(); }, 600);
        });
      }
    });
  }

  function resetFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('sellerFilter').value = '';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    document.getElementById('minStock').value = '';
    document.getElementById('maxStock').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('sortFilter').value = 'newest';
    
    if (jQuery.fn.select2) {
      $('#categoryFilter').val('').trigger('change');
      $('#sellerFilter').val('').trigger('change');
    }
    
    state.currentPage = 1;
    loadProducts();
  }

  function toggleDropdown(btn) {
    document.querySelectorAll('.dropdown-menu').forEach(el => el.style.display = 'none');
    const menu = btn.nextElementSibling;
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }

  function showLoadingState() {
    document.getElementById('productsTableBody').innerHTML = 
      `<tr><td colspan="11" style="text-align:center; padding: 40px;"><div class="loading"></div> Loading...</td></tr>`;
  }
  
  function updateStatsUI(stats) {
    if (!stats) return;
    document.getElementById('activeCount').innerText = stats.active || 0;
    document.getElementById('inactiveCount').innerText = stats.inactive || 0;
    document.getElementById('pendingCount').innerText = stats.pending || 0;
    document.getElementById('draftCount').innerText = stats.draft || 0;
    document.getElementById('outOfStockCount').innerText = stats.outOfStock || 0;
    document.getElementById('archivedCount').innerText = stats.archived || 0;
  }
  
  function showToast(message, type = 'info') {
    Toastify({
      text: message,
      duration: 3000,
      gravity: "top",
      position: "right",
      backgroundColor: type === 'success' ? "#059669" : 
                     type === 'error' ? "#dc2626" : 
                     type === 'warning' ? "#d97706" : "#0891b2",
      stopOnFocus: true
    }).showToast();
  }
  
  function exportProducts() { 
    // Trigger CSV download
    const params = new URLSearchParams();
    const filters = {
      search: document.getElementById('searchInput').value.trim(),
      status: document.getElementById('statusFilter').value,
      category: document.getElementById('categoryFilter').value,
    };
    
    Object.keys(filters).forEach(key => {
      if (filters[key] && filters[key] !== 'all' && filters[key] !== '') {
        params.append(key, filters[key]);
      }
    });
    
    window.open(`${API_V1}/admin/products/export?${params}`, '_blank');
  }
</script>
</body>
</html>
